;; -*- coding: utf-8
#+OPTIONS: ^:{}
#+TITLE: SUK GE EMACS PUIJI

* Cinyin
ni go citding mangin hai yunglai taigÃ²u makying ge Emacs taiyim.
kÃªi saugoi zo hÃ²u do ge makying citding tungmai zÃ¡psing zo dÃ¡ilÃ¶ng ge cÃ¡pgin.

ZaphÃ¡ng  *Org Babel Tangle* mingling: ` /M-x org-babel-tangle/ ` hÃªi sangsing EL mangin.

* Taicin Puiji Yaphau: early-init.el
** Yatdit SÃ¶iyiu Taicin ZaphÃ¡ng Ge Citding
#+begin_src emacs-lisp :tangle early-init.el
  (when (or (featurep 'esup-child)
            (fboundp 'profile-dotemacs)
            (daemonp)
            (boundp 'startup-now)
            noninteractive)
    (setq package-enable-at-startup nil))

  (defvar my-computer-has-smaller-memory-p nil
    "Installing&Compiling many packages could cost too much memory.")

  ;; @see https://www.reddit.com/r/emacs/comments/ofhket/further_boost_start_up_time_with_a_simple_tweak/
  (unless my-computer-has-smaller-memory-p
  ;; Defer garbage collection further back in the startup process
    (setq gc-cons-threshold most-positive-fixnum
          gc-cons-percentage 0.6)
  )
  ;; Prevent unwanted runtime compilation for gccemacs (native-comp) users;
  ;; packages are compiled ahead-of-time when they are installed and site files
  ;; are compiled when gccemacs is installed.
  (setq native-comp-deferred-compilation nil ;; obsolete since 29.1
        native-comp-jit-compilation nil)

  (setq inhibit-startup-message t)

  ;; In Emacs 27+, package initialization occurs before `user-init-file' is
  ;; loaded, but after `early-init-file'. Doom handles package initialization, so
  ;; we must prevent Emacs from doing it early!
  (setq package-enable-at-startup nil)
  ;; Do not allow loading from the package cache (same reason).
  (setq package-quickstart nil)
  ;; `use-package' is builtin since 29.
  ;; It must be set before loading `use-package'.
  (setq use-package-enable-imenu-support t)


  ;; Prevent the glimpse of un-styled Emacs by disabling these UI elements early.
  (push '(menu-bar-lines . 0) default-frame-alist)
  (push '(tool-bar-lines . 0) default-frame-alist)
  (push '(vertical-scroll-bars) default-frame-alist)
  (when (featurep 'ns)
    (push '(ns-transparent-titlebar . t) default-frame-alist))
  (setq-default mode-line-format nil)

  (provide 'early-init)
  ;;(global-unset-key (kbd "C-SPC"))
#+end_src

* Puiji JÃ¼ Yaphau: init.el
The configuration entrance is mainly used to load other settings and plug-ins.

** Dingyi Muluk BinlÃ¶ng.
#+BEGIN_SRC emacs-lisp :tangle init.el
  ;;; init.el --- Initialize configurations.  -*- lexical-binding: t -*-
  ;; Copyright (C) 1999 - 2024 Suk
  ;; Author: Suk

  ;; This file is not part of GNU Emacs.
  ;;

  ;; This program is free software; you can redistribute it and/or
  ;; modify it under the terms of the GNU General Public License as
  ;; published by the Free Software Foundation; either version 2, or
  ;; (at your option) any later version.
  ;;
  ;; but WITHOUT ANY WARRANTY; without even the implied warranty of
  ;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  ;; General Public License for more details.
  ;;
  ;; You should have received a copy of the GNU General Public License
  ;; along with this program; see the file COPYING.  If not, write to
  ;; the Free Software Foundation, Inc., 51 Franklin Street, Fifth
  ;; Floor, Boston, MA 02110-1301, USA.
  ;;
  ;;; Commentary
  ;;
  ;; Emacs configurations.
  ;;

  ;;; Code:

  (provide 'init)


  ;; Dingyi yidit muluk, fongbin yathÃ²u cingyi.
  ;; user-emacs-directory tungsÃ¶ng hai ~/.emacs.d
  ;; windows hÃ¡, ~/ tungsÃ¶ng hai $EMACS_INSTALL_DIR, wÃ¡kze EMACS citding de `HOME` binlÃ¶ng
  (defvar suk-emacs-root-dir (file-truename user-emacs-directory))
  (defvar suk-emacs-config-dir (expand-file-name "etc" suk-emacs-root-dir))
  (defvar suk-emacs-extension-dir (expand-file-name "extensions" suk-emacs-root-dir))
  (defvar suk-emacs-share-dir (expand-file-name "share" suk-emacs-root-dir))
  (defvar suk-emacs-themes-dir (expand-file-name "themes" suk-emacs-share-dir))
  (defvar suk-emacs-elpa-dir (expand-file-name "elpa" suk-emacs-root-dir))
  (defvar suk-emacs-var-dir (expand-file-name "var" suk-emacs-root-dir))
  (defvar suk-emacs-tmp-dir (expand-file-name "tmp" suk-emacs-var-dir))
  (defvar suk-emacs-backup-dir (expand-file-name "backup" suk-emacs-tmp-dir))

  ;; OS ge HOME muluk.
  (defvar user-home-dir (getenv "HOME"))

  (if (eq system-type 'windows-nt)
      (defvar user-home-dir (getenv "USERPROFILE")))
#+END_SRC

** Dingyi Lamsi Mangin Tungmai Muluk.
#+BEGIN_SRC emacs-lisp :tangle init.el
  ;; blink search
  (setq blink-search-db-path (expand-file-name "blink-search.db" suk-emacs-tmp-dir))
  ;; Saveplace
  (setq save-place-file (concat suk-emacs-var-dir "/saveplace"))
  ;; Recentf
  (setq recentf-save-file (concat suk-emacs-var-dir "/recentf"))
  ;;(setq recentf-save-file "~/.emacs.d/var/recentf")
  ;; History
  (setq savehist-file (concat suk-emacs-var-dir "/history"))
  ; Amx
  (setq amx-save-file (concat suk-emacs-var-dir "/amx-items"))
  ;; Auto save
  (setq auto-save-list-file-prefix (concat suk-emacs-var-dir "/auto-save-list/.saves-"))
  ;; Eshell
  (setq eshell-directory-name (concat suk-emacs-var-dir "/eschell"))
  (setq eshell-history-file-name (concat eshell-directory-name "/history"))
  ;; projectitle-bookmarks
  (setq projectile-known-projects-file (concat suk-emacs-var-dir "/projectile-bookmarks.eld"))
  (setq backup-directory-alist `(("" . ,suk-emacs-tmp-dir)))
  ;; Bookmark
  (setq bookmark-default-file (concat suk-emacs-var-dir "/emacs.bmk"))
  ;; Diary
  (setq diary-file (concat user-home-dir "/diary"))

#+END_SRC

** GÃ¡zoi Muluk HÃ¡msÃ²u: DaiÄ£ai Emacs Tungmai CÃ¡pgin Ge Citding Muluk DÃ²u `load-path`
#+BEGIN_SRC emacs-lisp :tangle init.el
  ;; Ignore `cl` expiration warnings
  (setq byte-compile-warnings '(cl-function))

  ;; original version
  ;;(defun add-subdirs-to-load-path (dir)
  ;;  "Recursive add directories to `load-path'."
  ;;  (let ((default-directory (file-name-as-directory dir)))
  ;;     (add-to-list 'load-path dir)
  ;;     (normal-top-level-add-subdirs-to-load-path)))

  ;; çŽ‹å‹‡çš„ç‰ˆæœ¬ https://manateelazycat.github.io/emacs/2022/03/02/emacs-load-directory-recursively.html
  (require 'cl-lib)
  (defun add-subdirs-to-load-path (search-dir isFirst)
    (interactive)
    (when isFirst
      ;; åŽŸæ¥çš„ç‰ˆæœ¬æ²¡æœ‰æŠŠç¬¬1ä¸ª search-dir æœ¬èº«æ·»åŠ åˆ° `load path`
      ;; é€’å½’æ—¶çš„search-diræ˜¯åœ¨é€’å½’å‰åŠ å…¥äº†ã€‚
      (add-to-list 'load-path search-dir))
    (let* ((dir (file-name-as-directory search-dir)))
      (dolist (subdir
               ;; golÃ¶i bat bityiu ge mukluk, taising Emacs kaidung cudou.
               (cl-remove-if
                #'(lambda (subdir)
                    (or
                     ;; m hai mangin
                     (not (file-directory-p (concat dir subdir)))
                     ;; yicÃ¶i hÃ¡min ge mukluk
                     (member subdir '("." ".." ; Linux/Uniux haitung ge  dongcin mukluk tungmÃ¡i fu mukluk
                                      "dist" "node_modules" "__pycache__" ; takding ge yÃ¼yin sÃ¶ngÄ£Ã¡n ge mukluk
                                      "RCS" "CVS" "rcs" "cvs" ".git" ".github")))) ; bÃ¡nbun hungjai mukluk
                (directory-files dir)))
        (let ((subdir-path (concat dir (file-name-as-directory subdir))))
          ;; mukluk bauhÃ¡m  .el .so .dll ge mangin di louging sinji gÃ¡ dou `load-path` binlÃ¶ng
          (when (cl-some #'(lambda (subdir-file)
                             (and (file-regular-p (concat subdir-path subdir-file))
                                  ;; .so .dll æ–‡ä»¶æŒ‡éžElispè¯­è¨€ç¼–å†™çš„EmacsåŠ¨æ€åº“
                                  (member (file-name-extension subdir-file) '("el" "so" "dll"))))
                         (directory-files subdir-path))

            ;; jÃ¼yi: add-to-list ge daisÃ¡m go cÃ¡msou bitsÃ¶iwai t, timgÃ¡ dou meibou,
            ;; kokbou Ä£ongdou yausin
            (add-to-list 'load-path subdir-path t))

          ;; geiÃ¶uk daiÄ£ai sausok ji mukluk.
          (add-subdirs-to-load-path subdir-path nil)))))

  ;; gÃ¡zoi tsiding ge muluk.
  (add-subdirs-to-load-path suk-emacs-config-dir t)
  (add-subdirs-to-load-path suk-emacs-extension-dir t)
  (add-subdirs-to-load-path suk-emacs-themes-dir t)

#+END_SRC

** GÃ¡zoi Dakding Ge Citding Mangin
#+BEGIN_SRC emacs-lisp :tangle init.el
  ;; The contents of the Emacs configuration file are written below.
  (let (;;  Temporarily increase `gc-cons-threshold' when loading to speed up
        ;;  startup.
        (gc-cons-threshold most-positive-fixnum)
        (gc-cons-percentage 0.8)

        ;; Clear to avoid analyzing files when loading remote files.
        (file-name-handler-alist nil))
    ;; Don't pass case-insensitive to `auto-mode-alist'
    (setq auto-mode-case-fold nil)
    ;; Prevent flashing of unstyled modeline at startup
    (setq-default mode-line-format nil)
    (unless (or (daemonp) noninteractive init-file-debug)
      ;; Suppress file handlers operations at startup
      ;; `file-name-handler-alist' is consulted on each call to `require' and `load'
      (let ((old-value file-name-handler-alist))
        (setq file-name-handler-alist nil)
        (set-default-toplevel-value 'file-name-handler-alist file-name-handler-alist)
        (add-hook 'emacs-startup-hook
                  (lambda ()
                    "Recover file name handlers."
                    (setq file-name-handler-alist
                          (delete-dups (append file-name-handler-alist old-value))))
                  101)))




    (require '+const)  ; Constants
    (require '+custom) ; Customization
    (require '+func)   ; Functions
    (require 'init-basic)
    (require 'lazy-load)
    (require 'init-key)
    (require 'init-package)
    (require 'init-completion)
    (require 'init-ui)
    (require 'init-org)
    (require 'init-utils)
    (require 'init-mode)
    (when sys/linuxp
      (progn
        (require 'init-shell)
        (require 'init-im)   ;; windows ä¸‹è¡¨çŽ°ä¸å¥½
        (require 'init-sudo)
        )
      )

    ;; delay load
    (run-with-idle-timer
     1 nil
     #'(lambda ()
         ;; Restore session at last.
         (require 'init-session)
         (emacs-session-restore)
         (server-start)
         (require 'init-bookmark)
         (require 'init-buffers)
         (require 'init-recentf)
         (require 'init-dired)
         (require 'init-auto-save)
         (require 'init-edit)
         (require 'init-idle)
         (require 'init-eshell)
         ;;(require 'highlight-parentheses)
         (require 'init-highlight)
         (require 'init-window)
         (require 'init-reader)
         (require 'init-calendar)
         (require 'load-abbrev)
         ;; Programming
         (require 'init-ide)
         ;; Make gc pauses faster by decreasing the threshold.
         (setq gc-cons-threshold (* 16 1000 1000))
         ))
    )

#+END_SRC

#+begin_src emacs-lisp :tangle init.el

#+end_src
** Citji GC
#+begin_src emacs-lisp :tangle init.el
   ;; Reset the GC setting
  (add-hook 'emacs-startup-hook
           (lambda ()
             "Fuifuk makying ge zik"
             (setq file-name-handler-alist default-file-name-handler-alist)
             ;; makying zik wai 0.8MB
             ;;(setq gc-cons-threshold 80000000)
             (message "Emacs ready in %s with %d garbage collections."
                      (format "%.2f seconds"
                              (float-time
                               (time-subtract after-init-time before-init-time)))
                      gcs-done)
             (add-hook 'focus-out-hook 'garbage-collect)))

  ;; @see https://www.reddit.com/r/emacs/comments/55ork0/is_emacs_251_noticeably_slower_than_245_on_windows/
  ;; Emacs 25 does gc too frequently
  ;; (setq garbage-collection-messages t) ; for debug
  (defun my-cleanup-gc ()
    "Clean up gc."
    (setq gc-cons-threshold  67108864) ; 64M
    (setq gc-cons-percentage 0.1) ; original value
    (garbage-collect))

  (message "*** Emacs loaded in %s with %d garbage collections."
           (format "%.2f seconds"
                   (float-time (time-subtract after-init-time before-init-time)))
           gcs-done)
  (run-with-idle-timer 4 nil #'my-cleanup-gc)
#+end_src
* Citding Haitung SÃ¶nglÃ¶ng: etc/+const.el
** DINGYI YATDIT HAITUNG BIUGÃˆI
#+begin_src  emacs-lisp :tangle etc/+const.el
  ;; +const.el --- Define constants.	-*- lexical-binding: t -*-
  ;;; Commentary:
  ;;
  ;; Define constants.
  ;;

  ;;; Code:
  (defconst custom-template-file
    (expand-file-name "custom-template.el" user-emacs-directory)
    "Custom template file of Suk's Emacs.")

  (defconst suk-homepage
    "https://github.com/bruceasu/.emacs.d"
    "The Github page of this Emacs config.")

  (defconst sys/win32p
    (eq system-type 'windows-nt)
    "Are we running on a WinTel system?")

  (defconst sys/linuxp
    (eq system-type 'gnu/linux)
    "Are we running on a GNU/Linux system?")

  (defconst sys/macp
    (eq system-type 'darwin)
    "Are we running on a Mac system?")

  (defconst sys/mac-x-p
    (and (display-graphic-p) sys/macp)
    "Are we running under X on a Mac system?")

  (defconst sys/linux-x-p
    (and (display-graphic-p) sys/linuxp)
    "Are we running under X on a GNU/Linux system?")

  (defconst sys/cygwinp
    (eq system-type 'cygwin)
    "Are we running on a Cygwin system?")

  (defconst sys/rootp
    (string-equal "root" (getenv "USER"))
    "Are you using ROOT user?")

  (defconst emacs/>=25p
    (>= emacs-major-version 25)
    "Emacs is 25 or above.")

  (defconst emacs/>=26p
    (>= emacs-major-version 26)
    "Emacs is 26 or above.")

  (defconst emacs/>=27p
    (>= emacs-major-version 27)
    "Emacs is 27 or above.")

  (defconst emacs/>=28p
    (>= emacs-major-version 28)
    "Emacs is 28 or above.")

  (defconst emacs/>=29p
    (>= emacs-major-version 29)
    "Emacs is 29 or above.")

  (defconst emacs/>=30p
    (>= emacs-major-version 30)
    "Emacs is 30 or above.")

  (provide '+const)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; +const.el ends here

#+end_src
* Citding Ji DÃ¬ngyi BinlÃ¶ng: etc/+custom.el
** DINGYI YATDIT ZIDINGYI BINLÃ–NG
#+begin_src  emacs-lisp :tangle etc/+custom.el
  ;; +custom.el --- Define customizations.	-*- lexical-binding: t -*-
  ;;; Commentary:
  ;;
  ;; Customizations.
  ;;

  ;;; Code:

  (eval-when-compile
    (require '+const)
    (require 'package))

  (defgroup suk nil
    "suk Emacs customizations."
    :group 'convenience
    :link '(url-link :tag "Homepage" "https://github.com/bruceasu/.emacs.d"))

  (defcustom suk-logo (expand-file-name
                           (if (display-graphic-p) "logo.png" "banner.txt")
                           user-emacs-directory)
    "Set Suk logo. nil means official logo."
    :group 'suk
    :type 'string)

  (defcustom suk-full-name "Suk"
    "Set user full name."
    :group 'suk
    :type 'string)

  (defcustom suk-mail-address "bruceasu@gmail.com"
    "Set user email address."
    :group 'suk
    :type 'string)

  (defcustom suk-proxy "127.0.0.1:1080"
    "Set network proxy."
    :group 'suk
    :type 'string)

  (defcustom suk-cnfonts nil
    "Use cnfonts or not."
    :group 'suk
    :type 'boolean)

  (defcustom user-home-dir (getenv "HOME")
    "User home directory."
    :group 'suk
    :type 'string)

  (if sys/win32p
      (setq user-home-dir (getenv "USERPROFILE"))
  )

  (defcustom suk-icon t
    "Display icons or not."
    :group 'suk
    :type 'boolean)

  (defcustom org-roam-directory (expand-file-name "RoamNotes" user-home-dir)
    "The org roam directory."
    :group 'suk
    :type 'string)

  (defcustom org-files-directory (expand-file-name "org" user-home-dir)
    "The org roam directory."
    :group 'suk
    :type 'string)

  (defcustom  org-css-file "~/.emacs.d/share/my-org-style-min.css"
    "The org css style file."
    :group 'suk
    :type 'string)

  (defcustom windows-bash-path (expand-file-name "C:/Program Files/Git/bin/bash.exe")
    "The windows version of bash."
    :group 'suk
    :type 'string)


  (defcustom suk-completion-style 'childframe
    "Completion display style."
    :group 'suk
    :type '(choice (const :tag "Minibuffer" minibuffer)
                   (const :tag "Child Frame" childframe)))

  (defcustom suk-dashboard (not (daemonp))
    "Display dashboard at startup or not.
  If Non-nil, use dashboard, otherwise will restore previous session."
    :group 'suk
    :type 'boolean)

  (defcustom suk-lsp 'eglot
    "Set language server.

  `lsp-mode': See https://github.com/emacs-lsp/lsp-mode.
  `eglot': See https://github.com/joaotavora/eglot.
  nil means disabled."
    :group 'suk
    :type '(choice (const :tag "LSP Mode" lsp-mode)
                   (const :tag "Eglot" eglot)
                   (const :tag "Disable" nil)))

  (defcustom suk-tree-sitter t
    "Enable tree-sitter or not.
  Native tree-sitter is introduced in 29."
    :group 'suk
    :type 'boolean)

  (defcustom suk-lsp-format-on-save nil
    "Auto format buffers on save."
    :group 'suk
    :type 'boolean)

  (defcustom suk-lsp-format-on-save-ignore-modes
    '(c-mode c++-mode python-mode markdown-mode)
    "The modes that don't auto format and organize imports while saving the buffers.
  `prog-mode' means ignoring all derived modes."
    :group 'suk
    :type '(repeat (symbol :tag "Major-Mode")))

  (defcustom suk-prettify-symbols-alist
    '(("lambda" . ?Î»)
      ("<-"     . ?â†)
      ("->"     . ?â†’)
      ("->>"    . ?â† )
      ("=>"     . ?â‡’)
      ("map"    . ?â†¦)
      ("/="     . ?â‰ )
      ("!="     . ?â‰ )
      ("=="     . ?â‰¡)
      ("<="     . ?â‰¤)
      (">="     . ?â‰¥)
      ("=<<"    . (?= (Br . Bl) ?â‰ª))
      (">>="    . (?â‰« (Br . Bl) ?=))
      ("<=<"    . ?â†¢)
      (">=>"    . ?â†£)
      ("&&"     . ?âˆ§)
      ("||"     . ?âˆ¨)
      ("not"    . ?Â¬))
    "A list of symbol prettifications.
  Nil to use font supports ligatures."
    :group 'suk
    :type '(alist :key-type string :value-type (choice character sexp)))

  (defcustom suk-prettify-org-symbols-alist
    '(("[ ]"            . ?ï‚–)
      ("[-]"            . ?ï…‡)
      ("[X]"            . ?ï†)

      (":PROPERTIES:"   . ?ï€‹)
      (":ID:"           . ?ðŸªª)
      (":END:"          . ?ðŸ”š)

      ("#+ARCHIVE:"     . ?ðŸ“¦)
      ("#+AUTHOR:"      . ?ðŸ‘¤)
      ("#+CREATOR:"     . ?ðŸ’)
      ("#+DATE:"        . ?ðŸ“†)
      ("#+DESCRIPTION:" . ?â¸™)
      ("#+EMAIL:"       . ?ðŸ“§)
      ("#+HEADERS"      . ?â˜°)
      ("#+OPTIONS:"     . ?âš™)
      ("#+SETUPFILE:"   . ?âš’)
      ("#+TAGS:"        . ?ðŸ·)
      ("#+TITLE:"       . ?ðŸ““)

      ("#+BEGIN_SRC"    . ?âœŽ)
      ("#+END_SRC"      . ?â–¡)
      ("#+BEGIN_QUOTE"  . ?Â«)
      ("#+END_QUOTE"    . ?Â»)
      ("#+RESULTS:"     . ?ðŸ’»))
    "A list of symbol prettifications for `org-mode'."
    :group 'suk
    :type '(alist :key-type string :value-type (choice character sexp)))


  ;; Load `custom-file'
  ;; If it doesn't exist, copy from the template, then load it.
  (setq custom-file (expand-file-name "custom.el" user-emacs-directory))

  (let ((custom-template-file
         (expand-file-name "custom-template.el" user-emacs-directory)))
    (if (and (file-exists-p custom-template-file)
             (not (file-exists-p custom-file)))
        (copy-file custom-template-file custom-file)))

  (if (file-exists-p custom-file)
      (load custom-file))

  ;; Load `custom-post.el'
  ;; Put personal configurations to override defaults here.
  (add-hook 'after-init-hook
            (lambda ()
              (let ((file
                     (expand-file-name "custom-post.el" user-emacs-directory)))
                (if (file-exists-p file)
                    (load file)))))

  (provide '+custom)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; +custom.el ends here

#+end_src
* Citding Tungyong HÃ¡mshou: etc/+func.el
#+begin_src   emacs-lisp :tangle etc/+func.el
  ;; -*- coding: utf-8; lexical-binding: t; -*-
  (eval-when-compile
    (require '+const)
    (require '+custom)
    )

  (defun childframe-workable-p ()
    "Whether childframe is workable."
    (not (or noninteractive
             emacs-basic-display
             (not (display-graphic-p)))))

  (defun childframe-completion-workable-p ()
    "Whether childframe completion is workable."
    (and (eq suk-completion-style 'childframe)
         (childframe-workable-p)))

  (defun icons-displayable-p ()
    "Return non-nil if icons are displayable."
    (and suk-icon
         (or (featurep 'nerd-icons)
             (require 'nerd-icons nil t))))

  (defun suk-treesit-available-p ()
    "Check whether tree-sitter is available.
  Native tree-sitter is introduced since 29.1."
    (and suk-tree-sitter
         (fboundp 'treesit-available-p)
         (treesit-available-p)))

  (defun too-long-file-p ()
    "Check whether the file is too long."
    (or (> (buffer-size) 100000)
        (and (fboundp 'buffer-line-statistics)
             (> (car (buffer-line-statistics)) 10000))))

  ;; Increase selected region by semantic units
  (defun suk-treesit-available-p ()
    "Check whether tree-sitter is available.
  Native tree-sitter is introduced since 29.1."
    (and suk-tree-sitter
         (fboundp 'treesit-available-p)
         (treesit-available-p)))


  ;; Browse URL
  ;;;###autoload
  (defun suk-webkit-browse-url (url &optional pop-buffer new-session)
    "Browse URL with xwidget-webkit' and switch or pop to the buffer.

    POP-BUFFER specifies whether to pop to the buffer.
    NEW-SESSION specifies whether to create a new xwidget-webkit session."
    (interactive (progn
                   (require 'browse-url)
                   (browse-url-interactive-arg "xwidget-webkit URL: ")))
    (or (featurep 'xwidget-internal)
        (user-error "Your Emacs was not compiled with xwidgets support"))

    (xwidget-webkit-browse-url url new-session)
    (let ((buf (xwidget-buffer (xwidget-webkit-current-session))))
      (when (buffer-live-p buf)
        (and (eq buf (current-buffer)) (quit-window))
        (if pop-buffer
            (pop-to-buffer buf)
          (switch-to-buffer buf)))))


  (defun local-require (pkg)
    "Require PKG in site-lisp directory."
    (unless (featurep pkg)
      (load (expand-file-name
             (cond
              ((eq pkg 'go-mode-load)
               (format "%s/go-mode/%s" suk-emacs-extension-dir pkg))
              (t
               (format "%s/%s/%s" suk-emacs-extension-dir pkg pkg))))
            t t)))

  (defun my-ensure (feature)
    "Make sure FEATURE is required."
    (unless (featurep feature)
      (condition-case nil
          (require feature)
        (error nil))))

  (when sys/linuxp
  ;;;###autoload
    (defun my-hostname ()
      "Return stripped output of cli program hostname."
      (let* ((output (shell-command-to-string "hostname")))
        ;; Windows DOS might output some extra noise
        (string-trim (replace-regexp-in-string "hostname" "" output))))

    )

  ;;;###autoload
  (defun my-git-root-dir ()
    "Git root directory."
    ;;(interactive)
    (locate-dominating-file default-directory ".git"))

  ;;;###autoload
  (defun my-git-files-in-rev-command (rev level)
    "Return git command line to show files in REV and LEVEL."
    (unless level (setq level 0))
    (concat "git diff-tree --no-commit-id --name-only -r "
            rev
            (make-string level ?^)))

  ;;;###autoload
  (defun my-nonempty-lines (str)
    "Split STR into lines."
    (split-string str "[\r\n]+" t))

  ;;;###autoload
  (defun my-lines-from-command-output (command)
    "Return lines of COMMAND output."
    (let* ((output (string-trim (shell-command-to-string command)))
           (cands (my-nonempty-lines output)))
      (delq nil (delete-dups cands))))

  ;;;###autoload
  (defun run-cmd-and-replace-region (cmd)
    "Run CMD in shell on selected region or current buffer.
  Then replace the region or buffer with cli output."
    (let* ((orig-point (point))
           (b (if (region-active-p) (region-beginning) (point-min)))
           (e (if (region-active-p) (region-end) (point-max))))
      (shell-command-on-region b e cmd nil t)
      (goto-char orig-point)))

  ;;;###autoload
  (defun my-use-tags-as-imenu-function-p ()
    "Can use tags file to build imenu function"
    (my-ensure 'counsel-etags)
    (and (locate-dominating-file default-directory "TAGS")
         ;; latest universal ctags has built in parser for javascript/typescript
         (counsel-etags-universal-ctags-p "ctags")
         (memq major-mode '(typescript-mode js-mode javascript-mode))))

  ;; {{ copied from http://ergoemacs.org/emacs/elisp_read_file_content.html
  ;;;###autoload
  (defun my-get-string-from-file (file)
    "Return FILE's content."
    (with-temp-buffer
      (insert-file-contents file)
      (buffer-string)))
  ;;;###autoload
  (defun my-read-lines (file)
    "Return a list of lines of FILE."
    (split-string (my-get-string-from-file file) "\n" t))
  ;; }}

  ;;;###autoload
  (defun my-write-to-file (str file)
    "Write STR to FILE."
    (with-temp-buffer
      (insert str)
      (write-file (file-truename file))))

  ;;;###autoload
  (defun my-write-to-missing-file (str file)
    "Write STR to FILE if it's missing."
    (unless (file-exists-p file)
      (my-write-to-file str file)))

  ;;;###autoload
  ;; Handier way to add modes to auto-mode-alist
  (defun my-add-auto-mode (mode &rest patterns)
    "Add entries to `auto-mode-alist' to use MODE for given file PATTERNS."
    (dolist (pattern patterns)
      (push (cons pattern mode) auto-mode-alist)))

  ;;;###autoload
  (defun my-add-interpreter-mode (mode &rest patterns)
    "Add entries to `interpreter-mode-alist' to use MODE for given file PATTERNS."
    (dolist (pattern patterns)
      (push (cons pattern mode) interpreter-mode-alist )))

  ;;;###autoload
  (defmacro my-push-if-uniq (item items)
    "Push ITEM into ITEMS if it's unique."
    `(unless (member ,item ,items) (push ,item ,items)))

  ;;;###autoload
  (defun my-what-face (&optional position)
    "Show all faces at POSITION."
    (let* ((face (get-text-property (or position (point)) 'face)))
      (unless (keywordp (car-safe face)) (list face))))



  ;; String utilities missing from core emacs
  ;;;###autoload
  (defun string-all-matches (regex str &optional group)
    "Find matches for REGEX in STR, returning the full match or GROUP."
    (let ((result nil)
          (pos 0)
          (group (or group 0)))
      (while (string-match regex str pos)
        (push (match-string group str) result)
        (setq pos (match-end group)))
      result))

  ;;;###autoload
  (defun path-in-directory-p (file directory)
    "FILE is in DIRECTORY."
    (let* ((pattern (concat "^" (file-name-as-directory directory))))
      (if (string-match pattern file) file)))

  ;;;###autoload
  (defun my-prepare-candidate-fit-into-screen (s)
    (let* ((w (frame-width))
           ;; display kill ring item in one line
           (key (replace-regexp-in-string "[ \t]*[\n\r]+[ \t]*" "\\\\n" s)))
      ;; strip the whitespace
      (setq key (replace-regexp-in-string "^[ \t]+" "" key))
      ;; fit to the minibuffer width
      (if (> (length key) w)
          (setq key (concat (substring key 0 (- w 4)) "...")))
      (cons key s)))

  ;;;###autoload
  (defun my-select-from-kill-ring (fn)
    "If N > 1, yank the Nth item in `kill-ring'.
  If N is nil, use `ivy-mode' to browse `kill-ring'."
    (interactive "P")
    (let* ((candidates (cl-remove-if
                        (lambda (s)
                          (or (< (length s) 5)
                              (string-match "\\`[\n[:blank:]]+\\'" s)))
                        (delete-dups kill-ring)))
           (ivy-height (/ (frame-height) 2)))
      (ivy-read "Browse `kill-ring':"
                (mapcar #'my-prepare-candidate-fit-into-screen candidates)
                :action fn)))

  ;;;###autoload
  (defun my-delete-selected-region ()
    "Delete selected region."
    (when (region-active-p)
      (delete-region (region-beginning) (region-end))))

  ;;;###autoload
  (defun my-insert-str (str)
    "Insert STR into current buffer."
    ;; ivy8 or ivy9
    (if (consp str) (setq str (cdr str)))
    ;; evil-mode?
    (if (and (functionp 'evil-normal-state-p)
             (boundp 'evil-move-cursor-back)
             (evil-normal-state-p)
             (not (eolp))
             (not (eobp)))
        (forward-char))

    (my-delete-selected-region)

    ;; insert now
    (insert str)
    str)

  ;;;###autoload
  (defun my-line-str (&optional line-end)
    (buffer-substring-no-properties (line-beginning-position)
                                    (if line-end line-end (line-end-position))))

  ;;;###autoload
  (defun my-is-in-one-line (b e)
    (save-excursion
      (goto-char b)
      (and (<= (line-beginning-position) b)
           (<= e (line-end-position)))))

  ;;;###autoload
  (defun my-buffer-str ()
    (buffer-substring-no-properties (point-min) (point-max)))

  ;;;###autoload
  (defun my-selected-str ()
    "Get string of selected region."
    (buffer-substring-no-properties (region-beginning) (region-end)))

  ;;;###autoload
  (defun my-use-selected-string-or-ask (&optional hint)
    "Use selected region or ask for input.
  If HINT is empty, use symbol at point."
    (cond
     ((region-active-p)
      (my-selected-str))
     ((or (not hint) (string= "" hint))
      (thing-at-point 'symbol))
     (t
      (read-string hint))))

  ;;;###autoload
  (defun delete-this-file ()
    "Delete the current file, and kill the buffer."
    (interactive)
    (or (buffer-file-name) (error "No file is currently being edited"))
    (when (yes-or-no-p (format "Really delete '%s'?"
                               (file-name-nondirectory buffer-file-name)))
      (delete-file (buffer-file-name))
      (kill-this-buffer)))

  ;;;###autoload
  (defun rename-this-file-and-buffer (new-name)
    "Renames both current buffer and file it's visiting to NEW-NAME."
    (interactive "sNew name: ")
    (let ((name (buffer-name))
          (filename (buffer-file-name)))
      (unless filename
        (error "Buffer '%s' is not visiting a file!" name))
      (if (get-buffer new-name)
          (message "A buffer named '%s' already exists!" new-name)
        (progn
          (rename-file filename new-name 1)
          (rename-buffer new-name)
          (set-visited-file-name new-name)
          (set-buffer-modified-p nil)))))

  (defvar my-load-user-customized-major-mode-hook t)

  ;;;###autoload
  (defun buffer-too-big-p ()
    "Test if current buffer is too big."
    ;; 5000 lines
    (> (buffer-size) (* 5000 80)))

  ;;;###autoload
  (defun my-file-too-big-p (file)
    "Test if FILE is too big."
    (> (nth 7 (file-attributes file))
       (* 5000 64)))

  (defvar my-force-buffer-file-temp-p nil)
  ;;;###autoload
  (defun my-buffer-file-temp-p ()
    "If no file or a temp file or HTML file converted from org file."
    (interactive)
    (let* ((f (buffer-file-name)) (rlt t))
      (cond
       ((not my-load-user-customized-major-mode-hook)
        (setq rlt t))

       ((and (buffer-name) (string-match "\\* Org SRc" (buffer-name)))
        ;; org-babel edit inline code block need calling hook
        (setq rlt nil))

       ((null f)
        (setq rlt t))

       ((string-match (concat "^" temporary-file-directory) f)
        ;; file is create from temp directory
        (setq rlt t))

       ((and (string-match "\.html$" f)
             (file-exists-p (replace-regexp-in-string "\.html$" ".org" f)))
        ;; file is a html file exported from org-mode
        (setq rlt t))

       (my-force-buffer-file-temp-p
        (setq rlt t))

       (t
        (setq rlt nil)))
      rlt))


  (defvar my-mplayer-extra-opts ""
    "Extra options for mplayer (ao or vo setup).
  For example, you can '(setq my-mplayer-extra-opts \"-fs -ao alsa -vo vdpau\")'.")

  ;;;###autoload
  (defun my-guess-mplayer-path ()
    "Guess cli program mplayer's path."
    (let* ((program "mplayer")
           (common-opts "-fs -quiet"))
      (cond
       (*is-a-mac*
        (cond
         ((executable-find "mplayer")
          (setq program "mplayer"))
         (t
          (setq program "open")))

        (setq program "mplayer"))

       (sys/linuxp
        (setq program "mplayer -stop-xscreensaver"))

       (sys/cygwin
        (if (file-executable-p "/cygdrive/c/mplayer/mplayer.exe")
            (setq program "/cygdrive/c/mplayer/mplayer.exe")
          (setq program "/cygdrive/d/mplayer/mplayer.exe")))

       (sys/win32p
        (cond
         ((file-executable-p "c:/mplayer/mplayer.exe")
          (setq program "c:/mplayer/mplayer.exe"))
         ((file-executable-p "d:/mplayer/mplayer.exe")
          (setq program "d:/mplayer/mplayer.exe"))
         ((file-executable-p "c:/Program Files/mplayer/mplayer.exe")
          (setq program "\"c:/Program Files/mplayer/mplayer.exe\""))
         ((file-executable-p "d:/Program Files/mplayer/mplayer.exe")
          (setq program "\"d:/Program Files/mplayer/mplayer.exe\""))
         ((file-executable-p "c:/mpv/mpv.exe")
          (setq program "c:/mpv/mpv.exe"))
         ((file-executable-p "d:/mpv/mpv.exe")
          (setq program "d:/mpv/mpv.exe"))
         ((file-executable-p "c:/Program Files/mpv/mpv.exe")
          (setq program "\"c:/Program Files/mpv/mpv.exe\""))
         ((file-executable-p "d:/Program Files/mpv/mpv.exe")
          (setq program "\"d:/Program Files/mpv/mpv.exe\""))
         (t
          (error "Can't find media player."))))


       (t
        (error "Can't find any media player!")))

      (unless (string-match "mplayer" program)
        (setq common-opts ""))
      (format "%s %s %s" program common-opts my-mplayer-extra-opts)))

  ;;;###autoload
  (defun my-guess-image-viewer-path (image &optional stream-p)
    "How to open IMAGE which could be STREAM-P."
    (cond
     (sys/macp
      (format "open %s &" image))

     (sys/linuxp
      (if stream-p (format "curl -L %s | feh -F - &" image)
        (format "feh -F %s &" image)))

     (sys/cygwin
      "feh -F")

     (t ; windows
      (format "rundll32.exe %s\\\\System32\\\\\shimgvw.dll, ImageView_Fullscreen %s &"
              (getenv "SystemRoot")
              image))))

  ;;;###autoload
  (defun my-gclip ()
    "Get clipboard content."
    (let (powershell-program)
      (cond
       ;; Windows
       ((and *win64* (fboundp 'w32-get-clipboard-data))
        ;; `w32-set-clipboard-data' makes `w32-get-clipboard-data' always return null
        (w32-get-clipboard-data))

       ;; Windows 10
       ((and sys/win32p (setq powershell-program (executable-find "powershell.exe")))
        (string-trim-right
         (with-output-to-string
           (with-current-buffer standard-output
             (call-process powershell-program nil t nil "-command" "Get-Clipboard")))))

       (sys/cygwinp
        (string-trim-right (shell-command-to-string "cat /dev/clipboard")))

       ;; xclip can handle
       (t
        (xclip-get-selection 'clipboard)))))

  (defvar my-ssh-client-user nil
    "User name of ssh client.")

  ;;;###autoload
  (defun my-send-string-to-cli-stdin (string program)
    "Send STRING to cli PROGRAM's stdin."
    (with-temp-buffer
      (insert string)
      (call-process-region (point-min) (point-max) program)))

  ;;;###autoload
  (defun my-write-string-to-file (string file)
    "Write STRING to FILE."
    (with-temp-buffer
      (insert string)
      (write-region (point-min) (point-max) file)))

  ;;;###autoload
  (defun my-pclip (str-val)
    "Put STR-VAL into clipboard."
    (let* (win64-clip-program
           ssh-client)
      (cond
       ;; Windows 10
       ((and sys/win32p (setq win64-clip-program (executable-find "clip.exe")))
        (my-send-string-to-cli-stdin str-val win64-clip-program))

       ;; Windows
       ((and sys/win32p (fboundp 'w32-set-clipboard-data))
        ;; Don't know why, but on Windows 7 this API does not work.
        (w32-set-clipboard-data str-val))

       ;; Cygwin
       (sys/cygwinp
        (my-write-string-to-file str-val "/dev/clipboard"))

       ;; If Emacs is inside an ssh session, place the clipboard content
       ;; into "~/.tmp-clipboard" and send it back into ssh client
       ;; Make sure you already set up ssh correctly.
       ;; Only enabled if ssh server is macOS
       ((and (setq ssh-client (getenv "SSH_CLIENT"))
             (not (string= ssh-client ""))
             ,*is-a-mac*)
        (let* ((file "~/.tmp-clipboard")
               (ip (car (split-string ssh-client "[ \t]+")))
               (cmd (format "scp %s %s@%s:~/" file my-ssh-client-user ip)))
          (when my-ssh-client-user
            (my-write-to-file str-val file)
            (shell-command cmd)
            ;; clean up
            (delete-file file))))

       ;; xclip can handle
       (t
        (xclip-set-selection 'clipboard str-val)))))
  ;; }}


  ;;;###autoload
  (defun my-should-use-minimum-resource ()
    "Use minimum resource (no highlight or line number)."
    (and buffer-file-name
         (string-match "\.\\(mock\\|min\\|bundle\\)\.js" buffer-file-name)))

  ;;;###autoload
  (defun my-async-shell-command (command)
    "Execute string COMMAND asynchronously."
    (let* ((proc (start-process "Shell"
                                nil
                                shell-file-name
                                shell-command-switch command)))
      (set-process-sentinel proc `(lambda (process signal)
                                    (let* ((status (process-status process)))
                                      (when (memq status '(exit signal))
                                        (unless (string= (substring signal 0 -1) "finished")
                                          (message "Failed to run \"%s\"." ,command))))))))

  ;;;###autoload
  (defun my-org-babel-execute:python-hack (orig-func &rest args)
    ;; @see https://github.com/Liu233w/.spacemacs.d/issues/6
    (let ((coding-system-for-write 'utf-8))
      (apply orig-func args)))

  ;;;###autoload
  (defun my-setup-language-and-encode (language-name coding-system)
    "Set up LANGUAGE-NAME and CODING-SYSTEM at Windows.
  For example,
  - \"English\" and 'utf-16-le
  - \"Chinese-GBK\" and 'gbk"
    (cond
     ((eq system-type 'windows-nt)
      (set-language-environment language-name)
      (prefer-coding-system 'utf-8)
      (set-terminal-coding-system coding-system)

      (modify-coding-system-alist 'process "*" coding-system)

      (advice-add 'org-babel-execute:python :around #'my-org-babel-execute:python-hack))

     (t
      (set-language-environment "UTF-8")
      (prefer-coding-system 'utf-8))))
  ;; }}

  ;;;###autoload
  (defun my-skip-white-space (start step)
    "Skip white spaces from START, return position of first non-space character.
  If STEP is 1,  search in forward direction, or else in backward direction."
    (let* ((b start)
           (e (if (> step 0) (line-end-position) (line-beginning-position))))
      (save-excursion
        (goto-char b)
        (while (and (not (eq b e)) (memq (following-char) '(9 32)))
          (forward-char step))
        (point))))

  ;;;###autoload
  (defun my-comint-current-input-region ()
    "Region of current shell input."
    (cons (process-mark (get-buffer-process (current-buffer)))
          (line-end-position)))
  ;;;###autoload
  (defun my-comint-kill-current-input ()
    "Kill current input in shell."
    (interactive)
    (let* ((region (my-comint-current-input-region)))
      (kill-region (car region) (cdr region))))
  ;;;###autoload
  (defun my-comint-current-input ()
    "Get current input in shell."
    (let* ((region (my-comint-current-input-region)))
      (string-trim (buffer-substring-no-properties (car region) (cdr region)))))

  ;;;###autoload
  (defun my-rescan-imenu-items (&optional index-function)
    "Get imenu items using INDEX-FUNCTION."
    (my-ensure 'imenu)
    (let* ((imenu-auto-rescan t)
           (imenu-create-index-function (or index-function imenu-create-index-function))
           (imenu-auto-rescan-maxout (buffer-size))
           (items (imenu--make-index-alist t)))
      (delete (assoc "*Rescan*" items) items)))

  ;;;###autoload
  (defun my-create-range (&optional inclusive)
    "Return range by font face.
  Copied from 3rd party package evil-textobj."
    (let* ((point-face (my-what-face))
           (pos (point))
           (backward-none-space-point pos) ; last none white space char
           (forward-none-space-point pos) ; last none white space char
           (start pos)
           (end pos))

      ;; check chars backward,
      ;; stop when char is not white space and has different face
      (save-excursion
        (let ((continue t))
          (while (and continue (>= (- (point) 1) (point-min)))
            (backward-char)
            (unless (= 32 (char-after))
              (if (equal point-face (my-what-face))
                  (setq backward-none-space-point (point))
                (setq continue nil))))))

      ;; check chars forward,
      ;; stop when char is not white space and has different face
      (save-excursion
        (let ((continue t))
          (while (and continue (< (+ (point) 1) (point-max)))
            (forward-char)
            (let ((forward-point-face (my-what-face)))
              (unless (= 32 (char-after))
                (if (equal point-face forward-point-face)
                    (setq forward-none-space-point (point))
                  (setq continue nil)))))))

      (cond
       (inclusive
        (setq start backward-none-space-point)
        (setq end forward-none-space-point))
       (t
        (setq start (1+ backward-none-space-point))
        (setq end (1- forward-none-space-point))))

      (cons start (1+ end))))
  ;;;###autoload
  (defun my-get-char (position)
    "Get character at POSITION."
    (save-excursion
      (goto-char position)
      (following-char)))
  ;;;###autoload
  (defun my-extended-regexp (str)
    "Build regex compatible with pinyin from STR."
    (let* ((len (length str))
           bn)
      (cond
       ;; do nothing
       ((<= (length str) 1))

       ;; If the first character of input in ivy is ":" or ";",
       ;; remaining input is converted into Chinese pinyin regex.
       ((or (and (string-match "[:\|;]" (substring str 0 1))
                 (setq str (substring str 1 len)))
            (and (setq bn (buffer-name))
                 (or (member bn '("*Org Agenda*"))
                     (string-match ".*EMMS Playlist\\|\\.org$" bn))))
        (my-ensure 'pinyinlib)
        (setq str (pinyinlib-build-regexp-string str)))

       ;; If the first character of input in ivy is "/",
       ;; remaining input is converted to pattern to search camel case word
       ;; For example, input "/ic" match "isController" or "isCollapsed"
       ((string= (substring str 0 1) "/")
        (let* ((rlt "")
               (i 0)
               (subs (substring str 1 len))
               c)
          (when (> len 2)
            (setq subs (upcase subs))
            (while (< i (length subs))
              (setq c (elt subs i))
              (setq rlt (concat rlt (cond
                                     ((and (< c ?a) (> c ?z) (< c ?A) (> c ?Z))
                                      (format "%c" c))
                                     (t
                                      (concat (if (= i 0) (format "[%c%c]" (+ c 32) c)
                                                (format "%c" c))
                                              "[a-z]+")))))
              (setq i (1+ i))))
          (setq str rlt))))
      str))


  (defvar my-disable-idle-timer (daemonp)
    "Function passed to `my-run-with-idle-timer' is run immediately.")
  (defun my-run-with-idle-timer (seconds func)
    "After SECONDS, run function FUNC once."
    (cond
     (my-disable-idle-timer
      (funcall func))
     (t
      (run-with-idle-timer seconds nil func))))

  ;;;###autoload
  (defun my-imenu-item-position (item)
    "Handle some strange imenu ITEM."
    (if (markerp item) (marker-position item) item))
  ;;;###autoload
  (defun my-closest-imenu-item-internal (cands)
    "Return closest imenu item from CANDS."
    (let* ((pos (point))
           closest)
      (dolist (c cands)
        (let* ((item (cdr c))
               (m (cdr item)))
          (when (and m (<= (my-imenu-item-position m) pos))
            (cond
             ((not closest)
              (setq closest item))
             ((< (- pos (my-imenu-item-position m))
                 (- pos (my-imenu-item-position (cdr closest))))
              (setq closest item))))))
      closest))
  ;;;###autoload
  (defun my-mark-to-position (&optional position)
    "Mark text from point to POSITION or end of of line."
    (set-mark (or position (line-end-position)))
    (activate-mark))
  ;;;###autoload
  (defun my-closest-imenu-item ()
    "Return the closest imenu item."
    (my-ensure 'counsel)
    (my-closest-imenu-item-internal (counsel--imenu-candidates)))
  ;;;###autoload
  (defun my-setup-extra-keymap (extra-fn-list hint fn &rest args)
    "Map EXTRA-FN-LIST to new keymap and show HINT after calling FN with ARGS."
    (let ((echo-keystrokes nil))
      (when fn (apply fn args))
      (message hint)
      (set-transient-map
       (let ((map (make-sparse-keymap))
             cmd)
         (dolist (item extra-fn-list)
           (setq cmd (nth 1 item))
           (setq cmd (cond
                      ((commandp cmd)
                       cmd)
                      (t
                       `(lambda ()
                          (interactive)
                          (if (functionp ,cmd) (funcall ,cmd) ,cmd)))))
           (define-key map (kbd (nth 0 item)) cmd))
         map)
       t)))

  ;; @see http://emacs.stackexchange.com/questions/14129/which-keyboard-shortcut-to-use-for-navigating-out-of-a-string
  ;;;###autoload
  (defun my-font-face-similar-p (f1 f2)
    "Font face F1 and F2 are similar or same."
    ;; (message "f1=%s f2=%s" f1 f2)
    ;; in emacs-lisp-mode, the '^' from "^abde" has list of faces:
    ;;   (font-lock-negation-char-face font-lock-string-face)
    (if (listp f1) (setq f1 (nth 1 f1)))
    (if (listp f2) (setq f2 (nth 1 f2)))

    (or (eq f1 f2)
        ;; C++ comment has different font face for limit and content
        ;; f1 or f2 could be a function object because of rainbow mode
        (and (string-match "-comment-" (format "%s" f1))
             (string-match "-comment-" (format "%s" f2)))))
  ;;;###autoload
  (defun my-font-face-at-point-similar-p (font-face-list)
    "Test if font face at point is similar to any font in FONT-FACE-LIST."
    (let* ((f (get-text-property (point) 'face))
           rlt)
      (dolist (ff font-face-list)
        (if (my-font-face-similar-p f ff) (setq rlt t)))
      rlt))
  ;;;###autoload
  (defun my-pdf-view-goto-page (page)
    "Go to pdf file's specific PAGE."
    (cond
     ((eq major-mode 'pdf-view-mode)
      (pdf-view-goto-page page))
     (t
      (doc-view-goto-page page))))
  ;;;###autoload
  (defun my-focus-on-pdf-window-then-back (fn)
    "Focus on pdf window and call function FN then move focus back."
    (let* ((pdf-window (cl-find-if (lambda (w)
                                     (let ((file (buffer-file-name (window-buffer w))))
                                       (and file (string= (file-name-extension file) "pdf"))))
                                   (my-visible-window-list)))
           (pdf-file (buffer-file-name (window-buffer pdf-window)))
           (original-window (get-buffer-window)))
      (when (and pdf-window pdf-file)
        ;; select pdf-window
        (select-window pdf-window)
        ;; do something
        (funcall fn pdf-file)
        ;; back home
        (select-window original-window))))
  ;;;###autoload
  (defun my-list-windows-in-frame (&optional frame)
    "List windows in FRAME."
    (window-list frame 0 (frame-first-window frame)))
  ;;;###autoload
  (defun my-visible-window-list ()
    "Visible window list."
    (cl-mapcan #'my-list-windows-in-frame (visible-frame-list)))
  ;;;###autoload
  (defun my-lisp-find-file-or-directory (root regexp prefer-directory-p)
    "Find files or directories in ROOT whose names match REGEXP.
  If PREFER-DIRECTORY-P is t, return directory; or else, returns file.
  This function is written in pure Lisp and slow."
    (my-ensure 'find-lisp)
    (find-lisp-find-files-internal
     root
     (lambda (file dir)
       (let* ((directory-p (file-directory-p (expand-file-name file dir)))
              (rlt (and (if prefer-directory-p directory-p (not directory-p))
                        (not (or (string= file ".") (string= file "..")))
                        (string-match regexp file))))
         rlt))
     'find-lisp-default-directory-predicate))


  (defvar my-media-file-extensions
    '("3gp"
      "avi"
      "crdownload"
      "flac"
      "flv"
      "m4v"
      "mid"
      "mkv"
      "mov"
      "mp3"
      "mp4"
      "mpg"
      "ogm"
      "part"
      "rm"
      "rmvb"
      "wav"
      "wmv"
      "webm")
    "File extensions of media files.")

  (defvar my-image-file-extensions
    '("gif"
      "jpg"
      "jpeg"
      "tif"
      "png"
      "svg"
      "xpm")
    "File extensions of image files.")

  ;;;###autoload
  (defun my-file-extensions-to-regexp (extensions)
    "Convert file EXTENSIONS to one regex."
    (concat "\\." (regexp-opt extensions t) "$"))
  ;;;###autoload
  (defun my-binary-file-p (file)
    "Test if it's binary FILE."
    (let* ((other-exts '("pyim" "recentf"))
           (exts (append my-media-file-extensions
                         my-image-file-extensions
                         other-exts))
           (regexp (my-file-extensions-to-regexp exts)))
      (string-match regexp file)))
  ;;;###autoload
  (defun my-strip-path (path strip-count)
    "Strip PATH with STRIP-COUNT."
    (let* ((i (1- (length path)))
           str)
      (while (and (> strip-count 0)
                  (> i 0))
        (when (= (aref path i) ?/)
          (setq strip-count (1- strip-count)))
        (setq i (1- i)))
      (setq str (if (= 0 strip-count) (substring path (1+ i)) path))
      (replace-regexp-in-string "^/" "" str)))
  ;;;###autoload
  (defun my-goto-line (n)
    "Goto line N."
    (goto-char (point-min))
    (forward-line (1- n)))

  (provide '+func)
  ;; =========================================================
  ;; é€šè¿‡ç¼–è¾‘é…ç½®æ–‡ä»¶ä½¿å…¶å¯ä»¥è°ƒç”¨å¤–éƒ¨ç¨‹åºï¼Œæ¥ä¸ºå…¶æ·»åŠ åŠŸèƒ½ã€‚
  ;; å¢žåŠ å‘½ä»¤
  ;;(defun lxr (names)
  ;;  (interactive "sæŸ¥æ‰¾è”ç³»äººï¼Œè¯·è¾“å…¥æ¡ä»¶ï¼š")
  ;;  (call-process-shell-command "lxr" nil t t "-s" names))
  ;;æ‰§è¡Œå‘½ä»¤
  ;;é¦–å…ˆæŒ‰åŠŸèƒ½é”®ï¼ŒAlt+xï¼Œç„¶åŽè¾“å…¥å‘½ä»¤ lxr ã€‚
  ;;ç³»ç»Ÿæç¤ºï¼šâ€œæŸ¥æ‰¾è”ç³»äººï¼Œè¯·è¾“å…¥æ¡ä»¶ï¼š"ã€‚
  ;;è¾“å…¥å®ŒæˆåŽï¼Œemacs ä¼šæ‰§è¡Œå‘½ä»¤lxr -s namesï¼Œå¹¶è¾“å‡ºæ‰§è¡Œçš„ç»“æžœã€‚
  ;; =========================================================
#+end_src
* Geibun Citding: etc/init-basic.el
** Geibun Citding.
#+begin_src  emacs-lisp :tangle etc/init-basic.el
  ;; init-basic.el --- Initialize basic configurations.	-*- lexical-binding: t -*-

  (provide 'init-basic)

  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require '+func)
    (require 'subr-x)
    )

  ;; Speed up startup
  (defvar default-file-name-handler-alist file-name-handler-alist)
  (setq file-name-handler-alist nil)
  (setq inhibit-startup-message nil)
  (setq inhibit-startup-screen t) ; hÃ¨icÃ¨i makying ge kaidung gaimin
  (when (fboundp 'tool-bar-mode) (tool-bar-mode -1)) ; Ä£Ã¡nbÃ¨i gunggÃªi lÃ¡n.
  (when (fboundp 'menu-bar-mode) (menu-bar-mode -1)) ;Ä£Ã¡nbÃ¨i coidÃ¡n lÃ¡n
  (when (fboundp 'scroll-bar-mode) (scroll-bar-mode -1)) ;Ä£Ã¡nbÃ¨i Ä£andung tiu

  ;; Goyan sÃ¶nsik
  (setq user-full-name suk-full-name)
  (setq user-mail-address suk-mail-address)

  (setq-default major-mode 'text-mode
                fill-column 80
                tab-width 4
                c-basic-offset 4
                indent-tabs-mode nil)     ;; Permanently indent with spaces, never with TABs
  (setq read-process-output-max #x10000)  ; 64kb.  Increase how much is read from processes in a single chunk (default is 4kb)
  (setq vc-follow-symlinks t)
  (setq font-lock-maximum-decoration t)
  (setq initial-scratch-message nil)
  (setq adaptive-fill-regexp "[ t]+|[ t]*([0-9]+.|*+)[ t]*")
  (setq adaptive-fill-first-line-regexp "^* *$")
  (setq set-mark-command-repeat-pop t) ; Repeating C-SPC after popping mark pops it again
  (setq sentence-end "\\([ã€‚ï¼ï¼Ÿï¿¥%Ã—ï¼ˆï¼‰â€”]\\|â€¦â€¦\\|[.?!][]\"')}]*\\($\\|[ \t]\\)\\)[ \t\n]*") ;; citding sentence-end sikbit tsungman biudim, bat yungzoi `fill` shi, zoi gÃªihÃ²u hau cÃ¡pyap 2 go hung gÃ¡k.

  (add-hook 'after-change-major-mode-hook (lambda ()(modify-syntax-entry ?_ "w"))) ;; yÃ¶ng `_` bÃ¨i shiwai dÃ¡nci ge zÃ²using bÃ²ufan
  (add-hook 'after-change-major-mode-hook (lambda () (modify-syntax-entry ?- "w"))) ;; `-` fuhÃ²u tungsÃ¶ng
  (setq sentence-end-double-space nil)

  (setq scroll-step 2
        scroll-margin 2
        hscroll-step 2
        hscroll-margin 2
        scroll-conservatively 101
        scroll-up-aggressively 0.01
        scroll-down-aggressively 0.01
        scroll-preserve-screen-position 'always)

  (when sys/win32p
    ;; Key Modifiers
    ;; make PC keyboard's Win key or other to type Super or Hyper
    ;; (setq w32-pass-lwindow-to-system nil)
    (setq w32-lwindow-modifier 'super)    ; Left Windows key
    (setq w32-apps-modifier 'hyper)       ; Menu/App key
    ;; w32-register-hot-key åœ¨ Emacs ä¸­æ˜¯ç”¨æ¥åœ¨Windowsç³»ç»Ÿä¸Šæ³¨å†Œå…¨å±€çƒ­é”®çš„å‡½æ•°ï¼Œ
    ;; ä½†å®ƒå¹¶ä¸ç›´æŽ¥å…³è”åˆ°æ‰§è¡Œ Emacs Lisp å‡½æ•°ã€‚
    ;; è¿™ä¸ªå‡½æ•°æ›´å¤šçš„æ˜¯å‘Šè¯‰Windowsæ“ä½œç³»ç»Ÿï¼Œ
    ;; â€œå½“è¿™ä¸ªæŒ‰é”®ç»„åˆè¢«æŒ‰ä¸‹æ—¶ï¼Œåº”è¯¥é€šçŸ¥Emacsâ€ã€‚
    ;; è¦ä½¿Emacsåœ¨æŒ‰ä¸‹è¿™ä¸ªçƒ­é”®æ—¶æ‰§è¡Œç‰¹å®šçš„Elispå‡½æ•°ï¼Œè¿˜éœ€è¦åœ¨Emacså†…éƒ¨è®¾ç½®ç›¸åº”çš„
    ;; å“åº”æœºåˆ¶ã€‚è¿™é€šå¸¸æ¶‰åŠåˆ°ç¼–å†™ä¸€äº›é¢å¤–çš„Elispä»£ç æ¥ç›‘å¬è¿™ä¸ªçƒ­é”®ï¼Œ
    ;; å¹¶åœ¨å®ƒè¢«æŒ‰ä¸‹æ—¶è§¦å‘ç›¸åº”çš„æ“ä½œã€‚
    ;; å®žé™…ä¸Šï¼Œw32-register-hot-key æ›´å¤šåœ°ç”¨äºŽåœ¨æ“ä½œç³»ç»Ÿçº§åˆ«å¤„ç†ç‰¹å®šçš„æŒ‰é”®ç»„åˆï¼Œ
    ;; è€Œä¸æ˜¯åœ¨Emacsçš„ç¼–è¾‘çŽ¯å¢ƒå†…ã€‚å¦‚æžœæ‚¨æƒ³åœ¨Emacså†…éƒ¨ç»‘å®šçƒ­é”®å¹¶æ‰§è¡Œå‡½æ•°ï¼Œ
    ;; é€šå¸¸ä¼šä½¿ç”¨åƒ global-set-key æˆ– define-key è¿™æ ·çš„å‡½æ•°ã€‚
    (w32-register-hot-key [s-t])

    ;; Optimization
    (setq w32-get-true-file-attributes nil   ; decrease file IO workload
          w32-use-native-image-API t         ; use native w32 API
          w32-pipe-read-delay 0              ; faster IPC
          w32-pipe-buffer-size 65536)        ; read more at a time (64K, was 4K)
    )

  ;; Unix like OS.
  (unless sys/win32p
    ;; æ–°å»ºæ–‡ä»¶ä½¿ç”¨utf-8-unixæ–¹å¼
    (prefer-coding-system 'utf-8-unix)
    (setq system-time-locale "C")
    (set-selection-coding-system 'utf-8))

  (unless sys/macp
    (setq command-line-ns-option-alist nil))

  (unless sys/linuxp
    (setq command-line-x-option-alist nil))

  ;; GUI Environment
  (when (display-graphic-p)
    (progn
      ;; scroll-bar
      (set-scroll-bar-mode 'right)
      ;; éšè—åž‚ç›´æ»šåŠ¨æ¡ã€‚
      (modify-all-frames-parameters '((vertical-scroll-bars)))
      )
    )

#+end_src

** Mangin PinmÃ¡ Citding
#+begin_src emacs-lisp :tangle etc/init-basic.el
  ;;====================================================
  ;; Encoding begin
  ;;====================================================
  ;; Set UTF-8 as the default coding system
  (prefer-coding-system 'utf-8)
  (setq default-buffer-file-coding-system 'utf-8-unix)            ;ç¼“å­˜æ–‡ä»¶ç¼–ç 
  (setq default-file-name-coding-system 'utf-8-unix)              ;æ–‡ä»¶åç¼–ç 
  (setq default-keyboard-coding-system 'utf-8-unix)               ;é”®ç›˜è¾“å…¥ç¼–ç 
  (setq default-process-coding-system '(utf-8-unix . utf-8-unix)) ;è¿›ç¨‹è¾“å‡ºè¾“å…¥ç¼–ç 
  (setq default-sendmail-coding-system 'utf-8-unix)               ;å‘é€é‚®ä»¶ç¼–ç 
  (setq default-terminal-coding-system 'utf-8-unix)               ;ç»ˆç«¯ç¼–ç 


  (set-default-coding-systems 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (setq-default buffer-file-coding-system 'utf-8)

  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)

  (setq buffer-file-coding-system 'utf-8)
  (setq session-save-file-coding-system 'utf-8)

  (set-language-environment "UTF-8")

  ;; é‡è¦æç¤º:å†™åœ¨æœ€åŽä¸€è¡Œçš„ï¼Œå®žé™…ä¸Šæœ€ä¼˜å…ˆä½¿ç”¨; æœ€å‰é¢ä¸€è¡Œï¼Œåè€Œæ”¾åˆ°æœ€åŽæ‰è¯†åˆ«ã€‚
  ;; utf-16le-with-signature ç›¸å½“äºŽ Windows ä¸‹çš„ Unicode ç¼–ç ï¼Œè¿™é‡Œä¹Ÿå¯å†™æˆ
  ;; utf-16 (utf-16 ham:  utf-16le, utf-16be, utf-16le-with-signature dang)
  ;; Unicode
  ;; (prefer-coding-system 'utf-16le-with-signature)
  ;; (prefer-coding-system 'utf-16)
  ;; (prefer-coding-system 'utf-8-dos)
  (prefer-coding-system 'utf-8)

  (when sys/win32p
    (setq w32-unicode-filenames t)        ; kaiyung Unicode mangin ming jichi
    (setq file-name-coding-system 'utf-8) ; citji mangin ming pinmÃ¡ wai UTF-8
    (setq locale-coding-system 'utf-8)    ; citji kÃªiwik pinmÃ¡ wai UTF-8

    ;; gÃ¡mtai
    ;;(prefer-coding-system 'gb2312)
    ;;(prefer-coding-system 'cp936)
    ;;(prefer-coding-system 'gb18030)
    ;;(setq file-name-coding-system 'gb18030)
    ;;(setq locale-coding-system 'gb18030)

    ;; jÃ¬ngtai
    ;; (prefer-coding-system 'cp950)
    ;; (prefer-coding-system 'big5-hkscs)
    ;; (setq file-name-coding-system 'big5-hkscs) ; Hong Kong and Taiwan
    ;; (setq locale-coding-system 'big5-hkscs)

    ;; yatman
    ;; (setq file-name-coding-system 'cp932)
    ;; (setq locale-coding-system 'cp932)

  )
#+end_src
** Misc.
*** Calendar
#+begin_src emacs-lisp :tangle etc/init-basic.el
  (autoload 'calendar "init-calendar" "Config Chinese calendar " t)
#+end_src
*** Describe menu
#+begin_src emacs-lisp :tangle etc/init-basic.el
  (with-eval-after-load 'hydra

    (defhydra my-hydra-describe (:color blue :hint nil)
      "
  Describe Something: (q to quit)
  _a_ all help for everything screen
  _b_ bindings
  _c_ char
  _C_ coding system
  _f_ function
  _i_ input method
  _k_ key briefly
  _K_ key
  _l_ language environment
  _m_ major mode
  _M_ minor mode
  _n_ current coding system briefly
  _N_ current coding system full
  _o_ lighter indicator
  _O_ lighter symbol
  _p_ package
  _P_ text properties
  _s_ symbol
  _t_ theme
  _v_ variable
  _w_ where is something defined
  "
      ("b" describe-bindings)
      ("C" describe-categories)
      ("c" describe-char)
      ("C" describe-coding-system)
      ("f" describe-function)
      ("i" describe-input-method)
      ("K" describe-key)
      ("k" describe-key-briefly)
      ("l" describe-language-environment)
      ("M" describe-minor-mode)
      ("m" describe-mode)
      ("N" describe-current-coding-system)
      ("n" describe-current-coding-system-briefly)
      ("o" describe-minor-mode-from-indicator)
      ("O" describe-minor-mode-from-symbol)
      ("p" describe-package)
      ("P" describe-text-properties)
      ("q" nil)
      ("a" help)
      ("s" describe-symbol)
      ("t" describe-theme)
      ("v" describe-variable)
      ("w" where-is))
    (global-set-key (kbd "C-c C-q") 'my-hydra-describe/body))
#+end_src
* Emacs Package management configurations.
** citding package.el, yÃ¼go congfu ge fongman cukdÃ²u man, hoyi citji gengzÃ¶ng dÃ¨iji.
#+begin_src emacs-lisp :tangle etc/init-package.el
  ;;; init-package.el --- Initialize package configurations.	-*- lexical-binding: t -*-


  (provide 'init-package)

  (eval-when-compile
    (require '+const)
    (require '+func)
    (require '+custom))
  ;; Ö¸¶¨ELPAÄ¿Â¼
  (setq package-user-dir suk-emacs-elpa-dir)
  (add-subdirs-to-load-path package-user-dir t)
      ;; HACK: DO NOT copy package-selected-packages to init/custom file forcibly.
      ;; https://github.com/jwiegley/use-package/issues/383#issuecomment-247801751
      (defun my-save-selected-packages (&optional value)
        "Set `package-selected-packages' to VALUE but don't save to `custom-file'."
        (when value
          (setq package-selected-packages value)))
      (advice-add 'package--save-selected-packages :override #'my-save-selected-packages)


    (require 'package)
    ;; gnuï¼š
    ;; http://elpa.gnu.org/packages/
    ;; https://elpa.emacs-china.org/gnu/ http://1.15.88.122/gnu/
    ;; https://mirrors.163.com/elpa/gnu/
    ;; https://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/
    ;; melpa:
    ;; http://melpa.org/packages/
    ;; https://www.mirrorservice.org/sites/melpa.org/packages/
    ;; https://elpa.emacs-china.org/melpa/ http://1.15.88.122/melpa/
    ;; https://mirrors.163.com/elpa/melpa/
    ;; https://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/

    ;;(setq package-archives '(("melpa" . "http://melpa.org/packages/")
    ;;                         ("gnu" . "http://elpa.gnu.org/packages/")
    ;;                         ("nongnu" . "https://elpa.nongnu.org/nongnu/"))

    (add-to-list 'package-archives
                 '("melpa" . "https://melpa.org/packages/"))
    (add-to-list 'package-archives
                 '("melpa-stable" . "https://stable.melpa.org/packages/"))
    (add-to-list 'package-archives
                 '("org" . "https://orgmode.org/elpa/"))
    (add-to-list 'package-archives
                 '("gnu" . " https://elpa.gnu.org/packages/"))
    (add-to-list 'package-archives
                 '("nongnu" . "https://elpa.nongnu.org/nongnu/"))

    ;; Un-comment below line if you follow "Install stable version in easiest way"
    ;; (setq package-archives '(("myelpa" . "~/myelpa/")))

    ;; my local repository is always needed.
    ;; (push (cons "localelpa" (expand-file-name  "localelpa/" suk-emacs-root-dir)) package-archives)
    ;; (setq package-check-signature nil) ; ä¸ªåˆ«æ—¶å€™ä¼šå‡ºçŽ°ç­¾åæ ¡éªŒå¤±è´¥

    ;; Initialize packages
    ;; (unless (bound-and-true-p package--initialized) ; To avoid warnings in 27
    ;;   (setq package-enable-at-startup nil)          ; To prevent initializing twice
    ;;   (package-initialize))

    (unless (bound-and-true-p package--initialized)
      (package-initialize))

#+end_src
** use-package
*use-package* m hai bÃ¡u gunlÃ¨i gungkÃªi, makying shaiyung emacs noigin ge *package.el*.
*use-package* ling package ge onjÃ¶ng, puiji bindak yaungÃ¡ wo jinggit, gÃ¡nggÃ¡ duklap tungmai fongbin.
#+begin_verse
:init ;; zoi package gÃ¡zoi cin zÃ¡phÃ¡ng
:config ;; zoi package gÃ¡zoi hÃ²u puiji
:bind ;; yitgin bongding
:custom ;; wai zi dingyi binlÃ¶ng wÃ¡k binlÃ¶ng fujik
:hook ;; wai package hooks timgÃ¡ hÃ¡mshÃ²u
:ensure t ;; yÃ¶k mÃ¨i onjong package, zak zidÃ¹ng onjÃ¹ng
:diminish ;; bat zoi mode-line hinshi minor-mode
:demand ;; fÃ¹kgoi bÃ¡u ge yinchi gÃ¡zoi, kÃ¶ngzai lapzÃ¬k gÃ¡zoi
:disabled ;; gamyÃ¹ng mÃ²ufÃ¡i
:map ;; gÃ¹kbÃ²u yitgin bongdÃ¬ng, jiyau package gÃ¡zoi hÃ²u sin shanghÃ¡u
:defer ;; yinchi gÃ¡zoiï¼ˆ:commands,:bind, :bind*, :mode dÃ²u yau yinchi hÃ¡ugo)
:commands ;; conggin zidÃ¹ng gÃ¡zoi, cÃ¡mshÃ²u wai symbol wÃ¡k symbol litbiu
#+end_verse

#+begin_src emacs-lisp :tangle etc/init-package.el
  ;; Setup `use-package'
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package))

  ;; Should set before loading `use-package'
  ;; make use-package default behavior better
  ;; with `use-package-always-ensure' you won't need ":ensure t" all the time
  ;; with `use-package-always-defer' you won't need ":defer t" all the time
  (setq use-package-always-ensure nil
        use-package-always-defer t
        use-package-enable-imenu-support t
        use-package-expand-minimally t)

  (require 'use-package)


 #+end_src
** install packages
#+begin_src emacs-lisp :tangle etc/init-package.el

(make-directory (expand-file-name "var/persistent-scratch" user-emacs-directory) t)
;; Persistent the scratch buffer
(use-package persistent-scratch
  :diminish
  :bind (:map persistent-scratch-mode-map
			  ([remap kill-buffer] . (lambda (&rest _)
									   (interactive)
									   (user-error "Scratch buffer cannot be killed")))
			  ([remap revert-buffer] . persistent-scratch-restore)
			  ([remap revert-this-buffer] . persistent-scratch-restore))
  :hook ((after-init . persistent-scratch-autosave-mode)
         (lisp-interaction-mode . persistent-scratch-mode))
  :init (setq persistent-scratch-backup-file-name-format "%Y-%m-%d"
			  persistent-scratch-backup-directory (expand-file-name "var/persistent-scratch" user-emacs-directory)
              persistent-scratch-save-file (expand-file-name "var/persistent-scratch/.persistent-scratch" user-emacs-directory))
  :config
  (persistent-scratch-setup-default)


  ;; å®šä¹‰åˆ—å‡ºå¤‡ä»½æ–‡ä»¶çš„å‡½æ•°
  (defun list-scratch-backups ()
    "List all available scratch buffer backups."
    (interactive)
    (let ((backup-files (directory-files persistent-scratch-backup-directory nil "^[0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\}$")))
      (if backup-files
          (message "Available backups:\n%s" (string-join backup-files "\n"))
        (message "No backups available."))))

  ;; å®šä¹‰å¸¦è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½çš„åŠ è½½å¤‡ä»½æ–‡ä»¶çš„å‡½æ•°
  (defun load-scratch-backup (date)
    "Load a scratch buffer backup from a specific DATE."
    (interactive
     (list
      (completing-read "Enter the date (YYYY-MM-DD): "
                       (directory-files persistent-scratch-backup-directory nil "^[0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\}$") nil t)))
    (let ((backup-file (expand-file-name date persistent-scratch-backup-directory)))
      (if (file-exists-p backup-file)
          (with-temp-buffer
            (insert-file-contents backup-file)
            (let ((content (buffer-string)))
              (with-current-buffer "*scratch*"
                (erase-buffer)
                (insert content)
                (message "Loaded backup from %s" date))))
        (message "Backup file for date %s does not exist" date))))

  ;; å°†åˆ—å‡ºå¤‡ä»½å’ŒåŠ è½½å¤‡ä»½å‡½æ•°ç»‘å®šåˆ° M-x å‘½ä»¤
  ;;(global-set-key (kbd "C-c l") 'list-scratch-backups)
  ;;(global-set-key (kbd "C-c r") 'load-scratch-backup)

  )


  ;; Misc

  (unless sys/win32p
    (use-package daemons)                 ; system services/daemons
    )

  ;; On-demand installation of packages
  (defun require-package (package &optional min-version no-refresh)
    "Ask elpa to install given PACKAGE with MIN-VERSION.
    If NO-REFRESH is nil, `package-refresh-contents' is called."
    (my-ensure 'package)
    (unless (package-installed-p package min-version)
      (unless (or (assoc package package-archive-contents) no-refresh)
        (message "Missing package: %s" package)
        (package-refresh-contents))
      (package-install package)))

  ;;------------------------------------------------------------------------------
  ;; Fire up package.el and ensure the following packages are installed.
  ;;------------------------------------------------------------------------------

  (require-package 'async)
  (require-package 'amx)
  (require-package 'popup) ; some old package need it
  (require-package 'auto-yasnippet)
  (require-package 'csv-mode)
  ;;(require-package 'expand-region) ; I prefer stable version
  ;;(require-package 'fringe-helper)
  (require-package 'wgrep)
  (require-package 'request)
  ;;(require-package 'lua-mode)
  (require-package 'yaml-mode)
  ;;(require-package 'paredit)
  ;;(require-package 'findr)
  (require-package 'diredfl) ; font lock for `dired-mode'
  (require-package 'pinyinlib)
  (require-package 'find-by-pinyin-dired)
  (require-package 'jump)
  ;;(require-package 'nvm)
  ;;(require-package 'writeroom-mode)
  ;;(require-package 'haml-mode)
  (require-package 'markdown-mode)
  (unless emacs/>=28p
    (require-package 'link)
    (require-package 'connection)
    ;; dictionary requires 'link and 'connection
    (require-package 'dictionary))
  (require-package 'htmlize) ; prefer stable version
  (require-package 'forge)
  (require-package 'doom-modeline)
  (require-package 'orderless)
  (require-package 'pretty-hydra)
  (require-package 'centaur-tabs)
  (require-package 'diminish)
  (require-package 'nerd-icons-completion)
  (require-package 'nerd-icons-dired)
  (require-package 'persistent-scratch)
  (require-package 'treemacs)
  (require-package 'treemacs-projectile)
  (require-package 'treemacs-nerd-icons)
  (require-package 'treemacs-tab-bar)
  (require-package 'treemacs-magit)
  (require-package 'lsp-treemacs)
  (require-package 'diff-hl)

  (require-package 'scratch)
  (require-package 'rainbow-delimiters)
  (require-package 'textile-mode)
  (require-package 'git-timemachine)
  (require-package 'exec-path-from-shell)
  (require-package 'ivy)
  (require-package 'swiper)
  (require-package 'counsel) ; counsel => swiper => ivy
  (require-package 'find-file-in-project)
  (require-package 'counsel-bbdb)
  (require-package 'command-log-mode)
  (require-package 'regex-tool)
  ;;(require-package 'groovy-mode)
  ;;(require-package 'emmet-mode)
  ;;(require-package 'winum)
  ;;(require-package 'session)
  ;;(require-package 'unfill)
  (require-package 'counsel-gtags)
  ;;(require-package 'eww-lnum)
  (require-package 'buffer-move)
  (require-package 'ace-window)
  ;;(require-package 'cmake-mode)
  ;;(require-package 'cpputils-cmake)
  ;;(require-package 'bbdb)
  (require-package 'pomodoro)
  ;; rvm-open-gem to get gem's code
  ;;(require-package 'rvm)
  ;; C-x r l to list bookmarks
  (require-package 'js-doc)
  (require-package 'js2-mode)
  (require-package 'rjsx-mode)
  (require-package 'tagedit)
  (require-package 'cliphist)
  (require-package 'yasnippet)
  ;;(require-package 'yasnippet-snippets)
  (require-package 'company)
  (require-package 'native-complete)
  (require-package 'company-native-complete)
  (require-package 'company-c-headers)
  (require-package 'company-statistics)
  ;;(require-package 'lsp-mode)
  (require-package 'projectile)
  ;;(require-package 'legalese)
  ;;(require-package 'simple-httpd)
  (require-package 'git-gutter) ; use my patched version
  (require-package 'neotree)
  (require-package 'hydra)
  (require-package 'ivy-hydra) ; @see https://oremacs.com/2015/07/23/ivy-multiaction/
  (require-package 'web-mode)
  (require-package 'format-all)
  ;;(require-package 'websocket) ; for debug debugging of browsers
  ;; (require-package 'evil)
  ;; (require-package 'evil-escape)
  ;; (require-package 'evil-exchange)
  ;; (require-package 'evil-find-char-pinyin)
  ;; (require-package 'evil-mark-replace)
  ;; (require-package 'evil-matchit)
  ;; (require-package 'evil-nerd-commenter)
  ;; (require-package 'evil-surround)
  ;; (require-package 'evil-visualstar)
  (require-package 'counsel-css)
  (require-package 'auto-package-update)
  ;;(require-package 'keyfreq)
  ;;(require-package 'adoc-mode) ; asciidoc files
  (require-package 'shackle)
  (require-package 'toc-org)
  ;;(require-package 'elpa-mirror)
  ;; {{ @see https://pawelbx.github.io/emacs-theme-gallery/
  ;;(require-package 'color-theme)
  ;;(require-package 'visual-regexp) ;; Press "M-x vr-*"
  ;;(require-package 'vimrc-mode)
  (require-package 'nov) ; read epub
  (require-package 'hide-mode-line)
  ;; (require-package 'langtool) ; my own patched version is better
  (require-package 'typescript-mode)
  ;; run "M-x pdf-tool-install" at debian and open pdf in GUI Emacs
  (require-package 'pdf-tools)
  ;;(require-package 'pyim)
  ;;(require-package 'pyim-wbdict) ; someone may use wubi IME, not me
  ;;(require-package 'pyim-basedict)
  (require-package 'hungry-delete)
  (require-package 'esup)

  ;; {{ Fixed expiring GNU ELPA keys
  ;; GNU ELPA GPG key will expire on Sep-2019. So we need install this package to
  ;; update key or else users can't install packages from GNU ELPA.
  ;; @see https://www.reddit.com/r/emacs/comments/bn6k1y/updating_gnu_elpa_keys/
  ;; BTW, this setup uses MELPA only. So GNU ELPA GPG key is not used.
  ;; (require-package 'gnu-elpa-keyring-update)
  ;; }}

  ;; org => ppt
  ;;(require-package 'org-re-reveal)

  (require-package 'git-modes)
  (require-package 'ace-pinyin)
  (require-package 'which-key)
  (require-package 'highlight-symbol)
  (require-package 'wc-mode)
  (require-package 'helpful)
  (require-package 'inf-ruby)
  (require-package 'erlang)
  ;;(require-package 'qrencode)
  ;;(require-package 'ws-butler)
  ;;(require-package 'sage-shell-mode)
  ;;(require-package 'graphql-mode)
  ;;(require-package 'ob-sagemath)
  ;;(require-package 'pulseaudio-control)
  (when sys/linuxp
    (require-package 'vterm))

  ;; magit sometime use packages which not released yet
  ;; so we place it at the end to make sure other packages are installed first
  (require-package 'magit)

  ;; edit
  (require-package 'olivetti)
  (require-package 'goto-chg) ; Goto last change
  (require-package 'subword) ;Handling capitalized subwords in a nomenclature
  (require-package 'anzu)
  (require-package 'avy)
  (require-package 'avy-zap)
  (require-package 'sudo-edit)
  (require-package 'flyspell)
  (require-package 'beginend)
  (require-package 'autorevert)

  (unless emacs/>=28p
    (require-package 'undo-tree))

  ;; {{ trivial packages which has extra dependency
  ;;(require-package 'emms)
  ;; }}

  ;; kill buffer without my confirmation
  (setq kill-buffer-query-functions (delq 'process-kill-buffer-query-function kill-buffer-query-functions))


#+end_src
* FÃ¡izit Gin: etc/init-key.el
** Yilai Lazy-load
#+begin_src emacs-lisp :tangle etc/init-key.el
  ;; -*- lexical-binding: t -*-

  (provide 'init-key)
  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require 'lazy-load))

  ;;; å…¨å±€ lazy-load-global-keys
  ;;; æ¨¡å¼ lazy-load-local-keys
  ;;; æ”¯æŒæœ€åŽä¸€ä¸ªå‚æ•°ä¼ é€’å‰ç¼€æŒ‰é”®ï¼Œ
  ;;;
  ;;; å¦‚æžœEmacsé»˜è®¤å°±åŠ è½½äº†æŸä¸ªæ’ä»¶ï¼Œè€Œä¸éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ï¼Œä¹Ÿå¯
  ;;; ä»¥ä½¿ç”¨ lazy-load-set-keys
  ;;;
  ;;; å¾ˆå¤šå…¨å±€æŒ‰é”®é»˜è®¤å·²ç»è¢« Emacså ç”¨äº†ï¼Œå¿…é¡»å…ˆå¸è½½ä»¥åŽæ‰èƒ½é‡æ–°ç»‘
  ;;; å®šè¿™äº›å…¨å±€æŒ‰é”®ï¼Œæ¯”å¦‚ Ctrl + x, ä¸‹é¢è¿™æ®µä»£ç å°±æ˜¯ç”¨
  ;;; lazy-load-unset-keys å¸è½½é»˜è®¤ç»‘å®šçš„å…¨å±€æŒ‰é”®

  ;; Macå¹³å°ä¸‹äº¤æ¢ Option å’Œ Command é”®ã€‚
  ;;(when (featurep 'cocoa)
  ;;  (setq mac-option-modifier 'super)
  ;;  (setq mac-command-modifier 'meta))
  ;;
#+end_src
** Unset Key
#+begin_src emacs-lisp :tangle etc/init-key.el
 ;;; ### Unset key ###
  ;;; --- å¸è½½æŒ‰é”®
  (lazy-load-unset-keys                   ;å…¨å±€æŒ‰é”®çš„å¸è½½
   ;; '("C-z"  "s-W" "s-z" "M-h" "C-\\" "s-c" "s-x" "s-v"))
   '("C-z" ))

#+end_src
** Sudo
#+begin_src emacs-lisp :tangle etc/init-key.el
  ;;; ### sudo ###
  (when sys/linuxp
    (progn
      (lazy-load-global-keys
       '(("C-z C-s" . suk/sudo-actions-one-key))
       "init-sudo"
       )
      )
    )
#+end_src
** Singsai Yikwong Mingling Hong
#+begin_src emacs-lisp :tangle etc/init-key.el
  ;;; ### Sdcv ###
  ;;; --- æ˜Ÿé™…è¯‘çŽ‹å‘½ä»¤è¡Œ
  (when  (eq system-type 'gnu/linux)
  (lazy-load-global-keys
   '(("p" . sdcv-search-pointer)		   ;å…‰æ ‡å¤„çš„å•è¯, bufferæ˜¾ç¤º
     ("P" . sdcv-search-pointer+)		   ;å…‰æ ‡å¤„çš„å•è¯, tooltipæ˜¾ç¤º
     ("i" . sdcv-search-input)		   ;è¾“å…¥çš„å•è¯, bufferæ˜¾ç¤º
     (";" . sdcv-search-input+)
     ("y" . my-youdao-dictionary-search-at-point)
     ("Y" . youdao-dictionary-search-at-point)
     ("g" . google-translate-at-point)
     ("G" . google-translate-query-translate)
     ("s" . google-translate-smooth-translate)
     ("f" . fanyi-dwim)
     ("d" . fanyi-dwim2)
     ("h" . fanyi-from-history)
     )
   "init-translate"
   "C-z"))

#+end_src

** Zungman Mingzi FÃ¡nyik Shing Gokzung FunggÃ¡k Ge BinlÃ¶ng Ming.
#+begin_src emacs-lisp :tangle etc/init-key.el
  ;;; ### Insert translated name ###
  ;; youdao / google
  (setq insert-translated-name-translate-engine "google")
  (lazy-load-global-keys
   '(
     ("," . insert-translated-name-insert-with-underline)
     ("." . insert-translated-name-insert-with-camel)
     ("/" . insert-translated-name-insert)
     )
   "insert-translated-name"
   "C-z"
   )

#+end_src
** GungkÃªi HÃ¡mshÃ²u
#+begin_src emacs-lisp :tangle etc/init-key.el
    ;;; ### Toolkit ###
    ;;; --- å·¥å…·å‡½æ•°
  (lazy-load-set-keys
   '(
     ("C-," . bury-buffer)                ;éšè—å½“å‰buffer
     ("C-." . unbury-buffer)              ;åéšè—å½“å‰buffer
     ("s-[" . eval-expression)            ;æ‰§è¡Œè¡¨è¾¾å¼
     ("s-1" . sort-lines)                 ;æŽ’åº
     ("s-2" . hanconvert-region)          ;è½¬æ¢ç®€ä½“æˆ–ç¹ä½“ä¸­æ–‡
     ("s-3" . uniquify-all-lines-buffer)  ;åˆ é™¤é‡å¤çš„è¡Œ
     ("s-<f12>" . calendar)
     ("C-<f12>" . lazycat-theme-toggle)
     ;;([c-t] . transpose-chars)
     ([S-f6] . hs-minor-mode)
     ([S-f5] . toggle-truncate-lines)
     ("C-x M-a" . align-regexp)
     ("C-c ." . hs-toggle-hiding)
     ("C-c ," . hs-show-all)
     )
   )
     ;;; ### basic-toolkit ###
  (lazy-load-global-keys
   '(
     ("M-s-n" . comment-part-move-down)   ;å‘ä¸‹ç§»åŠ¨æ³¨é‡Š
     ("M-s-p" . comment-part-move-up)     ;å‘ä¸Šç§»åŠ¨æ³¨é‡Š
     ("C-s-n" . comment-dwim-next-line)   ;ç§»åŠ¨åˆ°ä¸Šä¸€è¡Œå¹¶æ³¨é‡Š
     ("C-s-p" . comment-dwim-prev-line)   ;ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œå¹¶æ³¨é‡Š
     ("M-2" . indent-buffer)              ;è‡ªåŠ¨æ ¼å¼åŒ–å½“å‰Buffer
     ("M-z" . upcase-char)                ;Upcase char handly with capitalize-word
     ;;("C-x u" . mark-line)              ;é€‰ä¸­æ•´è¡Œ
     ("s-k" . kill-and-join-forward)      ;åœ¨ç¼©è¿›çš„è¡Œä¹‹é—´åˆ é™¤
     ("M-G" . goto-column)                ;åˆ°æŒ‡å®šåˆ—
     ("C->" . remember-init)              ;è®°å¿†åˆå§‹å‡½æ•°
     ("C-<" . remember-jump)              ;è®°å¿†è·³è½¬å‡½æ•°
     ("M-s-," . point-stack-pop)          ;bufferç´¢å¼•è·³è½¬
     ("M-s-." . point-stack-push)         ;bufferç´¢å¼•æ ‡è®°
     ("s-g" . goto-percent) ;è·³è½¬åˆ°å½“å‰Bufferçš„æ–‡æœ¬ç™¾åˆ†æ¯”, å•ä½ä¸ºå­—ç¬¦
     ("M-I" . backward-indent)            ;å‘åŽç§»åŠ¨4ä¸ªå­—ç¬¦
                                          ;   ("s-J" . scroll-up-one-line)         ;å‘ä¸Šæ»šåŠ¨ä¸€è¡Œ
                                          ;   ("s-K" . scroll-down-one-line)       ;å‘ä¸‹æ»šåŠ¨ä¸€è¡Œ
     ("<f2>" . refresh-file)              ;è‡ªåŠ¨åˆ·æ–°æ–‡ä»¶
     ("s-f" . find-file-root)             ;ç”¨rootæ‰“å¼€æ–‡ä»¶
     ("s-r" . find-file-smb)              ;è®¿é—®sambao
     ("C-J" . joint-lines)                ;è¿žæŽ¥è¡Œ
     )
   "basic-toolkit")

      ;;; ### goto-line-preview ###
  (lazy-load-global-keys
   '(
     ("M-g p" . goto-line-preview))
   "goto-line-preview")

      ;;; ### Delete block ###
      ;;; --- å¿«é€Ÿåˆ é™¤å…‰æ ‡å·¦å³çš„å†…å®¹
  (lazy-load-global-keys
   '(
     ("M-," . delete-block-backward)
     ("M-." . delete-block-forward))
   "delete-block")


      ;;; ### watch other window ###
      ;;; --- æ»šåŠ¨å…¶ä»–çª—å£
  (lazy-load-global-keys
   '(
     ("C-P" . other-window-move-up)       ;å‘ä¸‹æ»šåŠ¨å…¶ä»–çª—å£
     ("C-N" . other-window-move-down) ;å‘ä¸Šæ»šåŠ¨å…¶ä»–çª—å£
     ("M-p" . window-move-up)         ;å‘ä¸‹æ»šåŠ¨å½“å‰çª—å£
     ("M-n" . window-move-down)           ;å‘ä¸Šæ»šåŠ¨å½“å‰çª—å£
     )
   "win-move")

  ;; ### move text ###
  (lazy-load-global-keys
   '(
     ("M-N" . move-text-down) ;æŠŠå…‰æ ‡æ‰€åœ¨çš„æ•´è¡Œæ–‡å­—(æˆ–æ ‡è®°)ä¸‹ç§»ä¸€è¡Œ
     ("M-P" . move-text-up)   ;æŠŠå…‰æ ‡æ‰€åœ¨çš„æ•´è¡Œæ–‡å­—(æˆ–æ ‡è®°)ä¸Šç§»ä¸€è¡Œ
     ("M-<DOWN>" . move-text-down)	;æŠŠå…‰æ ‡æ‰€åœ¨çš„æ•´è¡Œæ–‡å­—(æˆ–æ ‡è®°)ä¸‹ç§»ä¸€è¡Œ
     ("M-<UP>"   . move-text-up)	;æŠŠå…‰æ ‡æ‰€åœ¨çš„æ•´è¡Œæ–‡å­—(æˆ–æ ‡è®°)ä¸Šç§»ä¸€è¡Œ
     )
   "move-text")

  ;; ### duplicate-line ###
  (lazy-load-global-keys
   '(
     ("C-S-o" . duplicate-line-or-region-above) ;å‘ä¸Šå¤åˆ¶å½“å‰è¡Œæˆ–åŒºåŸŸ
     ("C-S-l" . duplicate-line-or-region-below) ;å‘ä¸‹å¤åˆ¶å½“å‰è¡Œæˆ–åŒºåŸŸ
     ("C-S-s-o" . duplicate-line-above-comment) ;å¤åˆ¶å½“å‰è¡Œåˆ°ä¸Šä¸€è¡Œ, å¹¶æ³¨é‡Šå½“å‰è¡Œ
     ("C-S-s-l" . duplicate-line-below-comment) ;å¤åˆ¶å½“å‰è¡Œåˆ°ä¸‹ä¸€è¡Œ, å¹¶æ³¨é‡Šå½“å‰è¡Œ
     ("C-:" . comment-or-uncomment-region+)     ;æ³¨é‡Šå½“å‰è¡Œ
     )
   "duplicate-line")

  ;;; ### open new line ###
  (lazy-load-global-keys
   '(
     ("C-o" . open-newline-above)         ;åœ¨ä¸Šé¢ä¸€è¡Œæ–°å»ºä¸€è¡Œ
     ("C-l" . open-newline-below)         ;åœ¨ä¸‹é¢ä¸€è¡Œæ–°å»ºä¸€è¡Œ
     )
   "open-newline")


  ;; ### Rect ###
  ;; --- çŸ©å½¢æ“ä½œ
  (lazy-load-global-keys
   '(
     ("s-M" . rm-set-mark)                ;çŸ©å½¢æ ‡è®°
     ("s-X" . rm-exchange-point-and-mark) ;çŸ©å½¢å¯¹è§’äº¤æ¢
     ("s-D" . rm-kill-region)             ;çŸ©å½¢åˆ é™¤
     ("s-S" . rm-kill-ring-save)          ;çŸ©å½¢ä¿å­˜
     ("s-Y" . yank-rectangle)             ;ç²˜å¸–çŸ©å½¢
     ("s-O" . open-rectangle)       ;ç”¨ç©ºç™½å¡«å……çŸ©å½¢, å¹¶å‘å³ç§»åŠ¨æ–‡æœ¬
     ("s-C" . clear-rectangle)      ;æ¸…ç©ºçŸ©å½¢
     ("s-T" . string-rectangle)     ;ç”¨å­—ç¬¦ä¸²æ›¿ä»£çŸ©å½¢çš„æ¯ä¸€è¡Œ
     ("s-I" . string-insert-rectangle)    ;æ’å…¥å­—ç¬¦ä¸²åœ¨çŸ©å½¢çš„æ¯ä¸€è¡Œ
     ("s-F" . delete-whitespace-rectangle) ;åˆ é™¤çŸ©å½¢ä¸­ç©ºæ ¼
     ("s-\"" . copy-rectangle-to-register) ;æ‹·è´çŸ©å½¢åˆ°å¯„å­˜å™¨
     ("s-:" . mark-rectangle-to-end)       ;æ ‡è®°çŸ©å½¢åˆ°è¡Œæœ«
     )
   "rect-extension")

  ;; ### Buffer Move ###
  ;; --- ç¼“å­˜ç§»åŠ¨
  (lazy-load-set-keys
   '(
     ;;("C-z i" . beginning-of-buffer)      ;ç¼“å­˜å¼€å§‹ M-<
     ;;("C-z k" . end-of-buffer)            ;ç¼“å­˜ç»“å°¾ M->
     ("C-M-f" . forward-paragraph)        ;ä¸‹ä¸€ä¸ªæ®µè½
     ("C-M-b" . backward-paragraph)       ;ä¸Šä¸€ä¸ªæ®µè½
     ("C-M-y" . backward-up-list)         ;å‘å·¦è·³å‡º LIST
     ("C-M-o" . up-list)                  ;å‘å³è·³å‡º LIST
     ("C-M-u" . backward-down-list)       ;å‘å·¦è·³è¿› LIST
     ("C-M-i" . down-list)                ;å‘å³è·³è¿› LIST
     ("C-M-a" . beginning-of-defun)       ;å‡½æ•°å¼€å¤´
     ("C-M-e" . end-of-defun)             ;å‡½æ•°æœ«å°¾
     ))

  ;; ### Buffer Edit ###
  ;; --- ç¼“å­˜ç¼–è¾‘
  (lazy-load-set-keys
   '(
     ("C-x C-x" . exchange-point-and-mark)   ;äº¤æ¢å½“å‰ç‚¹å’Œæ ‡è®°ç‚¹
     ("M-o" . backward-delete-char-untabify) ;å‘å‰åˆ é™¤å­—ç¬¦
     ("C-M-S-h" . mark-paragraph)            ;é€‰ä¸­æ®µè½
     ("M-SPC" . just-one-space)              ;åªæœ‰ä¸€ä¸ªç©ºæ ¼åœ¨å…‰æ ‡å¤„
     ))

  ;; ### Font ###
  ;; --- å­—ä½“å‘½ä»¤
  (lazy-load-set-keys
   '(
     ("C--" . text-scale-decrease)        ;å‡å°å­—ä½“å¤§å°
     ("C-=" . text-scale-increase)        ;å¢žåŠ å­—ä½“å¤§å°
     ))


  ;; ### Window Operation ###
  ;; --- çª—å£æ“ä½œ
  (lazy-load-set-keys
   '(
     ("C-c :" . split-window-vertically)   ;çºµå‘åˆ†å‰²çª—å£
     ("C-c |" . split-window-horizontally) ;æ¨ªå‘åˆ†å‰²çª—å£
     ("C-;" . kill-this-buffer)            ;å…³é—­å½“å‰buffer
     ("C-x ;" . delete-other-windows)      ;å…³é—­å…¶å®ƒçª—å£
     ))
  (lazy-load-global-keys
   '(
     ("C-c V" . delete-other-windows-vertically+) ;å…³é—­ä¸Šä¸‹çš„å…¶ä»–çª—å£
     ("C-c H" . delete-other-windows-horizontally+) ;å…³é—­å·¦å³çš„å…¶ä»–çª—å£
     ("C-'" . delete-current-buffer-and-window) ;å…³é—­å½“å‰buffer, å¹¶å…³é—­çª—å£
     ("C-\"" . delete-current-buffer-window) ;åˆ é™¤å½“å‰bufferçš„çª—å£
     ("M-s-o" . toggle-one-window)           ;åˆ‡æ¢ä¸€ä¸ªçª—å£
     ("C-x O" . toggle-window-split)
     )
   "window-extension")

  (lazy-load-global-keys
   '(
     ("C-c C-m" . rg-menu)
     ("C-c C-/" . webjump)
     ("C-c g" . github-code-search)
     ("C-c G" . google-search)
     )
   "init-search")

    ;;; ### Functin key ###
    ;;; --- åŠŸèƒ½å‡½æ•°
  (lazy-load-set-keys
   '(
     ("<f9>" . emacs-session-save )
     ("C-4" . insert-changelog-date)      ;æ’å…¥æ—¥å¿—æ—¶é—´ (%Y/%m/%d)
     ("C-&" . switch-to-messages)         ;è·³è½¬åˆ° *Messages* buffer
     ))

    ;;; ### Awesome-Pair ###
    ;;; --- ç»“æž„åŒ–ç¼–ç¨‹

    ;;; ### Thingh-edit ###
    ;;; --- å¢žå¼ºå¼ç¼–è¾‘å½“å‰å…‰æ ‡çš„å¯¹è±¡
  (lazy-load-global-keys
   '(
     ("C-c w" . thing-copy-word)
     ("C-c s" . thing-copy-symbol)
     ("C-c m" . thing-copy-email)
     ("C-c f" . thing-copy-filename)
     ("C-c u" . thing-copy-url)
     ("C-c x" . thing-copy-sexp)
     ("C-c g" . thing-copy-page)
     ("C-c t" . thing-copy-sentence)
     ("C-c o" . thing-copy-witespace)
     ("C-c i" . thing-copy-list)
     ("C-c c" . thing-copy-comment)
     ("C-c h" . thing-copy-defun)
     ("C-c p" . thing-copy-parentheses)
     ("C-c l" . thing-copy-line)
     ("C-c a" . thing-copy-to-line-begining)
     ("C-c e" . thing-copy-to-line-end)
     ("C-c W" . thing-cut-word)
     ("C-c S" . thing-cut-symbol)
     ("C-c M" . thing-cut-email)
     ("C-c F" . thing-cut-filename)
     ("C-c G" . thing-cut-page)
     ("C-c T" . thing-cut-sentence)
     ("C-c O" . thing-cut-whitespace)
     ("C-c I" . thing-cut-list)
     ("C-c C" . thing-cut-comment)
     ("C-c H" . thing-cut-defun)
     ("C-c P" . thing-cut-parentheses)
     ("C-c L" . thing-cut-line)
     ("C-c A" . thing-cut-to-line-beginning)
     ("C-c E" . thing-cut-to-line-end)
     )
   "thing-edit"
   "C-z"
   )

    ;;; ### Isearch ###
    ;;; --- äº¤äº’å¼æœç´¢
  (lazy-load-set-keys
   '(
     ("TAB" . isearch-complete)               ;isearchè¡¥å…¨
     ("C-s" . isearch-repeat-forward)         ;é‡å¤å‘å‰æœç´¢, ç¬¬ä¸€æ¬¡å¯ä»¥ç”¨æ¥æœç´¢ä¸Šä¸€æ¬¡çš„åŽ†å²å“Ÿ
     ("C-r" . isearch-repeat-backward)        ;é‡å¤å‘åŽæœç´¢
     ("C-g" . isearch-abort)                  ;ä¸­æ­¢æœç´¢
     ("C-w" . isearch-yank-word-or-char)      ;ç²˜å¸–å…‰æ ‡åŽçš„è¯æˆ–å­—ç¬¦ä½œä¸ºæœç´¢å¯¹è±¡
     ("C-y" . isearch-yank-line)              ;ç²˜å¸–å…‰æ ‡åŽçš„è¡Œä½œä¸ºæœç´¢å¯¹è±¡
     ("M-o" . isearch-delete-char)            ;åˆ é™¤
     ("M-p" . isearch-ring-retreat)           ;æœç´¢åŽ†å²å‘åŽ
     ("M-n" . isearch-ring-adjust)            ;æœç´¢åŽ†å²å‘å‰
     ("M-y" . isearch-yank-kill)              ;ä»Ž kill ring ä¸­ç²˜å¸–æœ€åŽä¸€é¡¹åˆ°æœç´¢å¯¹è±¡åŽ
     ("M-h" . isearch-yank-char)              ;ç²˜å¸–å…‰æ ‡åŽçš„å­—ç¬¦åˆ°æœç´¢å¯¹è±¡
     ("M-e" . isearch-edit-string)            ;ç¼–è¾‘æœç´¢å¯¹è±¡
     ("M-c" . isearch-toggle-case-fold)       ;åˆ‡æ¢å¤§å°å†™
     ("M-r" . isearch-toggle-regexp)          ;åˆ‡æ¢æ­£åˆ™è¡¨è¾¾å¼
     ("M-w" . isearch-toggle-word)            ;åˆ‡æ¢è¯
     ("M->" . isearch-beginning-of-buffer)    ;è·³è½¬åˆ°bufferå¼€å¤´å¹¶é‡æ–°æœç´¢, æœç´¢æœ€å‰é¢ä¸€ä¸ª
     ("M-<" . isearch-end-of-buffer)          ;è·³è½¬åˆ°bufferæœ«å°¾å¹¶é‡æ–°æœç´¢, æœç´¢æœ€åŽé¢ä¸€ä¸ª
     ("M-%" . isearch-query-replace)          ;æ›¿æ¢
     ("M-d" . isearch-find-duplicate-word)    ;æŸ¥æ‰¾é‡å¤çš„å•è¯
     ("M-z" . isearch-find-duplicate-line)    ;æŸ¥æ‰¾é‡å¤çš„è¡Œ
     ("C-M-%" . isearch-query-replace-regexp) ;æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢
     )
   isearch-mode-map
   )


    ;;; ### expand-region ###
  (lazy-load-global-keys
   '(
     ("C-+" . er/expand-region))
   "expand-region")

  ;; ### vdiff ###
  (lazy-load-global-keys
   '(
     ("M-s-u" . vdiff-buffers))
   "vdiff")

    ;;; ### Ace jump ###
  (lazy-load-global-keys
   '(
     ("C-c w" . ace-jump-word-mode)
     ("C-c c" . ace-jump-char-mode)
     ("C-c l" . ace-jump-line-mode)
     )
   "ace-jump-mode"
   "C-z"
   )


    ;;; ### Company en words ###
    ;;; --- è‹±æ–‡åŠ©æ‰‹
  (lazy-load-global-keys
   '(
     ("M-r" . toggle-company-english-helper) ;è‹±æ–‡åŠ©æ‰‹
     )
   "company-english-helper")



  (lazy-load-set-keys
   '(
     ("C-z S g" . suk/google-search)
     ("C-z S c" .  suk/github-code-search)
     )
   )

  ;;; --- ç¬”è®°ç®¡ç†å’Œç»„ç»‡
  ;; (define-prefix-command 'F9-map)
  ;; (global-set-key (kbd "<f9>") 'F9-map)
  ;; (lazy-load-global-keys
  ;;  '(("a" . org-agenda)
  ;;    ("A" . org-attach)
  ;;    ("s" . show-org-agenda)
  ;;    ("c" . org-capture)
  ;;    ("i" . org-toggle-inline-images)
  ;;    ("l" . org-toggle-link-display)
  ;;    ("d" . calendar)
  ;;    ("f" . boxquote-insert-file)
  ;;    ("r" . boxquote-region)
  ;;    ("v" . visible-mode))
  ;;  "init-org"
  ;;  "<f9>")

  ;;; Dash.
  ;;(lazy-load-global-keys
  ;; '(("y" . dash-at-point)
  ;;   )
  ;; "dash-at-point"
  ;; "C-x"
  ;; )

  ;; ### String Inflection ###
  ;; --- å•è¯è¯­æ³•é£Žæ ¼å¿«é€Ÿè½¬æ¢
  (lazy-load-global-keys
   '(
     ("C-c C-u" . one-key-string-inflection)
     )
   "init-string-inflection")

    ;;; ### Keyboard Macro ###
    ;;; --- é”®ç›˜å®
  (lazy-load-global-keys
   '(
     ("M-s-s" . kmacro-start-macro-or-insert-counter) ;å¼€å§‹é”®ç›˜å®æˆ–æ’å…¥ F3
     ("M-s-d" . kmacro-end-or-call-macro)    ;ç»“æŸé”®ç›˜å®æˆ–è°ƒç”¨ F4
     ("M-s-c" . kmacro-delete-ring-head)     ;åˆ é™¤å½“å‰çš„é”®ç›˜å®
     ("M-s-w" . kmacro-cycle-ring-next)      ;ä¸‹ä¸€ä¸ªé”®ç›˜å®
     ("M-s-e" . kmacro-cycle-ring-previous)  ;ä¸Šä¸€ä¸ªé”®ç›˜å®
     ("M-s-a" . kmacro-edit-macro)           ;ç¼–è¾‘é”®ç›˜å®
     ("M-s-v" . name-last-kbd-macro)         ;å‘½ä»¤å½“å‰é”®ç›˜å®
     ("M-s-f" . insert-kbd-macro)            ;æ’å…¥é”®ç›˜å®
     ("M-s-q" . apply-macro-to-region-lines) ;åº”ç”¨é”®ç›˜å®åˆ°é€‰æ‹©çš„åŒºåŸŸ
     )
   "macros+")

  ;;(global-set-key  [C-f7] 'suk/ska-point-to-register)
  ;;(global-set-key  [f7] 'suk/ska-jump-to-register)
  (lazy-load-global-keys
   '(
     ("C-<f7>" . suk/ska-point-to-register)
     ("<f7>"   . suk/ska-jump-to-register )
     )
   "init-bookmark")



  ;; kÃ¨itÃ¡ bongding
  ;; f3 start macro(kmacro-start-macro-or-insert-counter),
  ;; f4 done macro or run marcro (kmacro-end-or-call-macro).
  ;; C-x ( start macro (kmacro-start-macro),
  ;; C-x ) end done marco,
  ;; C-x e run marco(kmacro-end-macro)
  ;; å…ˆå®šä¹‰ä¸€ä¸ªå®
  ;; ç„¶åŽ name-last-kbd-macro
  ;; ç„¶åŽ insert-kbd-macro
  ;; ç­‰åˆ°å¦‚ä¸‹ç±»ä¼¼çš„é…ç½®
  ;; (fset 'delete-empty-lines (kbd "M-x flush-lines RET ^\s-*$ RET"))
  ;;




  ;; global-set-key examples:
  ;; (global-set-key (kbd "C-x C-\\") 'next-line)
  ;; (global-set-key [?\C-x ?\C-\\] 'next-line)
  ;; (global-set-key [(control ?x) (control ?\\)] 'next-line)

  ;;(global-set-key (kbd "C-(") 'backward-sexp)
  ;;(global-set-key (kbd "C-)") 'forward-sexp)

  ;;(global-set-key (kbd "C-x t T") 'suk/toggle-transparency)
  ;;(global-set-key (kbd "C-x t p") 'suk/toggle-toggle-proxy)
  ;;(global-set-key (kbd "C-x t f") 'global-flycheck-mode)
  ;;(global-set-key (kbd "C-x R") 'recentf)
  ;; M-x global-set-key RET äº¤äº’å¼çš„ç»‘å®šä½ çš„é”®ã€‚
  ;; C-x Esc Esc è°ƒå‡ºä¸Šä¸€æ¡â€œå¤æ‚å‘½ä»¤â€
  ;; ä½¿ç”¨æ–¹å¼
  ;; (suk-set-key-bindings 'global-set-key
  ;;   (list
  ;;      '([f2]              calendar)
  ;;      '([(shift f2)]      remember)
  ;;      '([f5]              revert-buffer)
  ;;      (list (kbd "C-c l") 'copy-line)))



  ;; è®¾ç½®ç»‘å®š
  (defun suk-set-key-bindings (ACTION BINDINGLIST)
    "Map keys.
    ACTION usually is 'global-set-key', and BINDINGLIST is key and command LIST."

    (mapcar (lambda(lst)
              ""
              (let ((x (car lst))
                    (y (car (last lst))))
                (funcall ACTION x y))) BINDINGLIST ))


  (suk-set-key-bindings 'global-set-key
                        (list
                         (list (kbd "C-x M-a") 'align-regexp)
                         ;;                      '([C-t]               transpose-chars)
                         ;;                      '([S-f6]              hs-minor-mode)
                         ;;                      '([S-f5]              toggle-truncate-lines)
                         ;; '([S-f11]          insert-translated-name-insert) ;; Chinese to English
                         ;; '([S-f12]          toggle-company-english-helper) ;; popup English tips

                         ;; '([S-f2]           suk/new-empty-buffer)
                         ;; '([f2]                hs-toggle-hiding)
                         ;;'([M-f12]             vterm)
                         ;; '([S-f1]              snails)
                         (list (kbd "C-(") 'backward-sexp)
                         (list (kbd "C-)") 'forward-sexp)
                         (list (kbd "C-x t T") 'suk/toggle-transparency)
                         (list (kbd "C-x t p") 'suk/toggle-toggle-proxy)
                         (list (kbd "C-x t f") 'global-flycheck-mode)
                         (list (kbd "C-x R") 'recentf-open)
                         (list (kbd "C-<f11>")  'toggle-frame-fullscreen)
                         ;; (list (kbd "C-S-f")  'toggle-frame-fullscreen) ; Compatible with macOS
                         (list (kbd "M-S-<return>")  'toggle-frame-fullscreen)
                         ;; åˆ›å»ºæ–°è¡Œçš„åŠ¨ä½œ
                         (list (kbd "RET") 'newline-and-indent) ;; å›žè½¦æ—¶åˆ›å»ºæ–°è¡Œå¹¶ä¸”å¯¹é½
                         (list (kbd "S-<return>") 'comment-indent-new-line) ;; å–æ¶ˆå¯¹é½åˆ›å»ºçš„æ–°è¡Œ

                         ))



  ;; bind-keys æ˜¯ç”± use-package å®æä¾›çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸åœ¨ä¸€ä¸ªå£°æ˜Žä¸­ç»‘å®šå¤šä¸ªé”®ã€‚è™½ç„¶
  ;; bind-keys å¯ä»¥ç‹¬ç«‹äºŽ use-package ä½¿ç”¨ï¼Œä½†å®ƒé€šå¸¸ä¸Ž use-package ç»“åˆä½¿ç”¨ï¼Œä»¥æ
  ;; ä¾›æ›´æ¸…æ™°å’Œæ¨¡å—åŒ–çš„é”®ç»‘å®šé…ç½®ã€‚
  ;; (use-package bind-key)
  ;; (bind-key "C-c x" #'some-function some-package-mode-map)
  ;; (bind-key "C-c y" #'another-function)

  ;; Toggle fullscreen <F11> also bind to fullscreen
  ;; (bind-keys ("C-<f11>" . toggle-frame-fullscreen)
  ;;            ("C-S-f" . toggle-frame-fullscreen) ; Compatible with macOS
  ;;            ("M-S-<return>" . toggle-frame-fullscreen) ; Compatible with Windos
  ;;            )

  (unless sys/win32p
    (global-set-key  (kbd "C-S-SPC") 'set-mark-command))

  ;; C-c TAB indent-region
  ;; C-u C-c TAB => (un)indent-region



  ;; has set to f7, c-f7
  ;;(global-set-key (kbd "<C-f6>") '(lambda () (interactive) (bookmark-set "SAVED")))
  ;;(global-set-key (kbd "<f6>") '(lambda () (interactive) (bookmark-jump "SAVED")))

  ;; default keys: C-x LEFT/RIGHT C-, C-.
  (global-set-key (kbd "<C-S-iso-lefttab>") 'previous-buffer)
  (global-set-key (kbd "<C-tab>") 'next-buffer)
  ;;(global-set-key (kbd "C-x C-b") 'buffer-menu)
  ;;(global-set-key (kbd "C-x C-b") 'ibuffer)

  ;; (define-prefix-command 'my-leader) ;è®¾å®šleader
  ;; (define-key keymap "keystrok" 'command-name)   ;å°†å¿«æ·é”®ç»‘å®šåˆ° leaderæŒ‰é”®åŽï¼Œå³å’Œé”®ä½å›¾ç»‘å®šã€‚
  ;; (global-set-key "keystroke" 'command-name) ; å®šä¹‰å…¨å±€å¿«æ·é”®
  ;; (local-set-key  "keystroke" 'command-name) ; å®šä¹‰å±€éƒ¨å¿«æ·é”®
  ;;æ³¨æ„ï¼škeystrokeä¸­çš„Control å’Œ Alternativeä½¿ç”¨\C, \Mè¡¨ç¤ºã€‚
  ;;å¦‚æžœæ˜¯kbdå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨Cå’ŒMè¡¨ç¤º

  ;; æ–¹å¼ä¸€ï¼š
  ;;(define-prefix-command 'SPC-map)
  ;;(global-set-key (kbd "SPC") 'SPC-map)
  ;;(global-set-key (kbd "SPC f") 'find-file)

  ;; æ–¹å¼äºŒï¼š
  ;;(define-prefix-command 'SPC-map)
  ;;(global-set-key (kbd "SPC") #'SPC-map)
  ;;(define-key SPC-map (kbd "f") #'find-file)


  ;; æ¼”ç¤ºäº†å¦‚ä½•å®šä¹‰ä¸€ä¸ªæ–°çš„æŒ‰é”®å‰ç¼€. è¿™é‡Œå®šä¹‰äº†M-cä½œä¸ºæŒ‰é”®å‰ç¼€.
  ;; (define-prefix-command 'comma-map)
  ;; (global-set-key (kbd ",") 'comma-map)
  ;; (global-set-key [(meta c)] 'meta-c-map)

  ;; æ¼”ç¤ºäº†å¦‚ä½•åœ¨ä¸€ä¸ªæ¨¡å¼ä¸‹(è¿™é‡Œæ˜¯isearchæ¨¡å¼), å®šä¹‰å¿«æ·é”®. é€€å‡ºisearch-mode, æ‰€æœ‰æŒ‰é”®å¤±æ•ˆ.
  ;; (add-hook 'isearch-mode-hook
  ;;        '(lambda ()
  ;;           ;; æœç´¢ä¸‹ä¸€ä¸ªç»“æžœ
  ;;           (define-key isearch-mode-map [(meta n)] 'isearch-repeat-forward)
  ;;           ;; æœç´¢å‰ä¸€ä¸ªç»“æžœ
  ;;           (define-key isearch-mode-map [(meta p)] 'isearch-repeat-backward)
  ;;           ;; æ›¿æ¢
  ;;           (define-key isearch-mode-map [(control r)] 'isearch-query-replace)
  ;;           ;; æ­£åˆ™æ›¿æ¢
  ;;           (define-key isearch-mode-map [(meta 5)] 'isearch-query-replace-regexp)
  ;;           (define-key isearch-mode-map [(meta f)] 'isearch-yank-word-or-char)
  ;;           ;; å‰ªåˆ‡æ¿ä½œä¸ºæœç´¢å†…å®¹
  ;;           (define-key isearch-mode-map [(meta y)] 'isearch-yank-kill)
  ;;           ;; å°†å…‰æ ‡åˆ°è¡Œå°¾ä½œä¸ºæœç´¢å†…å®¹
  ;;           (define-key isearch-mode-map [(meta k)] 'isearch-yank-line)
  ;;           (define-key isearch-mode-map [(hyper l)] 'isearch-yank-char)
  ;;           ;; å‘å·¦æˆ–å‘å³(é€‰æ‹©/å–æ¶ˆ)å•ä¸ªå­—ç¬¦ä½œä¸ºæœç´¢å†…å®¹
  ;;           (define-key isearch-mode-map [(hyper j)] 'isearch-delete-char)
  ;;           ;; æ˜¾ç¤ºoccurè§†å›¾
  ;;           (define-key isearch-mode-map [(meta o)] 'isearch-occur)
  ;;           ;; å•è¯æœç´¢
  ;;           (define-key isearch-mode-map [(meta w)] 'isearch-forward-word)
  ;;           (define-key isearch-mode-map [(meta s)] 'isearch-repeat-forward)
  ;;           ))



  ;;Emacs è‡ªåŠ¨æŽ’ç‰ˆ
  ;;å¾ˆç®€å•ï¼šC-x h C-M-\
  ;;å…¶ä¸­C-x h æ˜¯å…¨é€‰
  ;;C-M-\ æ˜¯æŽ’ç‰ˆ

  ;; C-x C-q set/unset readonly

  ;; (require 'undo-tree)
  ;;(define-key undo-tree-map (kbd "C-x u") #'(lambda ()
  ;;   (interactive)
  ;;   (undo-tree-visualize)
  ;;   (undo-tree-visualize-undo)))
  ;; c-/ c-_  undo | c-x u undo-tree | c-s-/ s-? M-_ redo

  ;; å¤§å°å†™è½¬æ¢ï¼š M-u, M-l, M-c

  ;; M-x align-regexp å¯ä»¥æ–¹ä¾¿çš„å¯¹é½ä¸€äº›æ–‡å­—

    ;;; rectangle
  ;; C-x r k
  ;; Kill the text of the region-rectangle, saving its contents as the last killed rectangle (kill-rectangle).
  ;; C-x r M-w
  ;; Save the text of the region-rectangle as the last killed rectangle (copy-rectangle-as-kill).
  ;; C-x r d
  ;; Delete the text of the region-rectangle (delete-rectangle).
  ;; C-x r y
  ;; Yank the last killed rectangle with its upper left corner at point (yank-rectangle).
  ;; C-x r o
  ;; Insert blank space to fill the space of the region-rectangle (open-rectangle). This pushes the previous contents of the region-rectangle to the right.
  ;; C-x r N
  ;; Insert line numbers along the left edge of the region-rectangle (rectangle-number-lines). This pushes the previous contents of the region-rectangle to the right.
  ;; C-x r c
  ;; Clear the region-rectangle by replacing all of its contents with spaces (clear-rectangle).
  ;; M-x delete-whitespace-rectangle
  ;; Delete whitespace in each of the lines on the specified rectangle, starting from the left edge column of the rectangle.
  ;; C-x r t string <RET>
  ;; Replace rectangle contents with string on each line (string-rectangle).
  ;; M-x string-insert-rectangle <RET> string <RET>
  ;; Insert string on each line of the rectangle.
  ;; C-x <SPC>
  ;; Toggle Rectangle Mark mode (rectangle-mark-mode). When this mode is active, the region-rectangle is highlighted and can be shrunk/grown, and the standard kill and yank commands operate on it.
  ;; The rectangle operations fall into two classes: commands to erase or insert rectangles, and comm

  ;; f3 start macro(kmacro-start-macro-or-insert-counter),
  ;; f4 done macro or run marcro (kmacro-end-or-call-macro).
  ;; C-x ( start macro (kmacro-start-macro),
  ;; C-x ) end done marco,
  ;; C-x e run marco(kmacro-end-macro)
  ;; å…ˆå®šä¹‰ä¸€ä¸ªå®
  ;; ç„¶åŽ name-last-kbd-macro
  ;; ç„¶åŽ insert-kbd-macro
  ;; ç­‰åˆ°å¦‚ä¸‹ç±»ä¼¼çš„é…ç½®
  (fset 'delete-empty-lines (kbd "M-x flush-lines RET ^\s-*$ RET"))

  (define-prefix-command 'leader-key)
  (global-set-key (kbd "M-s-SPC") 'leader-key)
#+end_src
* Modern completion configuration.  etc/init-completion.el
zidung bÃ²ucÃ¼n:
#+begin_src emacs-lisp :tangle etc/init-completion.el
  ;;; init-completion.el --- Initialize completion configurations.	-*- lexical-binding: t -*-

  ;;; Commentary:
  ;;
  ;; Modern completion configuration.
  ;;

  ;;; Code:

  (provide 'init-completion)
  (use-package emacs
  :init
  ;; TAB cycle if there are only few candidates
  (setq completion-cycle-threshold 3)

  ;; Only list the commands of the current modes
  (when (boundp 'read-extended-command-predicate)
    (setq read-extended-command-predicate
          #'command-completion-default-include-p))

  ;; Enable indentation+completion using the TAB key.
  ;; `completion-at-point' is often bound to M-TAB.
  (setq tab-always-indent 'complete))
#+end_src
zÃ¼ming ge Emacs bÃ²ucÃ¼n Ä·Ã¡nggÃ¡, wai LSP taigung Ã±atnoi ge gungnang, laiyÃ¼ zidung bÃ²ucÃ¼n.

#+begin_src emacs-lisp :tangle etc/init-completion.el
  (use-package company
    :defer 2
    :hook (after-init . global-company-mode)
    :init (setq company-tooltip-align-annotations t
                company-idle-delay 0 company-echo-delay 0
                company-minimum-prefix-length 1
                company-require-match nil
                company-dabbrev-ignore-case nil
                company-dabbrev-downcase nil
                company-show-numbers t)
    :config
    (setq switch-window-input-style 'minibuffer)
    (setq switch-window-increase 4)
    (setq switch-window-threshold 2)
    (setq switch-window-shortcut-sytle 'querty)
    (setq switch-window-qwerty-shortcuts
          '("a" "s" "d" "f" "j" "k" "l"))
    (global-company-mode)
    :bind (:map company-active-map
                ("C-n" . #'company-select-next)
                ("C-p" . #'company-select-previous)
                ("TAB" . company-complete-selection)
                ("M-h" . company-complete-selection)
                ("M-H" . company-complete-common)
                ("M-s" . company-search-candidates)
                ("M-S" . company-filter-candidates)
                ("M-n" . company-select-next)
                ("M-p" . company-select-previous))
    (:map leader-key
          ("c s" . #'company-yasnippet
           ))
    )
  (use-package company-box
    :ensure nil)
#+end_src

shaiyung `orderless' bÃ²ucÃ¼n funggak.
#+begin_src emacs-lisp :tangle etc/init-completion.el

  ;; Optionally use the `orderless' completion style.
  (use-package orderless
    :custom
    (completion-styles '(orderless basic))
    (completion-category-overrides '((file (styles basic partial-completion))))
    (orderless-component-separator #'orderless-escapable-split-on-space))

  ;; Support Pinyin
  (use-package pinyinlib
    :after orderless
    :autoload pinyinlib-build-regexp-string
    :init
    (defun completion--regex-pinyin (str)
      (orderless-regexp (pinyinlib-build-regexp-string str)))
    (add-to-list 'orderless-matching-styles 'completion--regex-pinyin))
#+end_src

shaiyung `vertico`
#+begin_src emacs-lisp :tangle etc/init-completion.el
  (use-package vertico
  :bind (:map vertico-map
              ("RET" . vertico-directory-enter)
              ("DEL" . vertico-directory-delete-char)
              ("M-DEL" . vertico-directory-delete-word))
  :hook ((after-init . vertico-mode)
         (rfn-eshadow-update-overlay . vertico-directory-tidy)))

(when (childframe-completion-workable-p)
  (use-package vertico-posframe
    :hook (vertico-mode . vertico-posframe-mode)
    :init (setq vertico-posframe-poshandler
                #'posframe-poshandler-frame-center-near-bottom
                vertico-posframe-parameters
                '((left-fringe  . 8)
                  (right-fringe . 8)))
    )
  )


#+end_src

shaiyung swiper
#+begin_src emacs-lisp :tangle etc/init-completion.el
  ;; (use-package swiper
  ;;   :bind
  ;;   (
  ;;    ("C-x M-s" . swiper)
  ;;    ("C-x C-F"  . counsel-find-file)
  ;;    ("C-x C-M-x" . counsel-M-x)
  ;;    )
  ;;   :config
  ;;   (progn
  ;;     (ivy-mode 1)
  ;;     (setq ivy-use-virtual-buffers t)
  ;;     (setq ivy-display-style 'fancy)
  ;;     ;;(define-key read-expression-map (kbd "C-r") 'counsel-expression-history))
  ;;     ))
#+end_src

shaiyung consult
#+begin_src emacs-lisp :tangle etc/init-completion.el
  (use-package consult
  :bind (;; C-c bindings in `mode-specific-map'
         ("C-c M-x" . consult-mode-command)
         ("C-c h"   . consult-history)
         ("C-c k"   . consult-kmacro)
         ("C-c m"   . consult-man)
         ("C-c i"   . consult-info)
         ("C-c r"   . consult-ripgrep)
         ("C-c T"   . consult-theme)
         ("C-."     . consult-imenu)

         ;;("C-c c e" . consult-colors-emacs)
         ;;("C-c c w" . consult-colors-web)
         ;;("C-c c f" . describe-face)
         ;;("C-c c t" . consult-theme)

         ([remap Info-search]        . consult-info)
         ([remap isearch-forward]    . consult-line)
         ([remap recentf-open-files] . consult-recent-file)

         ;; C-x bindings in `ctl-x-map'
         ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
         ("C-x b"   . consult-buffer)              ;; orig. switch-to-buffer
         ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
         ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
         ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
         ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
         ;; Custom M-# bindings for fast register access
         ("M-#"     . consult-register-load)
         ("M-'"     . consult-register-store)        ;; orig. abbrev-prefix-mark (unrelated)
         ("C-M-#"   . consult-register)
         ;; Other custom bindings
         ("M-y"     . consult-yank-pop)                ;; orig. yank-pop
         ;; M-g bindings in `goto-map'
         ("M-g e"   . consult-compile-error)
         ("M-g g"   . consult-goto-line)             ;; orig. goto-line
         ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
         ("M-g o"   . consult-outline)               ;; Alternative: consult-org-heading
         ("M-g m"   . consult-mark)
         ("M-g k"   . consult-global-mark)
         ("M-g i"   . consult-imenu)
         ("M-g I"   . consult-imenu-multi)
         ;; M-s bindings in `search-map'
         ("M-s d"   . consult-find)
         ("M-s D"   . consult-locate)
         ("M-s g"   . consult-grep)
         ("M-s G"   . consult-git-grep)
         ("M-s r"   . consult-ripgrep)
         ("M-s l"   . consult-line)
         ("M-s L"   . consult-line-multi)
         ("M-s k"   . consult-keep-lines)
         ("M-s u"   . consult-focus-lines)
         ;; Isearch integration
         ("M-s e"   . consult-isearch-history)
         :map isearch-mode-map
         ("M-e"     . consult-isearch-history)       ;; orig. isearch-edit-string
         ("M-s e"   . consult-isearch-history)       ;; orig. isearch-edit-string
         ("M-s l"   . consult-line)                  ;; needed by consult-line to detect isearch
         ("M-s L"   . consult-line-multi)            ;; needed by consult-line to detect isearch

         ;; Minibuffer history
         :map minibuffer-local-map
         ("C-s" . (lambda ()
                    "Insert the selected region or current symbol at point."
                    (interactive)
                    (insert (with-current-buffer
                                (window-buffer (minibuffer-selected-window))
                              (or (and transient-mark-mode mark-active (/= (point) (mark))
                                       (buffer-substring-no-properties (point) (mark)))
                                  (thing-at-point 'symbol t)
                                  "")))))
         ("M-s" . consult-history) ;;orig. next-matching-history-element
         ("M-r" . consult-history))   ;; orig. previous-matching-history-element

  ;; Enable automatic preview at point in the *Completions* buffer. This is
  ;; relevant when you use the default completion UI.
  :hook (completion-list-mode . consult-preview-at-point-mode)

  ;; The :init configuration is always executed (Not lazy)
  :init
  ;; Optionally configure the register formatting. This improves the register
  ;; preview for `consult-register', `consult-register-load',
  ;; `consult-register-store' and the Emacs built-ins.
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)

  ;; Optionally tweak the register preview window.
  ;; This adds thin lines, sorting and hides the mode line of the window.
  (advice-add #'register-preview :override #'consult-register-window)

  ;; Use Consult to select xref locations with preview
  (with-eval-after-load 'xref
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref))

  ;; More utils

  (use-package consult-flyspell
    :bind ("M-g s" . consult-flyspell))

  (use-package consult-yasnippet
    :bind ("M-g y" . consult-yasnippet)))
#+end_src
tÃ²ubiu
#+begin_src emacs-lisp :tangle etc/init-completion.el
  (use-package nerd-icons-completion
    :when (icons-displayable-p)
    :hook (vertico-mode . nerd-icons-completion-mode))

#+end_src
* GÃ¡imin Citding: etc/init-ui.el
#+begin_src emacs-lisp :tangle etc/init-ui.el
  ;;; init-ui.el --- Initialize UI configurations.	-*- lexical-binding: t -*-


  (provide 'init-ui)

  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require '+func)
    (require 'init-package)
    )

  ;; Optimization
  (setq idle-update-delay 1.0)


  ;; Compatibility
  (use-package compat :demand t)


  ;; å­—ä½“
  (defun font-installed-p (font-name)
    "Check if font with FONT-NAME is available."
    (find-font (font-spec :name font-name)))


  (display-time-mode -1)

  (setq column-number-mode t)
  (setq-default fill-column 80)
  (setq column-number-mode t)

  (require 'display-line-numbers)
  ;; è®¾ç½®è¡Œå·
  ;;(global-display-line-numbers-mode 1)
  ;; Alternatively, to use it only in programming modes:
  (add-hook 'prog-mode-hook #'display-line-numbers-mode)

  ;; Line numbers are not displayed when large files are used.
  (setq line-number-display-limit large-file-warning-threshold)
  (setq line-number-display-limit-width 1000)

  (dolist (hook (list
                 'c-mode-common-hook
                 'c-mode-hook
                 'emacs-lisp-mode-hook
                 'lisp-interaction-mode-hook
                 'lisp-mode-hook
                 'java-mode-hook
                 'asm-mode-hook
                 'haskell-mode-hook
                 'rcirc-mode-hook
                 'erc-mode-hook
                 'sh-mode-hook
                 'makefile-gmake-mode-hook
                 'python-mode-hook
                 'js-mode-hook
                 'html-mode-hook
                 'css-mode-hook
                 'tuareg-mode-hook
                 'go-mode-hook
                 'coffee-mode-hook
                 'qml-mode-hook
                 'markdown-mode-hook
                 'slime-repl-mode-hook
                 'package-menu-mode-hook
                 'cmake-mode-hook
                 'php-mode-hook
                 'web-mode-hook
                 'coffee-mode-hook
                 'sws-mode-hook
                 'jade-mode-hook
                 'vala-mode-hook
                 'rust-mode-hook
                 'ruby-mode-hook
                 'qmake-mode-hook
                 'lua-mode-hook
                 'swift-mode-hook
                 'llvm-mode-hook
                 'conf-toml-mode-hook
                 'nxml-mode-hook
                 'nim-mode-hook
                 'typescript-mode-hook
                 'elixir-mode-hook
                 'clojure-mode-hook
                 'dart-mode-hook
                 'zig-mode-hook

                 'c-ts-mode-hook
                 'c++-ts-mode-hook
                 'cmake-ts-mode-hook
                 'toml-ts-mode-hook
                 'css-ts-mode-hook
                 'js-ts-mode-hook
                 'json-ts-mode-hook
                 'python-ts-mode-hook
                 'bash-ts-mode-hook
                 'typescript-ts-mode-hook
                 'rust-ts-mode-hook
                 'java-ts-mode-hook
                 'kotlin-mode-hook
                 'prog-mode-hook
                 'yaml-mode-hook
                 'conf-mode-hook
                 ))
    (add-hook hook (lambda () (display-line-numbers-mode))))

  ;; Easily adjust the font size in all frames
  (use-package default-text-scale
    :ensure t
    :hook (after-init . default-text-scale-mode)
    :bind (:map default-text-scale-mode-map
           ("s-="   . default-text-scale-increase)
           ("s--"   . default-text-scale-decrease)
           ("s-0"   . default-text-scale-reset)
           ("C-s-=" . default-text-scale-increase)
           ("C-s--" . default-text-scale-decrease)
           ("C-s-0" . default-text-scale-reset)))


  ;; Icons
  (use-package nerd-icons
    :config
    (when (and (display-graphic-p)
               (not (font-installed-p nerd-icons-font-family)))
      (nerd-icons-install-fonts t)))

  ;; å›¾æ ‡æ”¯æŒ
  (use-package all-the-icons
    ;; :ensure t
    :load-path "~/.emacs.d/extensions/all-the-icons"
    :if (display-graphic-p))


  ;; Display ugly ^L page breaks as tidy horizontal lines
  (use-package page-break-lines
    :diminish
    :hook (after-init . global-page-break-lines-mode))

  (use-package ibuffer
    :ensure nil
    :bind ("C-x C-b" . ibuffer)
    :init (setq ibuffer-filter-group-name-face '(:inherit (font-lock-string-face bold))))

  ;; Display icons for buffers
  (use-package nerd-icons-ibuffer
    :hook (ibuffer-mode . nerd-icons-ibuffer-mode)
    :init (setq nerd-icons-ibuffer-icon suk-icon))

  (use-package hydra
    :hook (emacs-lisp-mode . hydra-add-imenu)
    :init
    (when (childframe-completion-workable-p)
      (setq hydra-hint-display-type 'posframe)

      (with-eval-after-load 'posframe
        (defun hydra-set-posframe-show-params ()
          "Set hydra-posframe style."
          (setq hydra-posframe-show-params
                `(:left-fringe 8
                  :right-fringe 8
                  :internal-border-width 2
                  :internal-border-color ,(face-background 'posframe-border nil t)
                  :background-color ,(face-background 'tooltip nil t)
                  :foreground-color ,(face-foreground 'tooltip nil t)
                  :lines-truncate t
                  :poshandler posframe-poshandler-frame-center-near-bottom)))
        (hydra-set-posframe-show-params)
        (add-hook 'after-load-theme-hook #'hydra-set-posframe-show-params t))))

  ;; -*- coding: utf-8; lexical-binding: t; -*-

  ;; @see https://github.com/abo-abo/hydra
  ;; color could: red, blue, amaranth, pink, teal

  ;; æœ€å¸¸ç”¨çš„åŠŸèƒ½
  (defhydra my-hydra-launcher (:color blue)
    "
  ^Misc^                    ^Study^                    ^Emms^
  -------------------------------------------------------------------
  [_ss_] Save workgroup     [_vv_] Pronounce word      [_R_] Random
  [_ll_] Load workgroup     [_W_] Big word list        [_n_] Next
  [_B_] New bookmark        [_vi_] Play word's video   [_p_] Previous
  [_m_] Goto bookmark       [_im_] Image of word       [_P_] Pause
  [_bb_] Switch Gnus buffer [_w_] Select big word      [_S_] Stop
  [_e_] Erase buffer        [_s1_] Pomodoro tiny task  [_O_] Open
  [_r_] Erase this buffer   [_s2_] Pomodoro big task   [_L_] Playlist
  [_f_] Recent file         [_st_] Pomodoro stop       [_K_] Search
  [_d_] Recent directory    [_sr_] Pomodoro resume     [_F_] filter
  [_z_] Jump around (z.sh)  [_sp_] Pomodoro pause      [_E_] replay
  [_bh_] Bash history       [_as_] Ascii table
  [_hh_] Favorite theme     [_T_] Typewriter on/off
  [_hr_] Random theme       [_V_] Old typewriter
  [_ka_] Kill other buffers
  [_ii_] Imenu
  [_id_] Insert date string
  [_aa_] Adjust subtitle
  [_q_] Quit
  "
    ("aa" my-srt-offset-subtitles-from-point)
    ("B" my-bookmark-set)
    ("m" my-bookmark-goto)
    ("f" my-counsel-recentf)
    ("d" my-recent-directory)
    ("bh" my-insert-bash-history)
    ("hh" my-random-favorite-color-theme)
    ("hr" my-random-healthy-color-theme)
    ("ii" my-counsel-imenu)
    ("ka" my-kill-all-but-current-buffer)
    ("id" my-insert-date)
    ("as" my-ascii-table)
    ("ss" wg-create-workgroup)
    ("ll" wg-open-workgroup)
    ("e" shellcop-erase-buffer)
    ("r" shellcop-reset-with-new-command)
    ("z" shellcop-jump-around)
    ("T" my-toggle-typewriter)
    ("V" twm/toggle-sound-style)

    ;; {{pomodoro
    ("s1" (pomodoro-start 15))
    ("s2" (pomodoro-start 60))
    ("st" pomodoro-stop)
    ("sr" pomodoro-resume)
    ("sp" pomodoro-pause)
    ;; }}

    ;; {{emms
    ("R" (progn (emms-shuffle) (emms-random)))
    ("F" my-emms-playlist-filter)
    ("K" my-emms-playlist-random-track)
    ("E" (emms-seek-to 0))
    ("p" emms-previous)
    ("P" emms-pause)
    ("S" emms-stop)
    ("O" emms-play-playlist)
    ("n" emms-next)
    ("L" emms-playlist-mode-go)
    ;; }}

    ("vv" mybigword-pronounce-word)
    ("w" mybigword-big-words-in-current-window)
    ("im" mybigword-show-image-of-word)
    ("W" my-lookup-bigword-definition-in-buffer)
    ("vi" mybigword-play-video-of-word-at-point)
    ("bb" dianyou-switch-gnus-buffer)
    ("q" nil :color red))

  ;; Because in message-mode/article-mode we've already use `y' as hotkey
  (global-set-key (kbd "C-c C-y") 'my-hydra-launcher/body)
  (defun org-mode-hook-hydra-setup ()
    (local-set-key (kbd "C-c C-y") 'my-hydra-launcher/body))
  (add-hook 'org-mode-hook 'org-mode-hook-hydra-setup)





  ;; ;; increase and decrease font size in GUI emacs
  ;; ;; @see https://oremacs.com/download/london.pdf
  ;; (when (display-graphic-p)
  ;;   ;; Since we already use GUI Emacs, f2 is definitely available
  ;;   (defhydra my-hydra-zoom (global-map "<f2>")
  ;;     "Zoom"
  ;;     ("g" text-scale-increase "in")
  ;;     ("l" text-scale-decrease "out")
  ;;     ("r" (text-scale-set 0) "reset")
  ;;     ("q" nil "quit")))


  (defhydra my-hydra-ebook ()
    "
  [_v_] Pronounce word
  [_;_] Jump to word
  [_w_] Display bigword in current window
  "
    ("v" mybigword-pronounce-word)
    (";" avy-goto-char-2)
    ("w" mybigword-big-words-in-current-window)
    ("q" nil))



  (use-package pretty-hydra
    :custom (pretty-hydra-default-title-body-format-spec " %s%s")
    :bind ("<f6>" . toggles-hydra/body)
    :hook (emacs-lisp-mode . (lambda ()
                               (add-to-list
                                'imenu-generic-expression
                                '("Hydras"
                                  "^.*(\\(pretty-hydra-define\\) \\([a-zA-Z-]+\\)"
                                  2))))
    :init
    (cl-defun pretty-hydra-title (title &optional icon-type icon-name
                                        &key face height v-adjust)
      "Add an icon in the hydra title."
      (let ((face (or face `(:inherit highlight :reverse-video t)))
            (height (or height 1.2))
            (v-adjust (or v-adjust 0.0)))
        (concat
         (when (and (icons-displayable-p) icon-type icon-name)
           (let ((f (intern (format "nerd-icons-%s" icon-type))))
             (when (fboundp f)
               (concat
                (apply f (list icon-name :face face :height height :v-adjust v-adjust))
                " "))))
         (propertize title 'face face))))

    ;; Global toggles
    (with-no-warnings
      (pretty-hydra-define+ toggles-hydra (:title (pretty-hydra-title "Toggles" 'faicon "nf-fa-toggle_on")
                                          :color amaranth :quit-key ("q" "C-g"))
        ("Basic"
         (("n" (cond ((fboundp 'display-line-numbers-mode)
                      (display-line-numbers-mode (if display-line-numbers-mode -1 1)))
                     ((fboundp 'gblobal-linum-mode)
                      (global-linum-mode (if global-linum-mode -1 1))))
           "line number"
           :toggle (or (bound-and-true-p display-line-numbers-mode)
                       (bound-and-true-p global-linum-mode)))
          ("i" global-aggressive-indent-mode "aggressive indent" :toggle t)
          ("d" global-hungry-delete-mode "hungry delete" :toggle t)
          ("e" electric-pair-mode "electric pair" :toggle t)
          ("c" flyspell-mode "spell check" :toggle t)
          ("s" prettify-symbols-mode "pretty symbol" :toggle t)
          ("l" global-page-break-lines-mode "page break lines" :toggle t)
          ("B" display-battery-mode "battery" :toggle t)
          ("T" display-time-mode "time" :toggle t)
          ("a" abbrev-mode "abrev" :toggle t)
          ("F" auto-fill-mode "auto fill" :toggle t)
          ("m" doom-modeline-mode "modern mode-line" :toggle t)
          ("t" toggle-truncate-lines "truncate lines" :toggle t)
          ("u" toggle-company-ispell "Company Ispell" :toggle t))
         "Highlight"
         (("h l" global-hl-line-mode "line" :toggle t)
          ("h p" show-paren-mode "paren" :toggle t)
          ("h s" symbol-overlay-mode "symbol" :toggle t)
          ("h r" rainbow-mode "rainbow" :toggle t)
          ("h w" (setq-default show-trailing-whitespace (not show-trailing-whitespace))
           "whitespace" :toggle show-trailing-whitespace)
          ("h d" rainbow-delimiters-mode "delimiter" :toggle t)
          ("h i" highlight-indent-guides-mode "indent" :toggle t)
          ("h t" global-hl-todo-mode "todo" :toggle t))
         "Program"
         (("f" flymake-mode "flymake" :toggle t)
          ("O" hs-minor-mode "hideshow" :toggle t)
          ("U" subword-mode "subword" :toggle t)
          ("w" whitespace-mode "whitespace" :toggle t)
          ("W" which-function-mode "which function" :toggle t)
          ("E" toggle-debug-on-error "debug on error" :toggle (default-value 'debug-on-error))
          ("Q" toggle-debug-on-quit "debug on quit" :toggle (default-value 'debug-on-quit))
          ("v" global-diff-hl-mode "gutter" :toggle t)
          ("V" diff-hql-flydiff-mode "live gutter" :toggle t)
          ("M" diff-hl-margin-mode "margin gutter" :toggle t)
          ("D" diff-hl-dired-mode "dired gutter" :toggle t))
         ))))

  (use-package hydra-posframe
    :load-path "~/.emacs.d/extensions/hydra-posframe/hydra-posframe.el"
    :defer 1
    :hook (after-init . hydra-posframe-mode))

  ;; Child frame
  (when (childframe-workable-p)
    (use-package posframe
      :hook (after-load-theme . posframe-delete-all)
      :init
      (defface posframe-border
        `((t (:inherit region)))
        "Face used by the `posframe' border."
        :group 'posframe)
      (defvar posframe-border-width 2
        "Default posframe border width.")
      :config
      (with-no-warnings
        (defun my-posframe--prettify-frame (&rest _)
          (set-face-background 'fringe nil posframe--frame))
        (advice-add #'posframe--create-posframe :after #'my-posframe--prettify-frame)

        (defun posframe-poshandler-frame-center-near-bottom (info)
          (cons (/ (- (plist-get info :parent-frame-width)
                      (plist-get info :posframe-width))
                   2)
                (/ (+ (plist-get info :parent-frame-height)
                      (* 2 (plist-get info :font-height)))
                   2))))))


  ;; Don't use GTK+ tooltip
  (when (boundp 'x-gtk-use-system-tooltips)
    (setq x-gtk-use-system-tooltips nil))

  (use-package vertico-posframe
    :ensure t
    :custom
    (vertico-posframe-parameters
     '((left-fringe . 8)
       (right-fringe . 8))))

  ;; Ligatures support
  (when (and emacs/>=28p (not suk-prettify-symbols-alist))
    (use-package composite
      :ensure nil
      :init (defvar composition-ligature-table (make-char-table nil))
      :hook (((prog-mode
               conf-mode nxml-mode markdown-mode help-mode
               shell-mode eshell-mode term-mode vterm-mode)
              . (lambda () (setq-local composition-function-table composition-ligature-table))))
      :config
      ;; support ligatures, some toned down to prevent hang
      (let ((alist
             '((33  . ".\\(?:\\(==\\|[!=]\\)[!=]?\\)")
               (35  . ".\\(?:\\(###?\\|_(\\|[(:=?[_{]\\)[#(:=?[_{]?\\)")
               (36  . ".\\(?:\\(>\\)>?\\)")
               (37  . ".\\(?:\\(%\\)%?\\)")
               (38  . ".\\(?:\\(&\\)&?\\)")
               (42  . ".\\(?:\\(\\*\\*\\|[*>]\\)[*>]?\\)")
               ;; (42 . ".\\(?:\\(\\*\\*\\|[*/>]\\).?\\)")
               (43  . ".\\(?:\\([>]\\)>?\\)")
               ;; (43 . ".\\(?:\\(\\+\\+\\|[+>]\\).?\\)")
               (45  . ".\\(?:\\(-[->]\\|<<\\|>>\\|[-<>|~]\\)[-<>|~]?\\)")
               ;; (46 . ".\\(?:\\(\\.[.<]\\|[-.=]\\)[-.<=]?\\)")
               (46  . ".\\(?:\\(\\.<\\|[-=]\\)[-<=]?\\)")
               (47  . ".\\(?:\\(//\\|==\\|[=>]\\)[/=>]?\\)")
               ;; (47 . ".\\(?:\\(//\\|==\\|[*/=>]\\).?\\)")
               (48  . ".\\(?:x[a-zA-Z]\\)")
               (58  . ".\\(?:\\(::\\|[:<=>]\\)[:<=>]?\\)")
               (59  . ".\\(?:\\(;\\);?\\)")
               (60  . ".\\(?:\\(!--\\|\\$>\\|\\*>\\|\\+>\\|-[-<>|]\\|/>\\|<[-<=]\\|=[<>|]\\|==>?\\||>\\||||?\\|~[>~]\\|[$*+/:<=>|~-]\\)[$*+/:<=>|~-]?\\)")
               (61  . ".\\(?:\\(!=\\|/=\\|:=\\|<<\\|=[=>]\\|>>\\|[=>]\\)[=<>]?\\)")
               (62  . ".\\(?:\\(->\\|=>\\|>[-=>]\\|[-:=>]\\)[-:=>]?\\)")
               (63  . ".\\(?:\\([.:=?]\\)[.:=?]?\\)")
               (91  . ".\\(?:\\(|\\)[]|]?\\)")
               ;; (92 . ".\\(?:\\([\\n]\\)[\\]?\\)")
               (94  . ".\\(?:\\(=\\)=?\\)")
               (95  . ".\\(?:\\(|_\\|[_]\\)_?\\)")
               (119 . ".\\(?:\\(ww\\)w?\\)")
               (123 . ".\\(?:\\(|\\)[|}]?\\)")
               (124 . ".\\(?:\\(->\\|=>\\||[-=>]\\||||*>\\|[]=>|}-]\\).?\\)")
               (126 . ".\\(?:\\(~>\\|[-=>@~]\\)[-=>@~]?\\)"))))
        (dolist (char-regexp alist)
          (set-char-table-range composition-ligature-table (car char-regexp)
                                `([,(cdr char-regexp) 0 font-shape-gstring]))))
      (set-char-table-parent composition-ligature-table composition-function-table)))

  (use-package centaur-tabs
    :demand
    :init
    ;; Set the style to rounded with icons
    (setq centaur-tabs-style "bar")
    (setq centaur-tabs-set-icons t)
    :config
    (centaur-tabs-mode t)
    :bind
    ("C-<prior>" . centaur-tabs-backward) ;; Ctrl PgUp
    ("C-<next>" . centaur-tabs-forward))  ;; Ctrl PgDn

  ;; ===================================
  ;; Theme ä¸»é¢˜è®¾ç½®
  ;; -----------------------------------
  ;;(require 'lazycat-theme)
  ;;(lazycat-theme-load-dark)

  (use-package doom-themes
    :ensure t
    :custom
    (doom-themes-enable-bold t)
    (doom-themes-enable-italic t)
    ;; åŠ è½½ä¸€ä¸ªä¸»é¢˜ï¼ŒDOOM One æ˜¯ DOOM Emacs çš„é»˜è®¤ä¸»é¢˜ï¼Œéžå¸¸ç¾Žè§‚
    :init
    (load-theme 'doom-one t)
    :config
    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)
    ;; WORKAROUND: Visual bell on 29+
    ;; @see https://github.com/doomemacs/themes/issues/733
    (with-no-warnings
      (defun my-doom-themes-visual-bell-fn ()
        "Blink the mode-line red briefly. Set `ring-bell-function' to this to use it."
        (let ((buf (current-buffer))
              (cookies (mapcar (lambda (face)
                                 (face-remap-add-relative face 'doom-themes-visual-bell))
                               (if (facep 'mode-line-active)
                                   '(mode-line-active solaire-mode-line-active-face)
                                 '(mode-line solaire-mode-line-face)))))
          (force-mode-line-update)
          (run-with-timer 0.15 nil
                          (lambda ()
                            (with-current-buffer buf
                              (mapc #'face-remap-remove-relative cookies)
                              (force-mode-line-update))))))
      (advice-add #'doom-themes-visual-bell-fn :override #'my-doom-themes-visual-bell-fn))
    )

  (defvar after-load-theme-hook nil
    "Hook run after a color theme is loaded using `load-theme'.")

  ;;;###autoload
  (defun run-after-load-theme-hook (&rest _)
    "Run `after-load-theme-hook'."
    (run-hooks 'after-load-theme-hook))
  (advice-add #'load-theme :after #'run-after-load-theme-hook)

  (use-package doom-modeline
  ;;  :load-path "~/.emacs.d/extensions/doom-modeline"
    :hook (after-init . doom-modeline-mode)
    :init
    ;;(doom-modeline-mode 1)
    (setq doom-modeline-icon suk-icon
          doom-modeline-minor-modes t)
    :bind (:map doom-modeline-mode-map
           ("C-<f6>" . doom-modeline-hydra/body))
    :config
    (column-number-mode 1)
    :custom
    (doom-modeline-height 30)
    (doom-modeline-window-width-limit nil)
    (doom-modeline-buffer-file-name-style 'truncate-with-project)
    (doom-modeline-icon t)
    ;;(doom-modeline-major-mode-icon nil)
    ;;(doom-modeline-minor-modes nil)
    ;;(doom-modeline-buffer-encoding nil)
    (doom-modeline-buffer-modification-icon t)
    ;;(doom-modeline-env-python-executeable "python")
    ;; needs display-time-mode to be one
    (doom-modeline-time t)
    (doom-modeline-vcs-max-leghth 50)
    ;; Windowsä¸‹è®°å¾—åŠ ä¸Š
    (if sys/win32p (setq inhibit-compacting-font-caches t))
    :pretty-hydra
    ((:title (pretty-hydra-title "Mode Line" 'sucicon "nf-custom-emacs" :face 'nerd-icons-purple)
      :color amaranth
      :quit-key ("q" "C-g"))
     ("Icon"
      (("i" (setq doom-modeline-icon (not doom-modeline-icon))
        "display icons" :toggle doom-modeline-icon)
       ("u" (setq doom-modeline-unicode-fallback (not doom-modeline-unicode-fallback))
        "unicode fallback" :toggle doom-modeline-unicode-fallback)
       ("m" (setq doom-modeline-major-mode-icon (not doom-modeline-major-mode-icon))
        "major mode" :toggle doom-modeline-major-mode-icon)
       ("c" (setq doom-modeline-major-mode-color-icon (not doom-modeline-major-mode-color-icon))
        "colorful major mode" :toggle doom-modeline-major-mode-color-icon)
       ("s" (setq doom-modeline-buffer-state-icon (not doom-modeline-buffer-state-icon))
        "buffer state" :toggle doom-modeline-buffer-state-icon)
       ("o" (setq doom-modeline-buffer-modification-icon (not doom-modeline-buffer-modification-icon))
        "modification" :toggle doom-modeline-buffer-modification-icon)
       ("x" (setq doom-modeline-time-icon (not doom-modeline-time-icon))
        "time" :toggle doom-modeline-time-icon)
       ("v" (setq doom-modeline-modal-icon (not doom-modeline-modal-icon))
        "modal" :toggle doom-modeline-modal-icon))
      "Segment"
      (("g h" (setq doom-modeline-hud (not doom-modeline-hud))
        "hud" :toggle doom-modeline-hud)
       ("g m" (setq doom-modeline-minor-modes (not doom-modeline-minor-modes))
        "minor modes" :toggle doom-modeline-minor-modes)
       ("g w" (setq doom-modeline-enable-word-count (not doom-modeline-enable-word-count))
        "word count" :toggle doom-modeline-enable-word-count)
       ("g e" (setq doom-modeline-buffer-encoding (not doom-modeline-buffer-encoding))
        "encoding" :toggle doom-modeline-buffer-encoding)
       ("g i" (setq doom-modeline-indent-info (not doom-modeline-indent-info))
        "indent" :toggle doom-modeline-indent-info)
       ("g c" (setq doom-modeline-display-misc-in-all-mode-lines (not doom-modeline-display-misc-in-all-mode-lines))
        "misc info" :toggle doom-modeline-display-misc-in-all-mode-lines)
       ("g l" (setq doom-modeline-lsp (not doom-modeline-lsp))
        "lsp" :toggle doom-modeline-lsp)
       ("g k" (setq doom-modeline-workspace-name (not doom-modeline-workspace-name))
        "workspace" :toggle doom-modeline-workspace-name)
       ("g g" (setq doom-modeline-github (not doom-modeline-github))
        "github" :toggle doom-modeline-github)
       ("g n" (setq doom-modeline-gnus (not doom-modeline-gnus))
        "gnus" :toggle doom-modeline-gnus)
       ("g u" (setq doom-modeline-mu4e (not doom-modeline-mu4e))
        "mu4e" :toggle doom-modeline-mu4e)
       ("g r" (setq doom-modeline-irc (not doom-modeline-irc))
        "irc" :toggle doom-modeline-irc)
       ("g f" (setq doom-modeline-irc-buffers (not doom-modeline-irc-buffers))
        "irc buffers" :toggle doom-modeline-irc-buffers)
       ("g s" (progn
                (setq doom-modeline-check-simple-format (not doom-modeline-check-simple-format))
                (and (bound-and-true-p flycheck-mode) (flycheck-buffer)))
        "simple check format" :toggle doom-modeline-check-simple-format)
       ("g t" (setq doom-modeline-time (not doom-modeline-time))
        "time" :toggle doom-modeline-time)
       ("g v" (setq doom-modeline-env-version (not doom-modeline-env-version))
        "version" :toggle doom-modeline-env-version))
      "Style"
      (("a" (setq doom-modeline-buffer-file-name-style 'auto)
        "auto"
        :toggle (eq doom-modeline-buffer-file-name-style 'auto))
       ("b" (setq doom-modeline-buffer-file-name-style 'buffer-name)
        "buffer name"
        :toggle (eq doom-modeline-buffer-file-name-style 'buffer-name))
       ("f" (setq doom-modeline-buffer-file-name-style 'file-name)
        "file name"
        :toggle (eq doom-modeline-buffer-file-name-style 'file-name))
       ("t u" (setq doom-modeline-buffer-file-name-style 'truncate-upto-project)
        "truncate upto project"
        :toggle (eq doom-modeline-buffer-file-name-style 'truncate-upto-project))
       ("t f" (setq doom-modeline-buffer-file-name-style 'truncate-from-project)
        "truncate from project"
        :toggle (eq doom-modeline-buffer-file-name-style 'truncate-from-project))
       ("t w" (setq doom-modeline-buffer-file-name-style 'truncate-with-project)
        "truncate with project"
        :toggle (eq doom-modeline-buffer-file-name-style 'truncate-with-project))
       ("t e" (setq doom-modeline-buffer-file-name-style 'truncate-except-project)
        "truncate except project"
        :toggle (eq doom-modeline-buffer-file-name-style 'truncate-except-project))
       ("t r" (setq doom-modeline-buffer-file-name-style 'truncate-upto-root)
        "truncate upto root"
        :toggle (eq doom-modeline-buffer-file-name-style 'truncate-upto-root))
       ("t a" (setq doom-modeline-buffer-file-name-style 'truncate-all)
        "truncate all"
        :toggle (eq doom-modeline-buffer-file-name-style 'truncate-all))
       ("t n" (setq doom-modeline-buffer-file-name-style 'truncate-nil)
        "truncate none"
        :toggle (eq doom-modeline-buffer-file-name-style 'truncate-nil))
       ("r f" (setq doom-modeline-buffer-file-name-style 'relative-from-project)
        "relative from project"
        :toggle (eq doom-modeline-buffer-file-name-style 'relative-from-project))
       ("r t" (setq doom-modeline-buffer-file-name-style 'relative-to-project)
        "relative to project"
        :toggle (eq doom-modeline-buffer-file-name-style 'relative-to-project)))
      "Project Detection"
      (("p a" (setq doom-modeline-project-detection 'auto)
        "auto"
        :toggle (eq doom-modeline-project-detection 'auto))
       ("p f" (setq doom-modeline-project-detection 'ffip)
        "ffip"
        :toggle (eq doom-modeline-project-detection 'ffip))
       ("p i" (setq doom-modeline-project-detection 'projectile)
        "projectile"
        :toggle (eq doom-modeline-project-detection 'projectile))
       ("p p" (setq doom-modeline-project-detection 'project)
        "project"
        :toggle (eq doom-modeline-project-detection 'project))
       ("p n" (setq doom-modeline-project-detection nil)
        "disable"
        :toggle (eq doom-modeline-project-detection nil)))
      "Misc"
      (("n" (progn
              (message "Fetching GitHub notifications...")
              (run-with-timer 300 nil #'doom-modeline--github-fetch-notifications)
              (browse-url "https://github.com/notifications"))
        "github notifications" :exit t)
       ("e" (cond ((bound-and-true-p flycheck-mode)
                   (flycheck-list-errors))
                  ((bound-and-true-p flymake-mode)
                   (flymake-show-diagnostics-buffer)))
        "list errors" :exit t)
       ("w" (if (bound-and-true-p grip-mode)
                (grip-browse-preview)
              (message "Not in preview"))
        "browse preview" :exit t)
       ("z h" (read-from-minibuffer
               "Eval: "
               (format "(setq %s %s)"
                       'doom-modeline-height
                       (symbol-value 'doom-modeline-height)))
        "set height" :exit t)
       ("z w" (read-from-minibuffer
               "Eval: "
               (format "(setq %s %s)"
                       'doom-modeline-bar-width
                       (symbol-value 'doom-modeline-bar-width)))
        "set bar width" :exit t)
       ("z g" (read-from-minibuffer
               "Eval: "
               (format "(setq %s %s)"
                       'doom-modeline-github-interval
                       (symbol-value 'doom-modeline-github-interval)))
        "set github interval" :exit t)
       ("z n" (read-from-minibuffer
               "Eval: "
               (format "(setq %s %s)"
                       'doom-modeline-gnus-timer
                       (symbol-value 'doom-modeline-gnus-timer)))
        "set gnus interval" :exit t))))
    )

  (use-package hide-mode-line
    :hook (((treemacs-mode
             eshell-mode shell-mode
             term-mode vterm-mode
             embark-collect-mode
             lsp-ui-imenu-mode
             pdf-annot-list-mode) . turn-on-hide-mode-line-mode)
           (dired-mode . (lambda()
                           (and (bound-and-true-p hide-mode-line-mode)
                                (turn-off-hide-mode-line-mode))))))

  ;; A minor-mode menu for mode-line
  (use-package minions
    :hook (doom-modeline-mode . minions-mode))

  ;; Frame transparence
  (use-package transwin
    :bind (("C-M-9" . transwin-inc)
           ("C-M-8" . transwin-dec)
           ("C-M-7" . transwin-toggle))
    :init
    (when sys/linux-x-p
      (setq transwin-parameter-alpha 'alpha-background)))




  ;;===================================================
  ;; Frame
  ;;===================================================
  ;; Title
  (setq frame-title-format
        '("Suk's Emacs - "
          (:eval (if (buffer-file-name)
                     (abbreviate-file-name (buffer-file-name))
                   "%b")))
        icon-title-format frame-title-format
        )

  (defvar suk/frame--geometry nil)
  ;;;###autoload
  (defun suk/frame--save-geometry ()
    "Save current frame's geometry."
    (setq suk/frame--geometry
          `((left   . ,(frame-parameter nil 'left))
            (top    . ,(frame-parameter nil 'top))
            (width  . ,(frame-parameter nil 'width))
            (height . ,(frame-parameter nil 'height))
            (fullscreen))))

  ;;;###autoload
  (defun suk/frame--fullscreen-p ()
    "Return Non-nil if the frame is fullscreen."
    (memq (frame-parameter nil 'fullscreen) '(fullscreen fullboth)))

  ;;;###autoload
  (defun suk/frame-maximize ()
    "Maximize the frame."
    (interactive)
    (suk/frame--save-geometry)
    (unless (eq (frame-parameter nil 'fullscreen) 'maximized)
      (set-frame-parameter nil 'fullscreen 'maximized)))

  ;;;###autoload
  (defun suk/frame-restore ()
    "Restore the frame's size and position."
    (interactive)
    (modify-frame-parameters nil suk/frame--geometry))

  ;;;###autoload
  (defun suk/frame-left-half ()
    "Put the frame to the left-half."
    (interactive)
    (unless (suk/frame--fullscreen-p)
      (suk/frame--save-geometry)
      (let* ((attr (frame-monitor-workarea))
             (width (- (/ (nth 2 attr) 2) 20))
             (height (- (nth 3 attr) 30))
             (left (nth 0 attr))
             (top (nth 1 attr)))
        (set-frame-parameter nil 'fullscreen nil)
        (set-frame-position nil left top)
        (set-frame-size nil width height t))))

  ;;;###autoload
  (defun suk/frame-right-half ()
    "Put the frame to the right-half."
    (interactive)
    (unless (suk/frame--fullscreen-p)
      (suk/frame--save-geometry)
      (let* ((attr (frame-monitor-workarea))
             (width (- (/ (nth 2 attr) 2) 20))
             (height (- (nth 3 attr) 30))
             (left (+ (nth 0 attr) width 20))
             (top (nth 1 attr)))
        (set-frame-parameter nil 'fullscreen nil)
        (set-frame-position nil left top)
        (set-frame-size nil width height t))))

  ;;;###autoload
  (defun suk/frame-top-half ()
    "Put the frame to the top-half."
    (interactive)
    (unless (suk/frame--fullscreen-p)
      (suk/frame--save-geometry)
      (let* ((attr (frame-monitor-workarea))
             (width (- (nth 2 attr) 20))
             (height (- (/ (nth 3 attr) 2) 30))
             (left (nth 0 attr))
             (top (nth 1 attr)))
        (set-frame-parameter nil 'fullscreen nil)
        (set-frame-position nil left top)
        (set-frame-size nil width height t))))

  ;;;###autoload
  (defun suk/frame-bottom-half ()
    "Put the frame to the bottom-half."
    (interactive)
    (unless (suk/frame--fullscreen-p)
      (suk/frame--save-geometry)
      (let* ((attr (frame-monitor-workarea))
             (width (- (nth 2 attr) 20))
             (height (- (/ (nth 3 attr) 2) 30))
             (left (nth 0 attr))
             (top (+ (nth 1 attr) height 30)))
        (set-frame-parameter nil 'fullscreen nil)
        (set-frame-position nil left top)
        (set-frame-size nil width height t))))



  (suk-set-key-bindings 'global-set-key
                        (list
                         (list (kbd "C-M-<return>")     #'suk/frame-maximize)
                         (list (kbd "C-M-<backspace>")  #'suk/frame-restore)
                         (list (kbd "C-M-<left>")       #'suk/frame-left-half)
                         (list (kbd "C-M-<right>")      #'suk/frame-right-half)
                         (list (kbd "C-M-<up>")         #'suk/frame-top-half)
                         (list (kbd "C-M-<down>")       #'suk/frame-bottom-half)
                         ))


  ;; è°ƒèŠ‚å±å¹•äº®åº¦
  ;;;###autoload
  (defun suk/set-backlight (&optional light-value)
    (interactive "sè¯·è¾“å…¥äº®åº¦(å°æ•°è¡¨ç¤ºçš„ç™¾åˆ†æ¯”): ")
    (let ((max-backlight (string-to-number (string-trim-right
                                            (shell-command-to-string
                                             "cat /sys/class/backlight/intel_backlight/max_brightness")))))
      (when (and light-value (floatp (string-to-number light-value)))
        (shell-command
         (concat "echo "
                 (format "%d" (* max-backlight (string-to-number light-value)))
                 " > /sys/class/backlight/intel_backlight/brightness")))))

  ;; å¢žåŠ 10%å±å¹•äº®åº¦
  ;;;###autoload
  (defun suk/plus-backlight ()
    (interactive)
    (let* (
           ;; æœ€å¤§äº®åº¦
           (max-backlight (string-to-number (string-trim-right
                                             (shell-command-to-string "cat /sys/class/backlight/intel_backlight/max_brightness"))))
           ;; å½“å‰äº®åº¦
           (current-backlight (string-to-number (string-trim-right
                                                 (shell-command-to-string "cat /sys/class/backlight/intel_backlight/brightness"))))
           ;; å¢žåŠ åŽçš„äº®åº¦
           (add-backlight (+ current-backlight (* max-backlight 0.1))))
      (if (< add-backlight max-backlight)
          (progn (shell-command
                  (concat "echo "
                          (format "%d" add-backlight)
                          " > /sys/class/backlight/intel_backlight/brightness"))
                 (message "äº®åº¦+10%"))
        (message "äº®åº¦MAX!!"))))

  ;; å‡å°‘å±å¹•äº®åº¦
  ;;;###autoload
  (defun suk/less-backlight ()
    (interactive)
    (let* (
           ;; æœ€å¤§äº®åº¦
           (max-backlight (string-to-number (string-trim-right
                                             (shell-command-to-string "cat /sys/class/backlight/intel_backlight/max_brightness"))))
           ;; å½“å‰äº®åº¦
           (current-backlight (string-to-number (string-trim-right
                                                 (shell-command-to-string "cat /sys/class/backlight/intel_backlight/brightness"))))
           ;; å‡å°‘åŽçš„äº®åº¦
           (less-backlight (- current-backlight (* max-backlight 0.1))))
      (if (> less-backlight (* max-backlight 0.1) )
          (progn (shell-command
                  (concat "echo "
                          (format "%d" less-backlight)
                          " > /sys/class/backlight/intel_backlight/brightness"))
                 (message "äº®åº¦-10%"))
        (message "äº®åº¦Min!!"))))



  (require 'load-set-font)

  (unless sys/win32p
    ;; åˆ‡æ¢bufferç„¦ç‚¹æ—¶é«˜äº®åŠ¨ç”»
    (use-package beacon
      :ensure t
      :hook (after-init . beacon-mode))
    )


  (unless sys/win32p
    ;; Mouse & Smooth Scroll
    ;; Scroll one line at a time (less "jumpy" than defaults)
    (when (display-graphic-p)
      (setq mouse-wheel-scroll-amount '(1 ((shift) . hscroll))
            mouse-wheel-scroll-amount-horizontal 1
            mouse-wheel-progressive-speed nil))
    (setq scroll-step 1
          scroll-margin 0
          scroll-conservatively 100000
          auto-window-vscroll nil
          scroll-preserve-screen-position t)

    ;; Good pixel line scrolling
    (if (fboundp 'pixel-scroll-precision-mode)
        (pixel-scroll-precision-mode t)
      (unless sys/macp
        (use-package good-scroll
          :diminish
          :hook (after-init . good-scroll-mode)
          :bind (([remap next] . good-scroll-up-full-screen)
                 ([remap prior] . good-scroll-down-full-screen)))))

    ;; Smooth scrolling over images
    (unless emacs/>=30p
      (use-package iscroll
        :diminish
        :hook (image-mode . iscroll-mode)))

    ;; Use fixed pitch where it's sensible
    (use-package mixed-pitch
      :diminish)
    )
#+end_src
* Jidung boucÃ¼n: etc/init-auto-save.el
** HOIKAI ZIDUNG BÃ’UCÃœN MANGIN.
#+begin_src  emacs-lisp :tangle etc/init-auto-save.el
;;; init-auto-save.el --- Init for auto-save.el
;; Filename: init-auto-save.el
;;; Commentary:
;;
;; Init for auto-save.el
;;
;;; Require

(require 'auto-save)

;;; Code:

(auto-save-enable)
(setq auto-save-silent t)
(setq auto-save-delete-trailing-whitespace t)

(provide 'init-auto-save)

;;; init-auto-save.el ends here

#+end_src

* Kuthou patpui: etc/init-awesome-pair.el
** KuthÃ²u SÃ¶ngÄ£Ã¡n Ge HÃ¡msÃ²u
#+begin_src  emacs-lisp :tangle etc/init-awesome-pair.el
  (require 'awesome-pair)
  (provide 'init-awesome-pair)
  (dolist (hook (list
                 'c-mode-common-hook
                 'c-mode-hook
                 'c++-mode-hook
                 'java-mode-hook
                 'haskell-mode-hook
                 'emacs-lisp-mode-hook
                 'lisp-interaction-mode-hook
                 'lisp-mode-hook
                 'maxima-mode-hook
                 'ielm-mode-hook
                 'sh-mode-hook
                 'makefile-gmake-mode-hook
                 'php-mode-hook
                 'python-mode-hook
                 'js-mode-hook
                 'go-mode-hook
                 'qml-mode-hook
                 'jade-mode-hook
                 'css-mode-hook
                 'ruby-mode-hook
                 'coffee-mode-hook
                 'rust-mode-hook
                 'qmake-mode-hook
                 'lua-mode-hook
                 'swift-mode-hook
                 'minibuffer-inactive-mode-hook
                 ))
    (add-hook hook #'(lambda () (awesome-pair-mode 1))))

  (define-key awesome-pair-mode-map (kbd "(") #'awesome-pair-open-round)
  (define-key awesome-pair-mode-map (kbd "[") #'awesome-pair-open-bracket)
  (define-key awesome-pair-mode-map (kbd "{") #'awesome-pair-open-curly)
  (define-key awesome-pair-mode-map (kbd ")") #'awesome-pair-close-round)
  (define-key awesome-pair-mode-map (kbd "]") #'awesome-pair-close-bracket)
  (define-key awesome-pair-mode-map (kbd "}") #'awesome-pair-close-curly)
  (define-key awesome-pair-mode-map (kbd "SPC") #'awesome-pair-space)
  (define-key awesome-pair-mode-map (kbd "=") #'awesome-pair-equal)
  (define-key awesome-pair-mode-map (kbd "\"") #'awesome-pair-double-quote)

  (define-key awesome-pair-mode-map (kbd "%") #'awesome-pair-match-paren)

  (define-key awesome-pair-mode-map (kbd "M-o") #'awesome-pair-backward-delete)
  (define-key awesome-pair-mode-map (kbd "C-c C-d") #'awesome-pair-forward-delete)
  (define-key awesome-pair-mode-map (kbd "C-k") #'awesome-pair-kill)

  (define-key awesome-pair-mode-map (kbd "M-\"") #'awesome-pair-wrap-double-quote)
  (define-key awesome-pair-mode-map (kbd "M-[") #'awesome-pair-wrap-bracket)
  (define-key awesome-pair-mode-map (kbd "M-{") #'awesome-pair-wrap-curly)
  (define-key awesome-pair-mode-map (kbd "M-(") #'awesome-pair-wrap-round)
  (define-key awesome-pair-mode-map (kbd "M-)") #'awesome-pair-unwrap)

  (define-key awesome-pair-mode-map (kbd "M-p") #'awesome-pair-jump-right)
  (define-key awesome-pair-mode-map (kbd "M-n") #'awesome-pair-jump-left)
  (define-key awesome-pair-mode-map (kbd "M-:") #'awesome-pair-jump-out-pair-and-newline)

#+end_src
* etc/init-bookmark.el
nige hai Emacs zidÃ¡i ge gungnang, tunggo `C-x r m` diuyung bookmark-set
hÃ¡msÃ²u, zÃ¶ng mangin gÃ¡p citji wai bookmark. citji shinggung ji hau,
zau hoyi saiyung `C-x r j` tiudÃ²u mangin gÃ¡p dungjung. cÃªi sÃ¼cim gungnang
jichÃ¼, yÃ¡ hoyi saiyung *register* gungnang tiudÃ²u mÃ²ugo mangin.

#+begin_src emacs-lisp :tangle etc/init-bookmark.el
  ;; init-bookmark.el --- bookmark configurations.	-*- lexical-binding: t -*-
  ;;; Commentary:
  ;;
  ;; Bookmark configuration.
  ;;

  ;;; Code:


  ;; åŒæ­¥æ›´æ–°ä¹¦ç­¾æ–‡ä»¶
  ;; æˆ–è€…é€€å‡ºæ—¶ä¿å­˜
  (setq bookmark-save-flag 1)

  ;;C-x r m (name)  M-x bookmark-set  è®¾ç½®ä¹¦ç­¾
  ;;C-x r b (name)  M-x bookmark-jump  è·³è½¬åˆ°ä¹¦ç­¾
  ;;C-x r l         M-x bookmark-bmenu-list  ä¹¦ç­¾åˆ—è¡¨
  ;;                M-x bookmark-delete  åˆ é™¤ä¹¦ç­¾
  ;;                M-x bookmark-load  è¯»å–å­˜å‚¨ä¹¦ç­¾æ–‡ä»¶

  ;; =========================================================
  ;; æ–¹ä¾¿å¿«é€Ÿè·³åˆ°bookmark
  ;; ---------------------------------------------------------
  ;;;###autoload
  (defun suk/ska-point-to-register()
    "Store cursorposition _fast_ in a register. Use ska-jump-to-register to jump back to the stored position."
    (interactive)
    (setq zmacs-region-stays t)
    (point-to-register 8))
  ;; ---------------------------------------------------------
  ;;;###autoload
  (defun suk/ska-jump-to-register()
    "Switch between current cursorposition and position that was stored with ska-point-to-register."
    (interactive)
    (setq zmacs-region-stays t)
    (let ((tmp (point-marker)))
      (jump-to-register 8)
      (set-register 8 tmp)))

  ;; use init-key.el to load and bind the functions.
  ;;(global-set-key  [C-f7] 'suk/ska-point-to-register)
  ;;(global-set-key  [f7] 'suk/ska-jump-to-register)


  ;; bookmark

  ;; è¿™ä¸ªæ˜¯ Emacs è‡ªå¸¦çš„åŠŸèƒ½ï¼Œé€šè¿‡ C-x r m è°ƒç”¨ bookmark-set å‡½æ•°ï¼Œå°†æ–‡ä»¶å¤¹è®¾ç½®ä¸º
  ;; bookmarkã€‚è®¾ç½®æˆåŠŸä¹‹åŽï¼Œå°±å¯ä»¥ä½¿ç”¨ C-x r j è·³è½¬åˆ°æ–‡ä»¶å¤¹å½“ä¸­ã€‚é™¤ä¹¦ç­¾åŠŸèƒ½ä¹‹å¤„ï¼Œ
  ;; ä¹Ÿå¯ä»¥ä½¿ç”¨ register åŠŸèƒ½è·³è½¬åˆ°æŸä¸ªæ–‡ä»¶ã€‚

  ;; C-x r m <RET>
  ;; Set the bookmark for the visited file, at point.
  ;; C-x r m bookmark <RET>
  ;; Set the bookmark named bookmark at point (bookmark-set).
  ;; C-x r M bookmark <RET>
  ;; Like C-x r m, but don't overwrite an existing bookmark.
  ;; C-x r b bookmark <RET>
  ;; Jump to the bookmark named bookmark (bookmark-jump).
  ;; C-x r l
  ;; List all bookmarks (list-bookmarks).
  ;; M-x bookmark-save
  ;; Save all the current bookmark values in the default bookmark file.
  ;; M-x bookmark-load <RET> filename <RET>
  ;; Load a file named filename that contains a list of bookmark values. You can use this command, as well as bookmark-write, to work with other files of bookmark values in addition to your default bookmark file.
  ;; M-x bookmark-write <RET> filename <RET>
  ;; Save all the current bookmark values in the file filename.
  ;; M-x bookmark-delete <RET> bookmark <RET>
  ;; Delete the bookmark named bookmark.
  ;; M-x bookmark-insert-location <RET> bookmark <RET>
  ;; Insert in the buffer the name of the file that bookmark bookmark points to.
  ;; M-x bookmark-insert <RET> bookmark <RET>
  ;; Insert in the buffer the contents of the file that bookmark bookmark points to.


  ;; Registers allow you to jump to a file or other location quickly.
  ;; To jump to a register, use C-x r j followed by the letter of the register.
  ;; Using registers for all these file shortcuts is probably a bit of
  ;; a waste since I can easily define my own keymap, but since I rarely
  ;; go beyond register A anyway. Also, I might as well add shortcuts for refiling.
  (require 'bookmark)
  (defvar my-refile-map (make-sparse-keymap))
  (defmacro my-defshortcut (key file)
    `(progn
       (set-register ,key (cons 'file ,file))
       (define-key my-refile-map
         (char-to-string ,key)
         (lambda (prefix)
           (interactive "p")
           (let ((org-refile-targets '(((,file) :maxlevel . 6)))
                 (current-prefix-arg (or current-prefix-arg '(4))))
             (call-interactively 'org-refile))))))

  ;;(define-key my-refile-map "," 'my-org-refile-to-previous-in-file)
  (my-defshortcut ?e "~/.emacs.d/init.el")
  (my-defshortcut ?E "~/.emacs.d/custom.el")
  ;; (my-defshortcut ?i "~/cloud/orgzly/Inbox.org")
  ;; (my-defshortcut ?o "~/cloud/orgzly/organizer.org")
  ;; (my-defshortcut ?s "~/personal/sewing.org")
  ;; (my-defshortcut ?b "~/personal/business.org")
  ;; (my-defshortcut ?p "~/personal/google-inbox.org")
  ;; (my-defshortcut ?P "~/personal/google-ideas.org")
  ;; (my-defshortcut ?B "~/Dropbox/books")
  (my-defshortcut ?n "~/notes")
  ;; (my-defshortcut ?N "~/sync/notes/QuickNote.md")
  ;; (my-defshortcut ?w "~/Dropbox/public/sharing/index.org")
  ;; (my-defshortcut ?W "~/Dropbox/public/sharing/blog.org")
  ;; (my-defshortcut ?j "~/personal/journal.org")
  ;; (my-defshortcut ?J "~/cloud/a/Journal.csv")
  ;; (my-defshortcut ?I "~/Dropbox/Inbox")
  ;; (my-defshortcut ?g "~/sachac.github.io/evil-plans/index.org")
  ;; (my-defshortcut ?c "~/code/dev/elisp-course.org")
  ;; (my-defshortcut ?C "~/personal/calendar.org")
  ;; (my-defshortcut ?l "~/dropbox/public/sharing/learning.org")
  ;; (my-defshortcut ?q "~/sync/notes/QuickNote.md")
  ;; (my-defshortcut ?Q "~/personal/questions.org")

  (defun my-bookmark-set ()
    "Set and save bookmark.
  If bookmark with same file name already exists, override it quietly."
    (interactive)
    (my-ensure 'bookmark)
    (bookmark-maybe-load-default-file)

    (let* ((filename (cond
                      ((eq major-mode 'eww-mode)
                       (eww-current-url))
                      (t
                       buffer-file-name)))
           existing-bookmark)
      (when (setq existing-bookmark
                  (cl-find-if (lambda (b)
                                (let* ((f (cdr (assoc 'filename (cdr b)))))
                                  (when (and f (file-exists-p f))
                                    (setq f (file-truename f)))
                                  (string= f filename)))
                              bookmark-alist))
        ;; extract name of existing bookmark
        (setq existing-bookmark (car existing-bookmark)))
      (bookmark-set existing-bookmark)

      ;; save bookmark now
      (bookmark-save)

      (when existing-bookmark
        (message "Saved into existing bookmark \"%s\"" existing-bookmark))))


  (defun my-bookmark-goto ()
    "Open ANY bookmark."
    (interactive)
    (my-ensure 'bookmark)
    (bookmark-maybe-load-default-file)
    ;; do the real thing
    (let* ((cands (delq nil (mapcar #'my-build-bookmark-candidate
                                    (and (boundp 'bookmark-alist)
                                         bookmark-alist))))
           (selected (completing-read "bookmarks:" cands)))
      (when selected
        (bookmark-jump (cdr (assoc selected cands))))))

  (with-eval-after-load 'bookmark
    (defun my-build-bookmark-candidate (bookmark)
      "Re-shape BOOKMARK."
      (let* ((key (cond
                   ((and (assoc 'filename bookmark) (cdr (assoc 'filename bookmark)))
                    (format "%s (%s)" (car bookmark) (cdr (assoc 'filename bookmark))))
                   ((and (assoc 'location bookmark) (cdr (assoc 'location bookmark)))
                    (format "%s (%s)" (car bookmark) (cdr (assoc 'location bookmark))))
                   (t
                    (car bookmark)))))
        ;; key will be displayed
        ;; re-shape the data so full bookmark be passed to ivy-read
        (cons key bookmark)))

    ;; use my own bookmark if it exists
    (let ((file "~/var/.emacs.bmk"))
      (when (file-exists-p file)
        (setq bookmark-default-file file))))

  ;; Bookmark
  (provide 'init-bookmark)
  ;;; init-bookmark.el ends here
#+end_src

** FÃICUK TIU DÃ’U BOOKMARK
#+begin_src emacs-lisp :tangle etc/init-bookmark.el

  ;; =========================================================
  ;; fÃ¡icuk tiu dÃ²u bookmark
  ;; ---------------------------------------------------------
  ;;;###autoload
  (defun suk/ska-point-to-register()
    "Store cursorposition _fast_ in a register. Use ska-jump-to-register to jump back to the stored position."
    (interactive)
    (setq zmacs-region-stays t)
    (point-to-register 8))
  ;; ---------------------------------------------------------
  ;;;###autoload
  (defun suk/ska-jump-to-register()
    "Switch between current cursorposition and position that was stored with ska-point-to-register."
    (interactive)
    (setq zmacs-region-stays t)
    (let ((tmp (point-marker)))
          (jump-to-register 8)
          (set-register 8 tmp)))

  ;; use init-key.el to load and bind the functions.
  ;;(global-set-key  [C-f7] 'suk/ska-point-to-register)
  ;;(global-set-key  [f7] 'suk/ska-jump-to-register)
#+end_src
** FÃICUK TIUDÃ’U MANGIN
#+begin_src emacs-lisp :tangle etc/init-bookmark.el

;; Registers allow you to jump to a file or other location quickly.
;; To jump to a register, use C-x r j followed by the letter of the register.
;; Using registers for all these file shortcuts is probably a bit of
;; a waste since I can easily define my own keymap, but since I rarely
;; go beyond register A anyway. Also, I might as well add shortcuts for refiling.
(require 'bookmark)
(defvar my-refile-map (make-sparse-keymap))
(defmacro my-defshortcut (key file)
  `(progn
     (set-register ,key (cons 'file ,file))
     (define-key my-refile-map
       (char-to-string ,key)
       (lambda (prefix)
         (interactive "p")
         (let ((org-refile-targets '(((,file) :maxlevel . 6)))
               (current-prefix-arg (or current-prefix-arg '(4))))
           (call-interactively 'org-refile))))))

;;(define-key my-refile-map "," 'my-org-refile-to-previous-in-file)
(my-defshortcut ?e "~/.emacs.d/init.el")
(my-defshortcut ?E "~/.emacs.d/custom.el")
;; (my-defshortcut ?i "~/cloud/orgzly/Inbox.org")
;; (my-defshortcut ?o "~/cloud/orgzly/organizer.org")
;; (my-defshortcut ?s "~/personal/sewing.org")
;; (my-defshortcut ?b "~/personal/business.org")
;; (my-defshortcut ?p "~/personal/google-inbox.org")
;; (my-defshortcut ?P "~/personal/google-ideas.org")
;; (my-defshortcut ?B "~/Dropbox/books")
(my-defshortcut ?n "~/notes")
;; (my-defshortcut ?N "~/sync/notes/QuickNote.md")
;; (my-defshortcut ?w "~/Dropbox/public/sharing/index.org")
;; (my-defshortcut ?W "~/Dropbox/public/sharing/blog.org")
;; (my-defshortcut ?j "~/personal/journal.org")
;; (my-defshortcut ?J "~/cloud/a/Journal.csv")
;; (my-defshortcut ?I "~/Dropbox/Inbox")
;; (my-defshortcut ?g "~/sachac.github.io/evil-plans/index.org")
;; (my-defshortcut ?c "~/code/dev/elisp-course.org")
;; (my-defshortcut ?C "~/personal/calendar.org")
;; (my-defshortcut ?l "~/dropbox/public/sharing/learning.org")
;; (my-defshortcut ?q "~/sync/notes/QuickNote.md")
;; (my-defshortcut ?Q "~/personal/questions.org")


#+end_src
* etc/init-buffers.el
** Citding Yitgin
#+begin_src emacs-lisp :tangle etc/init-buffers.el
  ;;; init-buffers.el --- Initialize buffers configurations. -*- lexical-binding: t -*-

  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require '+func)
    (require 'buffer-extension))

  (suk-set-key-bindings
   'global-set-key
   (list
    ;;(list (kbd "C-x b l") #'suk/count-brf-lines)

    (list (kbd "C-x x x") #'suk/switch-major-mode)
    (list (kbd "C-x x X") #'suk/get-mode-name)
    (list (kbd "C-x x n") #'suk/new-empty-buffer)
    (list (kbd "C-x x s") #'suk/create-scratch-buffer)
    (list (kbd "C-x x O") #'suk/create-scratch-org)
    (list (kbd "C-x x o") #'suk/new-org-buffer)
    (list (kbd "C-x x m") #'suk/switch-to-minibuffer)
    (list (kbd "C-x x c") #'copy-buffer-file-name-as-kill)
    (list (kbd "C-x x t") #'suk/toggle-margin-right)
    (list (kbd "C-x k")   #'suk/close-current-buffer)
    (list (kbd "C-x C-k")   #'suk/kill-all-buffers-except-current)
    (list (kbd "C-x K")  #'suk/kill-other-window-buffer) ;å…³é—­å…¶ä»–çª—å£çš„
    (list (kbd "C-x x u") #'suk/revert-buffer-with-utf8)
    (list (kbd "C-x x g") #'suk/revert-buffer-with-gbk)
    ;;'([C-t]               transpose-chars)
    ;;'([S-f6]              hs-minor-mode)
    ;;'([S-f5]              toggle-truncate-lines)
    (list (kbd "C-S-t") #'suk/open-last-closed)
    (list (kbd "C-x R") #'recentf-open)
    (list (kbd "C-S-<f6>") #'suk/move-buffer-file)
    (list (kbd "C-S-<f2>")  #'suk/rename-file-and-buffer)
    ))

  (with-eval-after-load 'hydra
    (defhydra my-hydra-buffers ()
      "
  Describe Something: (q to quit)
  ^Open/Clsoe^         ^Actions^               ^Creation^
  -------------------------------------------------------------------
  _m_inbuffer          s_w_itch mode           _n_ew
  _u_tf-8 realod       _G_et mode              _s_cratch
  _g_bk reload         _c_opy name             _o_rg
  _l_ast reopen        _M_ove                  _O_rg scratch
  _r_ecentf            _t_oggle margin right
  _k_ close current    re_n_ame
  close _A_ll
  _K_ close other
  "

      ("n" suk/new-empty-buffer)
      ("s" suk/create-scratch-buffer)
      ("O" suk/create-scratch-org)
      ("o" suk/new-org-buffer)

      ("k" suk/close-current-buffer)
      ("A" suk/kill-all-buffers-except-current)
      ("K" suk/kill-other-window-buffer) ;å…³é—­å…¶ä»–çª—å£çš„

      ("w" suk/switch-major-mode)
      ("G" suk/get-mode-name)
      ("c" copy-buffer-file-name-as-kill)
      ("M" suk/move-buffer-file)
      ("n" suk/rename-file-and-buffer)
      ("t" suk/toggle-margin-right)

      ("m" suk/switch-to-minibuffer)
      ("u" suk/revert-buffer-with-utf8)
      ("g" suk/revert-buffer-with-gbk)
      ("l" suk/open-last-closed)
      ("r" recentf-open)


      ("q" nil))
    (global-set-key (kbd "C-c b") 'my-hydra-buffers/body)
    )


  (provide 'init-buffers)
  ;;; init-buffers.el ends here
#+end_src
* etc/init-edit.el
#+begin_src emacs-lisp :tangle etc/init-edit.el
  ;; -*- coding: utf-8; lexical-binding: t; -*-

  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require '+func)
    (require 'init-package)
    )


  ;; @see http://endlessparentheses.com/super-smart-capitalization.html
  ;;;###autoload
  (defun endless/convert-punctuation (rg rp)
    "Look for regexp RG around point, and replace with RP.
  Only applies to text-mode."
    (let* ((f "\\(%s\\)\\(%s\\)")
           (space "?:[[:blank:]\n\r]*"))
      ;; We obviously don't want to do this in prog-mode.
      (if (and (derived-mode-p 'text-mode)
               (or (looking-at (format f space rg))
                   (looking-back (format f rg space) (point-min))))
          (replace-match rp nil nil nil 1))))
  ;;;###autoload
  (defun endless/call-subword-cmd (fn)
    (my-ensure 'subword)
    (call-interactively fn))
  ;;;###autoload
  (defun endless/capitalize ()
    "Capitalize region or word.
  Also converts commas to full stops, and kills
  extraneous space at beginning of line."
    (interactive)
    (endless/convert-punctuation "," ".")
    (if (use-region-p)
        (call-interactively 'capitalize-region)
      ;; A single space at the start of a line:
      (when (looking-at "^\\s-\\b")
        ;; get rid of it!
        (delete-char 1))
      (endless/call-subword-cmd 'subword-capitalize)))
  ;;;###autoload
  (defun endless/downcase ()
    "Downcase region or word.
  Also converts full stops to commas."
    (interactive)
    (endless/convert-punctuation "\\." ",")
    (if (use-region-p)
        (call-interactively 'downcase-region)
      (endless/call-subword-cmd 'subword-downcase)))
  ;;;###autoload
  (defun endless/upcase ()
    "Upcase region or word."
    (interactive)
    (if (use-region-p)
        (call-interactively 'upcase-region)
      (endless/call-subword-cmd 'subword-upcase)))

  ;; these bindings are fine
  (global-set-key (kbd "M-c") 'endless/capitalize)
  (global-set-key (kbd "M-l") 'endless/downcase)
  (global-set-key (kbd "M-u") 'endless/upcase)

  (my-run-with-idle-timer
   2
   #'(lambda()
       ;; expand-region :load-path "~/.emacs.d/extensions/expand-region"
       (lazy-load-global-keys
        '(("C-+" . er/expand-region))
        "expand-region")
       (with-eval-after-load 'expand-region
         (when (suk-treesit-available-p)
           (defun treesit-mark-bigger-node ()
             "Use tree-sitter to mark regions."
             (let* ((root (treesit-buffer-root-node))
                    (node (treesit-node-descendant-for-range root (region-beginning) (region-end)))
                    (node-start (treesit-node-start node))
                    (node-end (treesit-node-end node)))
               ;; Node fits the region exactly. Try its parent node instead.
               (when (and (= (region-beginning) node-start) (= (region-end) node-end))
                 (when-let ((node (treesit-node-parent node)))
                   (setq node-start (treesit-node-start node)
                         node-end (treesit-node-end node))))
               (set-mark node-end)
               (goto-char node-start)))
           ))))

  ;; ;; Jump to Chinese characters
  ;; (use-package ace-pinyin
  ;;   :diminish
  ;;   :hook (after-init . ace-pinyin-global-mode))

  ;; Minor mode to aggressively keep your code always indented
  (use-package aggressive-indent
    :diminish
    :defer 2
    :hook ((after-init . global-aggressive-indent-mode)
           ;; NOTE: Disable in large files due to the performance issues
           ;; https://github.com/Malabarba/aggressive-indent-mode/issues/73
           (find-file . (lambda ()
                          (when (too-long-file-p)
                            (aggressive-indent-mode -1)))))
    :config
    ;; Disable in some modes
    (dolist (mode '(gitconfig-mode
                    asm-mode web-mode html-mode css-mode
                    go-mode scala-mode
                    shell-mode term-mode vterm-mode
                    prolog-inferior-mode))
      (add-to-list 'aggressive-indent-excluded-modes mode))

    ;; Disable in some commands
    (add-to-list 'aggressive-indent-protected-commands #'delete-trailing-whitespace t)

    ;; Be slightly less aggressive in C/C++/C#/Java/Go/Swift
    (add-to-list 'aggressive-indent-dont-indent-if
                 '(and (derived-mode-p 'c-mode 'c++-mode 'csharp-mode
                                       'java-mode 'go-mode 'swift-mode)
                       (null (string-match "\\([;{}]\\|\\b\\(if\\|for\\|while\\)\\b\\)"
                                           )))))

  ;; Rectangle
  (use-package rect
    :ensure nil
    :defer 2
    :bind (:map text-mode-map
           ("<C-return>" . rect-hydra/body)
           :map prog-mode-map
           ("<C-return>" . rect-hydra/body))
    :init
    (with-eval-after-load 'org
      (bind-key "<s-return>" #'rect-hydra/body org-mode-map))
    (with-eval-after-load 'wgrep
      (bind-key "<C-return>" #'rect-hydra/body wgrep-mode-map))
    (with-eval-after-load 'wdired
      (bind-key "<C-return>" #'rect-hydra/body wdired-mode-map))
    :pretty-hydra
    ((:title (pretty-hydra-title "Rectangle" 'mdicon "nf-md-border_all")
      :color amaranth :body-pre (rectangle-mark-mode) :post (deactivate-mark) :quit-key ("q" "C-g"))
     ("Move"
      (("h" backward-char "â†")
       ("j" next-line "â†“")
       ("k" previous-line "â†‘")
       ("l" forward-char "â†’"))
      "Action"
      (("w" copy-rectangle-as-kill "copy") ; C-x r M-w
       ("y" yank-rectangle "yank")         ; C-x r y
       ("t" string-rectangle "string")     ; C-x r t
       ("d" kill-rectangle "kill")         ; C-x r d
       ("c" clear-rectangle "clear")       ; C-x r c
       ("o" open-rectangle "open"))        ; C-x r o
      "Misc"
      (("N" rectangle-number-lines "number lines")        ; C-x r N
       ("e" rectangle-exchange-point-and-mark "exchange") ; C-x C-x
       ("u" undo "undo")
       ("r" (if (region-active-p)
                (deactivate-mark)
              (rectangle-mark-mode 1))
        "reset")))))

  ;; Automatically reload files was modified by external program
  (use-package autorevert
    :ensure nil
    :diminish
    :defer 2
    :hook (after-init . global-auto-revert-mode))

  ;; Pass a URL to a WWW browser
  (use-package browse-url
    :ensure nil
    :defer 2
    :defines dired-mode-map
    :bind (("C-c C-z ." . browse-url-at-point)
           ("C-c C-z b" . browse-url-of-buffer)
           ("C-c C-z r" . browse-url-of-region)
           ("C-c C-z u" . browse-url)
           ("C-c C-z e" . browse-url-emacs)
           ("C-c C-z v" . browse-url-of-file))
    :init
    (with-eval-after-load 'dired
      (bind-key "C-c C-z f" #'browse-url-of-file dired-mode-map))

    (let ((cmd-exe "c:/Windows/System32/cmd.exe")
          (cmd-args '("/c" "start")))
      (when (file-exists-p cmd-exe)
        (setq browse-url-generic-program  cmd-exe
              browse-url-generic-args     cmd-args
              browse-url-browser-function 'browse-url-generic)
        (when (daemonp)
          (advice-add #'browse-url :override #'browse-url-generic)))))

  ;; Jump to things in Emacs tree-style
  (my-run-with-idle-timer
   2
   #'(lambda()
       (with-eval-after-load 'avy
         (setq avy-all-windows nil
               avy-all-windows-alt t
               avy-background t
               avy-style 'pre)
         (add-hook 'after-init-hook #'avy-setup-default)
         )

       (lazy-load-global-keys
        ' (("C-:"   . avy-goto-char)
           ("C-'"   . avy-goto-char-2)
           ("M-g l" . avy-goto-line)
           ("M-g w" . avy-goto-word-1)
           ("M-g e" . avy-goto-word-0))
        "avy")
       ;; Kill text between the point and the character CHAR
       (lazy-load-global-keys
        '(("M-z" . avy-zap-to-char-dwim)
          ("M-Z" . avy-zap-up-to-char-dwim))
        "avy-zap")

       ))

  ;; Show number of matches in mode-line while searching
  (my-run-with-idle-timer
   2
   #'(lambda()
       (use-package anzu
         :diminish
         :bind (([remap query-replace] . anzu-query-replace)
                ([remap query-replace-regexp] . anzu-query-replace-regexp)
                :map isearch-mode-map
                ([remap isearch-query-replace] . anzu-isearch-query-replace)
                ([remap isearch-query-replace-regexp] . anzu-isearch-query-replace-regexp))
         :hook (after-init . global-anzu-mode))))

  ;; Redefine M-< and M-> for some modes
  (my-run-with-idle-timer
   2
   #'(lambda()
       (require 'beginend)
       (add-hook 'after-init-hook #'(beginend-global-mode))
       (mapc (lambda (pair)
               (diminish (cdr pair)))
             beginend-modes)))

  (my-run-with-idle-timer 2 #'(lambda()(require 'hungry-delete)))

  (with-eval-after-load 'hungry-delete
    (setq hungry-delete-chars-to-skip " \t\f\v"
          hungry-delete-except-modes
          '(help-mode minibuffer-mode minibuffer-inactive-mode calc-mode))
    )


  ;; Treat undo history as a tree, ^x u
  (if emacs/>=28p
      (progn
        ;; vundo :load-path "~/.emacs.d/extensions/vundo"
        (lazy-load-global-keys
         '(("C-x u" . vundo)
           ("C-/" . vundo)
           )
         "vundo")
        (with-eval-after-load 'vundo
          (setq vundo-glyph-alist vundo-unicode-symbols)))
    (progn
      ;; use undo-tree
      (setq undo-tree-visualizer-timestamps t
            undo-tree-visualizer-diff t
            undo-tree-enable-undo-in-region nil
            undo-tree-auto-save-history nil)
      ;; HACK: keep the diff window
      (with-no-warnings
        (make-variable-buffer-local 'undo-tree-visualizer-diff)
        (setq-default undo-tree-visualizer-diff t))

      (lazy-load-global-keys
       '(("C-x u" . undo-trees)
         ("C-/" . undo-tree-undo)
         ("C-?" . undo-tree-redo)
         )
       "undo-tree")

      (with-eval-after-load 'undo-tree
        (add-hook 'after-init-hook #'global-undo-tree-mode))
      ))

  ;; Goto last change
  (my-run-with-idle-timer 2 #'(lambda()(require 'goto-chg)))

  ;; Handling capitalized subwords in a nomenclature
  (my-run-with-idle-timer
   2
   #'(lambda()
       (require 'subword)
       (add-hook 'prog-mode-hook #'subword-mode)
       (add-hook 'mimibuffer-setup #'subword-mode)
       ))
  ;; Flexible text folding
  (use-package hideshow
    :ensure nil
    :diminish hs-minor-mode
    :pretty-hydra
    ((:title (pretty-hydra-title "HideShow" 'octicon "nf-oct-fold")
      :color amaranth :quit-key ("q" "C-g"))
     ("Fold"
      (("t" hs-toggle-all "toggle all")
       ("a" hs-show-all "show all")
       ("i" hs-hide-all "hide all")
       ("g" hs-toggle-hiding "toggle hiding")
       ("c" hs-cycle "cycle block")
       ("s" hs-show-block "show block")
       ("h" hs-hide-block "hide block")
       ("l" hs-hide-level "hide level"))
      "Move"
      (("C-a" mwim-beginning-of-code-or-line "â­°")
       ("C-e" mwim-end-of-code-or-line "â­²")
       ("C-b" backward-char "â†")
       ("C-n" next-line "â†“")
       ("C-p" previous-line "â†‘")
       ("C-f" forward-char "â†’")
       ("C-v" pager-page-down "â†˜")
       ("M-v" pager-page-up "â†–")
       ("M-<" beginning-of-buffer "â­¶")
       ("M->" end-of-buffer "â­¸"))))
    :bind (:map hs-minor-mode-map
           ("C-~" . hideshow-hydra/body)
           ("C-S-<escape>" . hideshow-hydra/body))
    :hook (prog-mode . hs-minor-mode)
    :config
    ;; More functions
    ;; @see https://karthinks.com/software/simple-folding-with-hideshow/
    (defun hs-cycle (&optional level)
      (interactive "p")
      (let (message-log-max
            (inhibit-message t))
        (if (= level 1)
            (pcase last-command
              ('hs-cycle
               (hs-hide-level 1)
               (setq this-command 'hs-cycle-children))
              ('hs-cycle-children
               (save-excursion (hs-show-block))
               (setq this-command 'hs-cycle-subtree))
              ('hs-cycle-subtree
               (hs-hide-block))
              (_
               (if (not (hs-already-hidden-p))
                   (hs-hide-block)
                 (hs-hide-level 1)
                 (setq this-command 'hs-cycle-children))))
          (hs-hide-level level)
          (setq this-command 'hs-hide-level))))

    (defun hs-toggle-all ()
      "Toggle hide/show all."
      (interactive)
      (pcase last-command
        ('hs-toggle-all
         (save-excursion (hs-show-all))
         (setq this-command 'hs-global-show))
        (_ (hs-hide-all))))

    ;; Display line counts
    (defun hs-display-code-line-counts (ov)
      "Display line counts when hiding codes."
      (when (eq 'code (overlay-get ov 'hs))
        (overlay-put ov 'display
                     (concat
                      " "
                      (propertize
                       (if (char-displayable-p ?â·) "â·" "...")
                       'face 'shadow)
                      (propertize
                       (format " (%d lines)"
                               (count-lines (overlay-start ov)
                                            (overlay-end ov)))
                       'face '(:inherit shadow :height 0.8))
                      " "))))
    )

  ;; Hanlde minified code
  (if emacs/>=27p
      (add-hook 'after-init-hook #'global-so-long-mode))


  (lazy-load-global-keys
   '(
     ("<f7>" . olivetti-mode))
   "olivetti")

  (unless sys/win32p
    ;; Open files as another user
    (my-run-with-idle-timer 2 #'(use-package sudo-edit))
    ;; On-the-fly spell checker
    (use-package flyspell
      :ensure t
      :defer 2
      :diminish flyspell-mode
      :if (executable-find "aspell")
      :hook (((text-mode outline-mode) . flyspell-mode)
             (prog-mode . flyspell-prog-mode)
             (flyspell-mode . (lambda ()
                                (unbind-key "C-;" flyspell-mode-map)
                                (unbind-key "C-," flyspell-mode-map)
                                (unbind-key "C-." flyspell-mode-map))))
      :init
      (setq flyspell-issue-message-flag nil)
      (setq ispell-program-name "aspell")
      (setq ispell-extra-args '("--sug-mode=ultra" "--lang=en_US" "--run-together")))

    )
  (provide 'init-edit)
#+end_src
* etc/init-calendar.el
#+begin_src emacs-lisp :tangle etc/init-calendar.el
(provide 'init-calendar)
;;; è®¾ç½®æ—¥åŽ† ;;;;;;
;; Emacs Calender
;;
;; Emacs ä¸­æœ‰æ—¥åŽ†ï¼Œè€Œä¸”å¯ä»¥ç§°ä¹‹ä¸ºä¸€ä¸ªç³»ç»Ÿï¼Œå› ä¸ºå…¶ä¸­é™¤äº†æœ€å¸¸ç”¨çš„æ—¥åŽ†ä¹‹å¤–ï¼Œ
;; è¿˜æœ‰å…¶ä»–çš„è¿‘åç§åŽ†æ³•ï¼Œå…¶ä¸­æœ‰æ—¥è®°ã€çº¦ä¼šæé†’ã€çºªå¿µæ—¥æç¤ºä»¥åŠèŠ‚å‡æ—¥æç¤ºç­‰
;; ç­‰ã€‚å…¶ä¸­çš„åŽ†æ³•åŒ…æ‹¬ä¸­å›½çš„å†œåŽ†ã€å¸Œä¼¯æ¥åŽ†ã€ä¼Šæ–¯å…°åŽ†ã€æ³•å›½é©å‘½åŽ†ã€ä¸­ç¾ŽçŽ›é›…
;; åŽ†ç­‰ç­‰ï¼Œå¯ä»¥æ ¹æ®ç»çº¬åº¦å‘ŠçŸ¥ä½ çš„æ‰€åœ¨çš„æ¯å¤©æ—¥å‡ºæ—¥è½çš„æ—¶é—´ç­‰ç­‰ã€‚
;;
;; holiday-fixed m d    å›ºå®šé˜³åŽ†èŠ‚æ—¥ï¼Œ m æœˆ d æ—¥
;; holiday-float m w n æµ®åŠ¨é˜³åŽ†èŠ‚æ—¥ï¼Œ m æœˆçš„ç¬¬ n ä¸ªæ˜ŸæœŸ w%7
;;
;; ----------------------------------------------
;; .    è·³å›žå½“å‰å¤©
;; o    è·³åˆ°æŸä¸€ä¸ªæœˆ
;; g d    è·³åˆ°æŸå¹´æŸæœˆæŸæ—¥
;; g c    è·³åˆ°æŸå¹´æŸæ˜ŸæœŸçš„æ˜ŸæœŸå‡ 
;; g C    è·³åˆ°é˜´åŽ†çš„æŸä¸€å¤©
;; p C    æ˜¾ç¤ºå½“å‰çš„é˜´åŽ†æ—¥æœŸ
;; h    æ˜¾ç¤ºå½“å‰èŠ‚æ—¥
;; i d    åŠ å…¥å½“å‰è¿™ä¸€å¤©çš„æ—¥ç¨‹å®‰æŽ’
;; i w    åŠ å…¥æ¯å‘¨è¿™ä¸€å¤©çš„æ—¥ç¨‹å®‰æŽ’
;; i m    åŠ å…¥æ¯æœˆè¿™ä¸€å¤©çš„æ—¥ç¨‹å®‰æŽ’
;; i y    åŠ å…¥æ¯å¹´è¿™ä¸€å¤©çš„æ—¥ç¨‹å®‰æŽ’
;; i a    åŠ å…¥å‘¨å¹´çºªå¿µï¼ˆanniversaryï¼‰ï¼Œæ¯”å¦‚ç”Ÿæ—¥ç­‰
;; d    å¯Ÿçœ‹å½“å‰æ—¥æœŸçš„diary
;; -----------------------------------------------
;;

(defun animals(birthyear)
  "Calculate the Chinese aninal by year"
  (let ((x (% (- 1997 birthyear) 12)))
    (cond ((or (= x 1) (= x -11))  "é¼ ")
          ((= x 0)                 "ç‰›")
          ((or (= x 11) (= x -1))  "è™Ž")
          ((or (= x 10) (= x -2))  "å…”")
          ((or (= x 9) (= x -3))   "é¾™")
          ((or (= x 8) (= x -4))   "è›‡")
          ((or (= x 7) (= x -5))   "é©¬")
          ((or (= x 6) (= x -6))   "ç¾Š")
          ((or (= x 5) (= x -7))   "çŒ´")
          ((or (= x 4) (= x -8))   "é¸¡")
          ((or (= x 3) (= x -9))   "ç‹—")
          ((or (= x 2) (= x -10))  "çŒª")
          )
    )
  )


(setq diary-mail-addr user-mail-address)
(add-hook 'diary-hook 'appt-make-list)
;;appointment
(setq appt-issue-message t)

(autoload 'calendar-chinese-year "cal-china" "Chinese year data" t)
(require 'cal-china-x)
;; Holidays
;;é™¤åŽ»åŸºç£å¾’çš„èŠ‚æ—¥ã€å¸Œä¼¯æ¥äººçš„èŠ‚æ—¥å’Œä¼Šæ–¯å…°æ•™çš„èŠ‚æ—¥ã€‚
(setq hebrew-holidays nil
      islamic-holidays nil
      solar-holidays nil
      bahai-holidays nil
	  ;; christian-holidays nil
      )
(setq calendar-mark-holidays-flag t
      cal-china-x-important-holidays cal-china-x-chinese-holidays
      cal-china-x-general-holidays '((holiday-lunar 1 15 "å…ƒå®µèŠ‚")
                                     (holiday-lunar 7 7 "ä¸ƒå¤•èŠ‚")
                                     ;; ç”Ÿæ—¥
                                     (holiday-lunar 7 16  "è€è±†ç”Ÿæ—¥ (ä¸ƒæœˆåå…­)" );é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-lunar 1 10  "è€æ¯ç”Ÿæ—¥ (æ­£æœˆåˆå)" );é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-lunar 4 4  "è€æ¯ç”Ÿæ—¥ (å››æœˆåˆå››)" );é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-lunar 10 18 "æˆ‘å˜…ç”Ÿæ—¥ (åæœˆåå…«)" );é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-lunar 9 1   "ç´°ä½¬ç”Ÿæ—¥ (ä¹æœˆåˆä¸€)") ;é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-lunar 3 2   "å¥³å„¿ç”Ÿæ—¥ (ä¸‰æœˆåˆäºŒ)") ;é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-fixed 4 8   "å¥³å„¿ç”Ÿæ—¥ (4æœˆ8æ—¥)")   ;é˜³åŽ†ç”Ÿæ—¥
                                     (holiday-fixed 10 12  "å¥³å„¿ç”Ÿæ—¥ (10æœˆ12æ—¥)") ;é˜³åŽ†ç”Ÿæ—¥
                                     (holiday-lunar 9 14   "å¥³å„¿ç”Ÿæ—¥ (ä¹æœˆåå››)") ;é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-lunar 6 21  "è€å©†ç”Ÿæ—¥ (å…­æœˆå»¿ä¸€)") ;é˜´åŽ†ç”Ÿæ—¥
                                     (holiday-fixed 3 8 "å¦‡å¥³èŠ‚")
                                     (holiday-fixed 3 12 "æ¤æ ‘èŠ‚")
                                     (holiday-fixed 5 4 "é’å¹´èŠ‚")
                                     (holiday-fixed 6 1 "å„¿ç«¥èŠ‚")
                                     (holiday-fixed 9 10 "æ•™å¸ˆèŠ‚"))
      holiday-other-holidays '((holiday-fixed 2 14 "æƒ…äººèŠ‚")
                               (holiday-fixed 4 1 "æ„šäººèŠ‚")
                               (holiday-fixed 12 25 "åœ£è¯žèŠ‚")
                               (holiday-float 5 0 2 "æ¯äº²èŠ‚")
                               (holiday-float 6 0 3 "çˆ¶äº²èŠ‚")
                               (holiday-float 11 4 4 "æ„Ÿæ©èŠ‚"))
      calendar-holidays (append cal-china-x-important-holidays
                                cal-china-x-general-holidays
                                cal-china-x-japanese-holidays
              					holiday-general-holidays
              					holiday-christian-holidays
                                holiday-other-holidays))



(setq general-holidays '((holiday-fixed 1 1   "å…ƒæ—¦")
                         (holiday-fixed 2 14  "æƒ…äººèŠ‚")
                         (holiday-fixed 4 1   "æ„šäººèŠ‚")
                         (holiday-fixed 12 25 "åœ£è¯žèŠ‚")
                         (holiday-fixed 10 1  "å›½åº†èŠ‚")
                         (holiday-float 5 0 2 "æ¯äº²èŠ‚")   ;5æœˆçš„ç¬¬äºŒä¸ªæ˜ŸæœŸå¤©
                         (holiday-float 6 0 3 "çˆ¶äº²èŠ‚")
                         ))

(setq local-holidays '((holiday-chinese 1 15  "å…ƒå®µèŠ‚ (æ­£æœˆåäº”)")
                       (holiday-chinese 5 5   "ç«¯åˆèŠ‚ (äº”æœˆåˆäº”)")
                       (holiday-chinese 9 9   "é‡é˜³èŠ‚ (ä¹æœˆåˆä¹)")
                       (holiday-chinese 8 15  "ä¸­ç§‹èŠ‚ (å…«æœˆåäº”)")
                       ;; ç”Ÿæ—¥
                       (holiday-chinese 7 16  "è€è±†ç”Ÿæ—¥ (ä¸ƒæœˆåå…­)" );é˜´åŽ†ç”Ÿæ—¥
                       (holiday-chinese 1 10  "è€æ¯ç”Ÿæ—¥ (æ­£æœˆåˆå)" );é˜´åŽ†ç”Ÿæ—¥
                       (holiday-chinese 4 4  "è€æ¯ç”Ÿæ—¥ (å››æœˆåˆå››)" );é˜´åŽ†ç”Ÿæ—¥
                       (holiday-chinese 10 18 "æˆ‘å˜…ç”Ÿæ—¥ (åæœˆåå…«)" );é˜´åŽ†ç”Ÿæ—¥
                       (holiday-chinese 9 1   "ç´°ä½¬ç”Ÿæ—¥ (ä¹æœˆåˆä¸€)") ;é˜´åŽ†ç”Ÿæ—¥
                       (holiday-chinese 3 2   "å¥³å„¿ç”Ÿæ—¥ (ä¸‰æœˆåˆäºŒ)") ;é˜´åŽ†ç”Ÿæ—¥
                       (holiday-fixed   4 8   "å¥³å„¿ç”Ÿæ—¥ (4æœˆ8æ—¥)")   ;é˜³åŽ†ç”Ÿæ—¥
                       (holiday-fixed   10 12  "å¥³å„¿ç”Ÿæ—¥ (10æœˆ12æ—¥)") ;é˜³åŽ†ç”Ÿæ—¥
                       (holiday-chinese 9 14   "å¥³å„¿ç”Ÿæ—¥ (ä¹æœˆåå››)") ;é˜´åŽ†ç”Ÿæ—¥
                       (holiday-chinese 6 21  "è€å©†ç”Ÿæ—¥ (å…­æœˆå»¿ä¸€)") ;é˜´åŽ†ç”Ÿæ—¥
                       ))

(setq chinese-calendar-celestial-stem
      ["ç”²" "ä¹™" "ä¸™" "ä¸" "æˆŠ" "å·±" "åºš" "è¾›" "å£¬" "ç™¸"])
(setq chinese-calendar-terrestrial-branch
      ["å­" "ä¸‘" "å¯…" "å¯" "è¾°" "å·³" "åˆ" "æœª" "ç”³" "é…‰" "æˆŒ" "äº¥"])

(setq mark-diary-entries-in-calendar t
      appt-issue-message nil
      mark-holidays-in-calendar t
      view-calendar-holidays-initially nil)

(setq diary-date-forms '((year "/" month "/" day "[^/0-9]"))
      calendar-date-display-form '(year "/" month "/" day)
      calendar-time-display-form
      '(24-hours ":" minutes (if time-zone " (") time-zone (if time-zone ")")))

(add-hook 'today-visible-calendar-hook 'calendar-mark-today)



(defun holiday-chinese (cmonth cday string)
  "Chinese calendar holiday, month and day in Chinese calendar (CMONTH, CDAY).

If corresponding MONTH and DAY in gregorian calendar is visible,
the value returned is the list \(((MONTH DAY year) STRING)).
Returns nil if it is not visible in the current calendar window."
  (let* ((m displayed-month)
     (y displayed-year)
     (gdate (calendar-gregorian-from-absolute
         (+ (cadr (assoc cmonth (calendar-chinese-year y))) (1- cday))))
     (gm (car gdate))
     (gd (cadr gdate))
     (gy (caddr gdate)))
    (increment-calendar-month m y (- 11 gm))
    (if (> m 9)
        (list (list (list gm gd gy) string)))))

(defun birthday-fixed (month day string)
  "Holiday on MONTH, DAY (Gregorian) called STRING.
If MONTH, DAY is visible, the value returned is the list (((MONTH DAY year)
STRING)).  Returns nil if it is not visible in the current calendar window."
  (let ((m displayed-month)
        (y displayed-year)
        (animal (animals (string-to-number (nth 1 (split-string string "(")))))
        )
    (increment-calendar-month m y (- 11 month))
    (if (> m 9)
      (list (list (list month day y) string animal)))))


;;è®¾ç½®æˆ‘æ‰€åœ¨åœ°æ–¹çš„ç»çº¬åº¦ï¼Œcalendaré‡Œæœ‰ä¸ªåŠŸèƒ½æ˜¯æ—¥æœˆé£Ÿçš„é¢„æµ‹ï¼Œå’Œä½ çš„ç»çº¬åº¦ç›¸è”ç³»çš„ã€‚
;; è®©emacsèƒ½è®¡ç®—æ—¥å‡ºæ—¥è½çš„æ—¶é—´ï¼Œåœ¨ calendar ä¸Šç”¨ S å³å¯çœ‹åˆ°
(setq calendar-latitude +35.6764)
(setq calendar-longitude +139.6500)
(setq calendar-location-name "æ±äº¬")


;; è®¾ç½® calendar çš„æ˜¾ç¤º
(setq calendar-remove-frame-by-deleting t)
(setq calendar-week-start-day 1) ; è®¾ç½®æ˜ŸæœŸä¸€ä¸ºæ¯å‘¨çš„ç¬¬ä¸€å¤©
(setq mark-diary-entries-in-calendar t) ; æ ‡è®°calendarä¸Šæœ‰diaryçš„æ—¥æœŸ
(setq mark-holidays-in-calendar nil) ; ä¸ºäº†çªå‡ºæœ‰diaryçš„æ—¥æœŸï¼Œcalendarä¸Šä¸æ ‡è®°èŠ‚æ—¥
(setq view-calendar-holidays-initially nil) ; æ‰“å¼€calendarçš„æ—¶å€™ä¸æ˜¾ç¤ºä¸€å †èŠ‚æ—¥

;; bind `s-<F11>` in init-key.el
;;(global-set-key (kbd "<f11>") 'calendar)

#+end_src
* etc/init-dired.el
#+begin_src emacs-lisp :tangle etc/init-dired.el
  ;; -*- coding: utf-8; lexical-binding: t; -*-
  ;;; init-dired.el --- Dired configuration

  ;;; Require
  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require '+func)
    (require 'dired)
    (require 'dired-x)
    (require 'dired-details)                ;Diredè¯¦ç»†ä¿¡æ¯
    (require 'dired-details+)
    )

  ;; Quick sort dired buffers via hydra
  (use-package dired-quick-sort
    :bind (:map dired-mode-map
           ("S" . hydra-dired-quick-sort/body)))

  ;; Show git info in dired
  (use-package dired-git-info
    :bind (:map dired-mode-map
           (")" . dired-git-info-mode)))

  ;; Allow rsync from dired buffers
  (use-package dired-rsync
    :bind (:map dired-mode-map
           ("C-c C-r" . dired-rsync)))

  ;; Colorful dired
  (use-package diredfl
    :hook (dired-mode . diredfl-mode))

  ;; Shows icons
  (use-package nerd-icons-dired
    :diminish
    :when (icons-displayable-p)
    :custom-face
    (nerd-icons-dired-dir-face ((t (:inherit nerd-icons-dsilver :foreground unspecified))))
    :hook (dired-mode . nerd-icons-dired-mode))

  ;; Extra Dired functionality
  (use-package dired-aux :ensure nil)

  ;;; Code:
  ;; Guess a default target directory
  (setq dired-dwim-target t)

  ;; Always delete and copy recursively
  (setq dired-recursive-deletes 'always
        dired-recursive-copies 'always)

  ;; Show directory first
  (setq dired-listing-switches "-alh --group-directories-first")
  (let ((cmd (cond (sys/mac-x-p "open")
                   (sys/linux-x-p "xdg-open")
                   (sys/win32p "start")
                   (t ""))))
    (setq dired-guess-shell-alist-user
          `(("\\.pdf\\'" ,cmd)
            ("\\.docx\\'" ,cmd)
            ("\\.\\(?:djvu\\|eps\\)\\'" ,cmd)
            ("\\.\\(?:jpg\\|jpeg\\|png\\|gif\\|xpm\\)\\'" ,cmd)
            ("\\.\\(?:xcf\\)\\'" ,cmd)
            ("\\.csv\\'" ,cmd)
            ("\\.tex\\'" ,cmd)
            ("\\.\\(?:mp4\\|mkv\\|avi\\|flv\\|rm\\|rmvb\\|ogv\\)\\(?:\\.part\\)?\\'" ,cmd)
            ("\\.\\(?:mp3\\|flac\\)\\'" ,cmd)
            ("\\.html?\\'" ,cmd)
            ("\\.md\\'" ,cmd)))
    (when sys/macp
      (if (executable-find "gls")
          (progn
            ;; Use GNU ls as `gls' from `coreutils' if available.
            (setq insert-directory-program "gls")
            ;; Using `insert-directory-program'
            (setq ls-lisp-use-insert-directory-program t))
        (progn
          ;; Suppress the warning: `ls does not support --dired'.
          (setq dired-use-ls-dired nil)
          (setq dired-listing-switches "-alh"))))

    (setq dired-omit-files
          (concat dired-omit-files
                  "\\|^.DS_Store$\\|^.projectile$\\|^.git*\\|^.svn$\\|^.vscode$\\|\\.js\\.meta$\\|\\.meta$\\|\\.elc$\\|^.emacs.*")))

  (setq dired-recursive-copies t)         ;å¯ä»¥é€’å½’çš„è¿›è¡Œæ‹·è´
  (setq dired-recursive-deletes t)        ;å¯ä»¥é€’å½’çš„åˆ é™¤ç›®å½•
  (setq dired-recursive-deletes 'always)  ;åˆ é™¤ä¸œè¥¿æ—¶ä¸æç¤º
  (setq dired-recursive-copies 'always)   ;æ‹·è´ä¸œè¥¿æ—¶ä¸æç¤º
  (setq dired-listing-switches "-aluh")   ;ä¼ ç»™ ls çš„å‚æ•°
  (setq dired-details-hidden-string "") ;è®¾ç½®éšè—diredé‡Œé¢è¯¦ç»†ä¿¡æ¯çš„å­—ç¬¦ä¸²
  (setq directory-free-space-args "-Pkh") ;ç›®å½•ç©ºé—´é€‰é¡¹
  (setq dired-omit-size-limit nil)        ;diredå¿½ç•¥çš„ä¸Šé™
  (setq dired-dwim-target t)              ;Diredè¯•ç€çŒœå¤„é»˜è®¤çš„ç›®æ ‡ç›®å½•
  (setq my-dired-omit-status t)           ;è®¾ç½®é»˜è®¤å¿½ç•¥æ–‡ä»¶
  (setq my-dired-omit-regexp "^\\.?#\\|^\\..*") ;è®¾ç½®å¿½ç•¥æ–‡ä»¶çš„åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼
  (setq my-dired-omit-extensions '(".cache")) ;è®¾ç½®å¿½ç•¥æ–‡ä»¶çš„æ‰©å±•ååˆ—è¡¨
  (add-hook 'dired-after-readin-hook #'(lambda ()
                                         (progn
                                           (require 'dired-extension)
                                           (dired-sort-method)))) ;å…ˆæ˜¾ç¤ºç›®å½•, ç„¶åŽæ˜¾ç¤ºæ–‡ä»¶
  (add-hook
   'dired-mode-hook
   #'(lambda ()
       (require 'dired-extension)
       (dired-omit-method)                ;éšè—æ–‡ä»¶çš„æ–¹æ³•
       ))
  (setq dired-guess-shell-alist-user      ;è®¾ç½®æ–‡ä»¶é»˜è®¤æ‰“å¼€çš„æ¨¡å¼
        '(
          ;; åŽ‹ç¼©åŒ…
          (list "\\.rar$" "unrar e -ad")
          (list "\\.tar.bz2$" "tar jxvf")
          (list "\\.gz$" "gzip -d")
          ;; å…¶ä»–
          (list "\\.exe$" "wine")))

  ;;; ### Dired ###
  ;;; --- æ–‡ä»¶æµè§ˆå™¨
  (lazy-load-set-keys
   '(
     ("h" . dired-next-subdir)            ;ä¸‹ä¸€ä¸ªå­ç›®å½•
     ("l" . dired-prev-subdir)            ;ä¸Šä¸€ä¸ªå­ç›®å½•
     ("n" . dired-next-dirline)           ;ä¸‹ä¸€ä¸ªç›®å½•
     ("p" . dired-prev-dirline)           ;ä¸Šä¸€ä¸ªç›®å½•
     ("P" . dired-do-kill-lines)          ;åˆ é™¤æ ‡è®°çš„è¡Œ
     ("5" . dired-translate-to-html)      ;è½¬æ¢åˆ°HTMLæ ¼å¼
     ("9" . auto-install-from-dired)      ;è‡ªåŠ¨ä»ŽEmacsWikiå®‰è£…æ ‡è®°çš„æ–‡ä»¶
     ("I" . image-dired)                  ;æ‰“å¼€æµè§ˆæ¨¡å¼
     ("W" . dired-x-find-file)            ;æŸ¥æ‰¾æ–‡ä»¶
     ("J" . awesome-tab-backward-tab)
     ("K" . awesome-tab-forward-tab)
     ("X" . traverse-cp-or-mv-extfiles-in-dir) ;æ‹·è´æˆ–ç§»åŠ¨ç›®å½•ä¸‹æŒ‡å®šæ‰©å±•åçš„æ–‡ä»¶
     ("V" . traverse-dired-browse-archive)     ;æµè§ˆåŽ‹ç¼©æ–‡ä»¶
     ("," . dired-diff)                        ;æ¯”è¾ƒæ–‡ä»¶
     ("SPC" . scroll-up)                       ;å‘ä¸‹ç¿»é¡µ
     ("e" . scroll-down)                       ;å‘ä¸Šç¿»é¡µ
     ("c" . kill-this-buffer)                  ;å…³é—­å½“å‰æ ‡ç­¾
     ("/" . copy-buffer-file-name-as-kill)     ;æ˜¾ç¤ºè·¯å¾„æˆ–åç§°
     ;;("s" . one-key-menu-dired-sort)           ;æŽ’åº
     ;;("F" . one-key-menu-dired-filter)         ;è¿‡æ»¤
     ("w" . wdired-change-to-wdired-mode)      ;åˆ‡æ¢åˆ°diredç¼–è¾‘æ¨¡å¼
     )
   dired-mode-map
   )

  (lazy-load-local-keys
   '(
     ("/" . copy-buffer-file-name-as-kill))
   dired-mode-map
   "buffer-extension")


  (lazy-load-local-keys
   '(
     ("M-o" . dired-toggle-omit)          ;åˆ‡æ¢å¿½ç•¥çŠ¶æ€
     ("?" . dired-get-size)               ;å¾—åˆ°æ–‡ä»¶çš„å¤§å°
     ("[" . dired-rename-with-copy)       ;é‡å‘½åå‡½æ•°
     ("'" . dired-up-directory-single)    ;è¿”å›žä¸Šä¸€çº§ç›®å½•
     ("4" . dired-serial-rename)          ;æ‰¹é‡é‡å‘½å
     ("7" . dired-move-to-last-file)      ;ç§»åŠ¨åˆ°æœ€åŽä¸€ä¸ªæ–‡ä»¶
     ("8" . dired-move-to-first-file)     ;ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªæ–‡ä»¶
     ("k" . dired-previous-file-line)     ;ä¸Šä¸€è¡Œ
     ("j" . dired-next-file-line)         ;ä¸‹ä¸€è¡Œ
     ;;("{" . dired-gnome-open-file)        ;ç”¨GNOMEæ–¹å¼æ‰“å¼€æ–‡ä»¶
     ("E" . dired-touch-now)              ;Touchå‘½ä»¤
     ("f" . dired-find-file+)             ;æ‰“å¼€å½“å‰æ–‡ä»¶æˆ–ç›®å½•
     ("C-m" . dired-find-file+)           ;æ‰“å¼€å½“å‰æ–‡ä»¶æˆ–ç›®å½•
     )
   dired-mode-map
   "dired-extension")


  ;;;###autoload
  (defun my-file-usage ()
    (interactive)
    (message (shell-command-to-string "du -kh")))

  ;;;###autoload
  (defun my-computer-sleep-now ()
    "Make my computer sleep now."
    (interactive)
    (let* ((cmd (cond
                 (sys/win32p
                  "rundll32.exe PowrProf.dll,SetSuspendState")
                 (sys/cygwinp
                  "rundll32.exe PowrProf.dll,SetSuspendState")
                 (sys/macp
                  "pmset sleepnow")
                 (t
                  "sudo pm-suspend"))))
      (shell-command cmd)))


  ;; {{ dired
  (with-eval-after-load 'dired
    (defun my-replace-dired-base (base)
      "Change file name in `wdired-mode'"
      (let* ((fp (dired-file-name-at-point))
             (fb (file-name-nondirectory fp))
             (ext (file-name-extension fp))
             (dir (file-name-directory fp))
             (nf (concat base "." ext)))
        (when (yes-or-no-p (format "%s => %s at %s?"
                                   fb nf dir))
          (rename-file fp (concat dir nf)))))
    (defun my-extract-mp3-from-video ()
      "Extract mp3 from current video file using ffmpeg."
      (interactive)
      (let* ((video-file (file-name-nondirectory (dired-file-name-at-point)))
             (params (split-string (string-trim (read-string "Please input start-second [total seconds] (e.g, \"6 10\" or \"05:30 5\") or just press enter: "))
                                   " +"))
             (start (car params))
             (total (if (eq (length params) 1) "5" (nth 1 params)))
             cmd)
        (cond
         ((string= start "")
          ;; extract audio to MP3 with sample rate 44.1Khz (CD quality), stereo, and 2 channels
          (setq cmd (format "ffmpeg -i \"%s\" -vn -ar 44100 -ac 2 -ab 192 -f mp3 \"%s\""
                            video-file
                            (concat (file-name-base video-file) ".mp3"))))
         (t
          (setq cmd (format "ffmpeg -i \"%s\" -vn -ss %s -t %s -acodec copy \"%s\""
                            video-file
                            start
                            total
                            (format "%s-%s-%s.mp3" (file-name-base video-file) start total)))))
        (shell-command (concat cmd " &"))))

    (defun my-extract-mkv-subtitle ()
      "Use mkvtoolnix to extract mkv subtitle."
      (interactive)
      (let* ((file (file-name-nondirectory (dired-file-name-at-point)))
             (ext (file-name-extension file))
             (default-directory (file-name-directory (dired-file-name-at-point)))
             trunks
             track-number)
        (cond
         ((not (string= "mkv" ext))
          (message "Only mkv files can be processed."))
         ((not (executable-find "mkvextract"))
          (message "Please install mkvtoolnix."))
         (t
          ;; split output into trunks
          (setq trunks (split-string (shell-command-to-string (format "mkvinfo \"%s\"" file))
                                     "| ?\\+ [A-Z][^\n]+[\n]*"))
          ;; only interested english subtitle trunk
          (setq trunks (cl-remove-if-not
                        (lambda (trunk)
                          (string-match "Track type: subtitles" trunk))
                        trunks))
          ;; If there is more than one subtitle, process English track only
          (when (> (length trunks) 1)
            (setq trunks (cl-remove-if-not
                          (lambda (trunk)
                            (string-match "Language: eng" trunk))
                          trunks)))
          (when (and (> (length trunks) 0)
                     (string-match "Track number: \\([0-9]+\\)" (car trunks)))

            ;; only extract the track number from the first truck
            (setq track-number (1- (string-to-number (match-string 1 (car trunks)))))
            (shell-command (format "mkvextract tracks \"%s\" %s:\"%s.srt\" > /dev/null 2>&1"
                                   file
                                   track-number
                                   (file-name-base file))))))))

    (defun my-record-wav-by-mp3 ()
      "Record a wav using meta data from current mp3 file."
      (interactive)
      (let* ((mp3-file (file-name-nondirectory (dired-file-name-at-point)))
             (base (file-name-base mp3-file))
             (params (split-string base  "-"))
             (output-file (concat base ".wav"))
             (total (string-to-number (nth (1- (length params)) params)))
             cmd)
        (if (= total 0) (setq total 4))
        (setq cmd (format "arecord -fdat -d %s \"%s\""
                          total
                          output-file))
        (message "Start recording %s seconds wav ..." total)
        (my-async-shell-command cmd)))
    (defun my-play-both-mp3-and-wav ()
      "Play wav and mp3."
      (interactive)
      (let* ((audio-file (file-name-nondirectory (dired-file-name-at-point)))
             (base (file-name-base audio-file))
             (ext (file-name-extension audio-file) )
             (cmd (format "mplayer -quiet \"%s\" \"%s\""
                          audio-file
                          (concat base "." (if (string= ext "mp3") "wav" "mp3")))))
        (my-async-shell-command cmd)))
    (defun my-copy-file-info (fn)
      "Copy file or directory info."
      (let* ((file-name (dired-file-name-at-point)))
        (when (file-directory-p file-name)
          (setq file-name (directory-file-name file-name)))
        (message "%s => clipboard & yank ring"
                 (copy-yank-str (funcall fn file-name)))))

    (with-eval-after-load 'hydra
      (defhydra my-hydra-dired (:color blue)
        "
  ^Misc^                      ^File^              ^Copy Info^
  -----------------------------------------------------------------
  [_vv_] Video => Mp3        [_R_] Move           [_pp_] Path
  [_aa_] Record by mp3       [_cf_] New           [_nn_] Name
  [_zz_] Play wav&mp3        [_rr_] Rename        [_bb_] Base name
  [_sa_] Fetch subtitle(s)   [_C_]  Copy          [_dd_] directory
  [_se_] Extract subtitle    [_rb_] Change base
  [_aa_] Recording Wav       [_df_] Diff 2 files
  [_ee_] Mkv => Srt          [_ff_] Find
  [_+_] Create directory     [_du_] File usage
  [_mp_] Mplayer extra opts
  "
        ("mp" my-mplayer-setup-extra-opts)
        ("sa" shenshou-download-subtitle)
        ("se" shenshou-extract-subtitle-from-zip)
        ("pp" (my-copy-file-info 'file-truename))
        ("nn" (my-copy-file-info 'file-name-nondirectory))
        ("bb" (my-copy-file-info 'file-name-base))
        ("dd" (my-copy-file-info 'file-name-directory))
        ("rb" (my-replace-dired-base (car kill-ring)))
        ("vv" my-extract-mp3-from-video)
        ("ee" my-extract-mkv-subtitle)
        ("aa" my-record-wav-by-mp3)
        ("zz" my-play-both-mp3-and-wav)
        ("C" dired-do-copy)
        ("R" dired-do-rename)
        ("cf" find-file)
        ("du" my-file-usage)
        ("df" my-ediff-files)
        ("rr" dired-toggle-read-only)
        ("ff" (lambda (regexp)
                (interactive "sMatching regexp: ")
                (find-lisp-find-dired default-directory regexp)))
        ("+" dired-create-directory)
        ("q" nil)))

    (defun dired-mode-hook-hydra-setup ()
      (local-set-key (kbd "y") 'my-hydra-dired/body))
    (add-hook 'dired-mode-hook 'dired-mode-hook-hydra-setup))

  ;; }}

  (provide 'init-dired)

  ;;; init-dired.el ends here
#+end_src
* etc/init-eshell.el
#+begin_src emacs-lisp :tangle etc/init-eshell.el
;; init-eshell.el --- Initialize eshell configurations.	-*- lexical-binding: t -*-
;;; Commentary:
;;
;; Eshell configurations.
;;

;;; Code:

;; Emacs command shell
(use-package eshell
  :ensure nil
  :defines eshell-prompt-function
  :bind (:map eshell-mode-map
         ([remap recenter-top-bottom] . eshell/clear))
  :config
  (with-no-warnings
    (defun eshell/clear ()
      "Clear the eshell buffer."
      (interactive)
      (let ((inhibit-read-only t))
        (erase-buffer)
        (eshell-send-input)))

    (defun eshell/emacs (&rest args)
      "Open a file (ARGS) in Emacs.  Some habits die hard."
      (if (null args)
          ;; If I just ran "emacs", I probably expect to be launching
          ;; Emacs, which is rather silly since I'm already in Emacs.
          ;; So just pretend to do what I ask.
          (bury-buffer)
        ;; We have to expand the file names or else naming a directory in an
        ;; argument causes later arguments to be looked for in that directory,
        ;; not the starting directory
        (mapc #'find-file (mapcar #'expand-file-name (flatten-tree (reverse args))))))
    (defalias 'eshell/e #'eshell/emacs)
    (defalias 'eshell/ec #'eshell/emacs)

    (defun eshell/ebc (&rest args)
      "Compile a file (ARGS) in Emacs. Use `compile' to do background make."
      (if (eshell-interactive-output-p)
          (let ((compilation-process-setup-function
                 (list 'lambda nil
                       (list 'setq 'process-environment
                             (list 'quote (eshell-copy-environment))))))
            (compile (eshell-flatten-and-stringify args))
            (pop-to-buffer compilation-last-buffer))
        (throw 'eshell-replace-command
               (let ((l (eshell-stringify-list (flatten-tree args))))
                 (eshell-parse-command (car l) (cdr l))))))
    (put 'eshell/ebc 'eshell-no-numeric-conversions t)

    (defun eshell-view-file (file)
      "View FILE.  A version of `view-file' which properly rets the eshell prompt."
      (interactive "fView file: ")
      (unless (file-exists-p file) (error "%s does not exist" file))
      (let ((buffer (find-file-noselect file)))
        (if (eq (get (buffer-local-value 'major-mode buffer) 'mode-class)
                'special)
            (progn
              (switch-to-buffer buffer)
              (message "Not using View mode because the major mode is special"))
          (let ((undo-window (list (window-buffer) (window-start)
                                   (+ (window-point)
                                      (length (funcall eshell-prompt-function))))))
            (switch-to-buffer buffer)
            (view-mode-enter (cons (selected-window) (cons nil undo-window))
                             'kill-buffer)))))

    (defun eshell/less (&rest args)
      "Invoke `view-file' on a file (ARGS).

\"less +42 foo\" will go to line 42 in the buffer for foo."
      (while args
        (if (string-match "\\`\\+\\([0-9]+\\)\\'" (car args))
            (let* ((line (string-to-number (match-string 1 (pop args))))
                   (file (pop args)))
              (eshell-view-file file)
              (forward-line line))
          (eshell-view-file (pop args)))))
    (defalias 'eshell/more #'eshell/less))

  ;;  Display extra information for prompt
  (use-package eshell-prompt-extras
    :after esh-opt
    :defines eshell-highlight-prompt
    :autoload (epe-theme-lambda epe-theme-dakrone epe-theme-pipeline)
    :init (setq eshell-highlight-prompt nil
                eshell-prompt-function #'epe-theme-lambda))

  ;; `eldoc' support
  (use-package esh-help
    :init (setup-esh-help-eldoc))

  ;; `cd' to frequent directory in `eshell'
  (use-package eshell-z
    :hook (eshell-mode . (lambda () (require 'eshell-z)))))

(provide 'init-eshell)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; init-eshell.el ends here

#+end_src
* GÃ²ulÃ¶ng: etc/init-highlight.el
#+begin_src emacs-lisp :tangle etc/init-highlight.el
  ;; init-highlight.el --- Initialize highlighting configurations.	-*- lexical-binding: t -*-

  ;;; Commentary:
  ;;
  ;; Highlighting configurations.
  ;;

  ;;; Code:
  (provide 'init-highlight)

  (eval-when-compile
    (require '+const))

  ;; Highlight the current line
  (use-package hl-line
    :ensure nil
    :hook ((after-init . global-hl-line-mode)
           ((dashboard-mode eshell-mode shell-mode term-mode vterm-mode) .
            (lambda () (setq-local global-hl-line-mode nil)))))

  ;; Highlight matching parens
  (use-package paren
    :ensure nil
    :hook (after-init . show-paren-mode)
    :init (setq show-paren-when-point-inside-paren t
                show-paren-when-point-in-periphery t)
    :config
    (if emacs/>=29p
        (setq show-paren-context-when-offscreen
              (if (childframe-workable-p) 'child-frame 'overlay))
      (with-no-warnings
        ;; Display matching line for off-screen paren.
        (defun display-line-overlay (pos str &optional face)
          "Display line at POS as STR with FACE.

  FACE defaults to inheriting from default and highlight."
          (let ((ol (save-excursion
                      (goto-char pos)
                      (make-overlay (line-beginning-position)
                                    (line-end-position)))))
            (overlay-put ol 'display str)
            (overlay-put ol 'face
                         (or face '(:inherit highlight)))
            ol))

        (defvar-local show-paren--off-screen-overlay nil)
        (defun show-paren-off-screen (&rest _args)
          "Display matching line for off-screen paren."
          (when (overlayp show-paren--off-screen-overlay)
            (delete-overlay show-paren--off-screen-overlay))
          ;; Check if it's appropriate to show match info,
          (when (and (overlay-buffer show-paren--overlay)
                     (not (or cursor-in-echo-area
                              executing-kbd-macro
                              noninteractive
                              (minibufferp)
                              this-command))
                     (and (not (bobp))
                          (memq (char-syntax (char-before)) '(?\) ?\$)))
                     (= 1 (logand 1 (- (point)
                                       (save-excursion
                                         (forward-char -1)
                                         (skip-syntax-backward "/\\")
                                         (point))))))
            ;; Rebind `minibuffer-message' called by `blink-matching-open'
            ;; to handle the overlay display.
            (cl-letf (((symbol-function #'minibuffer-message)
                       (lambda (msg &rest args)
                         (let ((msg (apply #'format-message msg args)))
                           (setq show-paren--off-screen-overlay
                                 (display-line-overlay
                                  (window-start) msg ))))))
              (blink-matching-open))))
        (advice-add #'show-paren-function :after #'show-paren-off-screen))))


  ;; Colorize color names in buffers
  (use-package rainbow-mode
    :diminish
    :defines helpful-mode-map
    :bind (:map help-mode-map
           ("w" . rainbow-mode))
    :hook ((html-mode php-mode helpful-mode) . rainbow-mode)
    :init (with-eval-after-load 'helpful
            (bind-key "w" #'rainbow-mode helpful-mode-map))
    :config
    (with-no-warnings
      ;; HACK: Use overlay instead of text properties to override `hl-line' faces.
      ;; @see https://emacs.stackexchange.com/questions/36420
      (defun my-rainbow-colorize-match (color &optional match)
        (let* ((match (or match 0))
               (ov (make-overlay (match-beginning match) (match-end match))))
          (overlay-put ov 'ovrainbow t)
          (overlay-put ov 'face `((:foreground ,(if (> 0.5 (rainbow-x-color-luminance color))
                                                    "white" "black"))
                                  (:background ,color)))))
      (advice-add #'rainbow-colorize-match :override #'my-rainbow-colorize-match)

      (defun my-rainbow-clear-overlays ()
        "Clear all rainbow overlays."
        (remove-overlays (point-min) (point-max) 'ovrainbow t))
      (advice-add #'rainbow-turn-off :after #'my-rainbow-clear-overlays)))

  ;; Highlight brackets according to their depth
  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))

  ;; Highlight uncommitted changes using VC
  (use-package diff-hl
    :custom (diff-hl-draw-borders nil)
    :custom-face
    (diff-hl-change ((t (:inherit custom-changed :foreground unspecified :background unspecified))))
    (diff-hl-insert ((t (:inherit diff-added :background unspecified))))
    (diff-hl-delete ((t (:inherit diff-removed :background unspecified))))
    :bind (:map diff-hl-command-map
           ("SPC" . diff-hl-mark-hunk))
    :hook ((after-init . global-diff-hl-mode)
           (after-init . global-diff-hl-show-hunk-mouse-mode)
           (dired-mode . diff-hl-dired-mode))
    :config
    ;; Highlight on-the-fly
    (diff-hl-flydiff-mode 1)

    ;; Set fringe style
    (setq-default fringes-outside-margins t)

    (with-no-warnings
      (defun my-diff-hl-fringe-bmp-function (_type _pos)
        "Fringe bitmap function for use as `diff-hl-fringe-bmp-function'."
        (define-fringe-bitmap 'my-diff-hl-bmp
          (vector (if sys/linuxp #b11111100 #b11100000))
          1 8
          '(center t)))
      (setq diff-hl-fringe-bmp-function #'my-diff-hl-fringe-bmp-function)

      (unless (display-graphic-p)
        ;; Fall back to the display margin since the fringe is unavailable in tty
        (diff-hl-margin-mode 1)
        ;; Avoid restoring `diff-hl-margin-mode'
        (with-eval-after-load 'desktop
          (add-to-list 'desktop-minor-mode-table
                       '(diff-hl-margin-mode nil))))

      ;; Integration with magit
      (with-eval-after-load 'magit
        (add-hook 'magit-pre-refresh-hook #'diff-hl-magit-pre-refresh)
        (add-hook 'magit-post-refresh-hook #'diff-hl-magit-post-refresh))))

#+end_src
* etc/init-idle.el
#+begin_src emacs-lisp :tangle etc/init-idle.el
  (provide 'init-idle)

  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require '+func)
    (require 'init-package)
    )

#+end_src
** Citding
#+begin_src emacs-lisp :tangle etc/init-idle.el

  (setq suggest-key-bindings 1)             ;å½“ä½¿ç”¨ M-x COMMAND åŽï¼Œè¿‡ 1 ç§’é’Ÿæ˜¾ç¤ºè¯¥ COMMAND ç»‘å®šçš„é”®ã€‚
  (setq browse-kill-ring-quit-action        ;è®¾ç½®é€€å‡ºåŠ¨ä½œ
        (quote save-and-restore))           ;ä¿å­˜è¿˜åŽŸçª—å£è®¾ç½®
  (autoload 'hanconvert-region "hanconvert" ;ç®€ç¹ä¸­æ–‡äº’ç›¸è½¬æ¢
    "Convert a region from simple chinese to tradition chinese or
      from tradition chinese to simple chinese" t)
  (setq max-lisp-eval-depth 40000)          ;lispæœ€å¤§æ‰§è¡Œæ·±åº¦
  (setq max-specpdl-size 10000)             ;æœ€å¤§å®¹é‡
  (setq kill-ring-max 1024)                 ;ç”¨ä¸€ä¸ªå¾ˆå¤§çš„ kill ring. è¿™æ ·é˜²æ­¢æˆ‘ä¸å°å¿ƒåˆ æŽ‰é‡è¦çš„ä¸œè¥¿
  (setq mark-ring-max 1024)                 ;è®¾ç½®çš„mark ringå®¹é‡
  (setq eval-expression-print-length nil)   ;è®¾ç½®æ‰§è¡Œè¡¨è¾¾å¼çš„é•¿åº¦æ²¡æœ‰é™åˆ¶
  (setq eval-expression-print-level nil)    ;è®¾ç½®æ‰§è¡Œè¡¨è¾¾å¼çš„æ·±åº¦æ²¡æœ‰é™åˆ¶
  (auto-compression-mode 1)                 ;æ‰“å¼€åŽ‹ç¼©æ–‡ä»¶æ—¶è‡ªåŠ¨è§£åŽ‹ç¼©
  (setq read-quoted-char-radix 16)          ;è®¾ç½® å¼•ç”¨å­—ç¬¦ çš„åŸºæ•°
  (setq global-mark-ring-max 1024)          ;è®¾ç½®æœ€å¤§çš„å…¨å±€æ ‡è®°å®¹é‡
  (global-hl-line-mode 1)                   ;é«˜äº®å½“å‰è¡Œ
  (setq isearch-allow-scroll t)             ;isearchæœç´¢æ—¶æ˜¯å¯ä»¥æ»šåŠ¨å±å¹•çš„
  (setq enable-recursive-minibuffers t)     ;minibuffer é€’å½’è°ƒç”¨å‘½ä»¤
  (setq history-delete-duplicates t)        ;åˆ é™¤minibufferçš„é‡å¤åŽ†å²
  (setq minibuffer-message-timeout 1)       ;æ˜¾ç¤ºæ¶ˆæ¯è¶…æ—¶çš„æ—¶é—´
  (setq auto-revert-mode 1)                 ;è‡ªåŠ¨æ›´æ–°buffer
  (show-paren-mode t)                       ;æ˜¾ç¤ºæ‹¬å·åŒ¹é…
  (setq show-paren-style 'parentheses)      ;æ‹¬å·åŒ¹é…æ˜¾ç¤ºä½†ä¸æ˜¯çƒ¦äººçš„è·³åˆ°å¦ä¸€ä¸ªæ‹¬å·ã€‚
  (setq blink-matching-paren nil)           ;å½“æ’å…¥å³æ‹¬å·æ—¶ä¸æ˜¾ç¤ºåŒ¹é…çš„å·¦æ‹¬å·
  (setq message-log-max t)                  ;è®¾ç½®messageè®°å½•å…¨éƒ¨æ¶ˆæ¯, è€Œä¸ç”¨æˆªåŽ»
  (setq require-final-newline nil)          ;ä¸è‡ªåŠ¨æ·»åŠ æ¢è¡Œç¬¦åˆ°æœ«å°¾, æœ‰äº›æƒ…å†µä¼šå‡ºçŽ°é”™è¯¯
  (setq ediff-window-setup-function
        (quote ediff-setup-windows-plain))  ;æ¯”è¾ƒçª—å£è®¾ç½®åœ¨åŒä¸€ä¸ªframeé‡Œ
  (setq x-stretch-cursor t)                 ;å…‰æ ‡åœ¨ TAB å­—ç¬¦ä¸Šä¼šæ˜¾ç¤ºä¸ºä¸€ä¸ªå¤§æ–¹å—
  (put 'narrow-to-region 'disabled nil)     ;å¼€å¯å˜çª„åŒºåŸŸ
  (setq print-escape-newlines t)            ;æ˜¾ç¤ºå­—ç¬¦çª—ä¸­çš„æ¢è¡Œç¬¦ä¸º \n
  (setq tramp-default-method "ssh")         ;è®¾ç½®ä¼ é€æ–‡ä»¶é»˜è®¤çš„æ–¹æ³•
  (setq void-text-area-pointer nil)         ;ç¦æ­¢æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ
  (setq auto-window-vscroll nil)            ;å…³é—­è‡ªåŠ¨è°ƒèŠ‚è¡Œé«˜
  (setq mouse-yank-at-point nil)            ;è®©å…‰æ ‡æ— æ³•ç¦»å¼€è§†çº¿
  (setq kill-whole-line t)                  ; C-k deletes the end of line
  (setq delete-by-moving-to-trash t)        ; Deleting files go to OS's trash folder
  (setq track-eol t)                        ; Keep cursor at end of lines. Require line-move-visual is nil.
  (setq line-move-visual nil)
  (setq inhibit-compacting-font-caches t)   ; Donâ€™t compact font caches during GC.
  (setq save-interprogram-paste-before-kill t) ; Save clipboard contents into kill-ring before replace them
  ;;(setq auto-save-default nil)              ; Disable auto save
  (setq echo-keystrokes 0.1)              ;åŠ å¿«å¿«æ·é”®æç¤ºçš„é€Ÿåº¦
  (setq byte-compile-warnings
        (quote (
                ;; æ˜¾ç¤ºçš„è­¦å‘Š
                free-vars                 ;ä¸åœ¨å½“å‰èŒƒå›´çš„å¼•ç”¨å˜é‡
                unresolved                ;ä¸çŸ¥é“çš„å‡½æ•°
                callargs                  ;å‡½æ•°è°ƒç”¨çš„å‚æ•°å’Œå®šä¹‰çš„ä¸åŒ¹é…
                obsolete                  ;è’åºŸçš„å˜é‡å’Œå‡½æ•°
                noruntime                 ;å‡½æ•°æ²¡æœ‰å®šä¹‰åœ¨è¿è¡Œæ—¶æœŸ
                interactive-only          ;æ­£å¸¸ä¸è¢«è°ƒç”¨çš„å‘½ä»¤
                make-local                ;è°ƒç”¨ `make-variable-buffer-local' å¯èƒ½ä¼šä¸æ­£ç¡®çš„
                mapcar                    ;`mapcar' è°ƒç”¨
                ;;
                ;; æŠ‘åˆ¶çš„è­¦å‘Š
                (not redefine)            ;é‡æ–°å®šä¹‰çš„å‡½æ•° (æ¯”å¦‚å‚æ•°æ•°é‡æ”¹å˜)
                (not cl-functions)        ;`CL' åŒ…ä¸­çš„è¿è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°
                )))

  (setq-default cursor-type 'box) ; è®¾ç½®å…‰æ ‡æ ·å¼
      ;;; ### Speedbar ###
  (setq speedbar-show-unknown-files t)    ;æ˜¾ç¤ºæ–‡ä»¶

      ;;; ### Modeline-posn-column-limit ###
  (setq modelinepos-column-limit 80)      ;è®¾ç½®åˆ—æ•°é™åˆ¶, å¹¶åœ¨mode-lineä¸Šæ˜¾ç¤º
  ;; å¦‚æžœæœ‰ä¸¤ä¸ªé‡åbuffer, åˆ™å†å‰é¢åŠ ä¸Šè·¯å¾„åŒºåˆ«
  (require 'uniquify)
  ;; (setq uniquify-buffer-name-style 'forward)
  (setq uniquify-buffer-name-style 'post-forward-angle-brackets)


  ;; =========================================================
  ;;å¤‡ä»½ç­–ç•¥
  ;; =========================================================
  (setq make-backup-files t)
  (setq version-control t)     ; å…è®¸å¤šæ¬¡å¤‡ä»½
  (setq kept-old-versions 2)   ; ä¿ç•™æœ€æ—©çš„2ä¸ªå¤‡ä»½æ–‡ä»¶
  (setq kept-new-version 100)  ; ä¿ç•™æœ€è¿‘çš„100ä¸ªå¤‡ä»½æ–‡ä»¶
  (setq delete-old-versions t) ; è‡ªåŠ¨åˆ é™¤æ—§çš„å¤‡ä»½æ–‡ä»¶
#+end_src
** Kaiyung Daksing
#+begin_src emacs-lisp :tangle etc/init-idle.el

  (show-paren-mode t)
  (tooltip-mode -1)                       ;ä¸è¦æ˜¾ç¤ºä»»ä½• tooltips
  (delete-selection-mode 1)               ; é€‰ä¸­æ–‡æœ¬åŽè¾“å…¥ä¼šè¦†ç›–
  (auto-compression-mode 1)
  (size-indication-mode 1)
  (blink-cursor-mode -1)

  ;; Misc
  (if (boundp 'use-short-answers)
      (setq use-short-answers t)
    (fset 'yes-or-no-p 'y-or-n-p))
#+end_src
**  Gokjong Emacs HÃ¡ngwai Ge Ginyi
#+begin_src emacs-lisp :tangle etc/init-idle.el
  ;;; ### Advice ###
  ;;; --- å„ç§emacsè¡Œä¸ºå»ºè®®
  ;; åœ¨ç‰¹å®šåœ°æ¨¡å¼ä¸‹ç²˜è´´æ—¶è‡ªåŠ¨ç¼©è¿›
  (defadvice yank (after indent-region activate)
    "To make yank content indent automatically."
    (if (member major-mode '(emacs-lisp-mode
                             scheme-mode
                             lisp-mode
                             lisp-interaction-mode
                             c-mode
                             c++-mode
                             objc-mode
                             latex-mode
                             plain-tex-mode))
        (indent-region (region-beginning) (region-end) nil)))
#+end_src
** YÃ¼go Yau LÃ¶ng Go Cong Ming Ge *Buffer* , Jau Joi Cinmin GÃ¡sÃ¶ng Louging
#+begin_src emacs-lisp :tangle etc/init-idle.el
  ;; å¦‚æžœæœ‰ä¸¤ä¸ªé‡åbuffer, åˆ™å†å‰é¢åŠ ä¸Šè·¯å¾„åŒºåˆ«
  (require 'uniquify)
  ;; (setq uniquify-buffer-name-style 'forward)
  (setq uniquify-buffer-name-style 'post-forward-angle-brackets)
#+end_src

** Jidung Citding =chmod +x=
#+begin_src emacs-lisp :tangle etc/init-idle.el
  ;; chmod +x
  ;; ref. http://th.nao.ac.jp/MEMBER/zenitani/elisp-j.html#chmod
  (add-hook 'after-save-hook
            'executable-make-buffer-file-executable-if-script-p)

#+end_src

** Saiyung =Saveplace= Joi Ä¢Ã¡nbei Mangin Cin, BouocÃ¼n Gongbiu Ge Waiji
#+begin_src emacs-lisp :tangle etc/init-idle.el
  ;; Saiyung `saveplace` joi Ä£Ã¡nbei mangin cin, bouocÃ¼n gongbiu ge waiji
  (my-run-with-idle-timer
   2
   #'(lambda()
       ;;saveplace
       (setq save-place-file (expand-file-name "saveplace" suk-emacs-var-dir)) ; "~/.emacs.d/var/saveplace"
       (save-place-mode 1)
       ;;If emacs is slow to exit after enabling saveplace, you may be
       ;;running afoul of save-place-forget-unreadable-files. On exit,
       ;;it checks that every loaded file is readable before saving its
       ;;buffer position - potentially very slow if you use NFS.
       (setq save-place-forget-unreadable-files nil)
       ))
#+end_src

** Saiyung Savehist
#+begin_src emacs-lisp :tangle etc/init-idle.el
(my-run-with-idle-timer
 2
 #'(lambda()
     ;; savehist
     (setq enable-recursive-minibuffers t ; Allow commands in minibuffers
           history-length 1000
           savehist-additional-variables '(mark-ring
                                           global-mark-ring
                                           search-ring
                                           regexp-search-ring
                                           extended-command-history)
           savehist-autosave-interval 300
           savehist-file (expand-file-name "history" suk-emacs-var-dir) ; "~/.emacs.d/var/history"
           )
     (savehist-mode 1)
     ))


#+end_src
** Zaap hong

*** Doilei
#+begin_src emacs-lisp :tangle etc/init-idle.el
;;===================================================
;; Proxy settings
;;===================================================
(defun suk/proxy-http-show ()
  "Show http/https proxy."
  (interactive)
  (if url-proxy-services
      (message "Current HTTP proxy is \"%s\"" suk-proxy)
    (message "No proxy")))

(defun suk/proxy-http-enable ()
  "Enable http/https proxy."
  (interactive)
  (setq url-proxy-services `(("http" . suk-proxy)
                             ("https" . suk-proxy)
                             ("no_proxy" . "^\\(localhost\\|192.168.*\\|10.*\\)")))
  (suk/proxy-http-show))

(defun suk/proxy-http-disable ()
  "Disable http/https proxy."
  (interactive)
  (setq url-proxy-services nil)
  (suk/proxy-http-show))

(defun suk/proxy-http-toggle ()
  "Toggle http/https proxy."
  (interactive)
  (if url-proxy-services
      (suk/proxy-http-disable)
    (suk/proxy-http-enable)))

(defun suk/proxy-socks-enable ()
  "Enable Socks proxy."
  (interactive)
  (setq url-gateway-method 'socks)
  (setq socks-noproxy '("localhost"))
  (setq socks-server '("Default server" "127.0.0.1" 1080 5))
  (message "Enable socks proxy."))

(defun suk/proxy-socks-disable ()
  "Disable Socks proxy."
  (interactive)
  (setq url-gateway-method 'native)
  (setq socks-noproxy nil)
  (message "Disable socks proxy."))

#+end_src
*** Byte Compile
#+begin_src emacs-lisp :tangle etc/init-idle.el
;;===================================================
;; Byte Compile
;;===================================================
(defun byte-compile-elpa ()
  "Compile packages in elpa directory. Useful if you switch Emacs versions."
  (interactive)
  (if (fboundp 'async-byte-recompile-directory)
      (async-byte-recompile-directory package-user-dir)
    (byte-recompile-directory package-user-dir 0 t)))

(defun byte-compile-extensions ()
  "Compile packages in extensions directory."
  (interactive)
  (let ((dir (locate-user-emacs-file "extensions")))
    (if (fboundp 'async-byte-recompile-directory)
        (async-byte-recompile-directory dir)
      (byte-recompile-directory dir 0 t))))

(defun native-compile-elpa ()
  "Native-compile packages in elpa directory."
  (interactive)
  (if (fboundp 'native-compile-async)
      (native-compile-async package-user-dir t)))

(defun native-compile-extensions ()
  "Native compile packages in extensions directory."
  (interactive)
  (let ((dir (locate-user-emacs-file "extensions")))
    (if (fboundp 'native-compile-async)
        (native-compile-async dir t))))

(defun suk-set-variable (variable value &optional no-save)
  "Set the VARIABLE to VALUE, and return VALUE.

  Save to option `custom-file' if NO-SAVE is nil."
  (customize-set-variable variable value)
  (when (and (not no-save)
             (file-writable-p custom-file))
    (with-temp-buffer
      (insert-file-contents custom-file)
      (goto-char (point-min))
      (while (re-search-forward
              (format "^[\t ]*[;]*[\t ]*(setq %s .*)" variable)
              nil t)
        (replace-match (format "(setq %s '%s)" variable value) nil nil))
      (write-region nil nil custom-file)
      (message "Saved %s (%s) to %s" variable value custom-file))))


#+end_src
*** GÃ¡ngsan
#+begin_src emacs-lisp :tangle etc/init-idle.el

;;===================================================
;; Update
;;===================================================
(defun update-config ()
  "Update Suk's Emacs configurations to the latest version."
  (interactive)
  (let ((dir (expand-file-name user-emacs-directory)))
    (unless (file-exists-p dir)
      (user-error "\"%s\" doesn't exist" dir))

    (message "Updating configurations...")
    (cd dir)
    (shell-command "git pull")
    (message "Updating configurations...done")))
(defalias 'suk-update-config #'update-config)

(defun update-packages ()
  "Refresh package contents and update all packages."
  (interactive)
  (message "Updating packages...")
  (package-upgrade-all)
  (message "Updating packages...done"))
(defalias 'suk-update-packages #'update-packages)

(defun update-config-and-packages()
  "Update confgiurations and packages."
  (interactive)
  (update-config)
  (update-packages))
(defalias 'suk-update #'update-config-and-packages)

(defun update-dotfiles ()
  "Update the dotfiles to the latest version."
  (interactive)
  (let ((dir (or (getenv "DOTFILES")
                 (expand-file-name "~/.dotfiles/"))))
    (if (file-exists-p dir)
        (progn
          (message "Updating dotfiles...")
          (cd dir)
          (shell-command "git pull")
          (message "Updating dotfiles...done"))
      (message "\"%s\" doesn't exist" dir))))
(defalias 'suk-update-dotfiles #'update-dotfiles)

(defun update-org ()
  "Update Org files to the latest version."
  (interactive)
  (let ((dir (expand-file-name "~/org/")))
    (if (file-exists-p dir)
        (progn
          (message "Updating org files...")
          (cd dir)
          (shell-command "git pull")
          (message "Updating org files...done"))
      (message "\"%s\" doesn't exist" dir))))
(defalias 'suk-update-org #'update-org)

(defun update-all()
  "Update dotfiles, org files, configurations and packages to the latest."
  (interactive)
  (update-org)
  (update-dotfiles)
  (update-config-and-packages))
(defalias 'suk-update-all #'update-all)


#+end_src
*** JungdÃ¼n
#+begin_src emacs-lisp :tangle etc/init-idle.el
;; ==================================================
;; Terminate
;; ==================================================
(defun term()
  "Use Bash in windows."
  (interactive)
  (if sys/win32p
      (let (
            (shell-file-name windows-bash-path)
            )
        (call-interactively 'shell))
    (let ((explicit-shell-file-name "/bin/bash"))
      (call-interactively 'shell)))
  )

#+end_src
* etc/init-im.el
#+begin_src emacs-lisp :tangle  etc/init-im.el
;;; init-im -- è¾“å…¥æ³•
;;; summary:
;; è¾“å…¥æ³•
;; code:
;; å†…ç½®æœºåˆ¶
;;(require 'zyoy)
;;(require 'rain)
;;(require 'he)
;;(require 'he-quick)
;; (require 'flypy)

;; pyim
;; åœ¨windowsä¸‹è¾“å…¥æ³•éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå°±æ˜¯linuxæ¯”è¾ƒæ¶å¿ƒäº†ã€‚
(when sys/linuxp
  (require 'pyim-init))


(provide 'init-im)

#+end_src
* etc/ide.el
#+begin_src emacs-lisp :tangle etc/init-ide.el
  ;; -*- coding: utf-8; lexical-binding: t; -*-
  ;;; init-ide.el --- IDE configuration


  (provide 'init-ide)

  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require '+func)
    (require 'init-package))

  ;; è¯­æ³•æ£€æŸ¥åŒ…
  (use-package flycheck
    :ensure t
    :defer 3)

  ;; format all, formatter for almost languages
  ;; great for programmers
  (use-package format-all
    :ensure t
    :hook (prog-mode . format-all-ensure-formatter)
    :bind ("C-c f" . #'format-all-buffer))

  (setq-default indent-tabs-mode nil)
  (setq-default tab-width 4)

  ;; æŠ˜å å’Œæ”¶ç¼©ä»£ç 
  (use-package hideshow
    :ensure nil
    :diminish hs-minor-mode
    :pretty-hydra
    ((:title (pretty-hydra-title "HideShow" 'octicon "nf-oct-fold")
             :color amaranth :quit-key ("q" "C-g"))
     ("Fold"
      (("t" hs-toggle-all "toggle all")
       ("a" hs-show-all "show all")
       ("i" hs-hide-all "hide all")
       ("g" hs-toggle-hiding "toggle hiding")
       ("c" hs-cycle "cycle block")
       ("s" hs-show-block "show block")
       ("h" hs-hide-block "hide block")
       ("l" hs-hide-level "hide level"))
      "Move"
      (("C-a" mwim-beginning-of-code-or-line "â­°")
       ("C-e" mwim-end-of-code-or-line "â­²")
       ("C-b" backward-char "â†")
       ("C-n" next-line "â†“")
       ("C-p" previous-line "â†‘")
       ("C-f" forward-char "â†’")
       ("C-v" pager-page-down "â†˜")
       ("M-v" pager-page-up "â†–")
       ("M-<" beginning-of-buffer "â­¶")
       ("M->" end-of-buffer "â­¸"))))
    :bind
    (:map hs-minor-mode-map
                ("C-~" . hideshow-hydra/body)
                ("C-S-<escape>" . hideshow-hydra/body)
                ("C-c ." . hs-toggle-hiding)
                ("C-c ," . hs-show-all)
                )
    :hook (prog-mode . hs-minor-mode)
    :config
    ;; More functions
    ;; @see https://karthinks.com/software/simple-folding-with-hideshow/
    (defun hs-cycle (&optional level)
      (interactive "p")
      (let (message-log-max
            (inhibit-message t))
        (if (= level 1)
            (pcase last-command
              ('hs-cycle
               (hs-hide-level 1)
               (setq this-command 'hs-cycle-children))
              ('hs-cycle-children
               (save-excursion (hs-show-block))
               (setq this-command 'hs-cycle-subtree))
              ('hs-cycle-subtree
               (hs-hide-block))
              (_
               (if (not (hs-already-hidden-p))
                   (hs-hide-block)
                 (hs-hide-level 1)
                 (setq this-command 'hs-cycle-children))))
          (hs-hide-level level)
          (setq this-command 'hs-hide-level))))

    (defun hs-toggle-all ()
      "Toggle hide/show all."
      (interactive)
      (pcase last-command
        ('hs-toggle-all
         (save-excursion (hs-show-all))
         (setq this-command 'hs-global-show))
        (_ (hs-hide-all))))

    ;; Display line counts
    (defun hs-display-code-line-counts (ov)
      "Display line counts when hiding codes."
      (when (eq 'code (overlay-get ov 'hs))
        (overlay-put ov 'display
                     (concat
                      " "
                      (propertize
                       (if (char-displayable-p ?â·) "â·" "...")
                       'face 'shadow)
                      (propertize
                       (format " (%d lines)"
                               (count-lines (overlay-start ov)
                                            (overlay-end ov)))
                       'face '(:inherit shadow :height 0.8))
                      " "))))
    (setq hs-set-up-overlay #'hs-display-code-line-counts))

  ;;ä»£ç æŠ˜å 
  (add-hook 'c-mode-common-hook   'hs-minor-mode)
  (add-hook 'emacs-lisp-mode-hook 'hs-minor-mode)
  (add-hook 'java-mode-hook       'hs-minor-mode)
  (add-hook 'ess-mode-hook        'hs-minor-mode)
  (add-hook 'perl-mode-hook       'hs-minor-mode)
  (add-hook 'sh-mode-hook         'hs-minor-mode)
  (add-hook 'python-mode-hook     'hs-minor-mode)

  ;; ä»£ç ç‰‡æ®µ
  (require 'yasnippet)
  (use-package yasnippet
    :load-path "~/.emacs.d/extensions/yasnippet"
    :config
    (setq yas-snippet-dirs '("~/.emacs.d/share/snippets"))
    (yas-global-mode 1)
    (autoload 'yas-minor-mode-on "yasnippet")
    )


  (dolist (x '(org-mode-hook prog-mode-hook snippet-mode-hook))
    (add-hook x #'yas-minor-mode-on))

  ;; Prettify Symbols
  ;; e.g. display â€œlambdaâ€ as â€œÎ»â€
  (use-package prog-mode
    :ensure nil
    :hook (prog-mode . prettify-symbols-mode)
    :init
    (setq-default prettify-symbols-alist suk-prettify-symbols-alist)
    (setq prettify-symbols-unprettify-at-point 'right-edge))

  ;; Misc. programming modes

  (unless emacs/>=29p
    (use-package csharp-mode))
  (use-package powershell)
  (use-package csv-mode)

  (require 'init-treemacs)
  (require 'init-lang-web)
  (require 'init-lang-elisp)

  (use-package projectile
      :ensure t
      :config
      ;;(setq projectile-completion-system 'ido)
      ;;(setq ido-enable-flex-matching t)
      (setq projectile-completion-system 'ivy)
      ;; Eanble Projectile globally
      (projectile-mode 1)
      ;; Set akeybinding for projectile commands
      (global-set-key (kbd "C-c p") 'projectile-commander))

    ;;Show function arglist or variable docstring
    (use-package eldoc
      :ensure nil
      :diminish
      :config
      (when (childframe-workable-p)
        (use-package eldoc-box
          :diminish (eldoc-box-hover-mode eldoc-box-hover-at-point-mode)
          :custom
          (eldoc-box-lighter nil)
          (eldoc-box-only-multi-line t)
          (eldoc-box-clear-with-C-g t)
          :custom-face
          (eldoc-box-border ((t (:inherit posframe-border :background unspecified))))
          (eldoc-box-body ((t (:inherit tooltip))))
          :hook ((eglot-managed-mode . eldoc-box-hover-at-point-mode))
          :config
          ;; Prettify `eldoc-box' frame
          (setf (alist-get 'left-fringe eldoc-box-frame-parameters) 8
                (alist-get 'right-fringe eldoc-box-frame-parameters) 8))))

    ;; Cross-referencing commands
    (use-package xref
      :bind (("M-g ." . xref-find-definitions)
             ("M-g ," . xref-go-back))
      :init
      ;; Use faster search tool
      (when (executable-find "rg")
        (setq xref-search-program 'ripgrep))

      ;; Select from xref candidates in minibuffer
      (setq xref-show-definitions-function #'xref-show-definitions-completing-read
            xref-show-xrefs-function #'xref-show-definitions-completing-read))

  (use-package helpful)


  ;; ;; Enable lsp-mode for JavaScript development
  ;; (use-package lsp-mode
  ;;   :hook ((js-mode . lsp)
  ;;          (js2-mode . lsp)
  ;;          (typescript-mode . lsp))
  ;;   :commands lsp)

  ;; ;; Enable lsp-ui for additional UI features
  ;; (use-package lsp-ui
  ;;   :commands lsp-ui-mode)

  ;; https://github.com/manateelazycat/lsp-bridge
  (require 'lsp-bridge)
  (global-lsp-bridge-mode)
  (add-hook 'prog-mode-hook 'lsp-bridge-mode)
  ;; set the python interpreter path if it's different from default
  (setq lsp-bridge-python-command "C:\\green\Python311\\python.exe")

  (require 'lsp-bridge-jdtls) ;; æ ¹æ®é¡¹ç›®è‡ªåŠ¨ç”Ÿæˆè‡ªå®šä¹‰é…ç½®ï¼Œæ·»åŠ å¿…è¦çš„å¯åŠ¨å‚æ•°
  (setq lsp-bridge-enable-auto-import t) ;; å¼€å¯è‡ªåŠ¨å¯¼å…¥ä¾èµ–ï¼Œç›®å‰æ²¡æœ‰code actionã€‚è¡¥å…¨æ—¶å¯ä»¥é€šè¿‡è¿™ä¸ªå¯¼å…¥ç›¸åº”çš„ä¾èµ–ï¼Œå»ºè®®å¼€å¯ã€‚
  (setq lsp-bridge-jdtls-jvm-args '("-javaagent:c:/User/suk/.m2/repository/org/projectlombok/lombok/1.18.32/lombok-1.18.32.jar"))
  (custom-set-variables '(lsp-bridge-get-workspace-folder 'my-lsp-bridge-workspace))
  (add-hook 'java-mode-hook (lambda ()
                              (setq-local lsp-bridge-get-lang-server-by-project 'lsp-bridge-get-jdtls-server-by-project)))


  (defun my-lsp-bridge-workspace (proj)
    (let* ((proj-2-workspace
            '(("D:/03_projects/suk/word-process-src" . "file://D:/03_projects/suk")
              ("D:/03_projects/suk/anysql" . "file://D:/03_projects/suk")


            ))
           (kv (assoc proj proj-2-workspace)))
      (when kv
          (cdr kv))))

  ;; Jump to definition
  (use-package dumb-jump
      :pretty-hydra
      ((:title (pretty-hydra-title "Dump Jump" 'faicon "nf-fa-anchor")
        :color blue :quit-key ("q" "C-g"))
       ("Jump"
        (("j" dumb-jump-go "Go")
         ("o" dumb-jump-go-other-window "Go other window")
         ("e" dumb-jump-go-prefer-external "Go external")
         ("x" dumb-jump-go-prefer-external-other-window "Go external other window"))
        "Other"
        (("i" dumb-jump-go-prompt "Prompt")
         ("l" dumb-jump-quick-look "Quick look")
         ("b" dumb-jump-back "Back"))))
      :bind (("C-M-j" . dumb-jump-hydra/body))
      :init
      (add-hook 'xref-backend-functions #'dumb-jump-xref-activate)
      (setq dumb-jump-selector 'completing-read))

    ;; Tree-sitter support
    (when (suk-treesit-available-p)
      (use-package treesit-auto
        :hook (after-init . global-treesit-auto-mode)
        :init (setq treesit-auto-install 'prompt)))

  (use-package cmake-mode)
  (use-package yaml-mode)
  (use-package vimrc-mode)
  (require 'init-lang-vcs)


  ;;(setq copilot-node-executable "C:\\green\\node-v20.10.0-win-x64\\node.exe")
  ;;(add-to-list 'load-path "C:\\green\\emacs-suk\\.emacs.d\\extensions\\copilot\\copilot.el")

  ;;(require 'copilot)
  ;;(add-hook 'prog-mode-hook 'copilot-mode)

  ;; To customize the behavior of copilot-mode, please check copilot-enable-predicates and copilot-disable-predicates.
  ;; You need to bind copilot-complete to some key and call copilot-clear-overlay inside post-command-hook.
  ;;(define-key copilot-completion-map
  ;;            (kbd "<tab>")
  ;;            'copilot-accept-completion)
  ;;(define-key copilot-completion-map (kbd "TAB") 'copilot-accept-completion)
  ;; (add-to-list 'copilot-major-mode-alist '("jsonl" . "json"))
  ;; Login to Copilot by M-x copilot-login. You can also check the status by M-x copilot-diagnose (NotAuthorized means you don't have a valid subscription).




  ;;; {{ shell and conf
  (my-add-auto-mode 'conf-mode
                    "\\.[^b][^a][a-zA-Z]*rc\\'"
                    "\\.aspell\\.en\\.pws\\'"
                    "\\.i3/config-base\\'"
                    "\\.config/systemd/user/.*\\.service\\'"
                    "\\mimeapps\\.list\\'"
                    "\\mimeapps\\.list\\'"
                    "\\.editorconfig\\'"
                    "\\.meta\\'"
                    "\\.env[0-9a-z.-]*\\'" ; ".env" or ".env.local"
                    "PKGBUILD\\'" ; archlinux
                    "\\.pgpass\\'"
                    "\\.?muttrc\\'"
                    "\\.mailcap\\'"
                    "yarn\\.lock\\'")
  ;; }}


  (my-add-auto-mode 'text-mode
                    "TAGS\\'"
                    "\\.pyim\\'"
                    "\\.ctags\\'")

  (my-add-auto-mode 'java-mode
                    ;; java
                    "\\.aj\\'"
                    ;; makefile
                    "\\.ninja\\'" )

  (my-add-auto-mode 'groovy-mode
                    "\\.groovy\\'"
                    "\\.gradle\\'" )

  (my-add-auto-mode 'sh-mode
                    "\\.bash\\(_profile\\|_history\\|rc\\.local\\|rc\\)?\\'"
                    "\\.z?sh\\'")

  (my-add-auto-mode 'cmake-mode
                    "CMakeLists\\.txt\\'"
                    "\\.cmake\\'" )

  ;; vimrc
  (my-add-auto-mode 'vimrc-mode "\\.?vim\\(rc\\)?\\'")

  (my-add-auto-mode 'csv-mode "\\.[Cc][Ss][Vv]\\'")

  (my-add-auto-mode 'rust-mode "\\.rs\\'")

  ;; {{ verilog
  (autoload 'verilog-mode "verilog-mode" "Verilog mode" t )
  (my-add-auto-mode 'verilog-mode "\\.[ds]?vh?\\'")
  ;; }}

  (my-add-auto-mode 'adoc-mode "\\.adoc\\'")

  (my-add-auto-mode 'texile-mode "\\.textile\\'")

  (my-add-auto-mode 'tcl-mode "Portfile\\'")

  ;; epub
  (my-add-auto-mode 'nov-mode "\\.epub\\'")

  (my-add-auto-mode 'octave-mode "\\.m\\'")

  ;; {{ web/html
  (my-add-auto-mode 'web-mode
                    "\\.\\(cmp\\|app\\|page\\|component\\|wp\\|vue\\|tmpl\\|php\\|module\\|inc\\|hbs\\|tpl\\|[gj]sp\\|as[cp]x\\|erb\\|mustache\\|djhtml\\|ftl\\|[rp]?html?\\|xul?\\|eex?\\|xml?\\|jst\\|ejs\\|erb\\|rbxlx\\|plist\\)\\'")
  ;; }}

  ;; {{js
  (my-add-auto-mode 'js-mode
                    "\\.ja?son\\'"
                    "\\.pac\\'"
                    "\\.jshintrc\\'")

  ;; javascript
  (my-add-auto-mode 'js2-mode "\\.js\\(\\.erb\\)?\\'")
  ;; JSX
  (my-add-auto-mode 'rjsx-mode
                    "\\.[tj]sx\\'"
                    "components\\/.*\\.js\\'")
  ;; mock file
  (my-add-auto-mode 'js-mode "\\.mock.js\\'")
  (my-add-interpreter-mode 'js2-mode "node")
  ;; å¦‚æžœå†…å­˜ä¸å¤šæ—¶ï¼Œä½¿ç”¨js-modeæ›¿ä»£js2-modeå’Œrjsx-mode
  ;;(my-add-auto-mode 'js-mode "\\.js\\(\\.erb\\)?\\'" "\\.babelrc\\'")

  (my-add-auto-mode 'typescript-mode "\\.ts\\'")
  (my-add-auto-mode 'lua-mode "\\.lua\\'")
  (my-add-auto-mode 'markdown-mode "\\.\\(m[k]d\\|markdown\\)\\'")
  (my-add-auto-mode 'snippet-mode "\\.yasnippet\\'")
  ;; python
  (my-add-interpreter-mode 'python-mode "python")
  ;; roblox studio
  (my-add-auto-mode 'roblox-mode "\\.rbxlx\\'")
  ;; }}

  ;; `css-mode' has better imenu support and won't force flymake to create rubbish files.
  ;; besides, scss/sass is outdated. We use postcss or css in js these days.
  (my-add-auto-mode 'css-mode "\\.scss\\'")

	(require 'fingertip)
	(dolist (hook (list
	               'c-mode-common-hook
	               'c-mode-hook
	               'c++-mode-hook
	               'java-mode-hook
	               'haskell-mode-hook
	               'emacs-lisp-mode-hook
	               'lisp-interaction-mode-hook
	               'lisp-mode-hook
	               'maxima-mode-hook
	               'ielm-mode-hook
	               'sh-mode-hook
	               'makefile-gmake-mode-hook
	               'php-mode-hook
	               'python-mode-hook
	               'js-mode-hook
	               'go-mode-hook
	               'qml-mode-hook
	               'jade-mode-hook
	               'css-mode-hook
	               'ruby-mode-hook
	               'coffee-mode-hook
	               'rust-mode-hook
	               'rust-ts-mode-hook
	               'qmake-mode-hook
	               'lua-mode-hook
	               'swift-mode-hook
	               'web-mode-hook
	               'markdown-mode-hook
	               'llvm-mode-hook
	               'conf-toml-mode-hook
	               'nim-mode-hook
	               'typescript-mode-hook
	               'c-ts-mode-hook
	               'c++-ts-mode-hook
	               'cmake-ts-mode-hook
	               'toml-ts-mode-hook
	               'css-ts-mode-hook
	               'js-ts-mode-hook
	               'json-ts-mode-hook
	               'python-ts-mode-hook
	               'bash-ts-mode-hook
	               'typescript-ts-mode-hook
	               ))
	  (add-hook hook #'(lambda () (fingertip-mode 1))))
	  (define-key fingertip-mode-map (kbd "(") 'fingertip-open-round)
	(define-key fingertip-mode-map (kbd "[") 'fingertip-open-bracket)
	(define-key fingertip-mode-map (kbd "{") 'fingertip-open-curly)
	(define-key fingertip-mode-map (kbd ")") 'fingertip-close-round)
	(define-key fingertip-mode-map (kbd "]") 'fingertip-close-bracket)
	(define-key fingertip-mode-map (kbd "}") 'fingertip-close-curly)
	(define-key fingertip-mode-map (kbd "=") 'fingertip-equal)

	(define-key fingertip-mode-map (kbd "£¨") 'fingertip-open-chinese-round)
	(define-key fingertip-mode-map (kbd "¡¸") 'fingertip-open-chinese-bracket)
	(define-key fingertip-mode-map (kbd "¡¾") 'fingertip-open-chinese-curly)
	(define-key fingertip-mode-map (kbd "£©") 'fingertip-close-chinese-round)
	(define-key fingertip-mode-map (kbd "¡¹") 'fingertip-close-chinese-bracket)
	(define-key fingertip-mode-map (kbd "¡¿") 'fingertip-close-chinese-curly)

	(define-key fingertip-mode-map (kbd "%") 'fingertip-match-paren)
	(define-key fingertip-mode-map (kbd "\"") 'fingertip-double-quote)
	(define-key fingertip-mode-map (kbd "'") 'fingertip-single-quote)

	(define-key fingertip-mode-map (kbd "SPC") 'fingertip-space)
	(define-key fingertip-mode-map (kbd "RET") 'fingertip-newline)

	(define-key fingertip-mode-map (kbd "M-o") 'fingertip-backward-delete)
	(define-key fingertip-mode-map (kbd "C-d") 'fingertip-forward-delete)
	(define-key fingertip-mode-map (kbd "C-k") 'fingertip-kill)

	(define-key fingertip-mode-map (kbd "M-\"") 'fingertip-wrap-double-quote)
	(define-key fingertip-mode-map (kbd "M-'") 'fingertip-wrap-single-quote)
	(define-key fingertip-mode-map (kbd "M-[") 'fingertip-wrap-bracket)
	(define-key fingertip-mode-map (kbd "M-{") 'fingertip-wrap-curly)
	(define-key fingertip-mode-map (kbd "M-(") 'fingertip-wrap-round)
	(define-key fingertip-mode-map (kbd "M-)") 'fingertip-unwrap)

	(define-key fingertip-mode-map (kbd "M-p") 'fingertip-jump-right)
	(define-key fingertip-mode-map (kbd "M-n") 'fingertip-jump-left)
	(define-key fingertip-mode-map (kbd "M-:") 'fingertip-jump-out-pair-and-newline)

	(define-key fingertip-mode-map (kbd "C-j") 'fingertip-jump-up)

  ;;; init-ide.el ends here
#+end_src
* etc/init-lang-c.el
#+begin_src emacs-lisp :tangle etc/init-lang-c.el
  ;; init-c.el --- Initialize c configurations.	-*- lexical-binding: t -*-

  (provide 'init-lang-c)

  (eval-when-compile
    (require '+custom))

  ;; Tip 1: use more popular style "linux" instead of "gnu",
  ;;
  ;;   (setq c-default-style '((java-mode . "java")
  ;;                           (awk-mode . "awk")
  ;;                           (other . "linux")))

  ;; Tip 2: Search my article "C/C++/Java code indentation in Emacs"
  ;; My code might be obsolete, but the knowledge is still valid.kk
  ;;
  ;; C code example:
  ;;   if(1) // press ENTER here, zero means no indentation
  ;;   void fn() // press ENTER here, zero means no indentation

  (defun my-common-cc-mode-setup ()
    "Setup shared by all languages (java/groovy/c++ ...)."
    ;; give me NO newline automatically after electric expressions are entered
    (setq c-auto-newline nil)

    ;;make DEL take all previous whitespace with it
    (c-toggle-hungry-state 1))

  (defun my-c-mode-setup ()
    "C/C++ only setup."
    ;; @see http://stackoverflow.com/questions/3509919/ \
    ;; emacs-c-opening-corresponding-header-file
    ;; Use `ff-find-other-file' to open C/C++ header

    (setq cc-search-directories '("." "/usr/include" "/usr/local/include/*" "../*/include" "$WXWIN/include"))

    ;; In theory, you can write your own Makefile for `flymake-mode' without cmake.
    ;; Nobody actually does it in real world.

    ;; Browse Emacs' C code
    (push '(nil "^DEFUN *(\"\\([a-zA-Z0-9-]+\\)" 1) imenu-generic-expression )

    ;; make a #define be left-aligned
    (setq c-electric-pound-behavior (quote (alignleft))))

  (defun c-mode-common-hook-setup ()
    "C/C++ setup."
    (unless (my-buffer-file-temp-p)
      (my-common-cc-mode-setup)
      (unless (or (derived-mode-p 'java-mode) (derived-mode-p 'groovy-mode))
        (my-c-mode-setup))))
  (add-hook 'c-mode-common-hook 'c-mode-common-hook-setup)


  ;; C/C++ Mode
  (use-package cc-mode
    :ensure nil
    :bind (:map c-mode-base-map
           ("<f12>" . compile))
    :init (setq-default c-basic-offset 4))

  (when (suk-treesit-available-p)
    (use-package c-ts-mode
      :init (setq c-ts-mode-indent-offset 4)))


#+end_src
* etc/init-lang-elisp.el
#+begin_src emacs-lisp :tangle etc/init-lang-elisp.el
  ;; init-elisp.el --- Initialize Emacs Lisp configurations.	-*- lexical-binding: t -*-

  (defun my-show-scratch-buffer-message ()
    "Show something in scratch buffer."
    (let* ((fortune-prog (or (executable-find "fortune-zh")
                             (executable-find "fortune"))))
      (cond
       (fortune-prog
        (format
         ";; %s\n\n"
         (replace-regexp-in-string
          "\n" "\n;; " ; comment each line
          (replace-regexp-in-string
           "\\(\n$\\|\\|\\[m *\\|\\[[0-9][0-9];?[0-9]?m *\\|\\[;m\\)" ""    ; remove trailing line break
           (shell-command-to-string fortune-prog)))))
       (t
        (concat ";; Happy hacking "
                (or user-login-name "")
                " - Emacs loves you!\n\n")))))

  (setq-default initial-scratch-message (my-show-scratch-buffer-message))
  ;; A quick way to jump to the definition of a function given its key binding
  (global-set-key (kbd "C-h K") 'find-function-on-key)

  (with-eval-after-load 'paredit
    (diminish 'paredit-mode " Par"))
  (defvar paredit-minibuffer-commands '(eval-expression
                                        pp-eval-expression
                                        eval-expression-with-eldoc
                                        ibuffer-do-eval
                                        ibuffer-do-view-and-eval)
    "Interactive commands for which paredit should be enabled in the minibuffer.")

  (defun my-lisp-setup ()
    "Enable features useful in any Lisp mode."
    (enable-paredit-mode)
    (rainbow-delimiters-mode t)
    (turn-on-eldoc-mode))

  (let* ((hooks '(lisp-mode-hook
                  inferior-lisp-mode-hook)))
    (dolist (hook hooks)
      (add-hook hook 'my-lisp-setup)))

  (defun elisp-mode-hook-setup ()
    (unless (my-buffer-file-temp-p)
      (my-ensure 'eldoc)
      (turn-on-eldoc-mode)
      (enable-paredit-mode)
      (rainbow-delimiters-mode t)

      ;; Locally set `hippie-expand' completion functions for use with Emacs Lisp.
      (make-local-variable 'hippie-expand-try-functions-list)
      (push 'try-complete-lisp-symbol hippie-expand-try-functions-list)
      (push 'try-complete-lisp-symbol-partially hippie-expand-try-functions-list)

      (checkdoc-minor-mode 1)))

  (add-hook 'emacs-lisp-mode-hook 'elisp-mode-hook-setup)

  ;; Emacs lisp mode
  (use-package elisp-mode
    :ensure nil
    :bind (:map emacs-lisp-mode-map
           ("C-c C-x" . ielm)
           ("C-c C-c" . eval-defun)
           ("C-c C-b" . eval-buffer))
    :config
    (with-no-warnings
      ;; Align indent keywords
      ;; @see https://emacs.stackexchange.com/questions/10230/how-to-indent-keywords-aligned
      (defun my-lisp-indent-function (indent-point state)
        "This function is the normal value of the variable `lisp-indent-function'.
  The function `calculate-lisp-indent' calls this to determine
  if the arguments of a Lisp function call should be indented specially.

  INDENT-POINT is the position at which the line being indented begins.
  Point is located at the point to indent under (for default indentation);
  STATE is the `parse-partial-sexp' state for that position.

  If the current line is in a call to a Lisp function that has a non-nil
  property `lisp-indent-function' (or the deprecated `lisp-indent-hook'),
  it specifies how to indent.  The property value can be:

  ,* `defun', meaning indent `defun'-style
    \(this is also the case if there is no property and the function
    has a name that begins with \"def\", and three or more arguments);

  ,* an integer N, meaning indent the first N arguments specially
    (like ordinary function arguments), and then indent any further
    arguments like a body;

  ,* a function to call that returns the indentation (or nil).
    `lisp-indent-function' calls this function with the same two arguments
    that it itself received.

  This function returns either the indentation to use, or nil if the
  Lisp function does not specify a special indentation."
        (let ((normal-indent (current-column))
              (orig-point (point)))
          (goto-char (1+ (elt state 1)))
          (parse-partial-sexp (point) calculate-lisp-indent-last-sexp 0 t)
          (cond
           ;; car of form doesn't seem to be a symbol, or is a keyword
           ((and (elt state 2)
                 (or (not (looking-at "\\sw\\|\\s_"))
                     (looking-at ":")))
            (if (not (> (save-excursion (forward-line 1) (point))
                        calculate-lisp-indent-last-sexp))
                (progn (goto-char calculate-lisp-indent-last-sexp)
                       (beginning-of-line)
                       (parse-partial-sexp (point)
                                           calculate-lisp-indent-last-sexp 0 t)))
            ;; Indent under the list or under the first sexp on the same
            ;; line as calculate-lisp-indent-last-sexp.  Note that first
            ;; thing on that line has to be complete sexp since we are
            ;; inside the innermost containing sexp.
            (backward-prefix-chars)
            (current-column))
           ((and (save-excursion
                   (goto-char indent-point)
                   (skip-syntax-forward " ")
                   (not (looking-at ":")))
                 (save-excursion
                   (goto-char orig-point)
                   (looking-at ":")))
            (save-excursion
              (goto-char (+ 2 (elt state 1)))
              (current-column)))
           (t
            (let ((function (buffer-substring (point)
                                              (progn (forward-sexp 1) (point))))
                  method)
              (setq method (or (function-get (intern-soft function)
                                             'lisp-indent-function)
                               (get (intern-soft function) 'lisp-indent-hook)))
              (cond ((or (eq method 'defun)
                         (and (null method)
                              (length> function 3)
                              (string-match "\\`def" function)))
                     (lisp-indent-defform state indent-point))
                    ((integerp method)
                     (lisp-indent-specform method state
                                           indent-point normal-indent))
                    (method
                     (funcall method indent-point state))))))))
      (add-hook 'emacs-lisp-mode-hook
                (lambda () (setq-local lisp-indent-function #'my-lisp-indent-function)))

      ;; Add remove buttons for advices
      (add-hook 'help-mode-hook 'cursor-sensor-mode)

      (defun function-advices (function)
        "Return FUNCTION's advices."
        (let ((flist (indirect-function function)) advices)
          (while (advice--p flist)
            (setq advices `(,@advices ,(advice--car flist)))
            (setq flist (advice--cdr flist)))
          advices))

      (defun add-remove-advice-button (advice function)
        (when (and (functionp advice) (functionp function))
          (let ((inhibit-read-only t)
                (msg (format "Remove advice `%s'" advice)))
            (insert "\t")
            (insert-button
             "Remove"
             'face 'custom-button
             'cursor-sensor-functions `((lambda (&rest _) ,msg))
             'help-echo msg
             'action (lambda (_)
                       (when (yes-or-no-p msg)
                         (message "%s from function `%s'" msg function)
                         (advice-remove function advice)
                         (if (eq major-mode 'helpful-mode)
                             (helpful-update)
                           (revert-buffer nil t))))
             'follow-link t))))

      (defun add-button-to-remove-advice (buffer-or-name function)
        "Add a button to remove advice."
        (with-current-buffer buffer-or-name
          (save-excursion
            (goto-char (point-min))
            (let ((ad-list (function-advices function)))
              (while (re-search-forward "^\\(?:This function has \\)?:[-a-z]+ advice: \\(.+\\)$" nil t)
                (let ((advice (car ad-list)))
                  (add-remove-advice-button advice function)
                  (setq ad-list (delq advice ad-list))))))))

      (define-advice describe-function-1 (:after (function) advice-remove-button)
        (add-button-to-remove-advice (help-buffer) function))
      (with-eval-after-load 'helpful
        (define-advice helpful-update (:after () advice-remove-button)
          (when helpful--callable-p
            (add-button-to-remove-advice (current-buffer) helpful--sym))))

      ;; Remove hooks
      (defun remove-hook-at-point ()
        "Remove the hook at the point in the *Help* buffer."
        (interactive)
        (unless (memq major-mode '(help-mode helpful-mode))
          (error "Only for help-mode or helpful-mode"))

        (let ((orig-point (point)))
          (save-excursion
            (when-let
                ((hook (progn (goto-char (point-min)) (symbol-at-point)))
                 (func (when (and
                              (or (re-search-forward (format "^Value:?[\s|\n]") nil t)
                                  (goto-char orig-point))
                              (sexp-at-point))
                         (end-of-sexp)
                         (backward-char 1)
                         (catch 'break
                           (while t
                             (condition-case _err
                                 (backward-sexp)
                               (scan-error (throw 'break nil)))
                             (let ((bounds (bounds-of-thing-at-point 'sexp)))
                               (when (<= (car bounds) orig-point (cdr bounds))
                                 (throw 'break (sexp-at-point)))))))))
              (when (yes-or-no-p (format "Remove %s from %s? " func hook))
                (remove-hook hook func)
                (if (eq major-mode 'helpful-mode)
                    (helpful-update)
                  (revert-buffer nil t)))))))
      (bind-key "r" #'remove-hook-at-point help-mode-map)))

  ;; Interactive macro expander
  (use-package macrostep
    :bind (:map emacs-lisp-mode-map
           ("C-c e" . macrostep-expand)
           :map lisp-interaction-mode-map
           ("C-c e" . macrostep-expand)))


  (provide 'init-lang-elisp)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; init-elisp.el ends here
#+end_src
* etc/init-lang-vcs.el
#+begin_src emacs-lisp :tangle etc/init-lang-vcs.el
  ;; init-vcs.el --- Initialize version control system configurations.	-*- lexical-binding: t -*-

  (provide 'init-lang-vcs)

  (eval-when-compile
    (require '+const)
    (require '+func)
    )


  ;; ;; {{ Solution 1: disable all vc backends
  ;; @see http://stackoverflow.com/questions/5748814/how-does-one-disable-vc-git-in-emacs
  ;; (setq vc-handled-backends nil)
  ;; }}

  ;; {{ Solution 2: if NO network mounted drive involved
  (setq vc-handled-backends '(Git SVN Hg))
  ;; @see https://www.reddit.com/r/emacs/comments/4c0mi3/the_biggest_performance_improvement_to_emacs_ive/
  ;; open files faster but you can't check if file is version
  ;; controlled. other VCS functionality still works.
  (remove-hook 'find-file-hook 'vc-find-file-hook)
  ;; }}


  ;; Git
  ;; See `magit-define-global-key-bindings'
  (use-package magit
    :init (setq magit-diff-refine-hunk t)
    :config
    (when sys/win32p
      (setenv "GIT_ASKPASS" "git-gui--askpass"))

    ;; Unbind M-1, M-2, M-3, and M-4 shortcuts due to conflict with `ace-window'
    (unbind-key "M-1" magit-mode-map)
    (unbind-key "M-2" magit-mode-map)
    (unbind-key "M-3" magit-mode-map)
    (unbind-key "M-4" magit-mode-map)


    (with-eval-after-load 'hydra
      ;; {{ git-gutter, @see https://github.com/abo-abo/hydra/wiki/Git-gutter
      (defhydra my-hydra-git (:body-pre
                              (progn
                                (git-gutter-mode 1)
                                (setq git-link-use-commit t))
                              :after-exit (setq git-link-use-commit nil)
                              :color blue)
        "
  Git:
  [_dd_] Diff               [_ri_] Rebase closest
  [_dc_] Diff staged        [_s_] Show commit
  [_dr_] Diff range         [_rr_] Reset gutter
  [_au_] Add modified       [_rh_] Gutter => HEAD
  [_cc_] Commit             [_l_] Log selected/file
  [_ca_] Amend              [_b_] Branches
  [_ja_] Amend silent       [_k_] Git commit link
  [_tt_] Stash              [_Q_] Quit gutter
  [_ta_] Apply stash        [_cr_] Cherry pick from reflog
  [_f_] Find file in commit

  "
        ("ri" my-git-rebase-interactive)
        ("rr" my-git-gutter-reset-to-default)
        ("rh" my-git-gutter-reset-to-head-parent)
        ("cb" my-git-current-branch)
        ("s" my-git-show-commit)
        ("l" magit-log-buffer-file)
        ("b" magit-show-refs)
        ("k" git-link)
        ("g" magit-status)
        ("ta" magit-stash-apply)
        ("tt" magit-stash)
        ("dd" magit-diff-dwim)
        ("dc" magit-diff-staged)
        ("dr" (magit-diff-range (my-git-commit-id)))
        ("cc" magit-commit-create)
        ("ca" magit-commit-amend)
        ("nn" my-git-commit-create)
        ("na" my-git-commit-amend)
        ("ja" (my-git-commit-amend t))
        ("au" magit-stage-modified)
        ("Q" my-git-gutter-toggle)
        ("f" my-git-find-file-in-commit)
        ("cr" my-git-cherry-pick-from-reflog)
        ("q" nil))
      (global-set-key (kbd "C-c C-g") 'my-hydra-git/body)
      )
    ;; }}

    ;; Access Git forges from Magit
    (use-package forge
      :demand t
      :custom-face
      (forge-topic-label ((t (:inherit variable-pitch :height 0.9 :width condensed :weight regular :underline nil))))
      :init (setq forge-topic-list-columns
                  '(("#" 5 forge-topic-list-sort-by-number (:right-align t) number nil)
                    ("Title" 60 t nil title  nil)
                    ("State" 6 t nil state nil)
                    ("Updated" 10 t nil updated nil)))))

  (with-eval-after-load 'magit
    ;; {{speed up magit, @see https://jakemccrary.com/blog/2020/11/14/speeding-up-magit/
    (when my-prefer-lightweight-magit
      (remove-hook 'magit-status-sections-hook 'magit-insert-tags-header)
      (remove-hook 'magit-status-sections-hook 'magit-insert-status-headers)
      (remove-hook 'magit-status-sections-hook 'magit-insert-unpushed-to-pushremote)
      (remove-hook 'magit-status-sections-hook 'magit-insert-unpulled-from-pushremote)
      (remove-hook 'magit-status-sections-hook 'magit-insert-unpulled-from-upstream)
      (remove-hook 'magit-status-sections-hook 'magit-insert-unpushed-to-upstream-or-recent))
    ;; }}

    ;; "Continue listing the history of a file beyond renames (works only for a single file)."
    ;; - quoted from "git help log"
    (setq-default magit-buffer-log-args '("--follow"))

    ;; extra check&report after commit
    (defun my-git-check-status ()
      "Check git repo status."
      ;; use timer here to wait magit cool down
      (my-run-with-idle-timer 1 #'my-hint-untracked-files))
    (add-hook 'magit-post-commit-hook #'my-git-check-status)
    (add-hook 'git-commit-post-finish-hook #'my-git-check-status))

  ;; Display transient in child frame
  (when (childframe-completion-workable-p)
    (use-package transient-posframe
      :diminish
      :defines posframe-border-width
      :custom-face
      (transient-posframe ((t (:inherit tooltip))))
      (transient-posframe-border ((t (:inherit posframe-border :background unspecified))))
      :hook (after-init . transient-posframe-mode)
      :init
      (setq transient-posframe-border-width posframe-border-width
            transient-posframe-min-height nil
            transient-posframe-min-width 80
            transient-posframe-poshandler 'posframe-poshandler-frame-center
            transient-posframe-parameters '((left-fringe . 8)
                                            (right-fringe . 8)))
      :config
      (with-no-warnings
        (defun my-transient-posframe--hide ()
          "Hide transient posframe."
          (posframe-hide transient--buffer-name))
        (advice-add #'transient-posframe--delete :override #'my-transient-posframe--hide))))

  ;; Walk through git revisions of a file
  (use-package git-timemachine
    :custom-face
    (git-timemachine-minibuffer-author-face ((t (:inherit success :foreground unspecified))))
    (git-timemachine-minibuffer-detail-face ((t (:inherit warning :foreground unspecified))))
    :bind (:map vc-prefix-map
           ("t" . git-timemachine))
    :hook ((git-timemachine-mode . (lambda ()
                                     "Improve `git-timemachine' buffers."
                                     ;; Display different colors in mode-line
                                     (if (facep 'mode-line-active)
                                         (face-remap-add-relative 'mode-line-active 'custom-state)
                                       (face-remap-add-relative 'mode-line 'custom-state))

                                     ;; Highlight symbols in elisp
                                     (and (derived-mode-p 'emacs-lisp-mode)
                                          (fboundp 'highlight-defined-mode)
                                          (highlight-defined-mode t))

                                     ;; Display line numbers
                                     (and (derived-mode-p 'prog-mode 'yaml-mode)
                                          (fboundp 'display-line-numbers-mode)
                                          (display-line-numbers-mode t))))
           (before-revert . (lambda ()
                              (when (bound-and-true-p git-timemachine-mode)
                                (user-error "Cannot revert the timemachine buffer")))))
    :config
    ;; {{ git-timemachine
    (defun my-git-timemachine-show-selected-revision ()
      "Show last (current) revision of file."
      (interactive)
      (let* ((collection (mapcar (lambda (rev)
                                   ;; re-shape list for the ivy-read
                                   (cons (concat (substring-no-properties (nth 0 rev) 0 7) "|" (nth 5 rev) "|" (nth 6 rev)) rev))
                                 (git-timemachine--revisions))))
        (ivy-read "commits:"
                  collection
                  :action (lambda (rev)
                            ;; compatible with ivy 8+ and later ivy version
                            (unless (string-match "^[a-z0-9]*$" (car rev))
                              (setq rev (cdr rev)))
                            (git-timemachine-show-revision rev)))))

    (defun my-git-timemachine ()
      "Open git snapshot with the selected version."
      (interactive)
      (my-ensure 'git-timemachine)
      (git-timemachine--start #'my-git-timemachine-show-selected-revision))
    ;; }}
    )

  ;; Pop up last commit information of current line
  (use-package git-messenger
    :bind (:map vc-prefix-map
           ("p" . git-messenger:popup-message)
           :map git-messenger-map
           ("m" . git-messenger:copy-message))
    :init (setq git-messenger:show-detail t
                git-messenger:use-magit-popup t)
    :config
    (with-no-warnings
      (with-eval-after-load 'hydra
        (defhydra git-messenger-hydra (:color blue)
          ("s" git-messenger:popup-show "show")
          ("c" git-messenger:copy-commit-id "copy hash")
          ("m" git-messenger:copy-message "copy message")
          ("," (catch 'git-messenger-loop (git-messenger:show-parent)) "go parent")
          ("q" git-messenger:popup-close "quit")))

      (defun my-git-messenger:format-detail (vcs commit-id author message)
        (if (eq vcs 'git)
            (let ((date (git-messenger:commit-date commit-id))
                  (colon (propertize ":" 'face 'font-lock-comment-face)))
              (concat
               (format "%s%s %s \n%s%s %s\n%s  %s %s \n"
                       (propertize "Commit" 'face 'font-lock-keyword-face) colon
                       (propertize (substring commit-id 0 8) 'face 'font-lock-comment-face)
                       (propertize "Author" 'face 'font-lock-keyword-face) colon
                       (propertize author 'face 'font-lock-string-face)
                       (propertize "Date" 'face 'font-lock-keyword-face) colon
                       (propertize date 'face 'font-lock-string-face))
               (propertize (make-string 38 ?â”€) 'face 'font-lock-comment-face)
               message
               (propertize "\nPress q to quit" 'face '(:inherit (font-lock-comment-face italic)))))
          (git-messenger:format-detail vcs commit-id author message)))

      (defun my-git-messenger:popup-message ()
        "Popup message with `posframe', `pos-tip', `lv' or `message', and dispatch actions with `hydra'."
        (interactive)
        (let* ((hydra-hint-display-type 'message)
               (vcs (git-messenger:find-vcs))
               (file (buffer-file-name (buffer-base-buffer)))
               (line (line-number-at-pos))
               (commit-info (git-messenger:commit-info-at-line vcs file line))
               (commit-id (car commit-info))
               (author (cdr commit-info))
               (msg (git-messenger:commit-message vcs commit-id))
               (popuped-message (if (git-messenger:show-detail-p commit-id)
                                    (my-git-messenger:format-detail vcs commit-id author msg)
                                  (cl-case vcs
                                    (git msg)
                                    (svn (if (string= commit-id "-")
                                             msg
                                           (git-messenger:svn-message msg)))
                                    (hg msg)))))
          (setq git-messenger:vcs vcs
                git-messenger:last-message msg
                git-messenger:last-commit-id commit-id)
          (run-hook-with-args 'git-messenger:before-popup-hook popuped-message)
          (git-messenger-hydra/body)
          (cond ((and (fboundp 'posframe-workable-p) (posframe-workable-p))
                 (let ((buffer-name "*git-messenger*"))
                   (posframe-show buffer-name
                                  :string (concat (propertize "\n" 'face '(:height 0.3))
                                                  popuped-message
                                                  "\n"
                                                  (propertize "\n" 'face '(:height 0.3)))
                                  :left-fringe 8
                                  :right-fringe 8
                                  :max-width (round (* (frame-width) 0.62))
                                  :max-height (round (* (frame-height) 0.62))
                                  :internal-border-width 1
                                  :internal-border-color (face-background 'posframe-border nil t)
                                  :background-color (face-background 'tooltip nil t))
                   (unwind-protect
                       (push (read-event) unread-command-events)
                     (posframe-hide buffer-name))))
                ((and (fboundp 'pos-tip-show) (display-graphic-p))
                 (pos-tip-show popuped-message))
                ((fboundp 'lv-message)
                 (lv-message popuped-message)
                 (unwind-protect
                     (push (read-event) unread-command-events)
                   (lv-delete-window)))
                (t (message "%s" popuped-message)))
          (run-hook-with-args 'git-messenger:after-popup-hook popuped-message)))
      (advice-add #'git-messenger:popup-close :override #'ignore)
      (advice-add #'git-messenger:popup-message :override #'my-git-messenger:popup-message)))

  ;; Resolve diff3 conflicts
  (use-package smerge-mode
    :ensure nil
    :diminish
    :pretty-hydra
    ((:title (pretty-hydra-title "Smerge" 'octicon "nf-oct-diff")
      :color pink :quit-key ("q" "C-g"))
     ("Move"
      (("n" smerge-next "next")
       ("p" smerge-prev "previous"))
      "Keep"
      (("b" smerge-keep-base "base")
       ("u" smerge-keep-upper "upper")
       ("l" smerge-keep-lower "lower")
       ("a" smerge-keep-all "all")
       ("RET" smerge-keep-current "current")
       ("C-m" smerge-keep-current "current"))
      "Diff"
      (("<" smerge-diff-base-upper "upper/base")
       ("=" smerge-diff-upper-lower "upper/lower")
       (">" smerge-diff-base-lower "upper/lower")
       ("R" smerge-refine "refine")
       ("E" smerge-ediff "ediff"))
      "Other"
      (("C" smerge-combine-with-next "combine")
       ("r" smerge-resolve "resolve")
       ("k" smerge-kill-current "kill")
       ("ZZ" (lambda ()
               (interactive)
               (save-buffer)
               (bury-buffer))
        "Save and bury buffer" :exit t))))
    :bind (:map smerge-mode-map
           ("C-c m" . smerge-mode-hydra/body))
    :hook ((find-file . (lambda ()
                          (save-excursion
                            (goto-char (point-min))
                            (when (re-search-forward "^<<<<<<< " nil t)
                              (smerge-mode 1)))))
           (magit-diff-visit-file . (lambda ()
                                      (when smerge-mode
                                        (smerge-mode-hydra/body))))))

  ;; Open github/gitlab/bitbucket page
  (use-package browse-at-remote
    :bind (:map vc-prefix-map
           ("B" . browse-at-remote)))

  ;; Git configuration modes
  (use-package git-modes)


  ;; {{ git-gutter
  (with-eval-after-load 'git-gutter
    (unless (fboundp 'global-display-line-numbers-mode)
      ;; git-gutter's workaround for linum-mode bug.
      ;; should not be used in `display-line-number-mode'
      (git-gutter:linum-setup))

    (setq git-gutter:update-interval 2)
    ;; nobody use bzr
    ;; I could be forced to use subversion or hg which has higher priority
    ;; Please note my $HOME directory is under git control
    (setq git-gutter:handled-backends '(svn hg git))
    (setq git-gutter:disabled-modes
          '(asm-mode
            org-mode
            outline-mode
            markdown-mode
            image-mode))


    )

  (defun my-git-gutter-reset-to-head-parent()
    "Reset gutter to HEAD^.  Support Subversion and Git."
    (interactive)
    (let* ((filename (buffer-file-name))
           (cmd (concat "git --no-pager log --oneline -n1 --pretty=\"format:%H\" "
                        filename))
           (parent (cond
                    ((eq git-gutter:vcs-type 'svn)
                     "PREV")
                    (filename
                     (concat (shell-command-to-string cmd) "^"))
                    (t
                     "HEAD^"))))
      (git-gutter:set-start-revision parent)
      (message "git-gutter:set-start-revision HEAD^")))
  (defvar my-prefer-lightweight-magit t)
  ;;;###autoload
  (defun my-hint-untracked-files ()
    "If untracked files and committed files share same extension, warn users."

    ;; don't scan whole home directory
    (unless (string= (file-truename default-directory) (file-truename "~/"))
      (let* ((exts (mapcar 'file-name-extension (my-lines-from-command-output "git diff-tree --no-commit-id --name-only -r HEAD")))
             (untracked-files (my-lines-from-command-output "git --no-pager ls-files --others --exclude-standard"))
             (lookup-ext (make-hash-table :test #'equal))
             rlt)
        ;; file extensions of files in HEAD commit
        (dolist (ext exts)
          (puthash ext t lookup-ext))
        ;; If untracked file has same file extension as committed files
        ;; maybe they should be staged too?
        (dolist (file untracked-files)
          (when (gethash (file-name-extension file) lookup-ext)
            (push (file-name-nondirectory file) rlt)))
        (when rlt
          (message "Stage files? %s" (mapconcat 'identity rlt " "))))))


  (defun my-git-gutter-toggle ()
    "Toggle git gutter."
    (interactive)
    (git-gutter-mode -1)
    ;; git-gutter-fringe doesn't seem to
    ;; clear the markup right away
    (sit-for 0.1)
    (git-gutter:clear))

  (defun my-git-gutter-reset-to-default ()
    "Restore git gutter to its original status.
  Show the diff between current working code and git head."
    (interactive)
    (git-gutter:set-start-revision nil)
    (message "git-gutter reset"))

  (my-run-with-idle-timer 2 #'global-git-gutter-mode)

  (global-set-key (kbd "C-x C-g") 'git-gutter:toggle)
  (global-set-key (kbd "C-x v =") 'git-gutter:popup-hunk)
  ;; Stage current hunk
  (global-set-key (kbd "C-x v s") 'git-gutter:stage-hunk)
  ;; Revert current hunk
  (global-set-key (kbd "C-x v r") 'git-gutter:revert-hunk)

  ;; }}

  ;;;###autoload
  (defun my-git-commit-id ()
    "Select commit id from current branch."
    (let* ((git-cmd "git --no-pager log --date=short --pretty=format:'%h|%ad|%s|%an'")
           (collection (my-nonempty-lines (shell-command-to-string git-cmd)))
           (item (completing-read "git log:" collection)))
      (when item
        (car (split-string item "|" t)))))
  ;;;###autoload
  (defun my-git-show-commit-internal ()
    "Show git commit."
    (let* ((id (my-git-commit-id)))
      (when id
        (shell-command-to-string (format "git show %s" id)))))

  (defun my-git-show-commit ()
    "Show commit using ffip."
    (interactive)
    (let* ((ffip-diff-backends '(("Show git commit" . my-git-show-commit-internal))))
      (ffip-show-diff 0)))


  (defun git-get-current-file-relative-path ()
    "Get relative path of current file for Git."
    (replace-regexp-in-string (concat "^" (file-name-as-directory default-directory))
                              ""
                              buffer-file-name))

  (defun git-checkout-current-file ()
    "Git checkout current file."
    (interactive)
    (when (and (buffer-file-name)
               (yes-or-no-p (format "git checkout %s?"
                                    (file-name-nondirectory (buffer-file-name)))))
      (let* ((filename (git-get-current-file-relative-path)))
        (shell-command (concat "git checkout " filename))
        (message "DONE! git checkout %s" filename))))

  (defvar git-commit-message-history nil)
  (defun git-commit-tracked ()
    "Run 'git add -u' and commit."
    (interactive)
    (let* ((hint "Commit tracked files. Please input commit message (Enter to abort):")
           (msg (read-from-minibuffer hint
                                      nil
                                      nil
                                      nil
                                      'git-commit-message-history)))
      (cond
       ((and msg (> (length msg) 3))
        (shell-command "git add -u")
        (shell-command (format "git commit -m \"%s\"" msg))
        (message "Tracked files is committed."))
       (t
        (message "Do nothing!")))))

  (defun git-add-current-file ()
    "Git add file of current buffer."
    (interactive)
    (when buffer-file-name
      (let* ((filename (git-get-current-file-relative-path))
             (head-info (shell-command-to-string
                         "git log --pretty=format:'%h %s (%an)' --date=short -n1
  ")))
        (shell-command (concat "git add " filename))
        (message "%s added. HEAD: %s" filename head-info))))

  ;; {{ look up merge conflict
  (defvar my-goto-merge-conflict-fns
    '(("n" my-next-merge-conflict)
      ("p" my-prev-merge-conflict)))

  (defun my-goto-merge-conflict-internal (forward-p)
    "Goto specific hunk.  If FORWARD-P is t, go in forward direction."
    ;; @see https://emacs.stackexchange.com/questions/63413/finding-git-conflict-in-the-same-buffer-if-cursor-is-at-end-of-the-buffer#63414
    (my-ensure 'smerge-mode)
    (let ((buffer (current-buffer))
          (hunk-fn (if forward-p 'smerge-next 'smerge-prev)))
      (unless (funcall hunk-fn)
        (vc-find-conflicted-file)
        (when (eq buffer (current-buffer))
          (let ((prev-pos (point)))
            (goto-char (if forward-p (point-min) (1- (point-max))))
            (unless (funcall hunk-fn)
              (goto-char prev-pos)
              (message "No conflicts found")))))))

  (defun my-next-merge-conflict ()
    "Go to next merge conflict."
    (interactive)
    (my-goto-merge-conflict-internal t))

  (defun my-prev-merge-conflict ()
    "Go to previous merge conflict."
    (interactive)
    (my-goto-merge-conflict-internal nil))

  (defun my-search-next-merge-conflict ()
    "Search next merge conflict."
    (interactive)
    (my-setup-extra-keymap my-goto-merge-conflict-fns
                           "Goto merge conflict: [n]ext [p]revious [q]uit"
                           'my-goto-merge-conflict-internal
                           t))

  (defun my-search-prev-merge-conflict ()
    "Search previous merge conflict."
    (interactive)
    (my-setup-extra-keymap my-goto-merge-conflict-fns
                           "Goto merge conflict: [n]ext [p]revious [q]uit"
                           'my-goto-merge-conflict-internal
                           nil))
  ;; }}

  ;; {{ look up diff hunk
  (defvar my-goto-diff-hunk-fns
    '(("n" diff-hunk-next)
      ("p" diff-hunk-prev)))

  (defun my-search-next-diff-hunk ()
    "Search next diff hunk."
    (interactive)
    (my-setup-extra-keymap my-goto-diff-hunk-fns
                           "Goto diff hunk: [n]ext [p]revious [q]uit"
                           'diff-hunk-next))

  (defun my-search-prev-diff-hunk ()
    "Search previous diff hunk."
    (interactive)
    (my-setup-extra-keymap my-goto-diff-hunk-fns
                           "Goto diff hunk: [n]ext [p]revious [q]uit"
                           'diff-hunk-prev))
  ;; }}

  ;; {{
  (defun my-git-extract-based (target lines)
    "Extract based version from TARGET and LINES."
    (let* (based (i 0) break)
      (while (and (not break) (< i (length lines)))
        (cond
         ((string-match (regexp-quote target) (nth i lines))
          (setq break t))
         (t
          (setq i (1+ i)))))
      ;; find child of target commit
      (when (and (< 0 i)
                 (< i (length lines)))
        (setq based
              (replace-regexp-in-string "^tag: +"
                                        ""
                                        (car (split-string (nth (1- i) lines)
                                                           " +")))))
      based))

  (defun my-git-rebase-interactive (&optional user-select-branch)
    "Rebase interactively on the closest branch or tag in git log output.
  If USER-SELECT-BRANCH is not nil, rebase on the tag or branch selected by user."
    (interactive "P")
    (let* ((cmd "git --no-pager log --decorate --oneline -n 1024")
           (lines (my-lines-from-command-output cmd))
           (targets (delq nil
                          (mapcar (lambda (e)
                                    (when (and (string-match "^[a-z0-9]+ (\\([^()]+\\)) " e)
                                               (not (string-match "^[a-z0-9]+ (HEAD " e)))
                                      (match-string 1 e)))
                                  lines)))
           based)
      (cond
       ((or (not targets) (null targets))
        (message "No tag or branch is found to base on."))
       ((or (not user-select-branch) (eq (length targets) 1))
        ;; select the closest/only tag or branch
        (setq based (my-git-extract-based (nth 0 targets) lines)))
       (t
        ;; select the one tag or branch
        (setq based (my-git-extract-based (completing-read "Select based: " targets)
                                          lines))))

      ;; start git rebase
      (when based
        (magit-rebase-interactive based nil))))
  ;; }}

  (defun my-git-cherry-pick-from-reflog ()
    "Cherry pick a commit from git reflog."
    (interactive)
    (let* ((cmd "git --no-pager reflog --date=short")
           (lines (my-lines-from-command-output cmd))
           (selected (completing-read "Commit to cherry pick:" lines))
           (commit-id (and selected (car (split-string selected)))))
      (when commit-id
        (my-ensure 'magit)
        (magit-cherry-copy commit-id))))

  ;; {{ git-gutter use ivy
  (defun my-git-reshape-gutter (gutter)
    "Re-shape GUTTER for `ivy-read'."
    (let* ((linenum-start (aref gutter 3))
           (linenum-end (aref gutter 4))
           (target-line "")
           (target-linenum 1)
           (tmp-line "")
           (max-line-length 0))
      (save-excursion
        (while (<= linenum-start linenum-end)
          (my-goto-line linenum-start)
          (setq tmp-line (replace-regexp-in-string "^[ \t]*" ""
                                                   (buffer-substring (line-beginning-position)
                                                                     (line-end-position))))
          (when (> (length tmp-line) max-line-length)
            (setq target-linenum linenum-start)
            (setq target-line tmp-line)
            (setq max-line-length (length tmp-line)))

          (setq linenum-start (1+ linenum-start))))
      ;; build (key . linenum-start)
      (cons (format "%s %d: %s"
                    (if (eq 'deleted (aref gutter 1)) "-" "+")
                    target-linenum target-line)
            target-linenum)))

  (defun my-git-goto-gutter ()
    "Go to specific git gutter."
    (interactive)
    (if git-gutter:diffinfos
        (ivy-read "git-gutters:"
                  (mapcar 'my-git-reshape-gutter git-gutter:diffinfos)
                  :action (lambda (e)
                            (unless (numberp e) (setq e (cdr e)))
                            (my-goto-line e)))
      (message "NO git-gutters!")))

  ;; }}

  (defun my-git-find-file-in-commit (&optional level)
    "Find file in previous commit with LEVEL.
  If LEVEL > 0, find file in previous LEVEL commit."
    (interactive "P")
    (my-ensure 'magit)
    (let* ((rev (concat "HEAD" (if (and level (> level 0)) (make-string level ?^))))
           (pretty (string-trim (shell-command-to-string (format "git --no-pager log %s --oneline --no-walk" rev))))
           (prompt (format "Find file from commit [%s]: " pretty))
           (cmd (my-git-files-in-rev-command rev level))
           (default-directory (my-git-root-dir))
           (file (completing-read prompt (my-lines-from-command-output cmd))))
      (when file
        (find-file file))))

  (defun my-git-commit-create ()
    "Git commit."
    (interactive)
    (let ((msg (read-string "Git commit message: ")))
      (when (> (length msg) 0)
        (shell-command (format "git commit --no-verify -m \"%s\"" msg)))))

  (defun my-git-commit-amend (&optional reuse-p)
    "Git amend.  If REUSE-P is t, commit by reusing original message."
    (interactive)
    (let* ((original-msg  (shell-command-to-string "git log --pretty=format:'%s' -n1"))
           msg
           (extra-args (if reuse-p "--reuse-message=HEAD" ""))
           cmd)

      (setq msg (unless reuse-p
                  (read-string "Git amend message: " original-msg)))
      (when (or reuse-p (> (length msg) 0))
        (setq cmd (format "git commit --no-verify --amend %s" extra-args))
        (unless reuse-p
          (setq cmd (format "%s -m \"%s\"" cmd msg)))
        (shell-command cmd))))

  (defun my-git-current-branch ()
    "Show current branch name."
    (interactive)
    (message "Git current branch: %s"
             (string-trim (shell-command-to-string "git branch --show-current"))))


  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; init-vcs.el ends here
#+end_src
* etc/init-lang-web.el
#+begin_src emacs-lisp :tangle etc/init-lang-web.el
  ;; init-web.el --- Initialize web configurations.   -*- lexical-binding: t -*-
  (provide 'init-lang-web)

  (eval-when-compile
    (require '+custom)
    (require '+func)
    (require 'init-package))

  ;; {{ typescript
  (use-package typescript-mode
    :load-path "~/.emacs.d/extensions/typescript"
    :hook ((typescript-mode . (typescript-mode-hook-setup)))
    :config
    (defun typescript-mode-hook-setup ()
      "Set up `typescript-mode'."
      (when (my-use-tags-as-imenu-function-p)
        ;; use ctags to calculate imenu items
        (setq imenu-create-index-function
              'counsel-etags-imenu-default-create-index-function)))

    (defun my-typescript-beginning-of-defun-hack (orig-func &rest args)
      "Overwrite typescript beginning detection."
      (ignore orig-func)
      (ignore args)
      (when (my-use-tags-as-imenu-function-p)
        (let* ((closest (my-closest-imenu-item)))
          (when closest
            (imenu closest)))))
    (advice-add 'typescript-beginning-of-defun
                :around #'my-typescript-beginning-of-defun-hack)
    )

  ;; }}


  ;; CSS
  (use-package css-mode
    :init (setq css-indent-offset 2))

  ;; SCSS
  (use-package scss-mode
    :init (setq scss-compile-at-save nil))

  ;; LESS
  (unless (fboundp 'less-css-mode)
    (use-package less-css-mode))

  ;; JSON
  (unless (fboundp 'js-json-mode)
    (use-package json-mode
      :load-path "~/.emacs.d/extensions/json-mode"))

  ;; JavaScript
  (use-package js
    :init (setq js-indent-level 2))

  (with-eval-after-load 'js-mode
    ;; '$' is part of variable name like '$item'
    (modify-syntax-entry ?$ "w" js-mode-syntax-table))

  ;; {{ js-comint
  (defun my-js-clear-send-buffer ()
    (interactive)
    (js-comint-clear)
    (js-comint-send-buffer))
  ;; }}

  ;; {{ js-beautify
  (defun my-js-beautify (&optional indent-size)
    "Beautify selected region or whole buffer with js-beautify.
  INDENT-SIZE decide the indentation level.
  `sudo pip install jsbeautifier` to install js-beautify.'"
    (interactive "P")
    (let* ((executable (if (executable-find "js-beautify") "js-beautify"
                         "jsbeautify")))
      ;; detect indentation level
      (unless indent-size
        (setq indent-size
              (cond
               ((memq major-mode '(js-mode javascript-mode))
                js-indent-level)

               ((memq major-mode '(web-mode))
                web-mode-code-indent-offset)

               ((memq major-mode '(typescript-mode))
                typescript-indent-level)

               (t
                2))))
      ;; do it!
      (run-cmd-and-replace-region (concat executable
                                          " --stdin "
                                          " --jslint-happy --brace-style=end-expand --keep-array-indentation "
                                          (format " --indent-size=%d " indent-size)))))
  ;; }}

  (use-package js2-mode
    :mode (("\\.js\\'" . js2-minor-mode)
           ("\\.jsx\\'" . js2-minor-jsx-mode))
    :interpreter (("node" . js2-minor-mode)
                  ("node" . js2-minor-jsx-mode))
    :hook ((js2-minor-mode . (lambda()  (js2-imenu-extras-mode)
                              (js2-highlight-unused-variables-mode)

                              )))
    :config
    (defun my-validate-json-or-js-expression (&optional not-json-p)
      "Validate buffer or select region as JSON.
  If NOT-JSON-P is not nil, validate as Javascript expression instead of JSON."
      (interactive "P")
      (let* ((json-exp (if (region-active-p) (my-selected-str)
                         (my-buffer-str)))
             (jsbuf-offet (if not-json-p 0 (length "var a=")))
             errs
             first-err
             (first-err-pos (if (region-active-p) (region-beginning) 0)))
        (unless not-json-p
          (setq json-exp (format "var a=%s;"  json-exp)))
        (with-temp-buffer
          (insert json-exp)
          (my-ensure 'js2-mode)
          (js2-parse)
          (setq errs (js2-errors))
          (cond
           ((not errs)
            (message "NO error found. Good job!"))
           (t
            ;; yes, first error in buffer is the last element in errs
            (setq first-err (car (last errs)))
            (setq first-err-pos (+ first-err-pos (- (cadr first-err) jsbuf-offet)))
            (message "%d error(s), first at buffer position %d: %s"
                     (length errs)
                     first-err-pos
                     (js2-get-msg (caar first-err))))))
        (if first-err (goto-char first-err-pos))))

    (defun my-print-json-path (&optional hardcoded-array-index)
      "Print the path to the JSON value under point, and save it in the kill ring.
  If HARDCODED-ARRAY-INDEX provided, array index in JSON path is replaced with it."
      (interactive "P")
      (cond
       ((memq major-mode '(js2-mode))
        (js2-print-json-path hardcoded-array-index))
       (t
        (let* ((cur-pos (point))
               (str (my-buffer-str)))
          (when (string= "json" (file-name-extension buffer-file-name))
            (setq str (format "var a=%s;" str))
            (setq cur-pos (+ cur-pos (length "var a="))))
          (my-ensure 'js2-mode)
          (with-temp-buffer
            (insert str)
            (js2-init-scanner)
            (js2-do-parse)
            (goto-char cur-pos)
            (js2-print-json-path))))))
    (defun my-print-json-path (&optional hardcoded-array-index)
      "Print the path to the JSON value under point, and save it in the kill ring.
  If HARDCODED-ARRAY-INDEX provided, array index in JSON path is replaced with it."
      (interactive "P")
      (cond
       ((memq major-mode '(js2-mode))
        (js2-print-json-path hardcoded-array-index))
       (t
        (let* ((cur-pos (point))
               (str (my-buffer-str)))
          (when (string= "json" (file-name-extension buffer-file-name))
            (setq str (format "var a=%s;" str))
            (setq cur-pos (+ cur-pos (length "var a="))))
          (my-ensure 'js2-mode)
          (with-temp-buffer
            (insert str)
            (js2-init-scanner)
            (js2-do-parse)
            (goto-char cur-pos)
            (js2-print-json-path))))))


    ;;Latest rjsx-mode does not have indentation issue
    ;;@see https://emacs.stackexchange.com/questions/33536/how-to-edit-jsx-react-files-in-emacs
     (setq-default js2-additional-externs
                  '("$"
                    "$A" ; salesforce lightning component
                    "$LightningApp" ; salesforce
                    "AccessifyHTML5"
                    "Blob"
                    "FormData"
                    "KeyEvent"
                    "Raphael"
                    "React"
                    "URLSearchParams"
                    "__dirname" ; Node
                    "_content" ; Keysnail
                    "after"
                    "afterEach"
                    "angular"
                    "app"
                    "assert"
                    "assign"
                    "before"
                    "beforeEach"
                    "browser"
                    "by"
                    "clearInterval"
                    "clearTimeout"
                    "command" ; Keysnail
                    "content" ; Keysnail
                    "decodeURI"
                    "define"
                    "describe"
                    "display" ; Keysnail
                    "documentRef"
                    "element"
                    "encodeURI"
                    "expect"
                    "ext" ; Keysnail
                    "fetch"
                    "gBrowser" ; Keysnail
                    "global"
                    "goDoCommand" ; Keysnail
                    "hook" ; Keysnail
                    "inject"
                    "isDev"
                    "it"
                    "jest"
                    "jQuery"
                    "jasmine"
                    "key" ; Keysnail
                    "ko"
                    "log"
                    "mockStore"
                    "module"
                    "mountWithTheme"
                    "plugins" ; Keysnail
                    "process"
                    "require"
                    "setInterval"
                    "setTimeout"
                    "shell" ; Keysnail
                    "tileTabs" ; Firefox addon
                    "util" ; Keysnail
                    "utag") )
    )

  (use-package rjsx-mode
    :load-path "~/.emacs.d/extensions/rjsx-mode"
    :mode ("\\.js\\'")
    :hook ((rjsx-mode .  (lambda()
                           (flycheck-add-mode 'javascript-eslint 'rjsx-mode)
                           (flycheck-select-checker 'javascript-eslint))))
    ;;:config
    ;;(add-hook 'rjsx-mode-hook 'setup)

    )

  ;; @see https://github.com/felipeochoa/rjsx-mode/issues/33
  (with-eval-after-load 'rjsx-mode
    (define-key rjsx-mode-map "<" nil))

  (use-package emmet-mode
    :defer 3
    :init (setq emmet-expand-jsx-className? t)
    :hook (web-mode typescript-mode js-mode js2-mode rjsx-mode css-mode scss-mode sgml-mode))


  ;; Format HTML, CSS and JavaScript/JSON
  ;; Install: npm -g install prettier
  (when (executable-find "prettier")
    (use-package prettier
      :diminish
      :hook ((js-mode js2-mode css-mode sgml-mode web-mode) . prettier-mode)
      :init (setq prettier-pre-warm 'none)))

  (use-package prettier-js
    :ensure t
    :defer 3
    :hook ((css-mode web-mode typescript-mode js-mode json-mode js2-mode) . prettier-js-mode))



  ;; Major mode for editing web templates
  (use-package web-mode
    :mode "\\.\\(phtml\\|php\\|[gj]sp\\|as[cp]x\\|erb\\|djhtml\\|html?\\|hbs\\|ejs\\|jade\\|swig\\|tm?pl\\|vue\\)$"
    :config
    (setq web-mode-markup-indent-offset 2)
    (setq web-mode-css-indent-offset 2)
    (setq web-mode-code-indent-offset 2)
    (setq web-mode-enable-auto-closing t) ; enable auto close tag in text-mode
    (setq web-mode-enable-auto-pairing t)
    (setq web-mode-auto-close-style 2)
    (setq web-mode-enable-css-colorization t)
    (setq web-mode-imenu-regexp-list
          '(("<\\(h[1-9]\\)\\([^>]*\\)>\\([^<]*\\)" 1 3 ">" nil)
            ("^[ \t]*<\\([@a-z]+\\)[^>]*>? *$" 1 " id=\"\\([a-zA-Z0-9_]+\\)\"" "#" ">")
            ("^[ \t]*<\\(@[a-z.]+\\)[^>]*>? *$" 1 " contentId=\"\\([a-zA-Z0-9_]+\\)\"" "=" ">")
            ;; angular imenu
            (" \\(ng-[a-z]*\\)=\"\\([^\"]+\\)" 1 2 "="))))

  ;; Adds node_modules/.bin directory to `exec_path'
  (use-package add-node-modules-path
    :hook ((web-mode js-mode js2-mode) . add-node-modules-path))
#+end_src
* etc/init-markdown.el
#+begin_src emacs-lisp :tangle etc/init-markdown.el
  ;; init-markdown.el --- Initialize markdown configurations.	-*- lexical-binding: t -*-
  ;;; Commentary:
  ;;
  ;; Markdown configurations.
  ;;

  ;;; Code:

  (use-package markdown-mode
    :mode (("README\\.md\\'" . gfm-mode))
    :init
    (setq markdown-enable-wiki-links t
          markdown-italic-underscore t
          markdown-asymmetric-header t
          markdown-make-gfm-checkboxes-buttons t
          markdown-gfm-uppercase-checkbox t
          markdown-fontify-code-blocks-natively t

          markdown-content-type "application/xhtml+xml"
          markdown-css-paths '("https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css"
                               "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/github.min.css")
          markdown-xhtml-header-content "
  <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>
  <style>
  body {
    box-sizing: border-box;
    max-width: 740px;
    width: 100%;
    margin: 40px auto;
    padding: 0 10px;
  }
  </style>

  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/default.min.css'>
  <script src='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js'></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('markdown-body');
    document.querySelectorAll('pre code').forEach((code) => {
      if (code.className != 'mermaid') {
        hljs.highlightBlock(code);
      }
    });
  });
  </script>

  <script src='https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js'></script>
  <script>
  mermaid.initialize({
    theme: 'default',  // default, forest, dark, neutral
    startOnLoad: true
  });
  </script>
  "
          markdown-gfm-additional-languages "Mermaid")

    ;; `multimarkdown' is necessary for `highlight.js' and `mermaid.js'
    (when (executable-find "multimarkdown")
      (setq markdown-command "multimarkdown"))
    :config
    ;; Support `mermaid'
    (add-to-list 'markdown-code-lang-modes '("mermaid" . mermaid-mode))

    (with-no-warnings
      ;; Use `which-key' instead
      (advice-add #'markdown--command-map-prompt :override #'ignore)
      (advice-add #'markdown--style-map-prompt   :override #'ignore)

      ;; Preview with built-in webkit
      (defun my-markdown-export-and-preview (fn)
        "Preview with `xwidget' if applicable, otherwise with the default browser."
        (if (featurep 'xwidget-internal)
            (suk-webkit-browse-url (concat "file://" (markdown-export)) t)
          (funcall fn)))
      (advice-add #'markdown-export-and-preview :around #'my-markdown-export-and-preview))

    ;; Preview via `grip'
    ;; Install: pip install grip
    (use-package grip-mode
      :defines org-mode-map
      :bind (:map markdown-mode-command-map
             ("g" . grip-mode))
      :init
      (with-eval-after-load 'org
        (bind-key "C-c g" #'grip-mode org-mode-map))

      (setq grip-update-after-change nil)
      (when-let ((credential (auth-source-user-and-password "api.github.com")))
        (setq grip-github-user (car credential)
              grip-github-password (cadr credential))))

    ;; Table of contents
    (use-package markdown-toc
      :diminish
      :bind (:map markdown-mode-command-map
             ("r" . markdown-toc-generate-or-refresh-toc))
      :hook (markdown-mode . markdown-toc-mode)
      :init (setq markdown-toc-indentation-space 2
                  markdown-toc-header-toc-title "\n## Table of Contents"
                  markdown-toc-user-toc-structure-manipulation-fn 'cdr)
      :config
      (with-no-warnings
        (define-advice markdown-toc-generate-toc (:around (fn &rest args) lsp)
          "Generate or refresh toc after disabling lsp."
          (cond
           ((bound-and-true-p lsp-managed-mode)
            (lsp-managed-mode -1)
            (apply fn args)
            (lsp-managed-mode 1))
           ((bound-and-true-p eglot--manage-mode)
            (eglot--manage-mode -1)
            (apply fn args)
            (eglot--manage-mode 1))
           (t
            (apply fn args)))))))

  (provide 'init-markdown)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; init-markdown.el ends here

#+end_src
* etc/init-mode.el
#+begin_src emacs-lisp :tangle etc/init-mode.el
  ;;; init-mode.el --- File mode setup

  (provide 'init-mode)

  ;;; ### auto-mode-alist ###
  ;;; --- ç»‘å®šæ‰©å±•ååˆ°ç‰¹å®šçš„æ¨¡å¼
  (defun add-to-alist (alist-var elt-cons &optional no-replace)
    "Add to the value of ALIST-VAR an element ELT-CONS if it isn't there yet.
  If an element with the same car as the car of ELT-CONS is already present,
  replace it with ELT-CONS unless NO-REPLACE is non-nil; if a matching
  element is not already present, add ELT-CONS to the front of the alist.
  The test for presence of the car of ELT-CONS is done with `equal'."
    (let ((existing-element (assoc (car elt-cons) (symbol-value alist-var))))
      (if existing-element
          (or no-replace
              (rplacd existing-element (cdr elt-cons)))
        (set alist-var (cons elt-cons (symbol-value alist-var)))))
    (symbol-value alist-var))

  (dolist (elt-cons '(
                      ("\\.markdown" . markdown-mode)
                      ("\\.md" . markdown-mode)
                      ("\\.coffee$" . coffee-mode)
                      ("\\.iced$" . coffee-mode)
                      ("Cakefile" . coffee-mode)
                      ("\\.stumpwmrc\\'" . lisp-mode)
                      ("\\.[hg]s\\'" . haskell-mode)
                      ("\\.hi\\'" . haskell-mode)
                      ("\\.hs-boot\\'" . haskell-mode)
                      ("\\.chs\\'" . haskell-mode)
                      ("\\.l[hg]s\\'" . literate-haskell-mode)
                      ("\\.inc\\'" . asm-mode)
                      ("\\.max\\'" . maxima-mode)
                      ("\\.org\\'" . org-mode)
                      ("\\.cron\\(tab\\)?\\'" . crontab-mode)
                      ("cron\\(tab\\)?\\." . crontab-mode)
                      ("\\.a90\\'" . intel-hex-mode)
                      ("\\.hex\\'" . intel-hex-mode)
                      ("\\.py$" . python-mode)
                      ("/\\.php_cs\\(?:\\.dist\\)?\\'" . php-mode)
                      ("\\.\\(?:php\\.inc\\|stub\\)\\'" . php-mode)
                      ("\\.\\(?:php[s345]?\\|phtml\\)\\'" . php-mode-maybe)
                      ("SConstruct". python-mode)
                      ("\\.ml\\'" . tuareg-mode)
                      ("\\.mli\\'" . tuareg-mode)
                      ("\\.mly\\'" . tuareg-mode)
                      ("\\.mll\\'" . tuareg-mode)
                      ("\\.mlp\\'" . tuareg-mode)
                      ("\\.qml\\'" . qml-mode)
                      ("\\.jl\\'" . lisp-mode)
                      ("\\.asdf\\'" . lisp-mode)
                      ("CMakeLists\\.txt\\'" . cmake-mode)
                      ("\\.cmake\\'" . cmake-mode)
                      ("\\.vue" . web-mode)
                      ("\\.wxml" . web-mode)
                      ("\\.phtml\\'" . web-mode)
                      ("\\.jsp\\'" . web-mode)
                      ("\\.as[cp]x\\'" . web-mode)
                      ("\\.erb\\'" . web-mode)
                      ("\\.mustache\\'" . web-mode)
                      ("\\.djhtml\\'" . web-mode)
                      ("\\.html?\\'" . web-mode)
                      ("\\.coffee\\'" . coffee-mode)
                      ("\\.coffee.erb\\'" . coffee-mode)
                      ("\\.js.erb\\'" . js-mode)
                      ("\\.iced\\'" . coffee-mode)
                      ("\\.css\\'" . css-mode)
                      ("\\.wxss\\'" . css-mode)
                      ("Cakefile\\'" . coffee-mode)
                      ("\\.styl$" . sws-mode)
                      ("\\.jade" . jade-mode)
                      ("\\.go$" . go-mode)
                      ("\\.vala$" . vala-mode)
                      ("\\.vapi$" . vala-mode)
                      ("\\.rs$" . rust-mode)
                      ("\\.pro$" . qmake-mode)
                      ("\\.js$" . js-mode)
                      ("\\.wxs$" . js-mode)
                      ("\\.jsx$" . web-mode)
                      ("\\.lua$" . lua-mode)
                      ("\\.swift$" . swift-mode)
                      ("\\.l$" . flex-mode)
                      ("\\.y$" . bison-mode)
                      ("\\.pdf$" . pdf-view-mode)
                      ("\\.ts$" . typescript-mode)
                      ("\\.tsx$" . typescript-mode)
                      ("\\.cpp$" . c++-mode)
                      ("\\.h$" . c++-mode)
                      ("\\.ll$" . llvm-mode)
                      ("\\.bc$" . hexl-mode)
                      ("\\.nim$" . nim-mode)
                      ("\\.nims$" . nim-mode)
                      ("\\.nimble$" . nim-mode)
                      ("\\.nim.cfg$" . nim-mode)
                      ("\\.exs$" . elixir-mode)
                      ("\\.json$" . json-mode)
                      ("\\.clj$" . clojure-mode)
                      ("\\.dart$" . dart-mode)
                      ("\\.zig$" . zig-mode)
                      ("\\.kt$" . kotlin-mode)
                      ))
    (add-to-alist 'auto-mode-alist elt-cons))

  (add-to-list 'interpreter-mode-alist '("coffee" . coffee-mode))


  ;;; Mode load.
  (autoload 'markdown-mode "init-markdown-mode")
  (autoload 'web-mode "init-lang-web")
  (autoload 'css-mode "init-lang-web")
  (autoload 'js-mode "init-lang-web")
  (autoload 'rjsx-mode "rjsx-mode")
  (autoload 'typescript-mode "typescript-mode")
  (autoload 'json-mode "json-mode")


  ;;; ### Auto-fill ###
  ;;; --- è‡ªåŠ¨æ¢è¡Œ
  (setq default-fill-column 100)          ;é»˜è®¤æ˜¾ç¤º 100åˆ—å°±æ¢è¡Œ
  (dolist (hook (list
                 'after-text-mode-hook
                 'message-mode-hook
                 ))
    (add-hook hook #'(lambda () (auto-fill-mode 1))))


#+end_src
* etc/init-org.el
#+begin_src emacs-lisp :tangle etc/init-org.el
    ;; -*- lexical-binding: t -*-

    (provide 'init-org)

    (eval-when-compile
      (require '+const)
      (require '+custom)
      (require 'init-package)
      )
    ;;(message org-files-directory)


   ;; åˆ›å»º var æ–‡ä»¶å¤¹
   (make-directory (expand-file-name "var" user-emacs-directory) t)

   ;; è®¾ç½® org-persist ç›®å½•
   (setq org-persist-directory (expand-file-name "var/org-persist" user-emacs-directory))

  ;; åˆ›å»ºæ–°çš„ org-persist ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
  (unless (file-exists-p org-persist-directory)
    (make-directory org-persist-directory t))
    (require 'org)
    ;;(setq plantuml-default-exec-mode 'server) ;default
    ;; ;; Sample jar configuration
    ;; (setq plantuml-jar-path "/path/to/your/copy/of/plantuml.jar")
    ;; (setq plantuml-default-exec-mode 'jar)

    ;; ;; Sample executable configuration
    ;; (setq plantuml-executable-path "/path/to/your/copy/of/plantuml.bin")
    ;; (setq plantuml-default-exec-mode 'executable)
    (setq plantuml-default-exec-mode 'jar)
    (setq org-plantuml-jar-path
          (expand-file-name "C:/green/plantuml-1.2024.3.jar"))
    (setq org-plantuml-jar-args (list "-charset" "UTF-8"))
    ;; plantuml-java-args
    ;; plantuml-jar-args
    (defun my-org-plantuml-execute (orig-fun &rest args)
      (let (
            (plantuml-java-args (list
                                 "-Djava.awt.headless=true"
                                 "-Dfile.encoding=UTT-8"
                                 "-jar"
                                 "--illegal-access=deny"
                                 ))
            (plantuml-jar-args (list  "-charset" "UTF-8")) ;default value
            )
        (apply orig-fun args)))

    (advice-add 'org-plantuml-execute :around #'my-org-plantuml-execute)
    (add-to-list 'org-src-lang-modes '("plantuml" . plantuml))
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((plantuml . t)
       (dot . t)
       ))
                                            ;(setq process-environment (cons "PATH=D:/green/plantUML/bin;%PATH%" process-environment))

    (defun my-org-export-before-processing-hook (backend)
      (;let ((process-environment (cons "PATH=%PATH%" process-environment)))
       ;; (org-babel-execute-src-block)
       (org-babel-execute-buffer)))

    (add-hook 'org-export-before-processing-hook 'my-org-export-before-processing-hook)

    (defun my-org-mode-refresh-images ()
      (when (derived-mode-p 'org-mode) ; ç¡®ä¿å½“å‰æ¨¡å¼æ˜¯ Org-mode
        (org-redisplay-inline-images))) ; åˆ·æ–°å†…åµŒå›¾ç‰‡

    (add-hook 'org-babel-after-execute-hook 'my-org-mode-refresh-images)
    (setq org-agenda-diary-file (expand-file-name "diary.org" org-files-directory))
    ;; setup agenda files
    ;; org-mode manages the org-agenda-files variable automatically
    ;; using C-c [ and C-c ] to add and remove files respectively.
    ;; They can be files or directories.
    (setq org-agenda-files
          `(,(expand-file-name "gtd.org" org-files-directory)
            ,(expand-file-name "work.org" org-files-directory)
            ,(expand-file-name "finished.org" org-files-directory)
            ,(expand-file-name "cancel.org" org-files-directory)
            ,(expand-file-name "journal.org" org-files-directory)
            ,(expand-file-name "trash.org" org-files-directory)
            ;;,(expand-file-name "folder" org-files-directory)
            ))

    ;; To speed up startup, don't put to init section
    (setq org-modules nil)
    ;;(setq org-startup-indented t)
    (setq org-startup-folded t)
    (setq org-ellipsis  "... â†’ ")
    (setq org-pretty-entities t)
    (setq org-hide-emphasis-markers t)
    (setq org-hide-leading-stars nil)
    (setq org-blank-before-new-entry '((heading) (plain-list-item . auto)))
    (setq org-insert-heading-respect-content t)
    (setq org-yank-adjusted-subtrees t)
    ;; Use the current window for C-c ' source editing
    (setq org-src-window-setup 'current-window)
    ;; Use the current window for indirect buffer display
    (setq org-indirect-buffer-display 'current-window)
    (add-to-list 'auto-mode-alist '("\\.\\(org\\|org_archive\\)$" . org-mode))
    (setq org-agenda-block-separator ?â”€)
    (setq org-agenda-time-grid
          '((daily today require-timed)
            (800 1000 1200 1400 1600 1800 2000)
            " â”„â”„â”„â”„â”„ " "â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„â”„"))
    (setq org-agenda-current-time-string
          "â­  now â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
    (setq org-tags-column -80)
    (setq org-log-done 'time)
    (setq org-catch-invisible-edits 'smart)

      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;; Agenda
      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    (setq org-alphabetical-lists t)
    ;; Keep tasks with dates on the global todo lists
    (setq org-agenda-todo-ignore-with-date nil)
    ;; Keep tasks with deadlines on the global todo lists
    (setq org-agenda-todo-ignore-deadlines nil)
    ;; Keep tasks with scheduled dates on the global todo lists
    (setq org-agenda-todo-ignore-scheduled nil)
    ;; Keep tasks with timestamps on the global todo lists
    (setq org-agenda-todo-ignore-timestamp nil)
    ;; Remove completed deadline tasks from the agenda view
    (setq org-agenda-skip-deadline-if-done t)
    ;; Remove completed scheduled tasks from the agenda view
    (setq org-agenda-skip-scheduled-if-done t)
    ;; Remove completed items from search results
    (setq org-agenda-skip-timestamp-if-done t)
    (setq org-agenda-include-diary nil)
    (setq org-agenda-insert-diary-extract-time t)
    ;; Include agenda archive files when searching for things
    (setq org-agenda-text-search-extra-files (quote (agenda-archives)))
    ;; Show all future entries for repeating tasks
    (setq org-agenda-repeating-timestamp-show-all t)
    ;; Show all agenda dates - even if they are empty
    (setq org-agenda-show-all-dates t)
    ;; Sorting order for tasks on the agenda
    (setq org-agenda-sorting-strategy
          '((agenda habit-down time-up user-defined-up effort-up category-keep)
            (todo category-up effort-up)
            (tags category-up effort-up)
            (search category-up)))
    ;; Start the weekly agenda on Monday
    (setq org-agenda-start-on-weekday 1)
    (setq org-agenda-diary-file (expand-file-name "diary.org" org-files-directory))

    (setq org-agenda-persistent-filter t)
    ;; Do not dim blocked tasks
    (setq org-agenda-dim-blocked-tasks nil)
    ;; Compact the block agenda view
    (setq org-agenda-compact-blocks t)
    ;; capture template
    (setq org-default-notes-file (expand-file-name "notes.org" org-files-directory))
    ;; Capture templates for: TODO tasks, Notes,
    ;; appointments, phone calls, meetings, and (setq
    ;; org-protocol)
    (setq org-capture-templates
          '(
            ("t" "Todo"
             entry (file+headline (expand-file-name "gtd.org" org-files-directory) "Tasks")
             "* TODO %?\n%U\n%a\n"
             :clock-in t
             :clock-resume t)
            ("n" "note"
             entry (file (expand-file-name "notes.org" org-files-directory))
             "* %? :NOTE:\n%U\n%a\n"
             :clock-in t
             :clock-resume t)
            ("r" "respond"
             entry (file (expand-file-name "gtd.org" org-files-directory))
             "* NEXT Respond to %:from on %:subject\nSCHEDULED: %t\n%U\n%a\n"
             :clock-in t
             :clock-resume t
             :immediate-finish t)
            ("j" "Journal"
             entry (file+datetree (expand-file-name "journal.org" org-files-directory))
             "* %?\nEntered on %U\n  %i\n  %a")
            ("w" "Review"
             entry (file (expand-file-name "gtd.org" org-files-directory))
             "* TODO Review %c\n%U\n"
             :immediate-finish t)
            ("m" "Meeting"
             entry (file (expand-file-name "gtd.org" org-files-directory))
             "* MEETING with %? :MEETING:\n%U"
             :clock-in t
             :clock-resume t)
            ("p" "Phone call"
             entry (file (expand-file-name "gtd.org" org-files-directory))
             "* PHONE %? :PHONE:\n%U"
             :clock-in t
             :clock-resume t)
            ("h" "Habit"
             entry (file (expand-file-name "gtd.org" org-files-directory))
             "* NEXT %?\n%U\n%a\nSCHEDULED: %(format-time-string \"%<<%Y-%m-%d %a .+1d/3d>>\")\n:PROPERTIES:\n:STYLE: habit\n:REPEAT_TO_STATE: NEXT\n:END:\n")
            ))
    ;; è®¾ç½®æ‰“å¼€æŸç§æ–‡ä»¶ç±»åž‹
    (setq org-file-apps
          '((auto-mode . emacs)
            ("\\.mm\\'" . system)
            ("\\.x?html?\\'" . system)
            ("\\.pdf\\'" . system)))

    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;; TODO
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    (setq org-use-fast-todo-selection t)
    ;; ! çš„å«ä¹‰æ˜¯è®°å½•æŸé¡¹æ›´æ”¹ä¸ºçŠ¶æ€çš„æ—¶é—´ã€‚æˆ‘ä¸æŠŠè¿™ä¸ªæ·»åŠ åˆ°å®Œæˆçš„çŠ¶æ€ï¼Œæ˜¯å› ä¸ºå®ƒä»¬å·²
    ;; ç»è¢«è®°å½•äº†ã€‚

    ;; @ ç¬¦å·è¡¨ç¤ºå¸¦ç†ç”±çš„æç¤ºï¼Œæ‰€ä»¥å½“åˆ‡æ¢åˆ° WAITTING æ—¶ï¼ŒOrg æ¨¡å¼ä¼šé—®æˆ‘ä¸ºä»€ä¹ˆï¼Œå¹¶å°†
    ;; è¿™ä¸ªæ·»åŠ åˆ°ç¬”è®°ä¸­ã€‚
    (setq org-todo-keywords
          '((sequence "TODO(t)" "NEXT(n!)" "HANGUP(h)"  "|" "DONE(d!)" "CANCELLED(c@/!)")
            (sequence "âš‘(T)" "ðŸ´(N)" "â“(H)" "|" "âœ”(D)" "âœ˜(C)")
            (sequence "WAITTING(w@/!)" "HOLD(h@/!)" "|" "CANCELLED(c@/!)" "PHONE" "MEETING")))
    (setq org-todo-keyword-faces
          '(("TODO" :foreground "red" :weight bold)
            ("NEXT" :foreground "blue" :weight bold)
            ("DONE" :foreground "forest green" :weight bold)
            ("WAITTING" :foreground "orange" :weight bold)
            ("HOLD" :foreground "magenta" :weight bold)
            ("CANCELLED" :foreground "forest grey" :weight bold)
            ("ABORT" :foreground "forest yellow" :weight bold)
            ("HANGUP" :foreground "orange" :weight bold)
            ("â“" :foreground "orange" :weight bold)
            ("MEETING" :foreground "forest brown" :weight bold)
            ("PHONE" :foreground "forest pink" :weight bold) ))


    (setq org-priority-faces
          '((?A . error)
            (?B . warning)
            (?C . success)))

    ;; The triggers break down to the following rules:
    ;;   Moving a task to CANCELLED adds a CANCELLED tag
    ;;   Moving a task to WAITTING adds a WAITTING tag
    ;;   Moving a task to HOLD adds WAITTING and HOLD tags
    ;;   Moving a task to a done state removes WAITTING and HOLD tags
    ;;   Moving a task to TODO removes WAITTING, CANCELLED, and HOLD tags
    ;;   Moving a task to NEXT removes WAITTING, CANCELLED, and HOLD tags
    ;;   Moving a task to DONE removes WAITTING, CANCELLED, and HOLD tags
    (setq org-todo-state-tags-triggers
          '(("CANCELLED" ("CANCELLED" . t))
            ("WAITTING" ("WAITTING" . t))
            ("HOLD" ("WAITTING") ("HOLD" . t))
            ("DONE" ("WAITTING") ("HOLD"))
            ("TODO" ("WAITTING") ("CANCELLED") ("HOLD"))
            ("NEXT" ("WAITTING") ("CANCELLED") ("HOLD"))
            ("DONE" ("WAITTING") ("CANCELLED") ("HOLD"))))

    ;; Filetags look like this:
    ;; #+FILETAGS: NORANG @office
    ;; Allow setting single tags without the menu
    (setq org-fast-tag-selection-single-key (quote expert))
    (setq org-tags-match-list-sublevels t)
    ;; allows changing todo states with S-left and S-right skipping all of the
    ;; normal processing when entering or leaving a todo state. This cycles
    ;; through the todo states but skips setting timestamps and entering notes
    ;; which is very convenient when all you want to do is fix up the status of an
    ;; entry.
    (setq org-treat-S-cursor-todo-selection-as-state-change nil)
    (setq org-deadline-warning-days 30)
    (setq org-log-done 'time)
    (setq org-log-into-drawer t)
    (setq org-log-state-notes-insert-after-drawers nil)
    ;; Sometimes I change tasks I'm clocking quickly
    ;; - this removes clocked tasks with 0:00 duration
    (setq org-clock-out-remove-zero-time-clocks t)

    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;; EXPORTER
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    (setq default-process-coding-system '(utf-8-unix . utf-8-unix))
    ;; Inline images in HTML instead of producting links to the image
    (setq org-html-inline-images t)
    ;; Use (setq org-manual.css from the norang website for export document stylesheets)
    ;; (setq org-html-head-extra "<link rel=\"stylesheet\" href=\"org-manual.css\" type=\"text/css\" />")
    (setq org-html-head-include-default-style nil)
    ;; Do not generate internal css formatting for HTML exports
    (setq org-export-htmlize-output-type (quote css))
    ;; Increase default number of headings to export
    (setq org-export-headline-levels 6)
    (setq org-export-coding-system 'utf-8)
    (setq org-table-export-default-format "orgtbl-to-csv")
    ;; Do not generate internal css formatting for HTML exports
    (setq org-export-htmlize-output-type 'css)
    (setq org-export-with-timestamps nil)
    ;; _ ä¸è½¬ä¹‰ï¼Œç›¸å½“äºŽ#+OPTIONS: ^:{}
    (setq org-export-with-sub-superscripts '{})

    ;; Embed inline CSS read from a file.
    ;;;###autoload
    (defun my-org-inline-css-hook (exporter)
      "Insert custom inline css"
      (when (eq exporter 'html)
        (let* ((dir (ignore-errors (file-name-directory (buffer-file-name))))
               ;;(path (concat dir "style.css"))
               (path  org-css-file)
               (homestyle (and (or (null dir) (null (file-exists-p path)))
                               (not (null-or-unboundp 'my-org-inline-css-file))))
               (final (if homestyle my-org-inline-css-file path)))
          (if (file-exists-p final)
              (progn
                (setq-local org-html-head-include-default-style nil)
                (setq-local org-html-head
                            (concat
                             "<style type=\"text/css\">\n"
                             "<!--/*--><![CDATA[/*><!--*/\n"
                             (with-temp-buffer
                               (insert-file-contents final)
                               (buffer-string))
                             "/*]]>*/-->\n"
                             "</style>\n")))))))

    (add-hook 'org-export-before-processing-hook #'my-org-inline-css-hook)
    (add-hook 'org-mode-hook
              (lambda ()
                "Beautify org symbols."
                (when suk-prettify-org-symbols-alist
                  (if prettify-symbols-alist
                      (push suk-prettify-org-symbols-alist prettify-symbols-alist)
                    (setq prettify-symbols-alist suk-prettify-org-symbols-alist)))
                (prettify-symbols-mode 1)
                (abbrev-mode 1)
                (setq truncate-lines nil)
                (set-fill-column 70)
                (turn-on-font-lock)
                (load-org-font)
                ))

    (add-hook 'org-agenda-mode-hook
              (lambda() (hl-line-mode 1)))
    (add-hook 'org-clock-out-hook
              (lambda()
                (save-excursion
                  (beginning-of-line 0)
                  (org-remove-empty-drawer-at "LOGBOOK" (point)))))


    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;; Refile settings
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;; Exclude DONE state tasks from refile targets
    ;;;###autoload
    (defun suk/verify-refile-target ()
      "Exclude todo keywords with a done state from refile targets."
      (not (member (nth 2 (org-heading-components)) org-done-keywords)))

    ;; Targets include this file and any file contributing to the agenda - up to 9 levels deep
    (setq org-refile-targets (quote ((nil :maxlevel . 9) (org-agenda-files :maxlevel . 9))))
    ;; Use full outline paths for refile targets
    (setq org-refile-use-outline-path t)
    (setq org-refile-target-verify-function 'suk/verify-refile-target)
    ;; Allow refile to create parent tasks with confirmation
    (setq org-refile-allow-creating-parent-nodes 'confirm)
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;;; Attachments
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    (setq org-id-method (quote uuidgen))
    ;; Say you want to attach a file x.sql to your current task. Create
    ;; the file data in /tmp/x.sql and save it.
    ;;
    ;; Attach the file with C-c C-a a and enter the filename: x.sql.
    ;; This generates a unique ID for the task and adds the file in the
    ;; attachment directory.
    ;;
    ;; * Attachments                                     :ATTACH:
    ;;   :PROPERTIES:
    ;;   :Attachments: x.sql
    ;;   :ID:       f1d38e9a-ff70-4cc4-ab50-e8b58b2aaa7b
    ;;   :END:
    ;;
    ;; The attached file is saved in
    ;; data/f1/d38e9a-ff70-4cc4-ab50-e8b58b2aaa7b/. Where it goes
    ;; exactly isn't important for me éˆ¥?as long as it is saved and
    ;; retrievable easily. Org-mode copies the original file /tmp/x.sql
    ;; into the appropriate attachment directory.
    ;;
    ;; Tasks with attachments automatically get an ATTACH tag so you can
    ;; easily find tasks with attachments with a tag search.
    ;;
    ;; To open the attachment for a task use C-c C-a o. This prompts for
    ;; the attachment to open and TAB completion works here.
    ;;
    ;; The ID changes for every task header when a new ID is generated.
    ;;
    ;; It's possible to use named directories for attachments but I
    ;; haven't needed this functionality yet éˆ¥?it's there if you need
    ;; it.
    ;;
    ;; I store my org-mode attachments with my org files in a
    ;; subdirectory data. These are automatically added to my git
    ;; repository along with any other org-mode changes I've made.

    ;; è¿è¡Œ Org Babel Tangle å‘½ä»¤ï¼š`M-x org-babel-tangle`ã€‚
    ;; ä»Ž org æ–‡ä»¶ä¸­ç”Ÿæˆ el é…ç½®æ–‡ä»¶
    ;; ä¿å­˜ user-emacs-directory(~/.emacs.d/) æ–‡ä»¶ä¸‹çš„ org æ—¶ï¼Œ
    ;; å¯¼å‡ºæ–‡ä»¶ä¸­ elisp ä»£ç åˆ°æ–‡ä»¶ä¸­ã€‚
    (defun suk/org-babel-tangle-config ()
      (when (string-equal (file-name-directory (buffer-file-name))
                          (expand-file-name user-emacs-directory)) ; ~/.emacs.d
        (let ((org-confirm-babel-evaluate nil))
          (org-babel-tangle))))

    (add-hook 'org-mode-hook
              (lambda ()
                (add-hook 'after-save-hook #'suk/org-babel-tangle-config)))


    ;;;###autoload
    (defun suk/load-theme-org()
      (interactive)
      (load-theme 'doom-solarized-light)
      )

    ;;;###autoload
    (defun suk/load-theme-default()
      (interactive)
      (load-theme 'doom-one)
      )

    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;;; å¿«æ·é”®è®¾ç½® keys are set in init-key.el
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;; I use C-c c to start capture mode
    (global-set-key (kbd "C-c c") #'org-capture)
    ;; ;; (global-set-key (kbd "C-c C") 'org-capture)
    (global-set-key "\C-cl" #'org-store-link)
    (global-set-key "\C-ca" #'org-agenda)
    ;;(global-set-key "\C-cb" #'org-iswitchb)

    ;; C-',  C-, is org-cycle-agenda-files keys
    ;; æ–°ç‰ˆçš„org-modeä½¿ç”¨C-c C-, æ›¿æ¢äº† <sTAB æä¾›çš„æ¨¡æ¿åŠŸèƒ½ã€‚

    ;;Prettify UI
    (use-package org-modern
      :custom
    ;;  (org-modern-table nil)
      (prettify-symbols-alist nil)
      :config
      ;; Disable Prettify Symbols mode globally or locally as needed
      ;;(global-prettify-symbols-mode -1)
      :hook ((org-mode . org-modern-mode)
             (org-agenda-finalize . org-modern-agenda)
             ))

    ;; Export text/html MIME emails
    (use-package org-mime
      :bind (:map message-mode-map
                  ("C-c M-o" . org-mime-htmlize)
                  :map org-mode-map
                  ("C-c M-o" . org-mime-org-buffer-htmlize)))

    ;; covert to html
    (use-package htmlize
      :defer 2)


#+end_src
* etc/init-reader.el
#+begin_src emacs-lisp :tangle etc/init-reader.el
  ;; init-reader.el --- Initialize readers.	-*- lexical-binding: t -*-

  ;;; Commentary:
  ;;
  ;; PDF/EPUB/RSS readers.
  ;;

  ;;; Code:

  (eval-when-compile
    (require '+const))

  (bind-key "M-<f7>" #'suk-read-mode)

  ;; PDF reader
  (when (display-graphic-p)
    (use-package pdf-view
      :ensure pdf-tools
      :diminish (pdf-view-themed-minor-mode
                 pdf-view-midnight-minor-mode
                 pdf-view-printer-minor-mode)
      :defines pdf-annot-activate-created-annotations
      :hook ((pdf-tools-enabled . pdf-view-auto-slice-minor-mode)
             (pdf-tools-enabled . pdf-isearch-minor-mode))
      :mode ("\\.[pP][dD][fF]\\'" . pdf-view-mode)
      :magic ("%PDF" . pdf-view-mode)
      :bind (:map pdf-view-mode-map
             ("C-s" . isearch-forward))
      :init (setq pdf-view-use-scaling t
                  pdf-view-use-imagemagick nil
                  pdf-annot-activate-created-annotations t)
      :config
      ;; Activate the package
      (pdf-tools-install t nil t nil)

      ;; Recover last viewed position
      (use-package saveplace-pdf-view
        :when (ignore-errors (pdf-info-check-epdfinfo) t)
        :autoload (saveplace-pdf-view-find-file-advice saveplace-pdf-view-to-alist-advice)
        :init
        (advice-add 'save-place-find-file-hook :around #'saveplace-pdf-view-find-file-advice)
        (advice-add 'save-place-to-alist :around #'saveplace-pdf-view-to-alist-advice))))

  ;; Epub reader
  (use-package nov
    :mode ("\\.epub\\'" . nov-mode)
    :hook (nov-mode . my-nov-setup)
    :init
    (defun my-nov-setup ()
      "Setup `nov-mode' for better reading experience."
      (visual-line-mode 1)
      (suk-read-mode)
      (face-remap-add-relative 'variable-pitch :family "Times New Roman" :height 1.5))
    :config
    (with-no-warnings
      ;; WORKAROUND: errors while opening `nov' files with Unicode characters
      ;; @see https://github.com/wasamasa/nov.el/issues/63
      (defun my-nov-content-unique-identifier (content)
        "Return the the unique identifier for CONTENT."
        (let* ((name (nov-content-unique-identifier-name content))
               (selector (format "package>metadata>identifier[id='%s']"
                                 (regexp-quote name)))
               (id (car (esxml-node-children (esxml-query selector content)))))
          (and id (intern id))))
      (advice-add #'nov-content-unique-identifier :override #'my-nov-content-unique-identifier))

    ;; Fix encoding issue on Windows
    (when sys/win32p
      (setq process-coding-system-alist
            (cons `(,nov-unzip-program . (gbk . gbk))
                  process-coding-system-alist))))

  ;; Atom/RSS reader
  (use-package elfeed
    :pretty-hydra
    ((:title (pretty-hydra-title "Elfeed" 'faicon "nf-fa-rss_square" :face 'nerd-icons-orange)
      :color amaranth :quit-key ("q" "C-g"))
     ("Search"
      (("c" elfeed-db-compact "compact db")
       ("g" elfeed-search-update--force "refresh")
       ("G" elfeed-search-fetch "update")
       ("y" elfeed-search-yank "copy URL")
       ("+" elfeed-search-tag-all "tag all")
       ("-" elfeed-search-untag-all "untag all"))
      "Filter"
      (("l" elfeed-search-live-filter "live filter")
       ("s" elfeed-search-set-filter "set filter")
       ("*" (elfeed-search-set-filter "@6-months-ago +star") "starred")
       ("a" (elfeed-search-set-filter "@6-months-ago") "all")
       ("t" (elfeed-search-set-filter "@1-day-ago") "today"))
      "Article"
      (("b" elfeed-search-browse-url "browse")
       ("n" next-line "next")
       ("p" previous-line "previous")
       ("u" elfeed-search-tag-all-unread "mark unread")
       ("r" elfeed-search-untag-all-unread "mark read")
       ("RET" elfeed-search-show-entry "show"))))
    :bind (("C-x w" . elfeed)
           :map elfeed-search-mode-map
           ("?" . elfeed-hydra/body)
           :map elfeed-show-mode-map
           ("q" . delete-window))
    :hook (elfeed-show-mode . suk-read-mode)
    :init (setq url-queue-timeout 30
                elfeed-db-directory (locate-user-emacs-file ".elfeed")
                elfeed-show-entry-switch #'pop-to-buffer
                elfeed-show-entry-delete #'delete-window
                elfeed-feeds '(("https://planet.emacslife.com/atom.xml" planet emacslife)
                               ("http://www.masteringemacs.org/feed/" mastering)
                               ("https://oremacs.com/atom.xml" oremacs)
                               ("https://pinecast.com/feed/emacscast" emacscast)
                               ("https://emacstil.com/feed.xml" Emacs TIL)
                               ;; ("https://www.reddit.com/r/emacs.rss" reddit)
                               ))
    :config
    ;; Ignore db directory in recentf
    (push elfeed-db-directory recentf-exclude)

    ;; Add icons via tags
    (when (icons-displayable-p)
      (defun nerd-icon-for-tags (tags)
        "Generate Nerd Font icon based on tags.
    Returns default if no match."
        (cond ((member "youtube" tags)  (nerd-icons-faicon "nf-fa-youtube_play" :face '(:foreground "#FF0200")))
              ((member "instagram" tags) (nerd-icons-faicon "nf-fa-instagram" :face '(:foreground "#FF00B9")))
              ((or (member "emacs" tags) (member "emacslife" tags) (member "mastering" tags))
               (nerd-icons-sucicon "nf-custom-emacs" :face '(:foreground "#9A5BBE")))
              ((member "github" tags) (nerd-icons-faicon "nf-fa-github"))
              (t (nerd-icons-faicon "nf-fae-feedly" :face '(:foreground "#2AB24C")))))

      (defun lucius/elfeed-search-print-entry--better-default (entry)
        "Print ENTRY to the buffer."
        (let* ((date (elfeed-search-format-date (elfeed-entry-date entry)))
               (date-width (car (cdr elfeed-search-date-format)))
               (title (concat (or (elfeed-meta entry :title)
                                  (elfeed-entry-title entry) "")
                              ;; NOTE: insert " " for overlay to swallow
                              " "))
               (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
               (feed (elfeed-entry-feed entry))
               (feed-title (when feed (or (elfeed-meta feed :title) (elfeed-feed-title feed))))
               (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
               (tags-str (mapconcat (lambda (s) (propertize s 'face 'elfeed-search-tag-face)) tags ","))
               (title-width (- (frame-width)
                               ;; (window-width (get-buffer-window (elfeed-search-buffer) t))
                               date-width elfeed-search-trailing-width))
               (title-column (elfeed-format-column
                              title (elfeed-clamp
                                     elfeed-search-title-min-width
                                     title-width
                                     elfeed-search-title-max-width) :left))

               ;; Title/Feed ALIGNMENT
               (align-to-feed-pixel (+ date-width
                                       (max elfeed-search-title-min-width
                                            (min title-width elfeed-search-title-max-width)))))
          (insert (propertize date 'face 'elfeed-search-date-face) " ")
          (insert (propertize title-column 'face title-faces 'kbd-help title))
          (put-text-property (1- (point)) (point) 'display `(space :align-to ,align-to-feed-pixel))
          ;; (when feed-title (insert " " (propertize feed-title 'face 'elfeed-search-feed-face) " "))
          (when feed-title
            (insert " " (concat (nerd-icon-for-tags tags) " ")
                    (propertize feed-title 'face 'elfeed-search-feed-face) " "))
          (when tags (insert "(" tags-str ")"))))

      (setq  elfeed-search-print-entry-function #'lucius/elfeed-search-print-entry--better-default))

    ;; Use xwidget if possible
    (with-no-warnings
      (defun my-elfeed-show-visit (&optional use-generic-p)
        "Visit the current entry in your browser using `browse-url'.
  If there is a prefix argument, visit the current entry in the
  browser defined by `browse-url-generic-program'."
        (interactive "P")
        (let ((link (elfeed-entry-link elfeed-show-entry)))
          (when link
            (message "Sent to browser: %s" link)
            (cond
             ((featurep 'xwidget-internal)
              (suk-webkit-browse-url link))
             (use-generic-p
              (browse-url-generic link))
             (t (browse-url link))))))
      (advice-add #'elfeed-show-visit :override #'my-elfeed-show-visit)

      (defun my-elfeed-search-browse-url (&optional use-generic-p)
        "Visit the current entry in your browser using `browse-url'.
  If there is a prefix argument, visit the current entry in the
  browser defined by `browse-url-generic-program'."
        (interactive "P")
        (let ((entries (elfeed-search-selected)))
          (cl-loop for entry in entries
                   do (elfeed-untag entry 'unread)
                   when (elfeed-entry-link entry)
                   do (cond
                       ((featurep 'xwidget-internal)
                        (suk-webkit-browse-url it t))
                       (use-generic-p
                        (browse-url-generic it))
                       (t (browse-url it))))
          (mapc #'elfeed-search-update-entry entries)
          (unless (or elfeed-search-remain-on-entry (use-region-p))
            (forward-line))))
      (advice-add #'elfeed-search-browse-url :override #'my-elfeed-search-browse-url)))

  ;; Another Atom/RSS reader
  (use-package newsticker
    :ensure nil
    :bind ("C-x W" . newsticker-show-news)
    :hook (newsticker-treeview-item-mode . suk-read-mode)
    :init (setq newsticker-url-list
                '(("Planet Emacslife" "https://planet.emacslife.com/atom.xml")
                  ("Mastering Emacs" "http://www.masteringemacs.org/feed/")
                  ("Oremacs" "https://oremacs.com/atom.xml")
                  ("EmacsCast" "https://pinecast.com/feed/emacscast")
                  ("Emacs TIL" "https://emacstil.com/feed.xml")
                  ;; ("Emacs Reddit" "https://www.reddit.com/r/emacs.rss")
                  )))

  (provide 'init-reader)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; init-reader.el ends here

#+end_src
* etc/init-recentf.el
#+begin_src emacs-lisp :tangle etc/init-recentf.el
  ;; Recentf
  (use-package recentf
    :ensure nil
    :defer 1
    :init
    (setq recentf-save-file (concat suk-emacs-var-dir "/recentf"))
    ;;(setq recentf-save-file "~/.emacs.d/var/recentf")
    ;;(add-hook 'after-init-hook #'recentf-mode)
    (setq recentf-max-saved-items 500)
    (setq recentf-max-saved-items 17)
    (recentf-mode)
    (recentf-track-opened-file)

    :config
    (add-to-list 'recentf-exclude (expand-file-name package-user-dir))
    (add-to-list 'recentf-exclude ".cache")
    (add-to-list 'recentf-exclude ".cask")
    (add-to-list 'recentf-exclude ".elfeed")
    (add-to-list 'recentf-exclude "bookmarks")
    (add-to-list 'recentf-exclude "cache")
    (add-to-list 'recentf-exclude "persp-confs")
    (add-to-list 'recentf-exclude "recentf")
    (add-to-list 'recentf-exclude "url")
    (add-to-list 'recentf-exclude "COMMIT_EDITMSG\\'")
    (defun suk/recentf-exclude-p (file)
      (let ((file-dir (file-truename (file-name-directory file))))
        (-any-p (lamdba (dir)
                        (string-prefix-p dir file-dir))
                (mapcar 'file-truename (list var package-user-dir)))))
    (add-to-list 'recentf-exclude #'suk/recentf-exclude-p)
    )

  (provide 'init-recentf)
#+end_src
* etc/init-search.el
#+begin_src emacs-lisp :tangle etc/init-search.el
    ;; init-search.el --- Initialize searchser configurations.	-*- lexical-binding: t -*-
    ;;; Commentary:
    ;;
    ;; Basic configuration.
    ;;

    ;;; Code:
    ;; Search tools

    (eval-when-compile
      (require 'init-package)
      )

    ;;;###autoload
    (defun github-code-search ()
      "Search code on github for a given language."
      (interactive)
      (let ((language (completing-read
                       "Language: "
                       '("Java" "C/C++" "Emacs Javascript" "Lisp"  "Python" "Rust")))
            (code (read-string "Code: ")))
        (browse-url
         (concat "https://github.com/search?l=" language
                 "&type=code&q=" code))))

    ;;;###autoload
    (defun google-search-str (str)
      (browse-url
       (concat "https://www.google.com/search?q=" str)))

    ;;;###autoload
    (defun google-search ()
      "Google search region, if active, or ask for search string."
      (interactive)
      (if (region-active-p)
          (google-search-str
           (buffer-substring-no-properties (region-beginning)
                                           (region-end)))
        (google-search-str (read-from-minibuffer "Search: "))))


    ;; Writable `grep' buffer
    (use-package wgrep
      :init
      (setq wgrep-auto-save-buffer t
            wgrep-change-readonly-file t))

    ;; Search tool
    (use-package grep
      :ensure nil
      :autoload grep-apply-setting
      :init
      (when (executable-find "rg")
        (grep-apply-setting
         'grep-command "rg --color=auto --null -nH --no-heading -e ")
        (grep-apply-setting
         'grep-template "rg --color=auto --null --no-heading -g '!*/' -e <R> <D>")
        (grep-apply-setting
         'grep-find-command '("rg --color=auto --null -nH --no-heading -e ''" . 38))
        (grep-apply-setting
         'grep-find-template "rg --color=auto --null -nH --no-heading -e <R> <D>")))


    ;; Fast search tool `ripgrep'
    (use-package rg
      :hook (after-init . rg-enable-default-bindings)
      :bind (:map rg-global-map
                  ("c" . rg-dwim-current-dir)
                  ("f" . rg-dwim-current-file)
                  ("m" . rg-menu))
      :init (setq rg-group-result t
                  rg-show-columns t)
      :config
      (cl-pushnew '("tmpl" . "*.tmpl") rg-custom-type-aliases))



    (provide 'init-search)

#+end_src
* etc/init-sesion.el
#+begin_src emacs-lisp :tangle etc/init-session.el
  ;;; init-session.el --- Init for session save/restore
  ;;; Require
  (require 'auto-save)
  (require 'basic-toolkit)

  ;;; Code:

  (setq desktop-load-locked-desktop t) ; don't popup dialog ask user, load anyway
  (setq desktop-restore-frames nil)    ; don't restore any frame

  (defun emacs-session-restore ()
    "Restore emacs session."
    (interactive)
    (ignore-errors
      ;; Kill other windows.
      (delete-other-windows)
      ;; Kill unused buffers.
      (kill-unused-buffers)
      ;; Restore session.
      (desktop-read "~/.emacs.d/var/")
      ))

  (defun emacs-session-save (&optional arg)
    "Save emacs session."
    (interactive "p")
    (ignore-errors
      (if (equal arg 4)
          ;; Kill all buffers if with prefix argument.
          (mapc 'kill-buffer (buffer-list))
        ;; Kill unused buffers.
        (kill-unused-buffers)
        ;; Save all buffers before exit.
        (auto-save-buffers))
      ;; Save session.
      (make-directory "~/.emacs.d/var/" t)
      (desktop-save "~/.emacs.d/var/")
      ;; Exit emacs.
      (kill-emacs)))

  (provide 'init-session)

  ;;; init-session.el ends here

#+end_src
* etc/init-shell.el
#+begin_src emacs-lisp :tangle etc/init-shell.el
  ;; init-shell.el --- Initialize shell configurations.	-*- lexical-binding: t -*-
  ;;; Commentary:
  ;;
  ;; Shell configurations.
  ;;

  ;;; Code:

  (use-package shell
    :ensure nil
    :hook ((shell-mode . my-shell-mode-hook)
           (comint-output-filter-functions . comint-strip-ctrl-m))
    :init
    (setq system-uses-terminfo nil)

    (with-no-warnings
      (defun my-shell-simple-send (proc command)
        "Various PROC COMMANDs pre-processing before sending to shell."
        (cond
         ;; Checking for clear command and execute it.
         ((string-match "^[ \t]*clear[ \t]*$" command)
          (comint-send-string proc "\n")
          (erase-buffer))
         ;; Checking for man command and execute it.
         ((string-match "^[ \t]*man[ \t]*" command)
          (comint-send-string proc "\n")
          (setq command (replace-regexp-in-string "^[ \t]*man[ \t]*" "" command))
          (setq command (replace-regexp-in-string "[ \t]+$" "" command))
          ;;(message (format "command %s command" command))
          (funcall 'man command))
         ;; Send other commands to the default handler.
         (t (comint-simple-send proc command))))

      (defun my-shell-mode-hook ()
        "Shell mode customization."
        (local-set-key '[up] 'comint-previous-input)
        (local-set-key '[down] 'comint-next-input)
        (local-set-key '[(shift tab)] 'comint-next-matching-input-from-input)

        (ansi-color-for-comint-mode-on)
        (setq comint-input-sender 'my-shell-simple-send))))

  ;; ANSI & XTERM 256 color support
  (use-package xterm-color
    :defines (compilation-environment
              eshell-preoutput-filter-functions
              eshell-output-filter-functions)
    :functions (compilation-filter my-advice-compilation-filter)
    :init
    ;; For shell and interpreters
    (setenv "TERM" "xterm-256color")
    (setq comint-output-filter-functions
          (remove 'ansi-color-process-output comint-output-filter-functions))
    (add-hook 'comint-preoutput-filter-functions 'xterm-color-filter)
    (add-hook 'shell-mode-hook
              (lambda ()
                ;; Disable font-locking to improve performance
                (font-lock-mode -1)
                ;; Prevent font-locking from being re-enabled
                (make-local-variable 'font-lock-function)
                (setq font-lock-function #'ignore)))

    ;; For eshell
    (with-eval-after-load 'esh-mode
      (add-hook 'eshell-before-prompt-hook
                (lambda ()
                  (setq xterm-color-preserve-properties t)))
      (add-to-list 'eshell-preoutput-filter-functions 'xterm-color-filter)
      (setq eshell-output-filter-functions
            (remove 'eshell-handle-ansi-color eshell-output-filter-functions)))

    ;; For compilation buffers
    (setq compilation-environment '("TERM=xterm-256color"))
    (defun my-advice-compilation-filter (f proc string)
      (funcall f proc
               (if (eq major-mode 'rg-mode) ; compatible with `rg'
                   string
                 (xterm-color-filter string))))
    (advice-add 'compilation-filter :around #'my-advice-compilation-filter)
    (advice-add 'gud-filter :around #'my-advice-compilation-filter))

  ;; Better terminal emulator
  ;; @see https://github.com/akermu/emacs-libvterm#installation
  (when (and module-file-suffix           ; dynamic module
             (executable-find "cmake")
             (executable-find "libtool")  ; libtool-bin
             (executable-find "make"))
    (use-package vterm
      :bind (:map vterm-mode-map
             ([f9] . (lambda ()
                       (interactive)
                       (and (fboundp 'shell-pop-toggle)
                            (shell-pop-toggle)))))
      :init (setq vterm-always-compile-module t))

    (use-package multi-vterm
      :bind ("C-<f9>" . multi-vterm)
      :custom (multi-vterm-buffer-name "vterm")
      :config
      (with-no-warnings
        ;; Use `pop-to-buffer' instead of `switch-to-buffer'
        (defun my-multi-vterm ()
          "Create new vterm buffer."
          (interactive)
          (let ((vterm-buffer (multi-vterm-get-buffer)))
            (setq multi-vterm-buffer-list
                  (nconc multi-vterm-buffer-list (list vterm-buffer)))
            (set-buffer vterm-buffer)
            (multi-vterm-internal)
            (pop-to-buffer vterm-buffer)))
        (advice-add #'multi-vterm :override #'my-multi-vterm))))

  ;; Shell Pop: leverage `popper'
  (with-no-warnings
    (defvar shell-pop--frame nil)
    (defvar shell-pop--window nil)

    (defun shell-pop--shell (&optional arg)
      "Run shell and return the buffer."
      (cond ((fboundp 'vterm) (vterm arg))
            (sys/win32p (eshell arg))
            (t (shell))))

    (defun shell-pop--hide-frame ()
      "Hide child frame and refocus in parent frame."
      (when (and (childframe-workable-p)
                 (frame-live-p shell-pop--frame)
                 (frame-visible-p shell-pop--frame))
        (make-frame-invisible shell-pop--frame)
        (select-frame-set-input-focus (frame-parent shell-pop--frame))
        (setq shell-pop--frame nil)))

    (defun shell-pop-toggle ()
      "Toggle shell."
      (interactive)
      (shell-pop--hide-frame)
      (if (window-live-p shell-pop--window)
          (progn
            (delete-window shell-pop--window)
            (setq shell-pop--window nil))
        (setq shell-pop--window
              (get-buffer-window (shell-pop--shell)))))
    (bind-keys ([f9]  . shell-pop-toggle)
               ("C-`" . shell-pop-toggle))

    (when (childframe-workable-p)
      (defun shell-pop-posframe-hidehandler (_)
        "Hidehandler used by `shell-pop-posframe-toggle'."
        (not (eq (selected-frame) shell-pop--frame)))

      (defun shell-pop-posframe-toggle ()
        "Toggle shell in child frame."
        (interactive)
        (let* ((buffer (shell-pop--shell))
               (window (get-buffer-window buffer)))
          ;; Hide window: for `popper'
          (when (window-live-p window)
            (delete-window window))

          (if (and (frame-live-p shell-pop--frame)
                   (frame-visible-p shell-pop--frame))
              (progn
                ;; Hide child frame and refocus in parent frame
                (make-frame-invisible shell-pop--frame)
                (select-frame-set-input-focus (frame-parent shell-pop--frame))
                (setq shell-pop--frame nil))
            (let ((width  (max 100 (round (* (frame-width) 0.62))))
                  (height (round (* (frame-height) 0.62))))
              ;; Shell pop in child frame
              (setq shell-pop--frame
                    (posframe-show
                     buffer
                     :poshandler #'posframe-poshandler-frame-center
                     :hidehandler #'shell-pop-posframe-hidehandler
                     :left-fringe 8
                     :right-fringe 8
                     :width width
                     :height height
                     :min-width width
                     :min-height height
                     :internal-border-width 3
                     :internal-border-color (face-background 'posframe-border nil t)
                     :background-color (face-background 'tooltip nil t)
                     :override-parameters '((cursor-type . t))
                     :respect-mode-line t
                     :accept-focus t))

              ;; Focus in child frame
              (select-frame-set-input-focus shell-pop--frame)

              (with-current-buffer buffer
                (setq-local cursor-type 'box) ; blink cursor
                (goto-char (point-max))
                (when (fboundp 'vterm-reset-cursor-point)
                  (vterm-reset-cursor-point)))))))
      (bind-key "C-`" #'shell-pop-posframe-toggle)))

  (provide 'init-shell)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; init-shell.el ends here

#+end_src
* etc/init-speedbar.el
#+begin_src emacs-lisp :tangle etc/init-speedbar.el
  ;;; init-speedbar.el --- Init speedbar
  ;;; Commentary:
  ;;
  ;; Init speedbar
  ;;

  ;;; Installation:
  ;;
  ;; Put init-speedbar.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'init-speedbar)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-speedbar RET
  ;;

  ;;; Change log:
  ;;
  ;; 2013/12/30
  ;;      * First released.
  ;;

  ;;; Acknowledgements:
  ;;
  ;;
  ;;

  ;;; TODO
  ;;
  ;;
  ;;

  ;;; Require

  (require 'speedbar)
  (require 'sr-speedbar)

  ;;; Code:

  (setq speedbar-show-unknown-files t)    ;æ˜¾ç¤ºæ–‡ä»¶
  (setq sr-speedbar-skip-other-window-p t)
  (setq sr-speedbar-right-side nil)
  (setq speedbar-buffers-key-map nil)     ;å¸è½½ä¸€äº›æŒ‰é”®
  (setq speedbar-file-key-map nil)
  (lazy-load-set-keys
   '(
     ;; å¯¼èˆªæ“ä½œ
     ("f" . speedbar-edit-line)             ;è¿›å…¥å½“å‰æ¡ç›®
     ("C-m" . speedbar-edit-line)           ;è¿›å…¥å½“å‰æ¡ç›®
     ("j" . speedbar-next)                  ;ä¸‹ä¸€è¡Œ
     ("k" . speedbar-prev)                  ;ä¸Šä¸€è¡Œ
     ("n" . speedbar-forward-list)          ;ä¸‹ä¸€æ¡ç›®
     ("p" . speedbar-backward-list)         ;ä¸Šä¸€æ¡ç›®
     ("u" . speedbar-forced-contract)       ;è·³åˆ°ä¸Šä¸€çº§
     ("F" . speedbar-files)                 ;åˆ‡æ¢æ–‡ä»¶è§†å›¾
     ("B" . speedbar-buffers)               ;åˆ‡æ¢ç¼“å­˜è§†å›¾
     ("q" . sr-speedbar-toggle)             ;é€€å‡º
     ;; æ ‘æ“ä½œ
     ("x" . speedbar-expand-line)           ;å±•å¼€å½“å‰è¡Œ
     ("z" . speedbar-contract-line)         ;æ”¶ç¼©å½“å‰è¡Œ
     ("v" . speedbar-toggle-line-expansion) ;åˆ‡æ¢å½“å‰è¡Œçš„çŠ¶æ€
     ;; æ–‡ä»¶æ“ä½œ
     ("g" . speedbar-refresh)             ;åˆ·æ–°
     ("'" . speedbar-up-directory)        ;ä¸Šä¸€çº§ç›®å½•
     ("i" . speedbar-item-info)           ;æ˜¾ç¤ºä¿¡æ¯
     ("b" . speedbar-item-byte-compile)   ;ç¼–è¯‘
     ("l" . speedbar-item-load)           ;åŠ è½½
     ("c" . speedbar-item-copy)           ;æ‹·è´
     ("d" . speedbar-item-delete)         ;åˆ é™¤
     ("o" . speedbar-item-object-delete)  ;åˆ é™¤å¯¹è±¡
     ("r" . speedbar-item-rename)         ;é‡å‘½ä»¤
     ("m" . speedbar-create-directory)    ;åˆ›å»ºç›®å½•
     ("K" . speedbar-buffer-kill-buffer)  ;å…³é—­å½“å‰buffer
     )
   speedbar-key-map
   )

  (provide 'init-speedbar)

  ;;; init-speedbar.el ends here

#+end_src
* etc/init-string-inflection.el
#+begin_src emacs-lisp :tangle etc/init-string-inflection.el
  ;;; init-string-inflection.el --- Config for string-inflection.el
  ;;; Commentary:
  ;;
  ;; Config for string-inflection.el
  ;;

  ;;; Installation:
  ;;
  ;; Put init-string-inflection.el to your load-path.
  ;; The load-path is usually ~/elisp/.
  ;; It's set in your ~/.emacs like this:
  ;; (add-to-list 'load-path (expand-file-name "~/elisp"))
  ;;
  ;; And the following to your ~/.emacs startup file.
  ;;
  ;; (require 'init-string-inflection)
  ;;
  ;; No need more.

  ;;; Customize:
  ;;
  ;;
  ;;
  ;; All of the above can customize by:
  ;;      M-x customize-group RET init-string-inflection RET
  ;;

  ;;; Change log:
  ;;
  ;; 2018/06/12
  ;;      * First released.
  ;;

  ;;; Acknowledgements:
  ;;
  ;;
  ;;

  ;;; TODO
  ;;
  ;;
  ;;

  ;;; Require
  (require 'string-inflection)

  ;;; Code:

  (defvar one-key-string-inflection-alist nil
    "The `one-key' menu alist for DIRECTORY.")

  (setq one-key-string-inflection-alist
        '(
          (("c" . "FooBar") . (lambda () (interactive) (string-inflection-camelcase)))
          (("l" . "fooBar") . (lambda () (interactive) (string-inflection-lower-camelcase)))
          (("_" . "foo_bar") . (lambda () (interactive) (string-inflection-underscore)))
          (("u" . "FOO_BAR") . (lambda () (interactive) (string-inflection-upcase)))
          (("k" . "foo-bar") . (lambda () (interactive) (string-inflection-kebab-case)))
          (("t" . "foo_bar <=> FooBar") . (lambda () (interactive) (string-inflection-toggle)))
          ))

  (defun one-key-string-inflection ()
    "The `one-key' menu for DIRECTORY."
    (interactive)
    (one-key-menu "STRING INFLECTION" one-key-string-inflection-alist t))

  (provide 'init-string-inflection)

  ;;; init-string-inflection.el ends here

#+end_src
* etc/init-sudo.el
#+begin_src emacs-lisp :tangle etc/init-sudo.el
  ;;; init-sudo.el --- sudo .	-*- lexical-binding: t no-byte-compile: t; -*-
  ;;; Commentary:
  ;;
  ;; sudo setting
  ;;

  ;;; Code:

  (eval-when-compile
    (require '+const)
    (require '+custom))

  (when sys/linuxp
    (progn
      ;; =========================================================
      ;; æ™®é€šç”¨æˆ·è°ƒç”¨rootæƒé™å†™æ–‡ä»¶
      ;; ---------------------------------------------------------
          ;;;###autoload
      (defun suk/sudo-edit (&optional arg)
        (interactive "P")
        (if (or arg (not buffer-file-name))
            (find-file (concat "/sudo:root@localhost:"
                               (ido-read-file-name "Find file(as root): ")))
          (find-alternate-file (concat "/sudo:root@localhost:" buffer-file-name))
          )
        )
      ;; ---------------------------------------------------------
          ;;;###autoload
      (defadvice ido-find-file (after suk/sudo-find-file activate)
        "Find file as root if necessary."
        (unless (and buffer-file-name
                     (file-writable-p buffer-file-name))
          (find-alternate-file (concat "/sudo:root@localhost:" buffer-file-name))))
      ;; ---------------------------------------------------------
          ;;;###autoload
      (defun suk/sudo-find-file (file-name)
        "Like find file, but opens the file as root."
        (interactive "Find File for sudo-edit: ")
        (let ((tramp-file-name
               (concat "/sudo::"
                       (expand-file-name file-name)
                       )
               )
              )
          (find-file tramp-file-name)
          )
        )

      ;; ---------------------------------------------------------
          ;;;###autoload
      (defun suk/sudo-save ()
        (interactive)
        (if (not buffer-file-name)
                                          ; true condition
            (write-file (concat "/sudo:root@localhost:"
                                (ido-read-file-name "File:")
                                )
                        )
                                          ; false condition
          (write-file (concat "/sudo:root@localhost:" buffer-file-name))
          )
        )
      ;; Just hook on `find-file-hook', don't hook `dired-mode-hook', it's unnecessary.
      (add-hook 'find-file-hook
                #'(lambda ()
                    (require 'auto-sudoedit)
                    (auto-sudoedit)))         ;é»˜è®¤æ‰“å¼€å¿½ç•¥æ¨¡å¼
      )

    (defun suk/sudo-actions-one-key ()
      (interactive)
      (require 'one-key)
      (one-key-create-menu
       "SUDO ACTION"
       '(
         (("s" . "Sudo Save") . suk/sudo-save)
         (("f" . "Sudo Find") . suk/sudo-find-file)
         (("e" . "Sudo edit") . suk/sudo-edit)
         )
       t)
      )

    )

  ;; ---------------------------------------------------------
  ;;emacs sudoç¼–è¾‘è¿œç«¯æ–‡ä»¶ç”± jay å‘è¡¨äºŽ on å…­æœˆ 20æ—¥, 2011æˆ‘åœ¨ä¹‹å‰çš„ä¸€ç¯‡
  ;;æ–‡ç« é‡Œæåˆ°è¿‡åœ¨Emacsä¸‹ä½¿ç”¨sudoçš„æ–¹æ³•ã€‚è¿™ä¸ªè§£å†³äº†æˆ‘å¾ˆå¤šæœ¬åœ°ç¼–è¾‘çš„é—®é¢˜ã€‚
  ;;ä½†æ˜¯æˆ‘è¿˜æ˜¯æŠ›ä¸å¼€viï¼Œå› ä¸ºä¸€ç›´æ²¡æœ‰è§£å†³æœåŠ¡å™¨ä¸Šéœ€è¦sudoæ‰æœ‰æƒé™çš„æ–‡ä»¶ç¼–
  ;;è¾‘é—®é¢˜ã€‚çŽ°å®žä¸­è¿™æ˜¯ä¸€ä¸ªå¾ˆæ™®éçš„çŽ°è±¡ï¼Œå°±æ˜¯åœ¨æœåŠ¡å™¨ä¸Šå…³é—­äº†rootæˆ–è€…å…¶ä»–
  ;;ç”¨æˆ·çš„sshç™»é™†æƒé™ï¼Œæ˜¯é€šè¿‡ä¸€èˆ¬ç”¨æˆ·ç™»é™†ä»¥åŽé€šè¿‡sudoç­‰æ–¹å¼èŽ·å¾—æƒé™åŽæ‰èƒ½
  ;;è¿›è¡Œè¿›ä¸€æ­¥çš„æ–‡ä»¶ç¼–è¾‘ã€‚è€Œå¦‚æžœç›´æŽ¥ä½¿ç”¨sudoï¼Œç”¨æ¯”å¦‚
  ;;/sudo:user@host:filepathçš„æ–¹å¼æ¥æ‰“å¼€æ–‡ä»¶ï¼ŒEmacsä¼šæŠ¥é”™è¯´è¿™æ˜¯ä¸€ä¸ªè¿œç«¯æ–‡
  ;;ä»¶ï¼Œä¸èƒ½ä½¿ç”¨sudoæ¥è¿›è¡Œæ“ä½œã€‚å°±å› ä¸ºè¿™æç¤ºï¼Œå¯¼è‡´æˆ‘ä¸€ç›´ä»¥æ¥å¯¹äºŽè¿™æ ·çš„æƒ…
  ;;å†µåªèƒ½ä¹–ä¹–åœ°å¼€ä¸ªshellè·‘åˆ°æœåŠ¡å™¨ä¸Šé¢åŽ»ç”¨viç¼–è¾‘ï¼Œç¼–è¾‘è¿‡ç¨‹ä¸­çš„å„ç§ä¸çˆ½åœ¨
  ;;æ­¤ä¸è¡¨â€¦â€¦ ä¸è¿‡å½“æœ€ç»ˆå¿å—ä¸ä½è¿™ç§åªèƒ½ç”¨viçš„å¯‚å¯žåŽï¼Œç»ˆäºŽä¸‹å®šå†³å¿ƒçœ‹ä¸€ä¸‹
  ;;trampçš„æ‰‹å†Œï¼Œç»“æžœå¾ˆå¥½ï¼Œå‘çŽ°äº†è¿™ä¹ˆä¸€ç« å†…å®¹â€•â€•Connecting to a remote
  ;;host using multiple hopsï¼ŒåŽŸæ¥trampæ˜¯å¯ä»¥é€šè¿‡è®¾ç½®ä»£ç†çš„æ–¹å¼æ¥ç¼–è¾‘é‚£äº›
  ;;æ— æ³•ç›´æŽ¥è®¿é—®åˆ°çš„æ–‡ä»¶çš„ã€‚ä»£ç†å¯ä»¥æ˜¯å„ç§Inline methodï¼Œä¹Ÿå¯ä»¥æ˜¯Gateway
  ;;methodã€‚æ‰€ä»¥é€šè¿‡sshåšè·³æ¿å†sudoæ˜¯å®Œå…¨å¯è¡Œçš„ã€‚è®¾ç½®çš„æ ¼å¼æ˜¯(host user
  ;;proxy)ï¼Œå…¶ä¸­proxyå¯ä»¥ä½¿ç”¨%uå’Œ%hæ¥é€šé…è¾“å…¥çš„ç”¨æˆ·åå’Œä¸»æœºåã€‚è¯¦ç»†æƒ…å†µæ„Ÿ
  ;;å…´è¶£çš„ç«¥éž‹å¯ä»¥ç»†çœ‹æ‰‹å†Œï¼Œè¿™å„¿å°±åªè´´å‡ºæ»¡è¶³æˆ‘çš„éœ€æ±‚çš„ä»£ç äº†:
  ;;
  ;; è·³æ¿ï¼šlocalhost -> machine1.abc.def.edu -> machine2.abc.def.edu
                                          ;(add-to-list 'tramp-default-proxies-alist
                                          ;             '(nil "\\`user\\'" "/ssh:%h:")
                                          ;)
                                          ;
                                          ;(add-to-list 'tramp-default-proxies-alist
                                          ;'("machine2.abc.def.edu"
                                          ;  nil
                                          ;  "/ssh:myname@machine1.abc.def.edu:"))
  ;; ç»è¿‡è¿™æ ·çš„è®¾ç½®ï¼Œå°±å¯ä»¥ç›´æŽ¥ä½¿ç”¨ /sudo:user@host:filepath æ¥ç¼–è¾‘é‚£äº›è¿œç«¯
  ;; éœ€è¦sudoçš„æ–‡ä»¶äº†ã€‚æ‰€ä»¥ï¼Œæ³¡æ¯èŒ¶ï¼Œæ‰”æŽ‰viå§ :)
  ;; ---------------------------------------------------------
  ;; User Option: tramp-default-proxies-alist
  ;; tramp-default-proxies-alist specifies proxy hosts to pass through.
  ;; This variable is list of triples consisting of (host user proxy).
  ;;
  ;; The first match is the proxy host through which passes the file name
  ;; and the target host matching user@host. host and user are
  ;; regular expressions or nil, interpreted as a regular expression
  ;; which always matches.
  ;;
  ;; proxy is a literal TRAMP file name whose local name part is ignored,
  ;; and the method and user name parts are optional.
  ;;
  ;; The method must be an inline or gateway method (see Inline methods, see Gateway methods).
  ;; If proxy is nil, no additional hop is required reaching user@host.
  ;;
  ;; For example, to pass through the host â€˜bastion.your.domainâ€™ as user â€˜birdâ€™
  ;; to reach remote hosts outside the local domain:
  ;;
  ;; (add-to-list 'tramp-default-proxies-alist
  ;;              '("\\." nil "/ssh:bird@bastion.your.domain:"))
  ;; (add-to-list 'tramp-default-proxies-alist
  ;;              '("\\`your\\.domain\\'" nil nil))
  ;; Note: add-to-list adds elements at the beginning of a list.
  ;;       Therefore, most relevant rules must come last in the list.
  ;;
  ;; Proxy hosts can be cascaded in the alist. If there is another host called â€˜jump.your.domainâ€™,
  ;; which is the only host allowed to connect to â€˜bastion.your.domainâ€™, then:
  ;;
  ;; (add-to-list 'tramp-default-proxies-alist
  ;;              '("\\`bastion\\.your\\.domain\\'"
  ;;                "\\`bird\\'"
  ;;                "/ssh:jump.your.domain:"))
  ;; proxy can take patterns %h or %u for host or user respectively.
  ;;
  ;; To login as â€˜rootâ€™ on remote hosts in the domain â€˜your.domainâ€™,
  ;; but login as â€˜rootâ€™ is disabled for non-local access, then use this alist entry:
  ;;
  ;; (add-to-list 'tramp-default-proxies-alist
  ;;              '("\\.your\\.domain\\'" "\\`root\\'" "/ssh:%h:"))
  ;; Opening /sudo:randomhost.your.domain: first connects to â€˜randomhost.your.domainâ€™
  ;; via ssh under your account name, and then perform sudo -u root on that host.
  ;;
  ;; It is key for the sudo method in the above example to be applied on the host after reaching it and not on the local host.
  ;;
  ;; host, user and proxy can also take Lisp forms. These forms when evaluated must return either a string or nil.
  ;;
  ;; To generalize (from the previous example):
  ;; For all hosts, except my local one, first connect via ssh, and then apply sudo -u root:
  ;;
  ;; (add-to-list 'tramp-default-proxies-alist
  ;;              '(nil "\\`root\\'" "/ssh:%h:"))
  ;; (add-to-list 'tramp-default-proxies-alist
  ;;              '((regexp-quote (system-name)) nil nil))
  ;; The above configuration allows TRAMP connection as â€˜rootâ€™ to remote Ubuntu hosts.
  ;;
  ;; tramp-default-proxies-alist is also used for passing through firewalls or proxy servers.
  ;;
  ;; For example, the local host â€˜proxy.your.domainâ€™ on port 3128 serves as HTTP proxy
  ;; to the outer world. User has access rights to another proxy server on â€˜host.other.domainâ€™.1 Then the configuration is:
  ;;
  ;; (add-to-list 'tramp-default-proxies-alist
  ;;              '("\\`host\\.other\\.domain\\'" nil
  ;;              "/tunnel:proxy.your.domain#3128:"))
  ;; Gateway methods in a multiple hop chain can be declared only as the first hop.
  ;;
  ;; Passing through hops involves dealing with restricted shells, such as rbash.
  ;; If TRAMP is made aware, then it would use them for proxies only.
  ;; ---------------------------------------------------------
  ;; Inline methods
  ;;
  ;; Inline methods use the same login connection to transfer file contents.
  ;; Inline methods are quick and easy for small files. They depend on
  ;; the availability of suitable encoding and decoding programs on the remote host.
  ;; For local source and destination, TRAMP may use built-in equivalents of
  ;; such programs in Emacs.
  ;;
  ;; Inline methods can work in situations where an external transfer program
  ;; is unavailable. Inline methods also work when transferring files between
  ;; different user identities on the same host.
  ;;
  ;; TRAMP checks the remote host for the availability and usability of
  ;; mimencode (part of the metamail package) or uuencode. TRAMP uses
  ;; the first reliable command it finds. TRAMPâ€™s search path can be customized,
  ;; see Remote programs.
  ;;
  ;; In case both mimencode and uuencode are unavailable, TRAMP first transfers
  ;; a small Perl program to the remote host, and then tries that program
  ;; for encoding and decoding.
  ;;
  ;; To increase transfer speeds for large text files, use compression before encoding.
  ;; The variable tramp-inline-compress-start-size specifies the file size for
  ;; such optimization.
  ;;
  ;; rsh
  ;;     rsh is an option for connecting to hosts within local networks
  ;;     since rsh is not as secure as other methods.
  ;;
  ;; ssh
  ;;     ssh is a more secure option than others to connect to a remote host.
  ;;
  ;;     ssh can also take extra parameters as port numbers. For example,
  ;;     a host on port 42 is specified as host#42 (the real host name, a hash sign, then a port number).
  ;;     It is the same as passing -p 42 to the ssh command.
  ;;
  ;; telnet
  ;;     Connecting to a remote host with telnet is as insecure as the rsh method.
  ;;
  ;; su
  ;;     Instead of connecting to a remote host, su program allows editing as
  ;;     another user. The host can be either â€˜localhostâ€™ or the host returned
  ;;     by the function (system-name). See Multi-hops for an exception to this behavior.
  ;;
  ;; sudo
  ;;     Similar to su method, sudo uses sudo. sudo must have sufficient rights to start a shell.
  ;;
  ;; sshx
  ;;     Works like ssh but without the extra authentication prompts.
  ;;     sshx uses â€˜ssh -t -t host -l user /bin/shâ€™ to open a connection
  ;;     with a â€œstandardâ€ login shell.
  ;;
  ;;     Note that sshx does not bypass authentication questions.
  ;;     For example, if the host key of the remote host is not known,
  ;;     sshx will still ask â€œAre you sure you want to continue connecting?â€.
  ;;     TRAMP cannot handle such questions.
  ;;     Connections will have to be setup where logins can proceed without such questions.
  ;;
  ;;     sshx is useful for Windows users when ssh triggers an error about allocating a pseudo tty.
  ;;     This happens due to missing shell prompts that confuses TRAMP.
  ;;
  ;;     sshx supports the â€˜-pâ€™ argument.
  ;;
  ;; krlogin
  ;;     This method is also similar to ssh. It uses the krlogin -x command only for remote host login.
  ;;
  ;; ksu
  ;;     This is another method from the Kerberos suite. It behaves like su.
  ;;
  ;; plink
  ;;     plink method is for Windows users with the PuTTY implementation of SSH.
  ;;     It uses â€˜plink -sshâ€™ to log in to the remote host.
  ;;
  ;;     Check the â€˜Share SSH connections if possibleâ€™ control for that session.
  ;;
  ;;     plink method supports the â€˜-Pâ€™ argument.
  ;;
  ;; plinkx
  ;;     Another method using PuTTY on Windows with session names instead of host names.
  ;;     plinkx calls â€˜plink -load session -tâ€™. User names and port numbers must be defined in the session.
  ;;
  ;;     Check the â€˜Share SSH connections if possibleâ€™ control for that session.
  ;; ---------------------------------------------------------
  ;; Gateway methods
  ;;
  ;; Gateway methods are for proxy host declarations (see Multi-hops) so as to pass through
  ;; firewalls and proxy servers. They are not like the other methods that declare direct
  ;; connections to a remote host.
  ;;
  ;; A gateway method always comes with a port setting. TRAMP targets the port number with
  ;; the gateway method localhost#random_port from where the firewall or proxy server is accessed.
  ;;
  ;; Gateway methods support user name and password declarations for authenticating the corresponding
  ;; firewall or proxy server. Such authentication can be passed through only if granted access
  ;; by system administrators.
  ;;
  ;; tunnel
  ;; This method implements an HTTP tunnel via the CONNECT command (conforming to RFC 2616, 2817 specifications).
  ;; Proxy servers using HTTP version 1.1 or later protocol support this command.
  ;;
  ;; For authentication, this protocol uses only Basic Authentication (see RFC 2617).
  ;; When no port number is specified, this protocol defaults to 8080.
  ;;
  ;; socks
  ;; The socks method connects to SOCKSv5 servers (see RFC 1928) and supports
  ;; Username/Password Authentication.
  ;;
  ;; The default port number for the socks server is 1080, if not specified otherwise.

  (provide 'init-sudo)
  ;;; init-sudo.el ends here

#+end_src
* etc/init-translate.el
#+begin_src emacs-lisp :tangle etc/init-translate.el
  ;; init-translate.el --- Initialize translation ultilities.	-*- lexical-binding: t -*-
  ;;; Commentary:
  ;;
  ;; Some translation Utilities.
  ;;

  ;;; Code:

  (eval-when-compile
    (require 'init-package))

  (require 'sdcv)
  (setq sdcv-say-word-p t)                ;say word after search

  (setq sdcv-dictionary-data-dir
        (concat suk-emacs-root-dir "/share/sdcv-dict")) ;è®¾ç½®æ˜Ÿé™…è¯‘çŽ‹æœ¬åœ°è¯å…¸çš„ç›®å½•

  (setq sdcv-dictionary-simple-list    ;æ˜Ÿé™…è¯‘çŽ‹å±å¹•å–è¯è¯å…¸, ç®€å•, å¿«é€Ÿ
        '("æ‡’è™«ç®€æ˜Žè‹±æ±‰è¯å…¸"
          "æ‡’è™«ç®€æ˜Žæ±‰è‹±è¯å…¸"
          "KDic11ä¸‡è‹±æ±‰è¯å…¸"))

  (setq sdcv-dictionary-complete-list     ;æ˜Ÿé™…è¯‘çŽ‹çš„è¯å…¸, å®Œå…¨, è¯¦ç»†
        '(
          "æ‡’è™«ç®€æ˜Žè‹±æ±‰è¯å…¸"
          "è‹±æ±‰æ±‰è‹±ä¸“ä¸šè¯å…¸"
          "XDICTè‹±æ±‰è¾žå…¸"
          "stardict1.3è‹±æ±‰è¾žå…¸"
          "WordNet"
          "XDICTæ±‰è‹±è¾žå…¸"
          "Jargon"
          "æ‡’è™«ç®€æ˜Žæ±‰è‹±è¯å…¸"
          "FOLDOC"
          "æ–°ä¸–çºªè‹±æ±‰ç§‘æŠ€å¤§è¯å…¸"
          "KDic11ä¸‡è‹±æ±‰è¯å…¸"
          "æœ—é“æ±‰è‹±å­—å…¸5.0"
          "CDICT5è‹±æ±‰è¾žå…¸"
          "æ–°ä¸–çºªæ±‰è‹±ç§‘æŠ€å¤§è¯å…¸"
          "ç‰›æ´¥è‹±æ±‰åŒè§£ç¾ŽåŒ–ç‰ˆ"
          "21ä¸–çºªåŒè¯­ç§‘æŠ€è¯å…¸"
          "quick_eng-zh_CN"
          ))


  ;; è°·æ­Œç¿»è¯‘ï¼Œ
  (use-package google-translate
    ;;  :disabled
    :ensure t
    :defer 2
    :config (setq google-translate--tkk-url "http://translate.google.com/"
                  google-translate-base-url "http://translate.google.com/translate\_a/single"
                  google-translate-listen-url "https://translate.google.com/translate\_tts"
                  google-translate-default-target-language "zh-CN"
                  google-translate-default-source-language "en")
    (setq-default google-translate-enable-ido-completion t)
    :bind(
          ;; é…ç½®å¿«æ·é”®
          ("C-x t s" . google-translate-at-point)
          ("C-x t q" . google-translate-query-translate)
          ("C-x t S" . google-translate-smooth-translate)
    ))
  ;; A multi dictionaries interface
  (use-package fanyi
    :bind (("C-c d f" . fanyi-dwim)
           ("C-c d d" . fanyi-dwim2)
           ("C-c d h" . fanyi-from-history))
    :custom (fanyi-providers '(fanyi-haici-provider fanyi-longman-provider))

    (use-package go-translate
      :bind (("C-c d g" . gts-do-translate))
      :init (setq gts-translate-list '(("en" "zh") ("zh" "en")))))

  ;; Youdao Dictionay
  (use-package youdao-dictionary
    :defer 2
    :ensure t
    :bind (
          ("C-c y"   . my-youdao-dictionary-search-at-point)
           ("C-c d Y" . youdao-dictionary-search-async)
           ("C-c d y" . youdao-dictionary-search-at-point)
           ;;("C-x y Y" . youdao-dictionary-search-at-point-tooltip)
           ;;("C-c d p" . 'youdao-dictionary-search-at-point-posframe)
           ;;("C-c d v" . 'youdao-dictionary-play-voice-at-point)
           ("C-c d r" . 'youdao-dictionary-search-and-replace)
           ("C-c d i" . 'youdao-dictionary-search-from-input)
           :map youdao-dictionary-mode-map
           ("h"       . my-youdao-dictionary-help)
           ("?"       . my-youdao-dictionary-help)
    :init
    (setq url-automatic-caching t)
    (setq youdao-dictionary-use-chinese-word-segmentation t) ; ä¸­æ–‡åˆ†è¯
    :config
    ;; Cache documents
    (setq url-automatic-caching t)
    (which-key-add-key-based-replacements "C-c d" "æœ‰é“ç¿»è¯‘")
    ;; Enable Chinese word segmentation support (æ”¯æŒä¸­æ–‡åˆ†è¯)
    (with-no-warnings
      (with-eval-after-load 'hydra
        (defhydra youdao-dictionary-hydra (:color blue)
          ("p" youdao-dictionary-play-voice-of-current-word "play voice of current word")
          ("y" youdao-dictionary-play-voice-at-point "play voice at point")
          ("q" quit-window "quit")
          ("C-g" nil nil)
          ("h" nil nil)
          ("?" nil nil))
        (defun my-youdao-dictionary-help ()
          "Show help in `hydra'."
          (interactive)
          (let ((hydra-hint-display-type 'message))
            (youdao-dictionary-hydra/body))))

      (defun my-youdao-dictionary-search-at-point ()
        "Search word at point and display result with `posframe', `pos-tip' or buffer."
        (interactive)
        (if (posframe-workable-p)
            (youdao-dictionary-search-at-point-posframe)
          (youdao-dictionary-search-at-point)))

      (defun my-youdao-dictionary--posframe-tip (string)
        "Show STRING using `posframe-show'."
        (unless (posframe-workable-p)
          (error "Posframe not workable"))

        (if-let ((word (youdao-dictionary--region-or-word)))
            (progn
              (with-current-buffer (get-buffer-create youdao-dictionary-buffer-name)
                (let ((inhibit-read-only t))
                  (erase-buffer)
                  (youdao-dictionary-mode)
                  (insert string)
                  (set (make-local-variable 'youdao-dictionary-current-buffer-word) word)))
              (posframe-show
               youdao-dictionary-buffer-name
               :position (point)
               :left-fringe 8
               :right-fringe 8
               :max-width (/ (frame-width) 2)
               :max-height (/ (frame-height) 2)
               :background-color (face-background 'tooltip nil t)
               :internal-border-color (face-background 'posframe-border nil t)
               :internal-border-width 1)
              (unwind-protect
                  (push (read-event) unread-command-events)
                (progn
                  (posframe-hide youdao-dictionary-buffer-name)
                  (other-frame 0)))
              (message "Nothing to look up"))))
      (advice-add #'youdao-dictionary--posframe-tip
                  :override #'my-youdao-dictionary--posframe-tip)))

  (provide 'init-translate)

#+end_src
* etc/init-treemacs.el
#+begin_src emacs-lisp :tangle etc/init-treemacs.el
  ;; init-treemacs.el --- Initialize treemacs.	-*- lexical-binding: t -*-

  ;;; Commentary:
  ;;
  ;; Treemacs: A tree layout file explorer.
  ;;

  ;;; Code:

  (eval-when-compile
    (require '+custom))



  ;; A tree layout file explorer
  (use-package treemacs
    :commands (treemacs-follow-mode
               treemacs-filewatch-mode
               treemacs-git-mode)
    :custom-face
    (cfrs-border-color ((t (:inherit posframe-border))))
    :bind (([f8]        . treemacs)
           ("M-0"       . treemacs-select-window)
           ("C-x t 1"   . treemacs-delete-other-windows)
           ("C-x t t"   . treemacs)
           ("C-x t b"   . treemacs-bookmark)
           ("C-x t C-t" . treemacs-find-file)
           ("C-x t M-t" . treemacs-find-tag)
           :map treemacs-mode-map
           ([mouse-1]   . treemacs-single-click-expand-action))
    :config
    (setq treemacs-collapse-dirs           (if treemacs-python-executable 3 0)
          treemacs-missing-project-action  'remove
          treemacs-sorting                 'alphabetic-asc
          treemacs-follow-after-init       t
          treemacs-width                   30
          treemacs-no-png-images           (not suk-icon))

    (treemacs-follow-mode t)
    (treemacs-filewatch-mode t)
    (when sys/win32p
      (pcase (cons (not (null (executable-find "git.exe")))
                   (not (null (executable-find "c:/greem/Python311/python.exe"))))
        (`(t . t)
         (treemacs-git-mode 'deferred))
        (`(t . _)
         (treemacs-git-mode 'simple)))
    )
    (unless sys/win32p
      (pcase (cons (not (null (executable-find "git")))
                   (not (null (executable-find "python3"))))
        (`(t . t)
         (treemacs-git-mode 'deferred))
        (`(t . _)
         (treemacs-git-mode 'simple)))
      )

    (use-package treemacs-nerd-icons
      :demand t
      :when (icons-displayable-p)
      :custom-face
      (treemacs-nerd-icons-root-face ((t (:inherit nerd-icons-green :height 1.3))))
      (treemacs-nerd-icons-file-face ((t (:inherit nerd-icons-dsilver))))
      :config (treemacs-load-theme "nerd-icons"))

    (use-package treemacs-magit
      :hook ((magit-post-commit
              git-commit-post-finish
              magit-post-stage
              magit-post-unstage)
             . treemacs-magit--schedule-update))

    (use-package treemacs-tab-bar
      :ensure t
      :demand t
      :config (treemacs-set-scope-type 'Tabs)))

  (add-hook 'treemacs-mode-hook 'treemacs-project-follow-mode)
  (provide 'init-treemacs)

  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;; init-treemacs.el ends here
#+end_src
* etc/init-utils.el
#+begin_src emacs-lisp :tangle etc/init-utils.el
  ;; init-utils.el --- Initialize ultilities.	-*- lexical-binding: t -*-


  (provide 'init-utils)

  (eval-when-compile
    (require '+const)
    (require '+custom)
    (require 'init-package)
    )

  ;;(use-package bind-key)
  ;;Enhance M-x, use counsel-M-x
  ;;(use-package amx)


  ;; Display available keybindings in popup
  (use-package which-key
    :diminish
    :bind (("C-h M-m" . which-key-show-major-mode)
           (:map help-map ("C-h" . which-key-C-h-dispatch)))

    :hook (after-init . which-key-mode)
    :custom
    ;; ÂµÂ¯Â³Ã¶Â·Â½ÃŠÂ½Â£Â¬ÂµÃ—Â²Â¿ÂµÂ¯Â³Ã¶
    (which-key-popup-type 'side-window)
    :init (setq which-key-max-description-length 30
                which-key-lighter nil
                which-key-show-remaining-keys t)
    :config
    (which-key-mode)
    (which-key-add-key-based-replacements "C-c !" "flycheck")
    (which-key-add-key-based-replacements "C-c &" "yasnippet")
    (which-key-add-key-based-replacements "C-c @" "hideshow")
    (which-key-add-key-based-replacements "C-c d" "dict")
    (which-key-add-key-based-replacements "C-c l" "link-hint")
    (which-key-add-key-based-replacements "C-c n" "org-roam")
    (which-key-add-key-based-replacements "C-c t" "hl-todo")
    (which-key-add-key-based-replacements "C-c C-z" "browse")

    (which-key-add-key-based-replacements "C-x 8" "unicode")
    (which-key-add-key-based-replacements "C-x 8 e" "emoji")
    (which-key-add-key-based-replacements "C-x @" "modifior")
    (which-key-add-key-based-replacements "C-x a" "abbrev")
    (which-key-add-key-based-replacements "C-x c" "citre")
    (which-key-add-key-based-replacements "C-x n" "narrow")
    (which-key-add-key-based-replacements "C-x r" "rect & bookmark")
    (which-key-add-key-based-replacements "C-x t" "tab & treemacs")
    (which-key-add-key-based-replacements "C-x x" "buffer")
    (which-key-add-key-based-replacements "C-x C-a" "edebug")
    (which-key-add-key-based-replacements "C-x RET" "coding-system")
    (which-key-add-key-based-replacements "C-x X" "edebug")

    (which-key-add-major-mode-key-based-replacements 'org-mode
                                                     "C-c \"" "org-plot")
    (which-key-add-major-mode-key-based-replacements 'org-mode
                                                     "C-c C-v" "org-babel")
    (which-key-add-major-mode-key-based-replacements 'org-mode
                                                     "C-c C-x" "org-misc")

    (which-key-add-major-mode-key-based-replacements 'python-mode
                                                     "C-c C-t" "python-skeleton")

    (which-key-add-major-mode-key-based-replacements 'markdown-mode
                                                     "C-c C-a" "markdown-link")
    (which-key-add-major-mode-key-based-replacements 'markdown-mode
                                                     "C-c C-c" "markdown-command")
    (which-key-add-major-mode-key-based-replacements 'markdown-mode
                                                     "C-c C-s" "markdown-style")
    (which-key-add-major-mode-key-based-replacements 'markdown-mode
                                                     "C-c C-t" "markdown-header")
    (which-key-add-major-mode-key-based-replacements 'markdown-mode
                                                     "C-c C-x" "markdown-toggle")

    (which-key-add-major-mode-key-based-replacements 'gfm-mode
                                                     "C-c C-a" "markdown-link")
    (which-key-add-major-mode-key-based-replacements 'gfm-mode
                                                     "C-c C-c" "markdown-command")
    (which-key-add-major-mode-key-based-replacements 'gfm-mode
                                                     "C-c C-s" "markdown-style")
    (which-key-add-major-mode-key-based-replacements 'gfm-mode
                                                     "C-c C-t" "markdown-header")
    (which-key-add-major-mode-key-based-replacements 'gfm-mode
                                                     "C-c C-x" "markdown-toggle")

    (when (childframe-completion-workable-p)
      (use-package which-key-posframe
        :diminish
        :functions posframe-poshandler-frame-center-near-bottom
        :custom-face
        (which-key-posframe ((t (:inherit tooltip))))
        (which-key-posframe-border ((t (:inherit posframe-border :background unspecified))))
        :init
        (setq which-key-posframe-border-width posframe-border-width
              which-key-posframe-poshandler #'posframe-poshandler-frame-center-near-bottom
              which-key-posframe-parameters '((left-fringe . 8)
                                              (right-fringe . 8)))
        (which-key-posframe-mode 1))))



  ;; Do NOT start elnode-web-server by default, prefer manual way

  ;; per project setup may be better
  ;; (setq httpd-root "/var/www")
  (setq httpd-port 4444)
  (defun httpd-restart-now ()
    (interactive)
    (httpd-stop)
    (httpd-start)
    (message "http://localhost:%d/ at %s restarted"
             httpd-port httpd-root))

  (defun httpd-restart-at-default-directory ()
    (interactive)
    (setq httpd-root default-directory)
    (httpd-restart-now))

#+end_src
* etc/init-window.el
#+begin_src emacs-lisp :tangle etc/init-window.el
  ;; init-window.el --- Initialize window configurations.	-*- lexical-binding: t -*-



  (provide 'init-window)

  ;; Directional window-selection routines
  (use-package windmove
    :ensure nil
    :hook (after-init . (lambda ()
                          (windmove-default-keybindings 'super)))
    )

  ;; Restore old window configurations
  (use-package winner
    :ensure nil
    :commands (winner-undo winner-redo)
    :hook (after-init . winner-mode)
    :init (setq winner-boring-buffers '("*Completions*"
                                        "*Compile-Log*"
                                        "*inferior-lisp*"
                                        "*Fuzzy Completions*"
                                        "*Apropos*"
                                        "*Help*"
                                        "*cvs*"
                                        "*Buffer List*"
                                        "*Ibuffer*"
                                        "*esh command on file*")))

  ;; Quickly switch windows
  (use-package ace-window
    :pretty-hydra
    ((:title (pretty-hydra-title "Window Management" 'faicon "nf-fa-th")
      :foreign-keys warn :quit-key ("q" "C-g"))
     ("Actions"
      (("TAB" other-window "switch")
       ("x" ace-delete-window "delete")
       ("X" ace-delete-other-windows "delete other" :exit t)
       ("s" ace-swap-window "swap")
       ("a" ace-select-window "select" :exit t)
       ("m" toggle-frame-maximized "maximize" :exit t)
       ("u" toggle-frame-fullscreen "fullscreen" :exit t))
      "Movement"
      (("i" windmove-up "move â†‘")
       ("k" windmove-down "move â†“")
       ("j" windmove-left "move â†")
       ("l" windmove-right "move â†’")
       ("f" follow-mode "follow"))
      "Resize"
      (("<left>" shrink-window-horizontally "shrink H")
       ("<right>" enlarge-window-horizontally "enlarge H")
       ("<up>" shrink-window "shrink V")
       ("<down>" enlarge-window "enlarge V")
       ("n" balance-windows "balance"))
      "Split"
      (("r" split-window-right "horizontally")
       ("R" split-window-horizontally-instead "horizontally instead")
       ("v" split-window-below "vertically")
       ("V" split-window-vertically-instead "vertically instead")
       ("t" toggle-window-split "toggle")
       ("o" delete-other-windows "only this")
       )
      "Zoom"
      (("+" text-scale-increase "in")
       ("=" text-scale-increase "in")
       ("-" text-scale-decrease "out")
       ("0" (text-scale-increase 0) "reset"))
      "Misc"
      (("o" set-frame-font "frame font")
       ("f" make-frame-command "new frame")
       ("d" delete-frame "delete frame")
       ("z" winner-undo "winner undo")
       ("Z" winner-redo "winner redo"))))
    :custom-face
    (aw-leading-char-face ((t (:inherit font-lock-keyword-face :foreground unspecified :bold t :height 3.0))))
    (aw-minibuffer-leading-char-face ((t (:inherit font-lock-keyword-face :bold t :height 1.0))))
    (aw-mode-line-face ((t (:inherit mode-line-emphasis :bold t))))
    :bind (([remap other-window] . ace-window)
           ("C-c w" . ace-window-hydra/body))
    :hook (emacs-startup . ace-window-display-mode)
    :config
    (defun toggle-window-split ()
      (interactive)
      (if (= (count-windows) 2)
          (let* ((this-win-buffer (window-buffer))
                 (next-win-buffer (window-buffer (next-window)))
                 (this-win-edges (window-edges (selected-window)))
                 (next-win-edges (window-edges (next-window)))
                 (this-win-2nd (not (and (<= (car this-win-edges)
                                             (car next-win-edges))
                                         (<= (cadr this-win-edges)
                                             (cadr next-win-edges)))))
                 (splitter
                  (if (= (car this-win-edges)
                         (car (window-edges (next-window))))
                      'split-window-horizontally
                    'split-window-vertically)))
            (delete-other-windows)
            (let ((first-win (selected-window)))
              (funcall splitter)
              (if this-win-2nd (other-window 1))
              (set-window-buffer (selected-window) this-win-buffer)
              (set-window-buffer (next-window) next-win-buffer)
              (select-window first-win)
              (if this-win-2nd (other-window 1))))
        (user-error "`toggle-window-split' only supports two windows")))

    ;; Bind hydra to dispatch list
    (add-to-list 'aw-dispatch-alist '(?w ace-window-hydra/body) t)

    ;; Select widnow via `M-1'...`M-9'
    (defun aw--select-window (number)
      "Slecet the specified window."
      (when (numberp number)
        (let ((found nil))
          (dolist (win (aw-window-list))
            (when (and (window-live-p win)
                       (eq number
                           (string-to-number
                            (window-parameter win 'ace-window-path))))
              (setq found t)
              (aw-switch-to-window win)))
          (unless found
            (message "No specified window: %d" number)))))
    (dotimes (n 9)
      (bind-key (format "M-%d" (1+ n))
                (lambda ()
                  (interactive)
                  (aw--select-window (1+ n))))))

  ;; Enforce rules for popups
  (use-package popper
    :custom
    (popper-group-function #'popper-group-by-directory)
    (popper-echo-dispatch-actions t)
    :bind (:map popper-mode-map
           ("C-h z"       . popper-toggle)
           ("C-<tab>"     . popper-cycle)
           ("C-M-<tab>"   . popper-toggle-type))
    :hook (emacs-startup . popper-echo-mode)
    :init
    (setq popper-reference-buffers
          '("\\*Messages\\*$"
            "Output\\*$" "\\*Pp Eval Output\\*$"
            "^\\*eldoc.*\\*$"
            "\\*Compile-Log\\*$"
            "\\*Completions\\*$"
            "\\*Warnings\\*$"
            "\\*Async Shell Command\\*$"
            "\\*Apropos\\*$"
            "\\*Backtrace\\*$"
            "\\*Calendar\\*$"
            "\\*Fd\\*$" "\\*Find\\*$" "\\*Finder\\*$"
            "\\*Kill Ring\\*$"
            "\\*Embark \\(Collect\\|Live\\):.*\\*$"

            bookmark-bmenu-mode
            comint-mode
            compilation-mode
            help-mode helpful-mode
            tabulated-list-mode
            Buffer-menu-mode

            flymake-diagnostics-buffer-mode
            flycheck-error-list-mode flycheck-verify-mode

            gnus-article-mode devdocs-mode
            grep-mode occur-mode rg-mode deadgrep-mode ag-mode pt-mode
            youdao-dictionary-mode osx-dictionary-mode fanyi-mode

            "^\\*Process List\\*$" process-menu-mode
            list-environment-mode cargo-process-mode

            "^\\*.*eshell.*\\*.*$"
            "^\\*.*shell.*\\*.*$"
            "^\\*.*terminal.*\\*.*$"
            "^\\*.*vterm[inal]*.*\\*.*$"

            "\\*DAP Templates\\*$" dap-server-log-mode
            "\\*ELP Profiling Restuls\\*" profiler-report-mode
            "\\*Paradox Report\\*$" "\\*package update results\\*$" "\\*Package-Lint\\*$"
            "\\*[Wo]*Man.*\\*$"
            "\\*ert\\*$" overseer-buffer-mode
            "\\*gud-debug\\*$"
            "\\*lsp-help\\*$" "\\*lsp session\\*$"
            "\\*quickrun\\*$"
            "\\*tldr\\*$"
            "\\*vc-.*\\**"
            "\\*diff-hl\\**"
            "^\\*macro expansion\\**"

            "\\*Agenda Commands\\*" "\\*Org Select\\*" "\\*Capture\\*" "^CAPTURE-.*\\.org*"
            "\\*Gofmt Errors\\*$" "\\*Go Test\\*$" godoc-mode
            "\\*docker-.+\\*"
            "\\*prolog\\*" inferior-python-mode
            "\\*rustfmt\\*$" rustic-compilation-mode rustic-cargo-clippy-mode
            rustic-cargo-outdated-mode rustic-cargo-run-mode rustic-cargo-test-mode
            ))

    (with-eval-after-load 'doom-modeline
      (setq popper-mode-line
            '(:eval (let ((face (if (doom-modeline--active)
                                    'doom-modeline-emphasis
                                  'doom-modeline)))
                      (if (and (icons-displayable-p)
                               (bound-and-true-p doom-modeline-icon)
                               (bound-and-true-p doom-modeline-mode))
                          (format " %s "
                                  (nerd-icons-octicon "nf-oct-pin" :face face))
                        (propertize " POP " 'face face))))))
    :config
    (with-no-warnings
      (defun my-popper-fit-window-height (win)
        "Determine the height of popup window WIN by fitting it to the buffer's content."
        (fit-window-to-buffer
         win
         (floor (frame-height) 3)
         (floor (frame-height) 3)))
      (setq popper-window-height #'my-popper-fit-window-height)

      (defun popper-close-window-hack (&rest _)
        "Close popper window via `C-g'."
        ;; `C-g' can deactivate region
        (when (and (called-interactively-p 'interactive)
                   (not (region-active-p))
                   popper-open-popup-alist)
          (let ((window (caar popper-open-popup-alist)))
            (when (window-live-p window)
              (delete-window window)))))
      (advice-add #'keyboard-quit :before #'popper-close-window-hack)))

#+end_src
